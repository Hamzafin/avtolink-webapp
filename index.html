<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Автолинк WebApp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", sans-serif; margin:0; padding:16px; background:#0f172a; color:#e5e7eb; }
    h1 { font-size:20px; margin:0 0 4px; text-align:center; }
    .subtitle { font-size:13px; text-align:center; color:#94a3b8; margin-bottom:16px; }
    .card { background:#111827; border-radius:16px; padding:16px; box-shadow:0 10px 25px rgba(0,0,0,0.5); max-width:560px; margin:0 auto; }
    .field { margin-bottom:12px; display:flex; flex-direction:column; gap:4px; }
    label { font-size:13px; color:#9ca3af; }
    input, select, textarea {
      border-radius:10px; border:1px solid #374151; padding:8px 10px; font-size:14px;
      background:#020617; color:#e5e7eb; outline:none;
    }
    input:focus, select:focus, textarea:focus { border-color:#38bdf8; }
    textarea { min-height:90px; resize:vertical; }
    .hint { font-size:12px; color:#94a3b8; line-height:1.35; margin-top:4px; }
    .pill {
      display:inline-block; padding:6px 10px; border-radius:999px; background:#0b1226;
      border:1px solid #334155; color:#cbd5e1; font-size:12px;
    }
    .row { display:flex; gap:10px; }
    .row .field { flex:1; }
    button#submitBtn {
      width:100%; border-radius:999px; border:none; padding:10px 14px; font-size:15px; font-weight:600;
      background:linear-gradient(135deg, #38bdf8, #6366f1); color:white; cursor:pointer; margin-top:12px;
    }
    button#submitBtn:disabled { opacity:.5; cursor:default; }
    .divider { height:1px; background:#1f2937; margin:14px 0; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <h1>Автолинк</h1>
  <div class="subtitle" id="subtitle"></div>

  <div class="card" id="formCard"></div>
  <button id="submitBtn" disabled>Отправить в бота</button>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const formType = urlParams.get("type") || "unknown";

    const brandsParam = urlParams.get("brands") || "";
    const investorsParam = urlParams.get("investors") || "";
    const sourcesParam = urlParams.get("sources") || "";
    const vinsParam = urlParams.get("vins") || "";
    const bossVinsParam = urlParams.get("bossvins") || "";

    const brands = brandsParam ? brandsParam.split("|") : [];
    const investors = investorsParam ? investorsParam.split("|") : [];
    const sources = sourcesParam ? sourcesParam.split("|") : [];
    const vins = vinsParam ? vinsParam.split("|") : [];
    const bossVins = bossVinsParam ? bossVinsParam.split("|") : [];

    const subtitleEl = document.getElementById("subtitle");
    const formCard = document.getElementById("formCard");
    const submitBtn = document.getElementById("submitBtn");

    const FORM_TITLES = {
      mgr_stock: "Сток",
      sale_nds_broker: "Продажа — НДС с комиссией брокера",
      sale_nds_no_broker: "Продажа — НДС без комиссии брокера",
      sale_cash: "Продажа — Наличные",
      sale_cash_broker: "Продажа — Наличные с комиссией",
      sale_deposit: "Продажа — Задаток",
      sale_extra: "Продажа — Доп. услуги",
      fin_auto_template: "Расходы на авто РФ",
      fin_oper: "Оперрасходы",
      boss_buy: "Закупка / Оплата по VIN",
      boss_invest_in: "Инвестиции — ввод",
      boss_invest_out: "Инвестиции — вывод"
    };

    subtitleEl.textContent = "Форма: " + (FORM_TITLES[formType] || formType);

    function todayISO() { return new Date().toISOString().slice(0, 10); }
    function formatDateToRu(value) {
      if (!value) return "";
      const [y,m,d] = value.split("-");
      if (y && m && d) return `${d}.${m}.${y}`;
      return value;
    }

    function createInput(id, labelText, placeholder = "", value = "", type = "text") {
      const w = document.createElement("div"); w.className="field";
      const l = document.createElement("label"); l.htmlFor=id; l.textContent=labelText;
      const i = document.createElement("input"); i.id=id; i.placeholder=placeholder; i.type=type;
      if (value) i.value=value;
      if (id.toLowerCase().includes("vin")) i.maxLength=17;
      w.appendChild(l); w.appendChild(i);
      return w;
    }
    function createTextarea(id, labelText, placeholder = "") {
      const w = document.createElement("div"); w.className="field";
      const l = document.createElement("label"); l.htmlFor=id; l.textContent=labelText;
      const t = document.createElement("textarea"); t.id=id; t.placeholder=placeholder;
      w.appendChild(l); w.appendChild(t);
      return w;
    }
    function createSelect(id, labelText, options, placeholder="Выберите...") {
      const w=document.createElement("div"); w.className="field";
      const l=document.createElement("label"); l.htmlFor=id; l.textContent=labelText;
      const s=document.createElement("select"); s.id=id;
      const ph=document.createElement("option"); ph.value=""; ph.textContent=placeholder; ph.disabled=true; ph.selected=true;
      s.appendChild(ph);
      options.forEach(opt => { const o=document.createElement("option"); o.value=opt.value; o.textContent=opt.label; s.appendChild(o); });
      w.appendChild(l); w.appendChild(s);
      return w;
    }
    function createAutocompleteInput(id, labelText, placeholder="", options=[]) {
      const w=document.createElement("div"); w.className="field";
      const l=document.createElement("label"); l.htmlFor=id; l.textContent=labelText;
      const i=document.createElement("input"); i.id=id; i.placeholder=placeholder;
      if (options.length) {
        const dlId=id+"_list";
        i.setAttribute("list", dlId);
        let dl=document.getElementById(dlId);
        if (!dl) { dl=document.createElement("datalist"); dl.id=dlId; document.body.appendChild(dl); }
        dl.innerHTML="";
        options.slice(0, 300).forEach(v => { const o=document.createElement("option"); o.value=v; dl.appendChild(o); });
      }
      w.appendChild(l); w.appendChild(i);
      return w;
    }
    function parseNum(v) {
      if (!v) return 0;
      return parseFloat(String(v).replace(/\s/g,"").replace(",", "."));
    }
    function setHidden(el, hide) {
      if (!el) return;
      el.classList.toggle("hidden", !!hide);
    }

    function setupVinAutocompleteSmart(inputId, allVins) {
      const input=document.getElementById(inputId);
      if (!input || !allVins.length) return;

      const listId=inputId+"_list";
      let dl=document.getElementById(listId);
      if (!dl) { dl=document.createElement("datalist"); dl.id=listId; document.body.appendChild(dl); }

      function fill(filter="") {
        dl.innerHTML="";
        let arr=allVins;
        const f=filter.toLowerCase();
        if (f && f.length>=2) {
          arr = allVins.filter(v => v.toLowerCase().includes(f) || v.toLowerCase().endsWith(f));
        }
        arr.slice(0, 150).forEach(v => { const o=document.createElement("option"); o.value=v; dl.appendChild(o); });
      }

      input.setAttribute("list", listId);
      fill("");
      input.addEventListener("input", () => fill(input.value.trim()));
    }

    // ===================== BOSS BUY / PAYMENT =====================

    function renderBossBuy() {
      formCard.innerHTML="";

      // VIN: для автопонимания режима используем bossVins
      const allVinOptions = Array.from(new Set([...(bossVins||[]), ...(vins||[])]));
      formCard.appendChild(createInput("vinInput", "VIN (можно последние 4 символа)", "Последние 4 или полный VIN"));

      // режим
      const modeWrap=document.createElement("div");
      modeWrap.className="field";
      const modeLabel=document.createElement("label");
      modeLabel.textContent="Что делаем?";
      const modeSelect=document.createElement("select");
      modeSelect.id="modeSelect";
      modeSelect.innerHTML = `
        <option value="purchase">Новая закупка (создать VIN)</option>
        <option value="payment">Добавить оплату к VIN</option>
      `;
      const modeBadge=document.createElement("div");
      modeBadge.style.marginTop="6px";
      modeBadge.innerHTML = `<span class="pill" id="modeBadge">Режим: —</span>`;
      modeWrap.appendChild(modeLabel);
      modeWrap.appendChild(modeSelect);
      modeWrap.appendChild(modeBadge);
      formCard.appendChild(modeWrap);

      const hint=document.createElement("div");
      hint.className="hint";
      hint.textContent="Логика: если VIN уже есть в таблице «Закупка», форма автоматически переключится в «Оплата». Если VIN новый — в «Новая закупка». Режим можно вручную поменять.";
      formCard.appendChild(hint);

      formCard.appendChild(document.createElement("div")).className="divider";

      // purchase block
      const purchaseBlock=document.createElement("div");
      purchaseBlock.id="purchaseBlock";

      purchaseBlock.appendChild(createInput("purchaseDateInput", "Дата закупки", "", todayISO(), "date"));
      purchaseBlock.appendChild(createInput("supplierInput", "Поставщик", "Например, дилер/компания"));
      purchaseBlock.appendChild(createInput("placeInput", "Место закупки", "Например, Германия / РФ / Китай"));
      purchaseBlock.appendChild(createAutocompleteInput("brandModelInput", "Марка / Модель", "Например, BMW X5", brands));
      purchaseBlock.appendChild(createInput("complectationInput", "Комплектация", "Например, M Sport"));

      purchaseBlock.appendChild(
        createSelect("currencyInput", "Валюта ($ / ₽ / € / ¥)", [
          {value:"$", label:"$ (доллар)"},
          {value:"₽", label:"₽ (рубль)"},
          {value:"€", label:"€ (евро)"},
          {value:"¥", label:"¥ (юань)"},
        ], "Выберите валюту закупки")
      );

      purchaseBlock.appendChild(createInput("amountCurrencyInput", "Сумма, валюта", "Например, 100000"));
      purchaseBlock.appendChild(createInput("rateInput", "Курс (на дату первой оплаты)", "Например, 80"));
      purchaseBlock.appendChild(createInput("amountRubInput", "Стоимость авто, руб", "Авторасчёт, можно исправить"));

      // optional first payment in purchase
      const payNowWrap=document.createElement("div");
      payNowWrap.className="field";
      const payNowLabel=document.createElement("label");
      payNowLabel.textContent="Добавить оплату сейчас?";
      const payNowSelect=document.createElement("select");
      payNowSelect.id="payNowSelect";
      payNowSelect.innerHTML = `
        <option value="no" selected>Нет</option>
        <option value="yes">Да</option>
      `;
      payNowWrap.appendChild(payNowLabel);
      payNowWrap.appendChild(payNowSelect);
      purchaseBlock.appendChild(payNowWrap);

      const purchasePayBlock=document.createElement("div");
      purchasePayBlock.id="purchasePayBlock";
      purchasePayBlock.className="hidden";

      purchasePayBlock.appendChild(createInput("payDateInput_p", "Дата оплаты", "", todayISO(), "date"));
      purchasePayBlock.appendChild(
        createSelect("payCurrencySelect_p", "Валюта оплаты", [
          {value:"₽", label:"₽ (рубль)"},
          {value:"$", label:"$ (доллар)"},
          {value:"€", label:"€ (евро)"},
          {value:"¥", label:"¥ (юань)"},
        ], "Выберите валюту оплаты")
      );
      purchasePayBlock.appendChild(createInput("payAmountCurrencyInput_p", "Сумма оплаты (валюта)", "Например, 20000"));
      purchasePayBlock.appendChild(createInput("payRateInput_p", "Курс на дату оплаты", "Например, 82"));
      purchasePayBlock.appendChild(createInput("payRubInput_p", "Сумма оплаты (руб)", "Авторасчёт, можно исправить"));
      purchaseBlock.appendChild(purchasePayBlock);

      purchaseBlock.appendChild(createTextarea("commentInput_p", "Комментарий", "По желанию"));

      // payment block
      const paymentBlock=document.createElement("div");
      paymentBlock.id="paymentBlock";

      paymentBlock.appendChild(createInput("payDateInput", "Дата оплаты", "", todayISO(), "date"));
      paymentBlock.appendChild(
        createSelect("payCurrencySelect", "Валюта оплаты", [
          {value:"₽", label:"₽ (рубль)"},
          {value:"$", label:"$ (доллар)"},
          {value:"€", label:"€ (евро)"},
          {value:"¥", label:"¥ (юань)"},
        ], "Выберите валюту оплаты")
      );

      const fxWrap=document.createElement("div");
      fxWrap.id="fxWrap";
      fxWrap.appendChild(createInput("payAmountCurrencyInput", "Сумма оплаты (валюта)", "Например, 20000"));
      fxWrap.appendChild(createInput("payRateInput", "Курс на дату оплаты", "Например, 82"));
      fxWrap.appendChild(createInput("payRubInput", "Сумма оплаты (руб)", "Авторасчёт, можно исправить"));
      paymentBlock.appendChild(fxWrap);

      const rubWrap=document.createElement("div");
      rubWrap.id="rubWrap";
      rubWrap.appendChild(createInput("payRubOnlyInput", "Сумма оплаты (руб)", "Например, 500000"));
      paymentBlock.appendChild(rubWrap);

      paymentBlock.appendChild(createTextarea("commentInput", "Комментарий", "По желанию"));

      formCard.appendChild(purchaseBlock);
      formCard.appendChild(paymentBlock);

      // --- helpers
      function setMode(mode) {
        const badge=document.getElementById("modeBadge");
        const mSel=document.getElementById("modeSelect");
        if (mSel.value !== mode) mSel.value = mode;
        badge.textContent = "Режим: " + (mode === "payment" ? "Оплата" : "Новая закупка");
        setHidden(purchaseBlock, mode !== "purchase");
        setHidden(paymentBlock, mode !== "payment");
      }

      function autoDetectModeByVin(vinRaw) {
        const vin = (vinRaw || "").trim().toUpperCase();
        if (!vin) return;

        // если ввели полный VIN и он есть в bossVins -> payment
        if (vin.length === 17 && bossVins.map(v=>v.toUpperCase()).includes(vin)) {
          setMode("payment");
          return;
        }

        // если ввели последние 4 — ищем совпадения
        if (vin.length >= 4 && vin.length < 17) {
          const matches = bossVins.filter(v => v.toUpperCase().endsWith(vin));
          if (matches.length === 1) {
            document.getElementById("vinInput").value = matches[0];
            setMode("payment");
            return;
          }
          if (matches.length > 1) {
            // не выбираем автоматически — но переводим в оплату
            setMode("payment");
            return;
          }
        }

        // иначе считаем что это новая закупка
        setMode("purchase");
      }

      // calc purchase rub
      function recalcPurchaseRub() {
        const cur = document.getElementById("currencyInput")?.value || "";
        const a = parseNum(document.getElementById("amountCurrencyInput")?.value);
        const r = parseNum(document.getElementById("rateInput")?.value);
        const out = document.getElementById("amountRubInput");
        if (!out) return;

        if (cur === "₽") {
          out.value = a ? Math.round(a).toString() : "";
          return;
        }
        if (a && r) out.value = Math.round(a * r).toString();
      }

      // calc payment rub (fx)
      function recalcPaymentRub(amountId, rateId, rubId, currencySelId) {
        const cur = document.getElementById(currencySelId)?.value || "";
        const a = parseNum(document.getElementById(amountId)?.value);
        const r = parseNum(document.getElementById(rateId)?.value);
        const out = document.getElementById(rubId);
        if (!out) return;
        if (cur && cur !== "₽") {
          if (a && r) out.value = Math.round(a * r).toString();
        }
      }

      function togglePaymentFields(curSelId, fxWrapEl, rubWrapEl) {
        const cur = document.getElementById(curSelId)?.value || "";
        if (cur === "₽") {
          setHidden(fxWrapEl, true);
          setHidden(rubWrapEl, false);
        } else {
          setHidden(fxWrapEl, false);
          setHidden(rubWrapEl, true);
        }
      }

      // wiring
      setupVinAutocompleteSmart("vinInput", allVinOptions);

      setMode("purchase");
      document.getElementById("modeBadge").textContent="Режим: Новая закупка";

      document.getElementById("vinInput").addEventListener("input", (e) => {
        autoDetectModeByVin(e.target.value);
      });

      document.getElementById("modeSelect").addEventListener("change", (e) => {
        setMode(e.target.value);
      });

      // purchase calc
      ["currencyInput","amountCurrencyInput","rateInput"].forEach(id => {
        const el=document.getElementById(id);
        if (el) el.addEventListener("input", recalcPurchaseRub);
        if (el) el.addEventListener("change", recalcPurchaseRub);
      });

      // purchase optional payment toggle
      document.getElementById("payNowSelect").addEventListener("change", (e) => {
        setHidden(purchasePayBlock, e.target.value !== "yes");
      });

      // payment block toggle fields
      const fxWrapEl=document.getElementById("fxWrap");
      const rubWrapEl=document.getElementById("rubWrap");
      togglePaymentFields("payCurrencySelect", fxWrapEl, rubWrapEl);

      document.getElementById("payCurrencySelect").addEventListener("change", () => {
        togglePaymentFields("payCurrencySelect", fxWrapEl, rubWrapEl);
      });

      // recalc for payment
      ["payAmountCurrencyInput","payRateInput"].forEach(id => {
        const el=document.getElementById(id);
        if (el) el.addEventListener("input", ()=>recalcPaymentRub("payAmountCurrencyInput","payRateInput","payRubInput","payCurrencySelect"));
      });

      // purchase payment block toggles
      const fxWrapP = purchasePayBlock; // внутри него будут поля
      document.getElementById("payCurrencySelect_p").addEventListener("change", ()=>{
        const cur = document.getElementById("payCurrencySelect_p").value;
        // просто: если ₽ — скрываем валютные поля, показываем рубли в payRubInput_p
        const a=document.getElementById("payAmountCurrencyInput_p").parentElement;
        const rr=document.getElementById("payRateInput_p").parentElement;
        if (cur === "₽") {
          a.classList.add("hidden");
          rr.classList.add("hidden");
        } else {
          a.classList.remove("hidden");
          rr.classList.remove("hidden");
        }
      });

      ["payAmountCurrencyInput_p","payRateInput_p"].forEach(id=>{
        const el=document.getElementById(id);
        if (el) el.addEventListener("input", ()=>recalcPaymentRub("payAmountCurrencyInput_p","payRateInput_p","payRubInput_p","payCurrencySelect_p"));
      });

      // init calc
      recalcPurchaseRub();

      submitBtn.disabled=false;
    }

    // ===================== РЕНДЕР ПО formType =====================

    function renderForm() {
      formCard.innerHTML="";

      if (formType === "boss_buy") {
        renderBossBuy();
        return;
      }

      // остальные формы оставлены как раньше (если нужно — скажешь, добавлю сюда полностью),
      // но чтобы ничего не ломалось — показываем fallback:
      formCard.appendChild(createTextarea("rawInput", "Данные", "Эта форма в этом файле сейчас не описана."));

      submitBtn.disabled=false;
    }

    renderForm();

    // ===================== СБОР ДАННЫХ =====================

    function collectFormData() {
      const payload = { formType };

      function getRuDate(id) {
        const el = document.getElementById(id);
        return el ? formatDateToRu(el.value) : "";
      }

      if (formType === "boss_buy") {
        const mode = document.getElementById("modeSelect").value;
        payload.mode = mode;

        payload.vin = document.getElementById("vinInput").value.trim().toUpperCase();

        // purchase fields
        if (mode === "purchase") {
          payload.purchase_date = getRuDate("purchaseDateInput");
          payload.supplier = document.getElementById("supplierInput").value;
          payload.purchase_place = document.getElementById("placeInput").value;
          payload.brand_model = document.getElementById("brandModelInput").value;
          payload.complectation = document.getElementById("complectationInput").value;
          payload.currency = document.getElementById("currencyInput").value;
          payload.amount_currency = document.getElementById("amountCurrencyInput").value;
          payload.rate_to_rub = document.getElementById("rateInput").value;
          payload.amount_rub = document.getElementById("amountRubInput").value;

          payload.comment = document.getElementById("commentInput_p").value;

          // optional payment
          const payNow = document.getElementById("payNowSelect").value === "yes";
          if (payNow) {
            payload.pay_date = getRuDate("payDateInput_p");
            payload.pay_currency = document.getElementById("payCurrencySelect_p").value;

            if (payload.pay_currency === "₽") {
              payload.pay_amount_currency = "";
              payload.pay_rate = "";
              payload.pay_amount_rub = document.getElementById("payRubInput_p").value;
            } else {
              payload.pay_amount_currency = document.getElementById("payAmountCurrencyInput_p").value;
              payload.pay_rate = document.getElementById("payRateInput_p").value;
              payload.pay_amount_rub = document.getElementById("payRubInput_p").value;
            }
          }

        } else {
          // payment fields
          payload.pay_date = getRuDate("payDateInput");
          payload.pay_currency = document.getElementById("payCurrencySelect").value;

          if (payload.pay_currency === "₽") {
            payload.pay_amount_currency = "";
            payload.pay_rate = "";
            payload.pay_amount_rub = document.getElementById("payRubOnlyInput").value;
          } else {
            payload.pay_amount_currency = document.getElementById("payAmountCurrencyInput").value;
            payload.pay_rate = document.getElementById("payRateInput").value;
            payload.pay_amount_rub = document.getElementById("payRubInput").value;
          }

          payload.comment = document.getElementById("commentInput").value;
        }

        return payload;
      }

      payload.raw = document.getElementById("rawInput").value;
      return payload;
    }

    // ===================== TELEGRAM SEND =====================

    submitBtn.addEventListener("click", () => {
      const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
      if (!tg) {
        alert("Открой форму через кнопку в Telegram-боте.");
        return;
      }

      try { tg.ready(); } catch(e) {}

      const payload = collectFormData();

      submitBtn.disabled = true;
      submitBtn.textContent = "Отправка...";

      try {
        tg.sendData(JSON.stringify(payload));
        setTimeout(() => { try { tg.close(); } catch(e) {} }, 400);
      } catch (e) {
        alert("Не удалось отправить данные. Попробуй ещё раз.");
        submitBtn.disabled = false;
        submitBtn.textContent = "Отправить в бота";
      }
    });
  </script>
</body>
</html>
