<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>AvtoLink WebApp</title>
  <style>
    :root { --bg:#0b0c10; --card:#12141b; --muted:#9aa3b2; --text:#eef1f7; --line:#232735; --accent:#ff3b30; }
    * { box-sizing:border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--text); }
    header { position:sticky; top:0; background:rgba(11,12,16,.9); backdrop-filter: blur(10px); border-bottom:1px solid var(--line); padding:14px 16px; z-index:10; }
    .title { font-size:16px; font-weight:700; }
    .subtitle { font-size:12px; color:var(--muted); margin-top:4px; }
    main { padding:16px; max-width:860px; margin:0 auto; }
    .card { background:var(--card); border:1px solid var(--line); border-radius:16px; padding:14px; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width:720px){ .row{ grid-template-columns:1fr; } }
    label { display:block; font-size:12px; color:var(--muted); margin:4px 0 6px; }
    input, select, textarea { width:100%; padding:12px 12px; border-radius:12px; border:1px solid var(--line); background:#0f1117; color:var(--text); outline:none; }
    input:focus, select:focus, textarea:focus { border-color:rgba(255,59,48,.8); box-shadow:0 0 0 4px rgba(255,59,48,.08); }
    textarea { min-height: 92px; resize: vertical; }
    .pillbar { display:flex; gap:8px; flex-wrap:wrap; }
    .pill { padding:9px 12px; border-radius:999px; border:1px solid var(--line); background:#0f1117; color:var(--text); font-size:13px; cursor:pointer; user-select:none; }
    .pill.active { border-color: rgba(255,59,48,.9); box-shadow:0 0 0 4px rgba(255,59,48,.08); }
    .divider { height:1px; background:var(--line); margin:14px 0; }
    .badge { display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border:1px solid var(--line); border-radius:999px; background:#0f1117; font-size:12px; color:var(--muted); }
    .badge strong { color:var(--text); font-weight:700; }
    .actions { display:flex; gap:10px; margin-top:14px; }
    .btn { flex:1; padding:12px 14px; border-radius:14px; border:1px solid var(--line); background:#0f1117; color:var(--text); font-weight:700; cursor:pointer; }
    .btn.primary { background: var(--accent); border-color: var(--accent); color:#fff; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }

    /* скрытая отладка — появляется только при ошибке */
    #dbg { display:none; margin-top:12px; padding:10px; border-radius:12px; border:1px solid rgba(255,180,176,.35); background:rgba(255,180,176,.08); color:#ffb4b0; font-size:12px; white-space:pre-wrap; }
    #dbg.show { display:block; }
  </style>
</head>
<body>
<header>
  <div class="title" id="hdrTitle">Форма</div>
  <div class="subtitle" id="hdrSub">AvtoLink</div>
</header>

<main>
  <div class="card" id="formCard"></div>
  <div id="dbg"></div>
  <div class="actions">
    <button class="btn primary" id="submitBtn">Отправить в бота</button>
    <button class="btn" id="closeBtn">Закрыть</button>
  </div>
</main>

<script>
(function(){
  const APP_VERSION = "7";
  const params = new URLSearchParams(location.search);
  const formType = params.get("type") || params.get("formType") || "";
  const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;

  // SW (ускорение повторных открытий)
  try { if ("serviceWorker" in navigator) navigator.serviceWorker.register("./sw.js?v=" + APP_VERSION); } catch(e) {}

  // Telegram viewport
  try { tg && tg.ready && tg.ready(); } catch(e) {}
  try { tg && tg.expand && tg.expand(); } catch(e) {}

  const dbg = document.getElementById("dbg");
  function showDbg(msg){
    dbg.textContent = String(msg||"");
    dbg.classList.add("show");
  }

  // Если JS где-то упадёт — покажем причину (иначе будет "стоит")
  window.addEventListener("error", (e)=> showDbg("JS error: " + (e.message||e.error||"")));
  window.addEventListener("unhandledrejection", (e)=> showDbg("Promise error: " + (e.reason?.message || e.reason || "")));

  const TITLES = {
    "mgr_stock": "Сток",
    "sale_main": "Продажа (основная)",
    "sale_deposit": "Задаток",
    "sale_extra": "Доп. услуги",
    "fin_auto_template": "Расходы на авто РФ",
    "fin_oper": "Оперрасходы",
    "boss_buy": "Закупка / Оплата",
    "boss_invest_in": "Инвестиции — ввод",
    "boss_invest_out": "Инвестиции — вывод",
  };

  const hdrTitle = document.getElementById("hdrTitle");
  const hdrSub = document.getElementById("hdrSub");
  hdrTitle.textContent = TITLES[formType] || ("Форма: " + (formType || "—"));
  hdrSub.textContent = "v" + APP_VERSION + (tg ? "" : " (вне Telegram)");

  // Lists from query (optional)
  const splitList = (k) => (params.get(k) || "").split("|").map(s => s.trim()).filter(Boolean);
  const brands = splitList("brands");
  const sources = splitList("sources");
  const investors = splitList("investors");
  const currencies = splitList("currencies");

  const card = document.getElementById("formCard");
  const submitBtn = document.getElementById("submitBtn");
  const closeBtn = document.getElementById("closeBtn");

  const el = (tag, cls) => { const n = document.createElement(tag); if (cls) n.className = cls; return n; };

  function createInput(id, labelText, placeholder="", value="", type="text") {
    const wrap = el("div");
    const lab = el("label"); lab.setAttribute("for", id); lab.textContent = labelText;
    const inp = el("input"); inp.id = id; inp.type = type; inp.placeholder = placeholder; inp.value = value || "";
    wrap.appendChild(lab); wrap.appendChild(inp);
    return wrap;
  }
  function createSelect(id, labelText, options, value="") {
    const wrap = el("div");
    const lab = el("label"); lab.setAttribute("for", id); lab.textContent = labelText;
    const sel = el("select"); sel.id = id;
    const empty = el("option"); empty.value=""; empty.textContent="—"; sel.appendChild(empty);
    options.forEach(o=>{ const opt=el("option"); opt.value=o; opt.textContent=o; sel.appendChild(opt); });
    sel.value = value || "";
    wrap.appendChild(lab); wrap.appendChild(sel);
    return wrap;
  }
  function createTextarea(id, labelText, placeholder="", value="") {
    const wrap = el("div");
    const lab = el("label"); lab.setAttribute("for", id); lab.textContent = labelText;
    const ta = el("textarea"); ta.id = id; ta.placeholder = placeholder; ta.value = value || "";
    wrap.appendChild(lab); wrap.appendChild(ta);
    return wrap;
  }
  function createDatalist(id, values) {
    const dl = el("datalist"); dl.id=id;
    values.forEach(v=>{ const opt=el("option"); opt.value=v; dl.appendChild(opt); });
    document.body.appendChild(dl);
    return dl;
  }
  function attachDatalist(inputId, listId){ const inp=document.getElementById(inputId); if(inp) inp.setAttribute("list", listId); }

  function todayISO(){ const d=new Date(); const mm=String(d.getMonth()+1).padStart(2,"0"); const dd=String(d.getDate()).padStart(2,"0"); return `${d.getFullYear()}-${mm}-${dd}`; }
  function getRuDate(inputId){
    const v=(document.getElementById(inputId)?.value||"").trim();
    if(!v) return "";
    const m=v.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if(!m) return v;
    return `${m[3]}.${m[2]}.${m[1]}`;
  }

  // Более жирный парсер денег: режет всё лишнее (₽, $, текст, пробелы)
  function parseMoney(s){
    if (s == null) return 0;
    const t = String(s)
      .replace(/\u00a0/g, " ")
      .replace(/\s/g, "")
      .replace(/[^\d,.\-]/g, "")
      .replace(",", ".");
    const n = parseFloat(t);
    return Number.isFinite(n) ? n : 0;
  }

  function setIfEmpty(inputId, value){
    const inp=document.getElementById(inputId);
    if(!inp) return;
    if((inp.value||"").trim()==="") inp.value = value || "";
  }

  function tgUserName(){
    try{
      const u = tg?.initDataUnsafe?.user;
      if(!u) return "";
      const n = [u.first_name, u.last_name].filter(Boolean).join(" ").trim();
      return n || (u.username ? ("@" + u.username) : "");
    }catch(e){ return ""; }
  }

  const LS = { manager:"avtolink_last_manager", vinMap:"avtolink_vin_brand_map_v1" };
  function loadVinMap(){ try{ return JSON.parse(localStorage.getItem(LS.vinMap)||"{}")||{}; }catch(e){ return {}; } }
  function rememberVinBrand(vin, brandModel){
    vin = String(vin||"").trim().toUpperCase();
    brandModel = String(brandModel||"").trim();
    if(!vin || !brandModel) return;
    const map = loadVinMap();
    map[vin] = brandModel;
    try{ localStorage.setItem(LS.vinMap, JSON.stringify(map)); }catch(e){}
  }

  // “ручное” — если человек начал вводить, авто не трогает
  const dirty = { brandModel:false, managerFee:false, profit:false };
  function wireDirty(inputId, key){
    const inp=document.getElementById(inputId);
    if(!inp) return;
    inp.addEventListener("input", ()=>{
      const v=(inp.value||"").trim();
      dirty[key] = v !== "";
    });
  }

  function renderError(msg){
    card.innerHTML="";
    const b=el("div");
    b.textContent=msg;
    b.style.color="#ffb4b0";
    card.appendChild(b);
    submitBtn.disabled=true;
  }

  // ---------- FORMS ----------
  function renderSaleMain(){
    card.innerHTML="";
    if(brands.length) createDatalist("dlBrands", brands);
    if(sources.length) createDatalist("dlSources", sources);

    const selWrap=el("div");
    const payBar=el("div","pillbar");
    const vatBar=el("div","pillbar");
    const comBar=el("div","pillbar");

    const badge=el("div","badge");
    badge.innerHTML=`Вариант: <strong id="variantText">—</strong>`;
    selWrap.appendChild(badge);
    selWrap.appendChild(el("div","divider"));

    selWrap.appendChild(el("label")).textContent="Оплата";
    ["Нал","Безнал"].forEach(v=>{ const p=el("div","pill"); p.textContent=v; p.dataset.val=v; payBar.appendChild(p); });
    selWrap.appendChild(payBar);

    selWrap.appendChild(el("label")).textContent="НДС";
    ["С НДС","Без НДС"].forEach(v=>{ const p=el("div","pill"); p.textContent=v; p.dataset.val=v; vatBar.appendChild(p); });
    selWrap.appendChild(vatBar);

    selWrap.appendChild(el("label")).textContent="Комиссия";
    ["Есть","Нет"].forEach(v=>{ const p=el("div","pill"); p.textContent=v; p.dataset.val=v; comBar.appendChild(p); });
    selWrap.appendChild(comBar);

    card.appendChild(selWrap);
    card.appendChild(el("div","divider"));

    const rowA=el("div","row");
    rowA.appendChild(createInput("managerInput","Менеджер"));
    rowA.appendChild(createInput("saleDateInput","Дата продажи","",todayISO(),"date"));
    card.appendChild(rowA);

    const rowB=el("div","row");
    rowB.appendChild(createInput("brandModelInput","Марка / Модель"));
    rowB.appendChild(createInput("vinInput","VIN"));
    card.appendChild(rowB);
    if(brands.length) attachDatalist("brandModelInput","dlBrands");

    const rowC=el("div","row");
    rowC.appendChild(createInput("leadSourceInput","Источник"));
    rowC.appendChild(createInput("buyerInput","Покупатель"));
    card.appendChild(rowC);
    if(sources.length) attachDatalist("leadSourceInput","dlSources");

    const dyn=el("div"); dyn.id="dynFields"; card.appendChild(dyn);

    // Auto manager (quiet)
    const managerFromTg = tgUserName();
    let remembered = "";
    try { remembered = localStorage.getItem(LS.manager) || ""; } catch(e) {}
    setIfEmpty("managerInput", remembered || managerFromTg);
    // если поле всё равно пустое — насильно поставим tg (иначе менеджерам неудобно)
    if ((document.getElementById("managerInput").value || "").trim() === "" && managerFromTg) {
      document.getElementById("managerInput").value = managerFromTg;
    }
    document.getElementById("managerInput").addEventListener("input", ()=>{
      try { localStorage.setItem(LS.manager, document.getElementById("managerInput").value || ""); } catch(e) {}
    });

    // Auto brand by VIN (quiet)
    const bmInp=document.getElementById("brandModelInput");
    const vinInp=document.getElementById("vinInput");
    bmInp.addEventListener("input", ()=>{ dirty.brandModel = (bmInp.value||"").trim() !== ""; });
    vinInp.addEventListener("input", ()=>{
      const vin=(vinInp.value||"").trim().toUpperCase();
      if(!vin) return;
      if(!dirty.brandModel && (bmInp.value||"").trim()===""){
        const map=loadVinMap();
        if(map[vin]) bmInp.value = map[vin];
      }
    });

    let state={ pay:"Безнал", vat:"С НДС", com:"Есть" };

    function setActive(bar,val){ [...bar.children].forEach(ch=>ch.classList.toggle("active", ch.dataset.val===val)); }
    function computeVariant(){
      if(state.pay==="Нал") return state.com==="Есть" ? "Нал / с комиссией" : "Нал / без комиссии";
      if(state.vat==="Без НДС") return state.com==="Есть" ? "Безнал / без НДС / с брокером" : "Безнал / без НДС / без брокера";
      return state.com==="Есть" ? "Безнал / с НДС / с брокером" : "Безнал / с НДС / без брокера";
    }

    function onAny(elm, fn){
      ["input","change","keyup"].forEach(ev=>elm.addEventListener(ev, fn));
    }

    function renderDynamicFields(){
      dyn.innerHTML="";
      document.getElementById("variantText").textContent = computeVariant();

      if(state.pay==="Нал"){
        const r1=el("div","row");
        r1.appendChild(createInput("priceCashInput","Цена (нал)"));
        r1.appendChild(createInput("receiverInput","Кому передали средства"));
        dyn.appendChild(r1);

        if(state.com==="Есть"){
          const r2=el("div","row");
          r2.appendChild(createInput("priceNoCommInput","Цена без комиссии"));
          r2.appendChild(createInput("managerFeeInput","Комиссия менеджера"));
          dyn.appendChild(r2);

          dirty.managerFee=false;
          wireDirty("managerFeeInput","managerFee");

          const pc=document.getElementById("priceCashInput");
          const pnc=document.getElementById("priceNoCommInput");
          const fee=document.getElementById("managerFeeInput");

          function recalcFee(){
            if(dirty.managerFee) return;
            const hasA = (pc.value||"").trim() !== "";
            const hasB = (pnc.value||"").trim() !== "";
            if(!hasA || !hasB){ fee.value=""; return; }
            const diff = parseMoney(pc.value) - parseMoney(pnc.value);
            fee.value = Number.isFinite(diff) ? String(diff) : "";
          }
          onAny(pc, recalcFee);
          onAny(pnc, recalcFee);
          recalcFee();
        }
        return;
      }

      // Безнал
      const r0=el("div","row");
      r0.appendChild(createInput("receiverInput","Кому передали средства"));
      r0.appendChild(createInput("buyer2Input","Покупатель"));
      dyn.appendChild(r0);

      if(state.vat==="С НДС"){
        const r1=el("div","row");
        r1.appendChild(createInput("priceNdsInput","Цена с НДС"));
        r1.appendChild(createInput("markupNdsInput","Наценка НДС (% / руб)"));
        dyn.appendChild(r1);

        const r2=el("div","row");
        r2.appendChild(createInput("contractPriceInput","Сумма договора"));
        r2.appendChild(createInput("priceCashlessInput","Цена (безнал)"));
        dyn.appendChild(r2);

        if(state.com==="Есть"){
          const r3=el("div","row");
          r3.appendChild(createInput("brokerPriceInput","Цена без комиссии брокера"));
          r3.appendChild(createInput("brokerExpenseInput","Расход брокера (кому/сумма/комментарий)"));
          dyn.appendChild(r3);
        }
        return;
      }

      // Без НДС
      const r4=el("div","row");
      r4.appendChild(createInput("priceCashlessInput","Цена (безнал)"));
      r4.appendChild(createInput("contractPriceInput","Сумма договора"));
      dyn.appendChild(r4);

      if(state.com==="Есть"){
        const r5=el("div","row");
        r5.appendChild(createInput("brokerPriceInput","Цена без комиссии брокера"));
        r5.appendChild(createInput("brokerExpenseInput","Расход брокера (кому/сумма/комментарий)"));
        dyn.appendChild(r5);
      }
    }

    function wireBar(bar,key){
      [...bar.children].forEach(ch=>{
        ch.addEventListener("click", ()=>{
          state[key]=ch.dataset.val;
          setActive(bar,state[key]);
          vatBar.style.display = (state.pay==="Нал") ? "none" : "flex";
          renderDynamicFields();
        });
      });
    }

    setActive(payBar, state.pay);
    setActive(vatBar, state.vat);
    setActive(comBar, state.com);
    vatBar.style.display = (state.pay==="Нал") ? "none" : "flex";

    wireBar(payBar,"pay");
    wireBar(vatBar,"vat");
    wireBar(comBar,"com");
    renderDynamicFields();

    submitBtn.disabled=false;
  }

  function renderSaleExtra(){
    card.innerHTML="";
    if(brands.length) createDatalist("dlBrands", brands);
    if(sources.length) createDatalist("dlSources", sources);

    const r1=el("div","row");
    r1.appendChild(createInput("managerInput","Менеджер"));
    r1.appendChild(createInput("saleDateInput","Дата","",todayISO(),"date"));
    card.appendChild(r1);

    const r2=el("div","row");
    r2.appendChild(createInput("brandModelInput","Марка / Модель"));
    r2.appendChild(createInput("vinInput","VIN"));
    card.appendChild(r2);
    if(brands.length) attachDatalist("brandModelInput","dlBrands");

    const r3=el("div","row");
    r3.appendChild(createInput("leadSourceInput","Источник"));
    r3.appendChild(createInput("receiverInput","Кому передали средства"));
    card.appendChild(r3);
    if(sources.length) attachDatalist("leadSourceInput","dlSources");

    card.appendChild(createTextarea("extraDescInput","Доп. услуги (описание)",""));

    const r4=el("div","row");
    r4.appendChild(createInput("priceInput","Цена (продажа)"));
    r4.appendChild(createInput("buyPriceInput","Закупочная цена"));
    card.appendChild(r4);

    const r5=el("div","row");
    r5.appendChild(createInput("purchaserInput","Кто выдал средства на закупку"));
    r5.appendChild(createInput("profitInput","Доход"));
    card.appendChild(r5);

    // manager auto
    const managerFromTg=tgUserName();
    let remembered=""; try{ remembered=localStorage.getItem(LS.manager)||""; }catch(e){}
    setIfEmpty("managerInput", remembered || managerFromTg);
    if ((document.getElementById("managerInput").value || "").trim()==="" && managerFromTg){
      document.getElementById("managerInput").value = managerFromTg;
    }
    document.getElementById("managerInput").addEventListener("input", ()=>{
      try{ localStorage.setItem(LS.manager, document.getElementById("managerInput").value||""); }catch(e){}
    });

    // brand by VIN cache
    const bmInp=document.getElementById("brandModelInput");
    const vinInp=document.getElementById("vinInput");
    bmInp.addEventListener("input", ()=>{ dirty.brandModel = (bmInp.value||"").trim() !== ""; });
    vinInp.addEventListener("input", ()=>{
      const vin=(vinInp.value||"").trim().toUpperCase();
      if(!vin) return;
      if(!dirty.brandModel && (bmInp.value||"").trim()===""){
        const map=loadVinMap();
        if(map[vin]) bmInp.value = map[vin];
      }
    });

    // stable profit
    dirty.profit=false;
    wireDirty("profitInput","profit");
    const price=document.getElementById("priceInput");
    const buy=document.getElementById("buyPriceInput");
    const profit=document.getElementById("profitInput");

    function onAny(elm, fn){ ["input","change","keyup"].forEach(ev=>elm.addEventListener(ev, fn)); }
    function recalcProfit(){
      if(dirty.profit) return;
      const hasA=(price.value||"").trim()!=="";
      const hasB=(buy.value||"").trim()!=="";
      if(!hasA || !hasB){ profit.value=""; return; }
      const diff=parseMoney(price.value)-parseMoney(buy.value);
      profit.value = Number.isFinite(diff) ? String(diff) : "";
    }
    onAny(price, recalcProfit);
    onAny(buy, recalcProfit);
    recalcProfit();

    submitBtn.disabled=false;
  }

  function renderSaleDeposit(){
    card.innerHTML="";
    if(brands.length) createDatalist("dlBrands", brands);
    if(sources.length) createDatalist("dlSources", sources);

    const r1=el("div","row");
    r1.appendChild(createInput("managerInput","Менеджер"));
    r1.appendChild(createInput("saleDateInput","Дата","",todayISO(),"date"));
    card.appendChild(r1);

    const r2=el("div","row");
    r2.appendChild(createInput("brandModelInput","Марка / Модель"));
    r2.appendChild(createInput("vinInput","VIN"));
    card.appendChild(r2);
    if(brands.length) attachDatalist("brandModelInput","dlBrands");

    const r3=el("div","row");
    r3.appendChild(createInput("leadSourceInput","Источник"));
    r3.appendChild(createInput("buyerInput","Покупатель"));
    card.appendChild(r3);
    if(sources.length) attachDatalist("leadSourceInput","dlSources");

    const r4=el("div","row");
    r4.appendChild(createInput("depositSumInput","Сумма задатка"));
    r4.appendChild(createInput("receiverInput","Кому передали средства"));
    card.appendChild(r4);

    card.appendChild(createInput("priceInput","Цена"));

    // manager auto
    const managerFromTg=tgUserName();
    let remembered=""; try{ remembered=localStorage.getItem(LS.manager)||""; }catch(e){}
    setIfEmpty("managerInput", remembered || managerFromTg);
    if ((document.getElementById("managerInput").value || "").trim()==="" && managerFromTg){
      document.getElementById("managerInput").value = managerFromTg;
    }
    document.getElementById("managerInput").addEventListener("input", ()=>{
      try{ localStorage.setItem(LS.manager, document.getElementById("managerInput").value||""); }catch(e){}
    });

    // brand by VIN cache
    const bmInp=document.getElementById("brandModelInput");
    const vinInp=document.getElementById("vinInput");
    bmInp.addEventListener("input", ()=>{ dirty.brandModel = (bmInp.value||"").trim() !== ""; });
    vinInp.addEventListener("input", ()=>{
      const vin=(vinInp.value||"").trim().toUpperCase();
      if(!vin) return;
      if(!dirty.brandModel && (bmInp.value||"").trim()===""){
        const map=loadVinMap();
        if(map[vin]) bmInp.value = map[vin];
      }
    });

    submitBtn.disabled=false;
  }

  function renderErrorForm(){
    renderError("Неизвестный тип формы: " + formType);
  }

  // ---------- Payload ----------
  function val(id){ return (document.getElementById(id)?.value || "").trim(); }

  function collectPayload(){
    const payload = { formType };

    if(formType==="sale_main"){
      payload.variant = (document.getElementById("variantText")?.textContent || "").trim();
      payload.manager = val("managerInput");
      payload.sale_date = getRuDate("saleDateInput");
      payload.brand_model = val("brandModelInput");
      payload.vin = val("vinInput");
      payload.source = val("leadSourceInput");

      payload.buyer = val("buyerInput");
      payload.receiver = val("receiverInput");

      // numbers
      payload.price_cash = val("priceCashInput");
      payload.price_no_commission = val("priceNoCommInput");
      payload.manager_fee = val("managerFeeInput");

      payload.price_cashless = val("priceCashlessInput");
      payload.price_nds = val("priceNdsInput");
      payload.markup_nds = val("markupNdsInput");
      payload.contract_price = val("contractPriceInput");
      payload.broker_price = val("brokerPriceInput");
      payload.broker_expense = val("brokerExpenseInput");

      const buyer2 = val("buyer2Input");
      if(buyer2) payload.buyer = buyer2;

      return payload;
    }

    if(formType==="sale_deposit"){
      payload.manager = val("managerInput");
      payload.sale_date = getRuDate("saleDateInput");
      payload.brand_model = val("brandModelInput");
      payload.vin = val("vinInput");
      payload.source = val("leadSourceInput");
      payload.deposit_sum = val("depositSumInput");
      payload.receiver = val("receiverInput");
      payload.buyer = val("buyerInput");
      payload.price = val("priceInput");
      return payload;
    }

    if(formType==="sale_extra"){
      payload.manager = val("managerInput");
      payload.sale_date = getRuDate("saleDateInput");
      payload.brand_model = val("brandModelInput");
      payload.vin = val("vinInput");
      payload.source = val("leadSourceInput");
      payload.extra_desc = val("extraDescInput");
      payload.price = val("priceInput");
      payload.receiver = val("receiverInput");
      payload.purchaser = val("purchaserInput");
      payload.buy_price = val("buyPriceInput");
      payload.profit = val("profitInput");
      return payload;
    }

    // другие формы не трогаем здесь (у тебя они уже работали)
    payload._raw = {};
    return payload;
  }

  // ---------- Render router ----------
  if(!formType){
    renderError("Не указан тип формы (type=...). Открой через кнопку в Telegram-боте.");
  } else if (formType==="sale_main"){
    renderSaleMain();
  } else if (formType==="sale_deposit"){
    renderSaleDeposit();
  } else if (formType==="sale_extra"){
    renderSaleExtra();
  } else {
    renderErrorForm();
  }

  // ---------- Actions ----------
  closeBtn.addEventListener("click", ()=>{
    try { tg && tg.close && tg.close(); } catch(e){ window.close(); }
  });

  submitBtn.addEventListener("click", ()=>{
    if(!tg || typeof tg.sendData !== "function"){
      showDbg("Telegram.WebApp недоступен. Открой форму через кнопку в боте.\n" +
              "tg=" + (!!tg) + ", sendData=" + (typeof tg?.sendData));
      return;
    }

    let payload;
    try { payload = collectPayload(); }
    catch(e){ showDbg("Ошибка сбора данных: " + (e?.message||e)); return; }

    // save caches (quiet)
    try{
      if(payload.manager) localStorage.setItem(LS.manager, payload.manager);
      if(payload.vin && payload.brand_model) rememberVinBrand(payload.vin, payload.brand_model);
    }catch(e){}

    // send
    const json = JSON.stringify(payload);
    // Telegram ограничивает размер данных, но здесь он небольшой — на всякий случай покажем если вдруг
    if(json.length > 3500){
      showDbg("Слишком много данных для отправки (" + json.length + " символов). Укоротите текстовые поля.");
      return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = "Отправка...";

    try{
      tg.sendData(json);
      try { tg.HapticFeedback && tg.HapticFeedback.notificationOccurred("success"); } catch(e){}
      setTimeout(()=>{ try { tg.close(); } catch(e) {} }, 120);
    }catch(e){
      submitBtn.disabled=false;
      submitBtn.textContent="Отправить в бота";
      showDbg("Не удалось отправить: " + (e?.message||e));
    }
  });

})();
</script>
</body>
</html>
