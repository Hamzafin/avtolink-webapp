<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Автолинк WebApp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: #0f172a;
      color: #e5e7eb;
    }
    h1 {
      font-size: 20px;
      margin-bottom: 4px;
      text-align: center;
    }
    .subtitle {
      font-size: 13px;
      text-align: center;
      color: #94a3b8;
      margin-bottom: 16px;
    }
    .card {
      background: #111827;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.5);
      max-width: 560px;
      margin: 0 auto;
    }
    .field {
      margin-bottom: 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    label {
      font-size: 13px;
      color: #9ca3af;
    }
    input, select, textarea {
      border-radius: 10px;
      border: 1px solid #374151;
      padding: 8px 10px;
      font-size: 14px;
      background: #020617;
      color: #e5e7eb;
      outline: none;
    }
    input:focus, select:focus, textarea:focus {
      border-color: #38bdf8;
    }
    textarea {
      min-height: 80px;
      resize: vertical;
    }
    .readonly {
      background: #020617;
      color: #9ca3af;
    }
    button#submitBtn {
      width: 100%;
      border-radius: 999px;
      border: none;
      padding: 10px 14px;
      font-size: 15px;
      font-weight: 500;
      background: linear-gradient(135deg, #38bdf8, #6366f1);
      color: white;
      cursor: pointer;
      margin-top: 10px;
    }
    button#submitBtn:disabled {
      opacity: 0.5;
      cursor: default;
    }

    /* --- MULTI OWNER UI (СТОК) --- */
    .owner-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 6px;
    }
    .owner-row input { flex: 1; }
    .mini-btn {
      border: 1px solid #374151;
      background: #0b1220;
      color: #e5e7eb;
      border-radius: 10px;
      padding: 8px 10px;
      cursor: pointer;
      white-space: nowrap;
    }
    .mini-btn:active { transform: translateY(1px); }

    /* --- DISTRIBUTION UI --- */
    .alloc-row {
      display: grid;
      grid-template-columns: 1fr 160px;
      gap: 10px;
      margin-top: 8px;
      align-items: center;
    }
    .alloc-name {
      font-size: 13px;
      color: #cbd5e1;
      white-space: pre-wrap;
    }
    .alloc-hint {
      font-size: 12px;
      color: #94a3b8;
      margin-top: 6px;
      line-height: 1.3;
    }
    .warn {
      font-size: 12px;
      margin-top: 8px;
      color: #fca5a5;
      display: none;
    }
    .ok {
      font-size: 12px;
      margin-top: 8px;
      color: #86efac;
      display: none;
    }
  </style>
</head>
<body>
  <h1>Автолинк</h1>
  <div class="subtitle" id="subtitle"></div>

  <div class="card" id="formCard"></div>

  <button id="submitBtn" disabled>Отправить в бота</button>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const formType = urlParams.get("type") || "unknown";
    const categoryFromUrl = urlParams.get("category") || "";
    const brandsParam = urlParams.get("brands") || "";
    const investorsParam = urlParams.get("investors") || "";
    const sourcesParam = urlParams.get("sources") || "";
    const vinsParam = urlParams.get("vins") || "";
    const currenciesParam = urlParams.get("currencies") || "";
    const distParam = urlParams.get("dist") || ""; // ✅ meta для распределения

    const brands = brandsParam ? brandsParam.split("|") : [];
    const investors = investorsParam ? investorsParam.split("|") : [];
    const sources = sourcesParam ? sourcesParam.split("|") : [];
    const vins = vinsParam ? vinsParam.split("|") : [];
    const currencies = currenciesParam ? currenciesParam.split("|") : [];

    const subtitleEl = document.getElementById("subtitle");
    const formCard = document.getElementById("formCard");
    const submitBtn = document.getElementById("submitBtn");

    const FORM_TITLES = {
      mgr_stock: "Сток",
      sale_nds_broker: "Продажа — НДС с комиссией брокера",
      sale_nds_no_broker: "Продажа — НДС без комиссии брокера",
      sale_cash: "Продажа — Наличные",
      sale_cash_broker: "Продажа — Наличные с комиссией",
      sale_deposit: "Продажа — Задаток",
      sale_extra: "Продажа — Доп. услуги",
      fin_auto_template: "Расходы на авто РФ",
      fin_oper: "Оперрасходы",
      boss_buy: "Закупка",
      boss_invest_in: "Инвестиции — ввод",
      boss_invest_out: "Инвестиции — вывод",
      boss_distribution: "Распределение инвестиций по авто"
    };

    subtitleEl.textContent =
      "Форма: " + (FORM_TITLES[formType] || formType) +
      (categoryFromUrl ? " | Категория: " + categoryFromUrl : "");

    function createInput(id, labelText, placeholder = "", readonly = false, value = "", type = "text") {
      const wrapper = document.createElement("div");
      wrapper.className = "field";

      const label = document.createElement("label");
      label.htmlFor = id;
      label.textContent = labelText;

      const input = document.createElement("input");
      input.id = id;
      input.placeholder = placeholder;
      input.type = type;
      if (value) input.value = value;
      if (readonly) {
        input.readOnly = true;
        input.classList.add("readonly");
      }
      if (id.toLowerCase().includes("vin")) input.maxLength = 17;

      wrapper.appendChild(label);
      wrapper.appendChild(input);
      return wrapper;
    }

    function createTextarea(id, labelText, placeholder = "", readonly = false, value = "") {
      const wrapper = document.createElement("div");
      wrapper.className = "field";

      const label = document.createElement("label");
      label.htmlFor = id;
      label.textContent = labelText;

      const textarea = document.createElement("textarea");
      textarea.id = id;
      textarea.placeholder = placeholder;
      if (value) textarea.value = value;
      if (readonly) {
        textarea.readOnly = true;
        textarea.classList.add("readonly");
      }

      wrapper.appendChild(label);
      wrapper.appendChild(textarea);
      return wrapper;
    }

    function createSelect(id, labelText, options, placeholder = "Выберите...") {
      const wrapper = document.createElement("div");
      wrapper.className = "field";

      const label = document.createElement("label");
      label.htmlFor = id;
      label.textContent = labelText;

      const select = document.createElement("select");
      select.id = id;

      const optPlaceholder = document.createElement("option");
      optPlaceholder.value = "";
      optPlaceholder.textContent = placeholder;
      optPlaceholder.disabled = true;
      optPlaceholder.selected = true;
      select.appendChild(optPlaceholder);

      options.forEach((opt) => {
        const o = document.createElement("option");
        o.value = opt;
        o.textContent = opt;
        select.appendChild(o);
      });

      wrapper.appendChild(label);
      wrapper.appendChild(select);
      return wrapper;
    }

    function createAutocompleteInput(id, labelText, placeholder = "", options = []) {
      const wrapper = document.createElement("div");
      wrapper.className = "field";

      const label = document.createElement("label");
      label.htmlFor = id;
      label.textContent = labelText;

      const input = document.createElement("input");
      input.id = id;
      input.placeholder = placeholder;

      if (options && options.length) {
        const datalistId = id + "_list";
        input.setAttribute("list", datalistId);

        let datalist = document.getElementById(datalistId);
        if (!datalist) {
          datalist = document.createElement("datalist");
          datalist.id = datalistId;
          document.body.appendChild(datalist);
        }
        datalist.innerHTML = "";
        options.forEach((opt) => {
          const o = document.createElement("option");
          o.value = opt;
          datalist.appendChild(o);
        });
      }

      wrapper.appendChild(label);
      wrapper.appendChild(input);
      return wrapper;
    }

    function todayISO() {
      return new Date().toISOString().slice(0, 10);
    }

    function formatDateToRu(value) {
      if (!value) return "";
      const parts = value.split("-");
      if (parts.length === 3) {
        const [y, m, d] = parts;
        return `${d}.${m}.${y}`;
      }
      return value;
    }

    function getRuDate(id) {
      const el = document.getElementById(id);
      if (!el) return "";
      return formatDateToRu(el.value);
    }

    // ---------- VIN autocomplete ----------
    function setupVinAutocomplete() {
      const input = document.getElementById("vinInput");
      const listId = "vinInput_list";
      let datalist = document.getElementById(listId);

      if (!input || !vins.length) return;

      if (!datalist) {
        datalist = document.createElement("datalist");
        datalist.id = listId;
        document.body.appendChild(datalist);
      }

      function fillOptions(filter) {
        datalist.innerHTML = "";
        let arr = vins;
        if (filter) {
          const f = filter.toLowerCase();
          arr = vins.filter(v => v.toLowerCase().endsWith(f) || v.toLowerCase().includes(f));
        }
        arr.slice(0, 120).forEach(v => {
          const o = document.createElement("option");
          o.value = v;
          datalist.appendChild(o);
        });
      }

      input.setAttribute("list", listId);
      fillOptions("");

      input.addEventListener("input", () => {
        const text = input.value.trim();
        if (text.length >= 2) fillOptions(text);
        else fillOptions("");
      });
    }

    // ---------- Boss Buy calc ----------
    function setupBossBuyCalc() {
      const amountEl = document.getElementById("amountCurrencyInput");
      const rateEl = document.getElementById("rateInput");
      const rubEl = document.getElementById("amountRubInput");
      if (!amountEl || !rateEl || !rubEl) return;

      function parseNum(v) {
        if (!v) return 0;
        return parseFloat(String(v).replace(",", ".").replace(/\s/g, ""));
      }

      function recalc() {
        const a = parseNum(amountEl.value);
        const r = parseNum(rateEl.value);
        if (a && r) rubEl.value = Math.round(a * r).toString();
        else rubEl.value = "";
      }

      amountEl.addEventListener("input", recalc);
      rateEl.addEventListener("input", recalc);
    }

    // ---------- MULTI OWNER (Сток) ----------
    function createMultiOwnerInput(options = []) {
      const wrapper = document.createElement("div");
      wrapper.className = "field";

      const label = document.createElement("label");
      label.textContent = "Собственники (можно несколько)";
      wrapper.appendChild(label);

      const hint = document.createElement("div");
      hint.style.fontSize = "12px";
      hint.style.color = "#94a3b8";
      hint.textContent = "Каждый собственник — отдельной строкой. В таблицу уйдёт в одну ячейку «в столбик».";
      wrapper.appendChild(hint);

      const container = document.createElement("div");
      container.id = "ownersContainer";
      wrapper.appendChild(container);

      const datalistId = "owners_list";
      let datalist = document.getElementById(datalistId);
      if (!datalist) {
        datalist = document.createElement("datalist");
        datalist.id = datalistId;
        document.body.appendChild(datalist);
      }
      datalist.innerHTML = "";
      options.forEach((opt) => {
        const o = document.createElement("option");
        o.value = opt;
        datalist.appendChild(o);
      });

      function addOwnerRow(value = "") {
        const row = document.createElement("div");
        row.className = "owner-row";

        const input = document.createElement("input");
        input.placeholder = "Начните вводить собственника";
        input.classList.add("owner-item");
        input.setAttribute("list", datalistId);
        if (value) input.value = value;

        const del = document.createElement("button");
        del.type = "button";
        del.className = "mini-btn";
        del.textContent = "✖";
        del.title = "Удалить";
        del.addEventListener("click", () => {
          row.remove();
          const still = container.querySelectorAll(".owner-item");
          if (!still.length) addOwnerRow("");
        });

        row.appendChild(input);
        row.appendChild(del);
        container.appendChild(row);
      }

      addOwnerRow("");

      const addBtn = document.createElement("button");
      addBtn.type = "button";
      addBtn.className = "mini-btn";
      addBtn.textContent = "➕ Добавить собственника";
      addBtn.style.marginTop = "8px";
      addBtn.addEventListener("click", () => addOwnerRow(""));
      wrapper.appendChild(addBtn);

      return wrapper;
    }

    function collectOwners() {
      const items = Array.from(document.querySelectorAll(".owner-item"))
        .map(el => (el.value || "").trim())
        .filter(Boolean);
      return [...new Set(items)];
    }

    // ---------- dist meta decode ----------
    function decodeDistMeta(b64) {
      if (!b64) return {};
      try {
        let s = b64.replace(/-/g, "+").replace(/_/g, "/");
        while (s.length % 4) s += "=";
        const bytes = Uint8Array.from(atob(s), c => c.charCodeAt(0));
        const jsonStr = new TextDecoder("utf-8").decode(bytes);
        return JSON.parse(jsonStr);
      } catch (e) {
        console.log("dist decode error", e);
        return {};
      }
    }

    const distMeta = decodeDistMeta(distParam);

    // ---------- DISTRIBUTION UI ----------
    function parseNum(v) {
      if (!v) return 0;
      return parseFloat(String(v).replace(",", ".").replace(/\s/g, "")) || 0;
    }

    function formatInt(n) {
      if (!isFinite(n)) return "";
      return Math.round(n).toString();
    }

    function findVinFromInput(raw) {
      const v = (raw || "").trim();
      if (!v) return "";
      if (vins.includes(v)) return v;

      // если ввели последние 4 (или меньше/больше) — попробуем найти точное совпадение по endsWith
      const low = v.toLowerCase();
      const matches = vins.filter(x => x.toLowerCase().endsWith(low));
      if (matches.length === 1) return matches[0];
      return "";
    }

    function buildAllocRows(owners, totalCost) {
      const container = document.getElementById("allocContainer");
      const warn = document.getElementById("allocWarn");
      const ok = document.getElementById("allocOk");
      container.innerHTML = "";

      if (!owners || !owners.length) {
        warn.style.display = "block";
        warn.textContent = "Не нашли собственников по этому VIN (проверь лист «Сток»).";
        ok.style.display = "none";
        return;
      }

      warn.style.display = "none";
      ok.style.display = "none";

      owners.forEach((name, idx) => {
        const row = document.createElement("div");
        row.className = "alloc-row";

        const left = document.createElement("div");
        left.className = "alloc-name";
        left.textContent = name;

        const inp = document.createElement("input");
        inp.type = "text";
        inp.className = "alloc-amount";
        inp.setAttribute("data-owner", name);

        // последний — автоостаток
        if (owners.length === 1) {
          inp.value = formatInt(totalCost);
          inp.readOnly = true;
          inp.classList.add("readonly");
        } else if (idx === owners.length - 1) {
          inp.readOnly = true;
          inp.classList.add("readonly");
          inp.value = "";
        }

        row.appendChild(left);
        row.appendChild(inp);
        container.appendChild(row);
      });

      function recalc() {
        const inputs = Array.from(document.querySelectorAll(".alloc-amount"));
        const total = parseNum(document.getElementById("totalCostInput").value);

        if (!total || total <= 0) {
          warn.style.display = "block";
          warn.textContent = "Полная себестоимость = 0. Сначала внеси «Закупка» и/или «Расходы на авто РФ» по VIN.";
          ok.style.display = "none";
          return;
        }

        if (inputs.length === 1) {
          inputs[0].value = formatInt(total);
          warn.style.display = "none";
          ok.style.display = "block";
          ok.textContent = "Один собственник — сумма выставлена автоматически.";
          return;
        }

        const last = inputs[inputs.length - 1];
        let sum = 0;
        for (let i = 0; i < inputs.length - 1; i++) {
          sum += parseNum(inputs[i].value);
        }
        const rest = total - sum;

        if (rest < 0) {
          last.value = "0";
          warn.style.display = "block";
          warn.textContent = "Сумма больше себестоимости. Уменьши значения.";
          ok.style.display = "none";
        } else {
          last.value = formatInt(rest);
          warn.style.display = "none";
          ok.style.display = "block";
          ok.textContent = "Остаток автоматически добавлен последнему собственнику.";
        }
      }

      // подписываемся на изменения кроме последнего
      const inputs = Array.from(document.querySelectorAll(".alloc-amount"));
      inputs.forEach((inp, idx) => {
        if (idx === inputs.length - 1) return;
        inp.addEventListener("input", recalc);
      });

      recalc();
    }

    function updateDistributionByVin() {
      const vinRaw = document.getElementById("vinInput").value;
      const vin = findVinFromInput(vinRaw);
      const brandEl = document.getElementById("distBrandModel");
      const ownersEl = document.getElementById("distOwners");
      const totalEl = document.getElementById("totalCostInput");

      if (!vin) {
        brandEl.value = "";
        ownersEl.value = "";
        totalEl.value = "";
        document.getElementById("allocContainer").innerHTML = "";
        document.getElementById("allocWarn").style.display = "none";
        document.getElementById("allocOk").style.display = "none";
        return;
      }

      // если нашли 1 VIN по последним 4 — подставим полный VIN в поле
      if (vinRaw !== vin) document.getElementById("vinInput").value = vin;

      const meta = distMeta[vin] || null;
      if (!meta) {
        brandEl.value = "";
        ownersEl.value = "";
        totalEl.value = "";
        document.getElementById("allocWarn").style.display = "block";
        document.getElementById("allocWarn").textContent = "Не нашли meta по VIN. Проверь, что форма открыта из бота (кнопка «Распределение»).";
        return;
      }

      const owners = meta.owners || [];
      const brand = meta.brand_model || "";
      const total = meta.total_cost || 0;

      brandEl.value = brand;
      ownersEl.value = owners.join("\n");
      totalEl.value = formatInt(total);

      buildAllocRows(owners, total);
    }

    // ---------- RENDER FORMS ----------
    function renderForm() {
      formCard.innerHTML = "";

      if (formType === "mgr_stock") {
        formCard.appendChild(
          createSelect("dealTypeInput", "Тип сделки", ["Склад", "Поставка"], "Выберите тип сделки")
        );

        // ✅ мульти-собственники только в Стоке
        formCard.appendChild(createMultiOwnerInput(investors));

        formCard.appendChild(
          createAutocompleteInput("brandModelInput", "Марка / Модель", "Начните вводить марку или модель", brands)
        );

        formCard.appendChild(
          createInput("vinInput", "VIN (введите последние 4 символа, чтобы увидеть варианты)", "Последние 4 символа или полный VIN")
        );
        formCard.appendChild(createInput("configInput", "Комплектация", "Например, Comfort"));
        formCard.appendChild(createInput("bodyColorInput", "Цвет кузова", "Черный"));
        formCard.appendChild(createInput("salonColorInput", "Цвет салона", "Черный"));
        formCard.appendChild(createInput("priceInput", "Цена, ₽", "1500000"));
        formCard.appendChild(createInput("stockDateInput", "Дата", "", false, todayISO(), "date"));

        formCard.appendChild(
          createSelect("payTypeInput", "Тип оплаты", ["Нал", "Безнал", "НДС"], "Выберите тип оплаты")
        );
        formCard.appendChild(createInput("clientInput", "Клиент (Имя + телефон)", "Иван Иванов, +7..."));

      }

      // ✅ ПРОДАЖИ: собственник убран (как просил)
      else if (formType === "sale_nds_broker") {
        formCard.appendChild(createInput("managerInput", "Менеджер", "Имя менеджера"));
        formCard.appendChild(createInput("saleDateInput", "Дата продажи", "", false, todayISO(), "date"));
        formCard.appendChild(createAutocompleteInput("brandModelInput", "Марка / Модель", "", brands));
        formCard.appendChild(createInput("vinInput", "VIN (введите последние 4 символа, чтобы увидеть варианты)", "Последние 4 символа или полный VIN"));
        formCard.appendChild(createAutocompleteInput("leadSourceInput", "Источник", "Например, Авито", sources));
        formCard.appendChild(createInput("priceNdsInput", "Цена с НДС", ""));
        formCard.appendChild(createInput("markupNdsInput", "Наценка НДС (% / руб)", ""));
        formCard.appendChild(createInput("contractPriceInput", "Цена в договоре (с учётом комиссии брокера)", ""));
        formCard.appendChild(createInput("brokerPriceInput", "Цена без комиссии брокера", ""));
        formCard.appendChild(createInput("brokerExpenseInput", "Расход брокера (машина + НДС, кому, сумма)", ""));
        formCard.appendChild(createInput("buyerInput", "Покупатель", ""));
      }

      else if (formType === "sale_nds_no_broker") {
        formCard.appendChild(createInput("managerInput", "Менеджер", ""));
        formCard.appendChild(createInput("saleDateInput", "Дата продажи", "", false, todayISO(), "date"));
        formCard.appendChild(createAutocompleteInput("brandModelInput", "Марка / Модель", "", brands));
        formCard.appendChild(createInput("vinInput", "VIN (введите последние 4 символа, чтобы увидеть варианты)", "Последние 4 символа или полный VIN"));
        formCard.appendChild(createAutocompleteInput("leadSourceInput", "Источник", "Например, Авито", sources));
        formCard.appendChild(createInput("priceNdsInput", "Цена с НДС", ""));
        formCard.appendChild(createInput("priceCashInput", "Цена за наличные", ""));
        formCard.appendChild(createInput("markupNdsInput", "Наценка НДС (% / руб)", ""));
        formCard.appendChild(createInput("buyerInput", "Покупатель", ""));
      }

      else if (formType === "sale_cash") {
        formCard.appendChild(createInput("managerInput", "Менеджер", ""));
        formCard.appendChild(createInput("saleDateInput", "Дата продажи", "", false, todayISO(), "date"));
        formCard.appendChild(createAutocompleteInput("brandModelInput", "Марка / Модель", "", brands));
        formCard.appendChild(createInput("vinInput", "VIN (введите последние 4 символа, чтобы увидеть варианты)", "Последние 4 символа или полный VIN"));
        formCard.appendChild(createAutocompleteInput("leadSourceInput", "Источник", "Например, Авито", sources));
        formCard.appendChild(createInput("priceInput", "Цена продажи", ""));
        formCard.appendChild(createInput("receiverInput", "Кому передали средства", ""));
        formCard.appendChild(createInput("buyerInput", "Покупатель", ""));
      }

      else if (formType === "sale_cash_broker") {
        formCard.appendChild(createInput("managerInput", "Менеджер", ""));
        formCard.appendChild(createInput("saleDateInput", "Дата продажи", "", false, todayISO(), "date"));
        formCard.appendChild(createAutocompleteInput("brandModelInput", "Марка / Модель", "", brands));
        formCard.appendChild(createInput("vinInput", "VIN (введите последние 4 символа, чтобы увидеть варианты)", "Последние 4 символа или полный VIN"));
        formCard.appendChild(createAutocompleteInput("leadSourceInput", "Источник", "Например, Авито", sources));
        formCard.appendChild(createInput("priceInput", "Цена продажи", ""));
        formCard.appendChild(createInput("priceNoCommInput", "Цена без комиссии", ""));
        formCard.appendChild(createInput("managerFeeInput", "Комиссия менеджера", ""));
        formCard.appendChild(createInput("receiverInput", "Кому передали средства", ""));
        formCard.appendChild(createInput("buyerInput", "Покупатель", ""));
      }

      else if (formType === "sale_deposit") {
        formCard.appendChild(createInput("managerInput", "Менеджер", ""));
        formCard.appendChild(createInput("saleDateInput", "Дата", "", false, todayISO(), "date"));
        formCard.appendChild(createAutocompleteInput("brandModelInput", "Марка / Модель", "", brands));
        formCard.appendChild(createInput("vinInput", "VIN (введите последние 4 символа, чтобы увидеть варианты)", "Последние 4 символа или полный VIN"));
        formCard.appendChild(createAutocompleteInput("leadSourceInput", "Источник", "Например, Авито", sources));
        formCard.appendChild(createInput("depositSumInput", "Сумма задатка", ""));
        formCard.appendChild(createInput("receiverInput", "Кому передана сумма", ""));
        formCard.appendChild(createInput("priceInput", "Цена продажи", ""));
        formCard.appendChild(createInput("buyerInput", "Покупатель", ""));
      }

      else if (formType === "sale_extra") {
        formCard.appendChild(createInput("managerInput", "Менеджер", ""));
        formCard.appendChild(createInput("saleDateInput", "Дата", "", false, todayISO(), "date"));
        formCard.appendChild(createAutocompleteInput("brandModelInput", "Марка / Модель", "", brands));
        formCard.appendChild(createInput("vinInput", "VIN (введите последние 4 символа, чтобы увидеть варианты)", "Последние 4 символа или полный VIN"));
        formCard.appendChild(createAutocompleteInput("leadSourceInput", "Источник", "Например, Авито", sources));
        formCard.appendChild(createTextarea("extraDescInput", "Доп. услуги (описание)", ""));
        formCard.appendChild(createInput("priceInput", "Цена продажи", ""));
        formCard.appendChild(createInput("receiverInput", "Кому передали средства", ""));
        formCard.appendChild(createInput("purchaserInput", "Кто выдал средства на закупку", ""));
        formCard.appendChild(createInput("buyPriceInput", "Цена покупки", ""));
        formCard.appendChild(createInput("profitInput", "Доход", ""));
      }

      else if (formType === "fin_auto_template") {
        formCard.appendChild(createInput("vinInput", "VIN (введите последние 4 символа, чтобы увидеть варианты)", "Последние 4 символа или полный VIN"));
        formCard.appendChild(createAutocompleteInput("brandModelInput", "Марка / Модель", "", brands));
        formCard.appendChild(createInput("faDateInput", "Дата", "", false, todayISO(), "date"));
        formCard.appendChild(createInput("evacuatorInput", "Эвакуатор", ""));
        formCard.appendChild(createInput("labInput", "Лаборатория", ""));
        formCard.appendChild(createInput("utilWriteoffInput", "Списания утильсбора", ""));
        formCard.appendChild(createInput("utilInput", "Утильсбор", ""));
        formCard.appendChild(createInput("preSaleInput", "Предпродажная подготовка", ""));
        formCard.appendChild(createInput("marketingInput", "Маркетинг", ""));
        formCard.appendChild(createInput("otherInput", "Прочие расходы", ""));
        formCard.appendChild(createTextarea("commentInput", "Комментарий", ""));
      }

      else if (formType === "fin_oper") {
        formCard.appendChild(createInput("categoryInput", "Категория", "Например, Аренда", false, categoryFromUrl || ""));
        formCard.appendChild(createInput("opDateInput", "Дата", "", false, todayISO(), "date"));
        formCard.appendChild(createInput("amountInput", "Сумма, ₽", ""));
        formCard.appendChild(createTextarea("commentInput", "Комментарий", ""));
      }

      else if (formType === "boss_buy") {
        formCard.appendChild(createInput("vinInput", "VIN (введите последние 4 символа, чтобы увидеть варианты)", "Последние 4 символа или полный VIN"));
        formCard.appendChild(createAutocompleteInput("brandModelInput", "Марка / Модель", "", brands));
        formCard.appendChild(createAutocompleteInput("currencyInput", "Валюта", "Например, юань", currencies));
        formCard.appendChild(createInput("amountCurrencyInput", "Сумма в валюте", ""));
        formCard.appendChild(createInput("rateInput", "Курс к рублю", ""));
        formCard.appendChild(createInput("amountRubInput", "Сумма в рублях (авто)", "", true));
        formCard.appendChild(createInput("opDateInput", "Дата", "", false, todayISO(), "date"));
      }

      // ✅ НОВОЕ: boss_distribution
      else if (formType === "boss_distribution") {
        formCard.appendChild(createInput("vinInput", "VIN (можно последние 4 символа)", "Например: 4837 или полный VIN"));
        formCard.appendChild(createInput("distBrandModel", "Марка / Модель (из данных)", "", true));
        formCard.appendChild(createTextarea("distOwners", "Собственники (из «Сток»)", "", true));
        formCard.appendChild(createInput("totalCostInput", "Полная себестоимость (Закупка + Расходы РФ)", "", true));
        formCard.appendChild(createInput("distDateInput", "Дата распределения", "", false, todayISO(), "date"));

        const hint = document.createElement("div");
        hint.className = "alloc-hint";
        hint.textContent =
          "Введи сумму для одного/нескольких собственников. " +
          "Последний собственник получит остаток автоматически. " +
          "Прибыль: 50% фирме / 50% собственникам — доли собственников считаются от их вклада в себестоимость.";
        formCard.appendChild(hint);

        const allocTitle = document.createElement("div");
        allocTitle.style.marginTop = "10px";
        allocTitle.style.fontSize = "13px";
        allocTitle.style.color = "#9ca3af";
        allocTitle.textContent = "Распределение себестоимости по собственникам:";
        formCard.appendChild(allocTitle);

        const allocContainer = document.createElement("div");
        allocContainer.id = "allocContainer";
        formCard.appendChild(allocContainer);

        const warn = document.createElement("div");
        warn.id = "allocWarn";
        warn.className = "warn";
        formCard.appendChild(warn);

        const ok = document.createElement("div");
        ok.id = "allocOk";
        ok.className = "ok";
        formCard.appendChild(ok);

        formCard.appendChild(createTextarea("distComment", "Комментарий", "По желанию"));

      }

      else if (formType === "boss_invest_in" || formType === "boss_invest_out") {
        formCard.appendChild(createAutocompleteInput("investorInput", "Инвестор", "Начните вводить инвестора", investors));
        formCard.appendChild(createInput("sumInput", "Сумма", ""));
        formCard.appendChild(createInput("opDateInput", "Дата", "", false, todayISO(), "date"));
        formCard.appendChild(createTextarea("commentInput", "Комментарий", ""));
      }

      else {
        formCard.appendChild(createTextarea("rawInput", "Данные", "Форма не настроена, введите данные в свободной форме."));
      }

      setupVinAutocomplete();

      if (formType === "boss_buy") setupBossBuyCalc();

      if (formType === "boss_distribution") {
        // при изменении VIN — подтягиваем owners + cost
        document.getElementById("vinInput").addEventListener("input", updateDistributionByVin);
      }

      submitBtn.disabled = false;
    }

    renderForm();

    // ---------- COLLECT DATA ----------
    function getBrandModel() {
      const el = document.getElementById("brandModelInput");
      return el ? (el.value || "") : "";
    }

    function collectFormData() {
      const payload = { formType };

      if (formType === "mgr_stock") {
        payload.deal_type = document.getElementById("dealTypeInput").value;

        const ownersArr = collectOwners();
        payload.owners = ownersArr;               // массив
        payload.owner  = ownersArr.join("\n");    // ✅ в одну ячейку "в столбик"

        payload.brand_model   = getBrandModel();
        payload.vin           = document.getElementById("vinInput").value;
        payload.complectation = document.getElementById("configInput").value;
        payload.body_color    = document.getElementById("bodyColorInput").value;
        payload.salon_color   = document.getElementById("salonColorInput").value;
        payload.price         = document.getElementById("priceInput").value;
        payload.stock_date    = getRuDate("stockDateInput");
        payload.payment_type  = document.getElementById("payTypeInput").value;
        payload.client        = document.getElementById("clientInput").value;
      }

      else if (formType === "sale_nds_broker") {
        payload.manager        = document.getElementById("managerInput").value;
        payload.sale_date      = getRuDate("saleDateInput");
        payload.brand_model    = getBrandModel();
        payload.vin            = document.getElementById("vinInput").value;
        payload.source         = document.getElementById("leadSourceInput").value;
        payload.price_nds      = document.getElementById("priceNdsInput").value;
        payload.markup_nds     = document.getElementById("markupNdsInput").value;
        payload.contract_price = document.getElementById("contractPriceInput").value;
        payload.broker_price   = document.getElementById("brokerPriceInput").value;
        payload.broker_expense = document.getElementById("brokerExpenseInput").value;
        payload.buyer          = document.getElementById("buyerInput").value;
      }

      else if (formType === "sale_nds_no_broker") {
        payload.manager     = document.getElementById("managerInput").value;
        payload.sale_date   = getRuDate("saleDateInput");
        payload.brand_model = getBrandModel();
        payload.vin         = document.getElementById("vinInput").value;
        payload.source      = document.getElementById("leadSourceInput").value;
        payload.price_nds   = document.getElementById("priceNdsInput").value;
        payload.price_cash  = document.getElementById("priceCashInput").value;
        payload.markup_nds  = document.getElementById("markupNdsInput").value;
        payload.buyer       = document.getElementById("buyerInput").value;
      }

      else if (formType === "sale_cash") {
        payload.manager     = document.getElementById("managerInput").value;
        payload.sale_date   = getRuDate("saleDateInput");
        payload.brand_model = getBrandModel();
        payload.vin         = document.getElementById("vinInput").value;
        payload.source      = document.getElementById("leadSourceInput").value;
        payload.price       = document.getElementById("priceInput").value;
        payload.receiver    = document.getElementById("receiverInput").value;
        payload.buyer       = document.getElementById("buyerInput").value;
      }

      else if (formType === "sale_cash_broker") {
        payload.manager             = document.getElementById("managerInput").value;
        payload.sale_date           = getRuDate("saleDateInput");
        payload.brand_model         = getBrandModel();
        payload.vin                 = document.getElementById("vinInput").value;
        payload.source              = document.getElementById("leadSourceInput").value;
        payload.price               = document.getElementById("priceInput").value;
        payload.price_no_commission = document.getElementById("priceNoCommInput").value;
        payload.manager_fee         = document.getElementById("managerFeeInput").value;
        payload.receiver            = document.getElementById("receiverInput").value;
        payload.buyer               = document.getElementById("buyerInput").value;
      }

      else if (formType === "sale_deposit") {
        payload.manager     = document.getElementById("managerInput").value;
        payload.sale_date   = getRuDate("saleDateInput");
        payload.brand_model = getBrandModel();
        payload.vin         = document.getElementById("vinInput").value;
        payload.source      = document.getElementById("leadSourceInput").value;
        payload.deposit_sum = document.getElementById("depositSumInput").value;
        payload.receiver    = document.getElementById("receiverInput").value;
        payload.price       = document.getElementById("priceInput").value;
        payload.buyer       = document.getElementById("buyerInput").value;
      }

      else if (formType === "sale_extra") {
        payload.manager     = document.getElementById("managerInput").value;
        payload.sale_date   = getRuDate("saleDateInput");
        payload.brand_model = getBrandModel();
        payload.vin         = document.getElementById("vinInput").value;
        payload.source      = document.getElementById("leadSourceInput").value;
        payload.extra_desc  = document.getElementById("extraDescInput").value;
        payload.price       = document.getElementById("priceInput").value;
        payload.receiver    = document.getElementById("receiverInput").value;
        payload.purchaser   = document.getElementById("purchaserInput").value;
        payload.buy_price   = document.getElementById("buyPriceInput").value;
        payload.profit      = document.getElementById("profitInput").value;
      }

      else if (formType === "fin_auto_template") {
        payload.vin         = document.getElementById("vinInput").value;
        payload.brand_model = getBrandModel();
        payload.op_date     = getRuDate("faDateInput"); // ✅ faDateInput -> op_date
        payload.evacuator   = document.getElementById("evacuatorInput").value;
        payload.lab         = document.getElementById("labInput").value;
        payload.util_writeoff = document.getElementById("utilWriteoffInput").value;
        payload.util        = document.getElementById("utilInput").value;
        payload.pre_sale    = document.getElementById("preSaleInput").value;
        payload.marketing   = document.getElementById("marketingInput").value;
        payload.other       = document.getElementById("otherInput").value;
        payload.comment     = document.getElementById("commentInput").value;
      }

      else if (formType === "fin_oper") {
        payload.category = document.getElementById("categoryInput").value;
        payload.op_date  = getRuDate("opDateInput");
        payload.amount   = document.getElementById("amountInput").value;
        payload.comment  = document.getElementById("commentInput").value;
      }

      else if (formType === "boss_buy") {
        payload.vin             = document.getElementById("vinInput").value;
        payload.brand_model     = getBrandModel();
        payload.currency        = document.getElementById("currencyInput").value;
        payload.amount_currency = document.getElementById("amountCurrencyInput").value;
        payload.rate_to_rub     = document.getElementById("rateInput").value;
        payload.amount_rub      = document.getElementById("amountRubInput").value;
        payload.op_date         = getRuDate("opDateInput");
      }

      else if (formType === "boss_distribution") {
        const vinFull = findVinFromInput(document.getElementById("vinInput").value);
        const meta = vinFull ? (distMeta[vinFull] || null) : null;

        payload.vin = vinFull || document.getElementById("vinInput").value;
        payload.brand_model = document.getElementById("distBrandModel").value;
        payload.owners = meta && meta.owners ? meta.owners : (document.getElementById("distOwners").value || "").split("\n").filter(Boolean);
        payload.owner  = payload.owners.join("\n");

        payload.total_cost = document.getElementById("totalCostInput").value;
        payload.op_date = getRuDate("distDateInput");
        payload.company_profit_pct = "50";
        payload.investors_profit_pct = "50";
        payload.comment = document.getElementById("distComment").value;

        const total = parseNum(payload.total_cost);
        const rows = Array.from(document.querySelectorAll(".alloc-amount"));

        const alloc = rows.map(inp => {
          const owner = inp.getAttribute("data-owner") || "";
          const amount = (inp.value || "").trim();
          const a = parseNum(amount);
          const share = total > 0 ? Math.round((a / total) * 10000) / 100 : 0; // 2 знака
          return { owner, amount, share_percent: share };
        }).filter(x => x.owner);

        payload.allocations = alloc;
      }

      else if (formType === "boss_invest_in" || formType === "boss_invest_out") {
        payload.investor = document.getElementById("investorInput").value;
        payload.sum      = document.getElementById("sumInput").value;
        payload.op_date  = getRuDate("opDateInput");
        payload.comment  = document.getElementById("commentInput").value;
      }

      else {
        payload.raw = document.getElementById("rawInput").value;
      }

      return payload;
    }

    // ---------- TELEGRAM INTEGRATION ----------
    function setupTelegramIntegration() {
      submitBtn.addEventListener("click", () => {
        const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
        if (!tg) {
          alert("Открой форму через Telegram-бота (кнопка в чате).");
          return;
        }

        const payload = collectFormData();

        submitBtn.disabled = true;
        submitBtn.textContent = "Отправка...";

        try {
          tg.sendData(JSON.stringify(payload));
          setTimeout(() => { try { tg.close(); } catch(e) {} }, 400);
        } catch (e) {
          alert("Не удалось отправить данные. Попробуйте ещё раз.");
          submitBtn.disabled = false;
          submitBtn.textContent = "Отправить в бота";
        }
      });
    }

    setupTelegramIntegration();
  </script>
</body>
</html>
