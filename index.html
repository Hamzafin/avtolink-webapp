<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Автолинк WebApp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    *,*::before,*::after{box-sizing:border-box;}
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: #0f172a;
      color: #e5e7eb;
      min-height: var(--app-height, var(--tg-viewport-height, 100vh));
      padding-bottom: calc(16px + env(safe-area-inset-bottom));
      overscroll-behavior: contain;
    }
    h1 { font-size: 20px; margin: 0 0 4px; text-align: center; }
    .subtitle { font-size: 13px; text-align: center; color: #94a3b8; margin-bottom: 16px; line-height: 1.35; }
    .card {
      background: #111827;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.5);
      max-width: 560px;
      margin: 0 auto;
    }
    .field { margin-bottom: 12px; display: flex; flex-direction: column; gap: 4px; }
    label { font-size: 13px; color: #9ca3af; }
    input, select, textarea {
      border-radius: 10px;
      border: 1px solid #374151;
      padding: 8px 10px;
      font-size: 14px;
      background: #020617;
      color: #e5e7eb;
      outline: none;
    }
    input:focus, select:focus, textarea:focus { border-color: #38bdf8; }
    textarea { min-height: 90px; resize: vertical; }
    .readonly { background: #020617; color: #9ca3af; }
    .hint { font-size: 12px; color: #94a3b8; line-height: 1.35; margin-top: 4px; }
    .pill { display: inline-block; padding: 6px 10px; border-radius: 999px; background: #0b1226; border: 1px solid #334155; color: #cbd5e1; font-size: 12px; }
    .divider { height: 1px; background: #1f2937; margin: 14px 0; }
    .hidden { display:none; }
    .toggle-row{display:flex;align-items:center;gap:10px;font-size:13px;color:#cbd5e1;}
    .toggle-row input{width:18px;height:18px;}
    .toggle-row small{color:#94a3b8;line-height:1.25;}
    button#submitBtn {
      width: 100%;
      border-radius: 999px;
      border: none;
      padding: 10px 14px;
      font-size: 15px;
      font-weight: 600;
      background: linear-gradient(135deg, #38bdf8, #6366f1);
      color: white;
      cursor: pointer;
      margin-top: 12px;
    }
    button#submitBtn:disabled { opacity: .5; cursor: default; }
    .mini-btn {
      border: 1px solid #374151;
      background: #0b1220;
      color: #e5e7eb;
      border-radius: 10px;
      padding: 8px 10px;
      cursor: pointer;
      white-space: nowrap;
    }
    .mini-btn:active { transform: translateY(1px); }
  </style>
</head>

<body>
  <h1>Автолинк</h1>
  <div class="subtitle" id="subtitle"></div>
  <div class="card" id="formCard"></div>
  <button id="submitBtn" disabled>Отправить в бота</button>

<script>
  // ---------- Telegram ----------
  const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
  const urlParams = new URLSearchParams(window.location.search);
  const formType = urlParams.get("type") || "unknown";
  const APP_VERSION = urlParams.get("v") || "5";

  // ---------- Service Worker ----------
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js?v=" + encodeURIComponent(APP_VERSION)).catch(() => {});
    });
  }

  try {
    if (tg) { tg.ready(); tg.expand(); }
  } catch (e) {}

  if (tg) {
    const setH = () => {
      document.documentElement.style.setProperty('--app-height', (tg.viewportHeight || window.innerHeight) + 'px');
    };
    setH();
    tg.onEvent('viewportChanged', setH);
  }

  function tgAlert(text) {
    try {
      if (tg && typeof tg.showAlert === "function") tg.showAlert(String(text));
      else alert(String(text));
    } catch(e) { alert(String(text)); }
  }

  // ---------- URL lists ----------
  const categoryFromUrl = urlParams.get("category") || "";

  // (эти списки могут приходить из URL, но для VIN мы не зависим от них)
  const brandsParam = urlParams.get("brands") || "";
  const investorsParam = urlParams.get("investors") || "";
  const sourcesParam = urlParams.get("sources") || "";
  const bossVinsParam = urlParams.get("bossvins") || "";
  const vinsParam = urlParams.get("vins") || "";
  const currenciesParam = urlParams.get("currencies") || "";

  const brands = brandsParam ? brandsParam.split("|") : [];
  const investors = investorsParam ? investorsParam.split("|") : [];
  const sources = sourcesParam ? sourcesParam.split("|") : [];
  const bossVins = bossVinsParam ? bossVinsParam.split("|") : [];
  const vins = vinsParam ? vinsParam.split("|") : [];
  const currencies = currenciesParam ? currenciesParam.split("|") : [];

  const subtitleEl = document.getElementById("subtitle");
  const formCard = document.getElementById("formCard");
  const submitBtn = document.getElementById("submitBtn");

  const FORM_TITLES = {
    mgr_stock: "Сток",
    sale_main: "Продажа — основная",
    sale_deposit: "Задаток",
    sale_extra: "Доп. услуги",
    sale_nds_broker: "Продажа — НДС с комиссией брокера",
    sale_nds_no_broker: "Продажа — НДС без комиссии брокера",
    sale_cash: "Продажа — Наличные",
    sale_cash_broker: "Продажа — Наличные с комиссией брокера",
    fin_auto_template: "Расходы на авто РФ",
    fin_oper: "Оперрасходы",
    boss_buy: "Закупка / Оплата по VIN",
    boss_invest_in: "Инвестиции — ввод",
    boss_invest_out: "Инвестиции — вывод",
  };

  function isSaleMainLike(t) {
    return ["sale_main","sale_nds_broker","sale_nds_no_broker","sale_cash","sale_cash_broker"].includes(String(t||""));
  }

  subtitleEl.textContent =
    "Форма: " + (FORM_TITLES[formType] || formType) +
    (categoryFromUrl ? " | Категория: " + categoryFromUrl : "");

  function todayISO() { return new Date().toISOString().slice(0, 10); }
  function formatDateToRu(value) {
    if (!value) return "";
    const parts = value.split("-");
    if (parts.length === 3) {
      const [y, m, d] = parts;
      return `${d}.${m}.${y}`;
    }
    return value;
  }
  function getRuDate(id) {
    const el = document.getElementById(id);
    if (!el) return "";
    return formatDateToRu(el.value);
  }
  function showEl(el, show) {
    if (!el) return;
    el.classList.toggle("hidden", !show);
  }

  // ---------- localStorage helpers ----------
  const LS_KEYS = {
    VINS: "boss_buy_vins",
    SUPPLIERS: "boss_buy_suppliers",
    PLACES: "boss_buy_places",
    BRAND_MODELS: "boss_buy_brand_models",
    SOURCES: "avtolink_sources",
  };

  function lsRead(key) {
    try {
      const v = localStorage.getItem(key);
      const arr = v ? JSON.parse(v) : [];
      return Array.isArray(arr) ? arr.filter(Boolean) : [];
    } catch (e) { return []; }
  }
  function lsWrite(key, arr, maxLen = 200) {
    try {
      const clean = (Array.isArray(arr) ? arr : []).filter(Boolean).slice(0, maxLen);
      localStorage.setItem(key, JSON.stringify(clean));
    } catch (e) {}
  }
  function lsAdd(key, value, maxLen = 200) {
    const v = String(value || "").trim();
    if (!v) return;
    const arr = lsRead(key);
    const lo = v.toLowerCase();
    const filtered = arr.filter(x => String(x).trim().toLowerCase() !== lo);
    filtered.unshift(v);
    lsWrite(key, filtered, maxLen);
  }
  function mergeUnique(...arrays) {
    const out = [];
    const seen = new Set();
    arrays.flat().forEach((x) => {
      const s = String(x || "").trim();
      if (!s) return;
      const k = s.toLowerCase();
      if (seen.has(k)) return;
      seen.add(k);
      out.push(s);
    });
    return out;
  }
  function updateDatalist(dlId, options) {
    const dl = document.getElementById(dlId);
    if (!dl) return;
    dl.innerHTML = "";
    (options || []).slice(0, 500).forEach((opt) => {
      const o = document.createElement("option");
      o.value = opt;
      dl.appendChild(o);
    });
  }
  function normalizeVin(v) { return String(v || "").trim().toUpperCase(); }

  // ---------- Apps Script lookup (2 URL) ----------
  // ✅ Старый URL (закупки / boss_buy) — оставил как было у тебя в коде
  const LOOKUP_API_URL_BOSS =
    "https://script.google.com/macros/s/AKfycbzuBwFkGUiXnJcwUeTSt5jP8Y1BdE8PD0MQO_0SH6hr74O2htidfhD3Oop5zZ80G-GlDw/exec";

  // ✅ Новый URL (СПРАВОЧНИКИ A↔C) — вставил твой
  const LOOKUP_API_URL_REF =
    "https://script.google.com/macros/s/AKfycbx_JDoOiJ_yTGiTyY16aIkNFSOjNelz40UiUbvVCdWq0wbsBpbTC5_0vZNga_ImSJ54MQ/exec";

  const LOOKUP_API_TOKEN = ""; // если вдруг включишь токен

  function getLookupUrl() {
    return (formType === "boss_buy") ? LOOKUP_API_URL_BOSS : LOOKUP_API_URL_REF;
  }
  function canUseLookup() {
    const u = getLookupUrl();
    return typeof u === "string" && u.trim().startsWith("https://");
  }

  function jsonpRequest(baseUrl, params, timeoutMs = 8000) {
    return new Promise((resolve, reject) => {
      const cb = "__cb_" + Math.random().toString(36).slice(2);
      const q = new URLSearchParams(params || {});
      q.set("callback", cb);
      if (LOOKUP_API_TOKEN) q.set("token", LOOKUP_API_TOKEN);

      const src = baseUrl + (baseUrl.includes("?") ? "&" : "?") + q.toString();
      const script = document.createElement("script");
      let done = false;

      function cleanup() {
        if (script && script.parentNode) script.parentNode.removeChild(script);
        try { delete window[cb]; } catch (e) { window[cb] = undefined; }
      }

      const timer = setTimeout(() => {
        if (done) return;
        done = true;
        cleanup();
        reject(new Error("Lookup timeout"));
      }, timeoutMs);

      window[cb] = (data) => {
        if (done) return;
        done = true;
        clearTimeout(timer);
        cleanup();
        resolve(data);
      };

      script.onerror = () => {
        if (done) return;
        done = true;
        clearTimeout(timer);
        cleanup();
        reject(new Error("Lookup request failed"));
      };

      script.src = src;
      document.body.appendChild(script);
    });
  }

  // remote cache (общий)
  const remoteCache = {
    vins: [],
    suppliers: [],
    places: [],
    brand_models: [],
    sources: [],
  };

  async function remoteListsLoad(force = false) {
    if (!canUseLookup()) return;
    try {
      const res = await jsonpRequest(getLookupUrl(), { action: "lists" }, 8000);
      if (res && res.ok && res.lists) {
        const L = res.lists;

        // VIN / models / sources
        remoteCache.vins = Array.isArray(L.vins) ? L.vins : remoteCache.vins;
        remoteCache.brand_models = Array.isArray(L.brand_models) ? L.brand_models : remoteCache.brand_models;
        remoteCache.sources = Array.isArray(L.sources) ? L.sources : remoteCache.sources;

        // boss lists (если отдаёт)
        remoteCache.suppliers = Array.isArray(L.suppliers) ? L.suppliers : remoteCache.suppliers;
        remoteCache.places = Array.isArray(L.places) ? L.places : remoteCache.places;

        // записываем в localStorage, чтобы VIN подсказки всегда были
        if (remoteCache.vins.length) {
          lsWrite(LS_KEYS.VINS, mergeUnique(remoteCache.vins, lsRead(LS_KEYS.VINS)), 1200);
        }
        if (remoteCache.brand_models.length) {
          lsWrite(LS_KEYS.BRAND_MODELS, mergeUnique(remoteCache.brand_models, lsRead(LS_KEYS.BRAND_MODELS)), 1200);
        }
        if (remoteCache.suppliers.length) {
          lsWrite(LS_KEYS.SUPPLIERS, mergeUnique(remoteCache.suppliers, lsRead(LS_KEYS.SUPPLIERS)), 600);
        }
        if (remoteCache.places.length) {
          lsWrite(LS_KEYS.PLACES, mergeUnique(remoteCache.places, lsRead(LS_KEYS.PLACES)), 600);
        }
        if (remoteCache.sources.length) {
          lsWrite(LS_KEYS.SOURCES, mergeUnique(remoteCache.sources, lsRead(LS_KEYS.SOURCES)), 600);
        }

        // если поля уже на странице — обновим подсказки
        updateDatalist("vinInput_list", getAllVins());
        updateDatalist("brandModelInput_list", mergeUnique(brands, remoteCache.brand_models, lsRead(LS_KEYS.BRAND_MODELS)));
        updateDatalist("supplierInput_list", mergeUnique(remoteCache.suppliers, lsRead(LS_KEYS.SUPPLIERS)));
        updateDatalist("placeInput_list", mergeUnique(remoteCache.places, lsRead(LS_KEYS.PLACES)));
        updateDatalist("leadSourceInput_list", mergeUnique(sources, remoteCache.sources, lsRead(LS_KEYS.SOURCES)));
      }
    } catch (e) {
      console.warn("remoteListsLoad failed:", e);
    }
  }

  // TTL: ключ завязан на версию и тип базы — чтобы не залипало “вчера работало / сегодня нет”
  const REMOTE_LISTS_TS_KEY = "avtolink_remote_lists_ts_" + APP_VERSION + "_" + ((formType === "boss_buy") ? "boss" : "ref");
  const REMOTE_LISTS_TTL_MS = 2 * 60 * 60 * 1000; // 2 часа

  function lsReadNum(key, fallback = 0) {
    const v = localStorage.getItem(key);
    const n = parseInt(String(v || ""), 10);
    return Number.isFinite(n) ? n : fallback;
  }
  function lsWriteNum(key, val) {
    try { localStorage.setItem(key, String(val)); } catch (e) {}
  }
  function shouldRefreshRemoteLists() {
    const ts = lsReadNum(REMOTE_LISTS_TS_KEY, 0);
    return (!ts) || ((Date.now() - ts) > REMOTE_LISTS_TTL_MS);
  }
  function scheduleRemoteListsLoad() {
    if (!canUseLookup()) return;
    // если кэш пустой — грузим сразу
    if (!remoteCache.vins.length && !remoteCache.brand_models.length) {
      remoteListsLoad(true).then(() => lsWriteNum(REMOTE_LISTS_TS_KEY, Date.now()));
      return;
    }
    if (!shouldRefreshRemoteLists()) return;
    const runner = async () => {
      await remoteListsLoad(true);
      lsWriteNum(REMOTE_LISTS_TS_KEY, Date.now());
    };
    const idle = window.requestIdleCallback || ((fn) => setTimeout(fn, 250));
    idle(runner);
  }

  // ✅ ВАЖНО: теперь getAllVins включает remoteCache.vins (раньше из-за этого VIN подсказки “пропадали”)
  function getAllVins() {
    return mergeUnique(
      remoteCache.vins || [],
      bossVins || [],
      vins || [],
      lsRead(LS_KEYS.VINS)
    ).map(v => String(v).trim().toUpperCase());
  }

  // ---- lookup by VIN (полный VIN) ----
  async function lookupByVin(vinRaw) {
    if (!canUseLookup()) return null;
    const vin = normalizeVin(vinRaw);
    if (!vin || vin.length < 4) return null;
    try {
      const res = await jsonpRequest(getLookupUrl(), { action: "lookup", vin: vin }, 8000);
      if (res && res.ok && res.found && res.data) return res.data;
    } catch (e) {}
    return null;
  }

  // ---------- UI builders ----------
  function createInput(id, labelText, placeholder = "", value = "", type = "text", readonly = false) {
    const w = document.createElement("div");
    w.className = "field";
    const l = document.createElement("label");
    l.htmlFor = id;
    l.textContent = labelText;
    const i = document.createElement("input");
    i.id = id;
    i.placeholder = placeholder;
    i.type = type;
    if (value) i.value = value;
    if (readonly) { i.readOnly = true; i.classList.add("readonly"); }
    if (id.toLowerCase().includes("vin")) i.maxLength = 17;
    w.appendChild(l);
    w.appendChild(i);
    return w;
  }

  function createTextarea(id, labelText, placeholder = "", readonly = false) {
    const w = document.createElement("div");
    w.className = "field";
    const l = document.createElement("label");
    l.htmlFor = id;
    l.textContent = labelText;
    const t = document.createElement("textarea");
    t.id = id;
    t.placeholder = placeholder;
    if (readonly) { t.readOnly = true; t.classList.add("readonly"); }
    w.appendChild(l);
    w.appendChild(t);
    return w;
  }

  function createSelectKV(id, labelText, options, placeholder = "Выберите...") {
    const w = document.createElement("div");
    w.className = "field";
    const l = document.createElement("label");
    l.htmlFor = id;
    l.textContent = labelText;
    const s = document.createElement("select");
    s.id = id;
    const ph = document.createElement("option");
    ph.value = "";
    ph.textContent = placeholder;
    ph.disabled = true;
    ph.selected = true;
    s.appendChild(ph);
    options.forEach((opt) => {
      const o = document.createElement("option");
      o.value = opt.value;
      o.textContent = opt.label;
      s.appendChild(o);
    });
    w.appendChild(l);
    w.appendChild(s);
    return w;
  }

  function createAutocompleteInput(id, labelText, placeholder = "", options = []) {
    const w = document.createElement("div");
    w.className = "field";
    const l = document.createElement("label");
    l.htmlFor = id;
    l.textContent = labelText;
    const i = document.createElement("input");
    i.id = id;
    i.placeholder = placeholder;
    const dlId = id + "_list";
    i.setAttribute("list", dlId);
    let dl = document.getElementById(dlId);
    if (!dl) {
      dl = document.createElement("datalist");
      dl.id = dlId;
      document.body.appendChild(dl);
    }
    updateDatalist(dlId, options);
    w.appendChild(l);
    w.appendChild(i);
    return w;
  }

  // ✅ VIN smart autocomplete:
  // теперь показывает варианты VIN, где введённая последовательность встречается ВНУТРИ VIN (includes)
  function setupVinAutocompleteSmart(inputId, allVinsSource) {
    const input = document.getElementById(inputId);
    if (!input) return;
    if (input.dataset && input.dataset.vinAuto === "1") return;
    input.dataset.vinAuto = "1";

    const listId = inputId + "_list";
    let dl = document.getElementById(listId);
    if (!dl) {
      dl = document.createElement("datalist");
      dl.id = listId;
      document.body.appendChild(dl);
    }
    input.setAttribute("list", listId);

    function getSource() {
      try {
        const src = (typeof allVinsSource === "function") ? allVinsSource() : allVinsSource;
        return Array.isArray(src) ? src : [];
      } catch (e) { return []; }
    }

    let remoteTimer = null;

    function fill(filter = "") {
      const raw = String(filter || "").trim();
      const f = raw.toLowerCase();

      // ✅ Хотелка: “цифры подряд” — начинаем показывать уже с 1 символа, но ограничиваем 80
      const onlyDigits = /^[0-9]+$/.test(raw);
      if (!raw) return;
      if (!onlyDigits && raw.length < 2) return;

      dl.innerHTML = "";

      const source = getSource();
      const out = [];
      for (let i = 0; i < source.length; i++) {
        const v = normalizeVin(source[i]);
        if (!v) continue;
        const lo = v.toLowerCase();
        // ✅ ВАЖНО: includes — “внутри VIN”
        if (lo.includes(f)) out.push(v);
        if (out.length >= 80) break;
      }

      if (out.length) {
        out.forEach(v => {
          const o = document.createElement("option");
          o.value = v;
          dl.appendChild(o);
        });
        return;
      }

      // если локально пусто — попробуем срочно подгрузить списки (часто решает “сегодня пропало”)
      if (canUseLookup() && (!remoteCache.vins.length)) {
        if (remoteTimer) clearTimeout(remoteTimer);
        remoteTimer = setTimeout(async () => {
          await remoteListsLoad(true);
          updateDatalist(listId, getAllVins().filter(x => normalizeVin(x).toLowerCase().includes(f)).slice(0, 80));
        }, 200);
      }
    }

    input.addEventListener("focus", () => fill(input.value));
    input.addEventListener("input", () => fill(input.value));
  }

  // ---------- Render: boss_buy (оставил как было по логике) ----------
  function setValueIfExists(id, val) {
    const el = document.getElementById(id);
    if (!el) return;
    if (val === null || typeof val === "undefined") return;
    el.value = String(val);
  }

  function prefillBossBuyFields(data) {
    if (!data) return;
    if (data.vin) setValueIfExists("vinInput", data.vin);
    setValueIfExists("purchaseDateInput", data.purchase_date || "");
    setValueIfExists("supplierInput", data.supplier || "");
    setValueIfExists("placeInput", data.purchase_place || "");
    setValueIfExists("brandModelInput", data.brand_model || "");
    setValueIfExists("complectationInput", data.complectation || "");
    if (document.getElementById("currencyInput")) setValueIfExists("currencyInput", data.currency || "");
    setValueIfExists("amountCurrencyInput", data.amount_currency || "");
    setValueIfExists("rateInput", data.rate_to_rub || "");
    if (document.getElementById("amountRubInput")) setValueIfExists("amountRubInput", data.cost_rub || "");
  }

  async function prefillBossBuyByVin(vinRaw) {
    const vin = normalizeVin(vinRaw);
    if (!vin) return;
    const data = await lookupByVin(vin);
    if (data) prefillBossBuyFields(data);
  }

  function renderBossBuy() {
    formCard.innerHTML = "";

    formCard.appendChild(createInput("vinInput", "VIN (можно любые символы подряд)", "Например: 1457 или полный VIN"));

    const modeWrap = document.createElement("div");
    modeWrap.className = "field";
    const modeLabel = document.createElement("label");
    modeLabel.textContent = "Что делаем?";
    const modeSelect = document.createElement("select");
    modeSelect.id = "modeSelect";
    modeSelect.innerHTML = `
      <option value="purchase">Новая закупка (создать VIN)</option>
      <option value="payment">Добавить оплату к VIN</option>
    `;
    const modeBadge = document.createElement("div");
    modeBadge.style.marginTop = "6px";
    modeBadge.innerHTML = `<span class="pill" id="modeBadge">Режим: —</span>`;
    modeWrap.appendChild(modeLabel);
    modeWrap.appendChild(modeSelect);
    modeWrap.appendChild(modeBadge);
    formCard.appendChild(modeWrap);

    const hint = document.createElement("div");
    hint.className = "hint";
    hint.textContent = "Подсказки VIN работают по вхождению. Можно вбивать цифры подряд.";
    formCard.appendChild(hint);

    const divider = document.createElement("div");
    divider.className = "divider";
    formCard.appendChild(divider);

    const purchaseBlock = document.createElement("div");
    purchaseBlock.id = "purchaseBlock";
    purchaseBlock.appendChild(createInput("purchaseDateInput", "Дата закупки", "", todayISO(), "date"));
    purchaseBlock.appendChild(createAutocompleteInput("supplierInput", "Поставщик", "Например, дилер/компания", mergeUnique(remoteCache.suppliers, lsRead(LS_KEYS.SUPPLIERS))));
    purchaseBlock.appendChild(createAutocompleteInput("placeInput", "Место закупки", "Например, Япония / РФ / Китай", mergeUnique(remoteCache.places, lsRead(LS_KEYS.PLACES))));
    purchaseBlock.appendChild(createAutocompleteInput("brandModelInput", "Марка / Модель", "Например, BMW X5", mergeUnique(brands, remoteCache.brand_models, lsRead(LS_KEYS.BRAND_MODELS))));
    purchaseBlock.appendChild(createInput("complectationInput", "Комплектация", "Например, M Sport"));

    purchaseBlock.appendChild(
      createSelectKV("currencyInput", "Валюта ($ / ₽ / ¥)", [
        {value:"$", label:"$ (доллар)"},
        {value:"₽", label:"₽ (рубль)"},
        {value:"¥", label:"¥ (юань)"},
      ], "Выберите валюту")
    );

    purchaseBlock.appendChild(createInput("amountCurrencyInput", "Сумма, валюта", "Например, 100000"));
    purchaseBlock.appendChild(createInput("rateInput", "Курс (на дату первой оплаты)", "Например, 80"));
    purchaseBlock.appendChild(createInput("amountRubInput", "Стоимость авто, ₽ (для контроля)", "Авторасчёт", "", "text", true));
    purchaseBlock.appendChild(createTextarea("commentInput_p", "Комментарий", "По желанию"));

    const paymentBlock = document.createElement("div");
    paymentBlock.id = "paymentBlock";
    paymentBlock.appendChild(createInput("payDateInput", "Дата оплаты", "", todayISO(), "date"));
    paymentBlock.appendChild(
      createSelectKV("payCurrencySelect", "Валюта оплаты", [
        {value:"₽", label:"₽ (рубль)"},
        {value:"$", label:"$ (доллар)"},
        {value:"¥", label:"¥ (юань)"},
      ], "Выберите валюту")
    );
    paymentBlock.appendChild(createInput("payAmountCurrencyInput", "Сумма оплаты (валюта)", "Например, 20000"));
    paymentBlock.appendChild(createInput("payRateInput", "Курс на дату оплаты", "Например, 82"));
    paymentBlock.appendChild(createInput("payRubInput", "Сумма оплаты (₽)", "Авторасчёт", "", "text", false));
    paymentBlock.appendChild(createTextarea("commentInput", "Комментарий", "По желанию"));

    formCard.appendChild(purchaseBlock);
    formCard.appendChild(paymentBlock);

    function setMode(mode) {
      const badge = document.getElementById("modeBadge");
      const mSel = document.getElementById("modeSelect");
      if (mSel.value !== mode) mSel.value = mode;
      badge.textContent = "Режим: " + (mode === "payment" ? "Оплата" : "Новая закупка");
      showEl(purchaseBlock, mode === "purchase");
      showEl(paymentBlock, mode === "payment");
    }

    setMode("purchase");

    setupVinAutocompleteSmart("vinInput", getAllVins);

    const vinEl = document.getElementById("vinInput");
    let tmr = null;
    vinEl.addEventListener("input", () => {
      if (tmr) clearTimeout(tmr);
      tmr = setTimeout(() => prefillBossBuyByVin(vinEl.value), 350);
    });
    vinEl.addEventListener("change", () => prefillBossBuyByVin(vinEl.value));
    vinEl.addEventListener("blur", () => prefillBossBuyByVin(vinEl.value));

    document.getElementById("modeSelect").addEventListener("change", (e) => setMode(e.target.value));

    function parseNum(v) {
      if (!v) return 0;
      const n = parseFloat(String(v).replace(/\s/g, "").replace(",", ".").replace(/[^\d.\-]/g,""));
      return isFinite(n) ? n : 0;
    }
    function recalcPurchaseRub() {
      const cur = document.getElementById("currencyInput")?.value || "";
      const a = parseNum(document.getElementById("amountCurrencyInput")?.value);
      const r = parseNum(document.getElementById("rateInput")?.value);
      const out = document.getElementById("amountRubInput");
      if (!out) return;
      if (!a) { out.value = ""; return; }
      if (cur === "₽") { out.value = Math.round(a).toString(); return; }
      if (a && r) out.value = Math.round(a * r).toString();
      else out.value = "";
    }
    ["currencyInput","amountCurrencyInput","rateInput"].forEach(id => {
      const el = document.getElementById(id);
      if (el) { el.addEventListener("input", recalcPurchaseRub); el.addEventListener("change", recalcPurchaseRub); }
    });
    recalcPurchaseRub();

    submitBtn.disabled = false;
  }

  // ---------- Render: sale_main (комиссию менеджера УБРАЛ) ----------
  function applySalePresetByType(t) {
    const pay = document.getElementById("salePaymentTypeInput");
    const vat = document.getElementById("saleVatInput");
    const comm = document.getElementById("saleCommissionInput");
    if (!pay || !vat || !comm) return;

    const type = String(t || "");
    pay.value = "cash";
    vat.value = "no";
    comm.value = "no";

    if (type === "sale_cash") { pay.value = "cash"; vat.value = "no"; comm.value = "no"; }
    else if (type === "sale_cash_broker") { pay.value = "cash"; vat.value = "no"; comm.value = "yes"; }
    else if (type === "sale_nds_no_broker") { pay.value = "cashless"; vat.value = "yes"; comm.value = "no"; }
    else if (type === "sale_nds_broker") { pay.value = "cashless"; vat.value = "yes"; comm.value = "yes"; }
  }

  function renderSaleMain() {
    formCard.innerHTML = "";

    const payWrap = createSelectKV("salePaymentTypeInput", "Оплата", [
      {value:"cash", label:"Нал"},
      {value:"cashless", label:"Безнал"},
    ], "Выберите оплату");

    const vatWrap = createSelectKV("saleVatInput", "НДС", [
      {value:"yes", label:"С НДС"},
      {value:"no", label:"Без НДС"},
    ], "Выберите НДС");

    const commWrap = createSelectKV("saleCommissionInput", "Комиссия брокера", [
      {value:"yes", label:"Есть"},
      {value:"no", label:"Нет"},
    ], "Выберите");

    formCard.appendChild(payWrap);
    formCard.appendChild(vatWrap);
    formCard.appendChild(commWrap);

    const badge = document.createElement("div");
    badge.style.marginTop = "6px";
    badge.innerHTML = `<span class="pill" id="saleVariantBadge">Вариант: —</span>`;
    formCard.appendChild(badge);

    formCard.appendChild(createInput("managerInput", "Менеджер", "Имя менеджера"));
    formCard.appendChild(createInput("saleDateInput", "Дата продажи", "", todayISO(), "date"));

    formCard.appendChild(createAutocompleteInput(
      "brandModelInput",
      "Марка / Модель",
      "",
      mergeUnique(brands, remoteCache.brand_models, lsRead(LS_KEYS.BRAND_MODELS))
    ));

    formCard.appendChild(createInput("vinInput", "VIN (вбей цифры подряд)", "Например: 1457 или полный VIN"));

    formCard.appendChild(createAutocompleteInput(
      "leadSourceInput",
      "Источник",
      "Например, Авито",
      mergeUnique(sources, remoteCache.sources, lsRead(LS_KEYS.SOURCES))
    ));

    const buyerWrap = createInput("buyerInput", "Покупатель", "");
    const receiverWrap = createInput("receiverInput", "Получатель", "");
    formCard.appendChild(buyerWrap);
    formCard.appendChild(receiverWrap);

    const priceCashWrap = createInput("priceCashInput", "Цена (нал)", "");
    const priceCashNoCommWrap = createInput("priceCashNoCommInput", "Цена без комиссии (нал)", "");
    const priceCashlessWrap = createInput("priceCashlessInput", "Сумма (безнал, без НДС)", "");
    const priceNdsWrap = createInput("priceNdsInput", "Цена с НДС", "");
    const markupNdsWrap = createInput("markupNdsInput", "Наценка НДС (% / руб)", "");
    const contractPriceWrap = createInput("contractPriceInput", "Сумма договора", "");
    const brokerPriceWrap = createInput("brokerPriceInput", "Цена без комиссии брокера", "");
    const brokerExpenseWrap = createInput("brokerExpenseInput", "Расход брокера (кому/сумма/коммент)", "");

    formCard.appendChild(priceCashWrap);
    formCard.appendChild(priceCashNoCommWrap);
    formCard.appendChild(priceCashlessWrap);
    formCard.appendChild(priceNdsWrap);
    formCard.appendChild(markupNdsWrap);
    formCard.appendChild(contractPriceWrap);
    formCard.appendChild(brokerPriceWrap);
    formCard.appendChild(brokerExpenseWrap);

    function updateSaleMainVisibility() {
      const payment = document.getElementById("salePaymentTypeInput").value || "cash";
      const commission = (document.getElementById("saleCommissionInput").value || "no") === "yes";
      const vatYes = (document.getElementById("saleVatInput").value || "no") === "yes";
      const vat = (payment === "cashless") && vatYes;

      const vatSelect = document.getElementById("saleVatInput");
      if (payment !== "cashless") {
        vatSelect.disabled = true;
        vatSelect.value = "no";
      } else {
        vatSelect.disabled = false;
      }

      showEl(receiverWrap, payment === "cash");

      showEl(priceCashWrap, payment === "cash");
      showEl(priceCashNoCommWrap, payment === "cash" && commission);

      showEl(priceCashlessWrap, payment === "cashless" && !vat);
      showEl(priceNdsWrap, payment === "cashless" && vat);
      showEl(markupNdsWrap, payment === "cashless" && vat);

      showEl(contractPriceWrap, payment === "cashless" && commission);
      showEl(brokerPriceWrap, payment === "cashless" && commission);
      showEl(brokerExpenseWrap, payment === "cashless" && commission);

      if (payment === "cash") {
        showEl(priceCashlessWrap, false);
        showEl(priceNdsWrap, false);
        showEl(markupNdsWrap, false);
        showEl(contractPriceWrap, false);
        showEl(brokerPriceWrap, false);
        showEl(brokerExpenseWrap, false);
      }

      let variant = "";
      if (payment === "cash" && !commission) variant = "Нал / без брокера";
      if (payment === "cash" && commission) variant = "Нал / с брокером";
      if (payment === "cashless" && vat && !commission) variant = "Безнал / с НДС / без брокера";
      if (payment === "cashless" && vat && commission) variant = "Безнал / с НДС / с брокером";
      if (payment === "cashless" && !vat && !commission) variant = "Безнал / без НДС / без брокера";
      if (payment === "cashless" && !vat && commission) variant = "Безнал / без НДС / с брокером";

      const badgeEl = document.getElementById("saleVariantBadge");
      if (badgeEl) badgeEl.textContent = "Вариант: " + variant;
    }

    applySalePresetByType(formType);
    document.getElementById("salePaymentTypeInput").addEventListener("change", updateSaleMainVisibility);
    document.getElementById("saleVatInput").addEventListener("change", updateSaleMainVisibility);
    document.getElementById("saleCommissionInput").addEventListener("change", updateSaleMainVisibility);
    updateSaleMainVisibility();

    // VIN подсказки + автоподтягивание Марки/Модели по VIN
    setupVinAutocompleteSmart("vinInput", getAllVins);

    let vinTimer = null;
    const vinEl = document.getElementById("vinInput");
    const brandEl = document.getElementById("brandModelInput");
    vinEl.addEventListener("input", () => {
      if (vinTimer) clearTimeout(vinTimer);
      vinTimer = setTimeout(async () => {
        const v = normalizeVin(vinEl.value);
        if (v.length < 4) return;
        const data = await lookupByVin(v);
        const bm = data?.brand_model || data?.brandModel || "";
        if (bm && (!brandEl.value)) brandEl.value = bm;
      }, 350);
    });

    submitBtn.disabled = false;
  }

  // ---------- Render: all forms ----------
  function renderForm() {
    formCard.innerHTML = "";
    submitBtn.disabled = true;

    if (formType === "mgr_stock") {
      formCard.appendChild(createSelectKV("dealTypeInput", "Тип сделки", [
        {value:"Склад", label:"Склад"},
        {value:"Поставка", label:"Поставка"},
      ], "Выберите тип сделки"));

      formCard.appendChild(createAutocompleteInput(
        "brandModelInput",
        "Марка / Модель",
        "Начните вводить марку или модель",
        mergeUnique(brands, remoteCache.brand_models, lsRead(LS_KEYS.BRAND_MODELS))
      ));

      formCard.appendChild(createInput("vinInput", "VIN (цифры подряд / часть VIN)", "Например: 1457 или полный VIN"));
      formCard.appendChild(createInput("configInput", "Комплектация", "Например, Comfort"));
      formCard.appendChild(createInput("bodyColorInput", "Цвет кузова", "Черный"));
      formCard.appendChild(createInput("salonColorInput", "Цвет салона", "Черный"));
      formCard.appendChild(createInput("priceInput", "Цена, ₽", "1500000"));
      formCard.appendChild(createInput("stockDateInput", "Дата", "", todayISO(), "date"));

      formCard.appendChild(createSelectKV("payTypeInput", "Тип оплаты", [
        {value:"Нал", label:"Нал"},
        {value:"Безнал", label:"Безнал"},
        {value:"НДС", label:"НДС"},
      ], "Выберите тип оплаты"));

      formCard.appendChild(createInput("clientInput", "Клиент (Имя + телефон)", "Иван Иванов, +7..."));

      setupVinAutocompleteSmart("vinInput", getAllVins);
      submitBtn.disabled = false;
      return;
    }

    if (isSaleMainLike(formType)) { renderSaleMain(); return; }

    if (formType === "sale_deposit") {
      formCard.appendChild(createInput("managerInput", "Менеджер", ""));
      formCard.appendChild(createInput("saleDateInput", "Дата", "", todayISO(), "date"));
      formCard.appendChild(createAutocompleteInput("brandModelInput", "Марка / Модель", "", mergeUnique(brands, remoteCache.brand_models, lsRead(LS_KEYS.BRAND_MODELS))));
      formCard.appendChild(createInput("vinInput", "VIN (цифры подряд / часть VIN)", "Например: 1457 или полный VIN"));
      formCard.appendChild(createAutocompleteInput("leadSourceInput", "Источник", "Например, Авито", mergeUnique(sources, remoteCache.sources, lsRead(LS_KEYS.SOURCES))));
      formCard.appendChild(createInput("depositSumInput", "Сумма задатка", ""));
      formCard.appendChild(createInput("receiverInput", "Кому передана сумма", ""));
      formCard.appendChild(createInput("priceInput", "Цена продажи", ""));
      formCard.appendChild(createInput("buyerInput", "Покупатель", ""));
      setupVinAutocompleteSmart("vinInput", getAllVins);
      submitBtn.disabled = false;
      return;
    }

    if (formType === "sale_extra") {
      formCard.appendChild(createInput("managerInput", "Менеджер", ""));
      formCard.appendChild(createInput("saleDateInput", "Дата", "", todayISO(), "date"));
      formCard.appendChild(createAutocompleteInput("brandModelInput", "Марка / Модель", "", mergeUnique(brands, remoteCache.brand_models, lsRead(LS_KEYS.BRAND_MODELS))));
      formCard.appendChild(createInput("vinInput", "VIN (цифры подряд / часть VIN)", "Например: 1457 или полный VIN"));
      formCard.appendChild(createAutocompleteInput("leadSourceInput", "Источник", "Например, Авито", mergeUnique(sources, remoteCache.sources, lsRead(LS_KEYS.SOURCES))));
      formCard.appendChild(createTextarea("extraDescInput", "Доп. услуги (описание)", ""));
      formCard.appendChild(createInput("priceInput", "Цена продажи", ""));
      formCard.appendChild(createInput("receiverInput", "Кому передали средства", ""));
      formCard.appendChild(createInput("purchaserInput", "Кто выдал средства на закупку", ""));
      formCard.appendChild(createInput("buyPriceInput", "Цена покупки", ""));
      formCard.appendChild(createInput("profitInput", "Доход", ""));
      setupVinAutocompleteSmart("vinInput", getAllVins);
      submitBtn.disabled = false;
      return;
    }

    if (formType === "fin_auto_template") {
      formCard.appendChild(createInput("vinInput", "VIN (цифры подряд / часть VIN)", "Например: 1457 или полный VIN"));
      formCard.appendChild(createAutocompleteInput("brandModelInput", "Марка / Модель", "", mergeUnique(brands, remoteCache.brand_models, lsRead(LS_KEYS.BRAND_MODELS))));
      formCard.appendChild(createInput("faDateInput", "Дата", "", todayISO(), "date"));
      formCard.appendChild(createInput("evacuatorInput", "Эвакуатор", ""));
      formCard.appendChild(createInput("labInput", "Лаборатория", ""));
      formCard.appendChild(createInput("utilWriteoffInput", "Списания утильсбора", ""));
      formCard.appendChild(createInput("utilInput", "Утильсбор", ""));
      formCard.appendChild(createInput("preSaleInput", "Предпродажная подготовка", ""));
      formCard.appendChild(createInput("marketingInput", "Маркетинг", ""));
      formCard.appendChild(createInput("otherInput", "Прочие расходы", ""));
      formCard.appendChild(createTextarea("extraExpensesInput", "Доп. расходы", "Если есть: строками (например: Шиномонтаж: 3000)"));
      formCard.appendChild(createTextarea("commentInput", "Комментарий", ""));
      setupVinAutocompleteSmart("vinInput", getAllVins);
      submitBtn.disabled = false;
      return;
    }

    if (formType === "fin_oper") {
      formCard.appendChild(createInput("categoryInput", "Категория", "", categoryFromUrl || "", "text", true));
      formCard.appendChild(createInput("opDateInput", "Дата", "", todayISO(), "date"));
      formCard.appendChild(createInput("amountInput", "Сумма, ₽", ""));
      formCard.appendChild(createTextarea("commentInput", "Комментарий", ""));
      submitBtn.disabled = false;
      return;
    }

    if (formType === "boss_buy") { renderBossBuy(); return; }

    if (formType === "boss_invest_in" || formType === "boss_invest_out") {
      formCard.appendChild(createAutocompleteInput("investorInput", "Инвестор", "Начните вводить инвестора", investors));
      formCard.appendChild(createInput("sumInput", "Сумма", ""));
      formCard.appendChild(createInput("opDateInput", "Дата", "", todayISO(), "date"));
      formCard.appendChild(createTextarea("commentInput", "Комментарий", ""));
      submitBtn.disabled = false;
      return;
    }

    formCard.appendChild(createTextarea("rawInput", "Данные", "Форма не настроена. Введите данные в свободной форме."));
    submitBtn.disabled = false;
  }

  // ---------- UX helpers ----------
  function tgUserFullName() {
    try {
      const u = window.Telegram?.WebApp?.initDataUnsafe?.user;
      if (!u) return "";
      return [u.first_name, u.last_name].filter(Boolean).join(" ").trim() || (u.username ? "@" + u.username : "");
    } catch (e) { return ""; }
  }

  function rememberField(id, lsKey, fallback = "") {
    const el = document.getElementById(id);
    if (!el) return;
    try {
      const saved = localStorage.getItem(lsKey);
      if (!el.value && saved) el.value = saved;
      if (!el.value && fallback) el.value = fallback;
    } catch (e) {}
    el.addEventListener("input", () => {
      try { localStorage.setItem(lsKey, el.value || ""); } catch (e) {}
    });
  }

  function insertToggleAfterInput(inputId, toggleId, labelText, hintText, checkedByDefault = true) {
    const input = document.getElementById(inputId);
    if (!input) return null;
    if (document.getElementById(toggleId)) return document.getElementById(toggleId);
    const field = input.closest(".field") || input.parentElement;
    if (!field || !field.parentElement) return null;

    const row = document.createElement("div");
    row.className = "field";
    row.innerHTML = `
      <div class="toggle-row">
        <input type="checkbox" id="${toggleId}" ${checkedByDefault ? "checked" : ""}/>
        <div>
          <div>${labelText}</div>
          ${hintText ? `<small>${hintText}</small>` : ""}
        </div>
      </div>
    `;
    field.parentElement.insertBefore(row, field.nextSibling);
    return document.getElementById(toggleId);
  }

  function postRenderEnhancements() {
    rememberField("managerInput", "avtolink_last_manager", tgUserFullName());
    rememberField("leadSourceInput", "avtolink_last_source", "");
    rememberField("receiverInput", "avtolink_last_receiver", "");
    rememberField("purchaserInput", "avtolink_last_purchaser", "");

    // Автоподстановка “Марка/Модель по VIN”
    const vinEl = document.getElementById("vinInput");
    const brandEl = document.getElementById("brandModelInput");
    if (vinEl && brandEl) {
      const t = insertToggleAfterInput(
        "vinInput",
        "autoVinFillToggle",
        "Автоподстановка «Марка / Модель» по VIN",
        "Если включено — подтягиваем марку/модель из справочника по VIN.",
        true
      );

      let manualBrand = false;
      brandEl.addEventListener("input", () => { manualBrand = true; });

      let timer = null;
      const run = async () => {
        if (!t || !t.checked) return;
        if (!canUseLookup()) return;
        const v = normalizeVin(vinEl.value);
        if (!v || v.length < 4) return;
        if (manualBrand && brandEl.value) return;

        const data = await lookupByVin(v);
        const bm = data?.brand_model || data?.brandModel || "";
        if (bm) {
          brandEl.value = bm;
          manualBrand = false;
        }
      };

      const schedule = () => {
        if (timer) clearTimeout(timer);
        timer = setTimeout(run, 350);
      };

      vinEl.addEventListener("input", schedule);
      vinEl.addEventListener("blur", schedule);
      vinEl.addEventListener("change", schedule);
    }

    // Авторасчёт дохода (sale_extra) — оставил как было
    const priceEl = document.getElementById("priceInput");
    const buyEl = document.getElementById("buyPriceInput");
    const profitEl = document.getElementById("profitInput");
    if (priceEl && buyEl && profitEl) {
      const t = insertToggleAfterInput(
        "profitInput",
        "autoProfitToggle",
        "Авторасчёт дохода",
        "Доход = Цена продажи − Цена покупки (можно поправить вручную).",
        true
      );

      const jsParseNum = (v) => {
        if (v === null || v === undefined) return 0;
        const s = String(v).replace(/\s/g, "").replace(",", ".").replace(/[^\d.\-]/g, "");
        const n = parseFloat(s);
        return Number.isFinite(n) ? n : 0;
      };

      const recalc = () => {
        if (!t || !t.checked) return;
        if (profitEl.dataset.manual === "1") return;
        const p = jsParseNum(priceEl.value);
        const b = jsParseNum(buyEl.value);
        if (!p && !b) return;
        const diff = p - b;
        if (!profitEl.value || profitEl.dataset.auto === "1") {
          profitEl.value = String(Math.round(diff));
          profitEl.dataset.auto = "1";
        }
      };

      profitEl.addEventListener("input", () => { profitEl.dataset.manual = "1"; });
      priceEl.addEventListener("input", recalc);
      buyEl.addEventListener("input", recalc);
      recalc();
    }
  }

  // ---------- Collect data ----------
  function cacheBossBuyPayload(payload) {
    if (!payload || payload.formType !== "boss_buy") return;
    const vin = String(payload.vin || "").trim().toUpperCase();
    if (vin) lsAdd(LS_KEYS.VINS, vin, 1200);
    if (payload.brand_model) lsAdd(LS_KEYS.BRAND_MODELS, payload.brand_model, 1200);
    if (payload.supplier) lsAdd(LS_KEYS.SUPPLIERS, payload.supplier, 600);
    if (payload.purchase_place) lsAdd(LS_KEYS.PLACES, payload.purchase_place, 600);
  }

  function collectSaleMain() {
    const payload = { formType };
    payload.manager = document.getElementById("managerInput")?.value || "";
    payload.sale_date = getRuDate("saleDateInput");
    payload.brand_model = document.getElementById("brandModelInput")?.value || "";
    payload.vin = document.getElementById("vinInput")?.value || "";
    payload.source = document.getElementById("leadSourceInput")?.value || "";
    payload.buyer = document.getElementById("buyerInput")?.value || "";
    payload.receiver = document.getElementById("receiverInput")?.value || "";

    const badgeEl = document.getElementById("saleVariantBadge");
    payload.variant = badgeEl ? String(badgeEl.textContent || "").replace("Вариант:", "").trim() : "";

    const payment = document.getElementById("salePaymentTypeInput")?.value || "cash";
    const vatYes = (document.getElementById("saleVatInput")?.value || "no") === "yes";
    const commission = (document.getElementById("saleCommissionInput")?.value || "no") === "yes";
    const vat = (payment === "cashless") && vatYes;

    let price = "";
    if (payment === "cash") {
      price = document.getElementById("priceCashInput")?.value || "";
    } else {
      price = vat ? (document.getElementById("priceNdsInput")?.value || "") : (document.getElementById("priceCashlessInput")?.value || "");
    }
    payload.price = price; // ✅ единая цена

    // брокер
    payload.price_no_commission = (payment === "cash" && commission) ? (document.getElementById("priceCashNoCommInput")?.value || "") : "";
    payload.contract_price = (payment === "cashless" && commission) ? (document.getElementById("contractPriceInput")?.value || "") : "";
    payload.broker_price = (payment === "cashless" && commission) ? (document.getElementById("brokerPriceInput")?.value || "") : "";
    payload.broker_expense = (payment === "cashless" && commission) ? (document.getElementById("brokerExpenseInput")?.value || "") : "";
    payload.markup_nds = (payment === "cashless" && vat) ? (document.getElementById("markupNdsInput")?.value || "") : "";

    // совместимость со старым python
    payload.price_cash = (payment === "cash") ? price : "";
    payload.price_cashless = (payment === "cashless" && !vat) ? price : "";
    payload.price_nds = (payment === "cashless" && vat) ? price : "";

    // ✅ менеджерскую комиссию НЕ отправляем вообще
    payload.manager_fee = "";

    return payload;
  }

  function collectFormData() {
    const payload = { formType };

    if (formType === "mgr_stock") {
      payload.deal_type = document.getElementById("dealTypeInput").value;
      payload.brand_model = document.getElementById("brandModelInput").value;
      payload.vin = document.getElementById("vinInput").value;
      payload.complectation = document.getElementById("configInput").value;
      payload.body_color = document.getElementById("bodyColorInput").value;
      payload.salon_color = document.getElementById("salonColorInput").value;
      payload.price = document.getElementById("priceInput").value;
      payload.stock_date = getRuDate("stockDateInput");
      payload.payment_type = document.getElementById("payTypeInput").value;
      payload.client = document.getElementById("clientInput").value;
      return payload;
    }

    if (isSaleMainLike(formType)) return collectSaleMain();

    if (formType === "sale_deposit") {
      payload.manager = document.getElementById("managerInput").value;
      payload.sale_date = getRuDate("saleDateInput");
      payload.brand_model = document.getElementById("brandModelInput").value;
      payload.vin = document.getElementById("vinInput").value;
      payload.source = document.getElementById("leadSourceInput").value;
      payload.deposit_sum = document.getElementById("depositSumInput").value;
      payload.receiver = document.getElementById("receiverInput").value;
      payload.price = document.getElementById("priceInput").value;
      payload.buyer = document.getElementById("buyerInput").value;
      return payload;
    }

    if (formType === "sale_extra") {
      payload.manager = document.getElementById("managerInput").value;
      payload.sale_date = getRuDate("saleDateInput");
      payload.brand_model = document.getElementById("brandModelInput").value;
      payload.vin = document.getElementById("vinInput").value;
      payload.source = document.getElementById("leadSourceInput").value;
      payload.extra_desc = document.getElementById("extraDescInput").value;
      payload.price = document.getElementById("priceInput").value;
      payload.receiver = document.getElementById("receiverInput").value;
      payload.purchaser = document.getElementById("purchaserInput").value;
      payload.buy_price = document.getElementById("buyPriceInput").value;
      payload.profit = document.getElementById("profitInput").value;
      return payload;
    }

    if (formType === "fin_auto_template") {
      payload.vin = document.getElementById("vinInput").value;
      payload.brand_model = document.getElementById("brandModelInput").value;
      payload.op_date = getRuDate("faDateInput");
      payload.evacuator = document.getElementById("evacuatorInput").value;
      payload.lab = document.getElementById("labInput").value;
      payload.util_writeoff = document.getElementById("utilWriteoffInput").value;
      payload.util = document.getElementById("utilInput").value;
      payload.pre_sale = document.getElementById("preSaleInput").value;
      payload.marketing = document.getElementById("marketingInput").value;
      payload.other = document.getElementById("otherInput").value;
      payload.extra_expenses = document.getElementById("extraExpensesInput").value;
      payload.comment = document.getElementById("commentInput").value;
      return payload;
    }

    if (formType === "fin_oper") {
      payload.category = document.getElementById("categoryInput").value;
      payload.op_date = getRuDate("opDateInput");
      payload.amount = document.getElementById("amountInput").value;
      payload.comment = document.getElementById("commentInput").value;
      return payload;
    }

    if (formType === "boss_buy") {
      const mode = document.getElementById("modeSelect").value;
      payload.mode = mode;
      payload.vin = normalizeVin(document.getElementById("vinInput").value);

      if (mode === "purchase") {
        payload.purchase_date = getRuDate("purchaseDateInput");
        payload.supplier = document.getElementById("supplierInput").value;
        payload.purchase_place = document.getElementById("placeInput").value;
        payload.brand_model = document.getElementById("brandModelInput").value;
        payload.complectation = document.getElementById("complectationInput").value;
        payload.currency = document.getElementById("currencyInput").value;
        payload.amount_currency = document.getElementById("amountCurrencyInput").value;
        payload.rate_to_rub = document.getElementById("rateInput").value;
        payload.amount_rub = document.getElementById("amountRubInput").value;
        payload.comment = document.getElementById("commentInput_p").value;
      } else {
        payload.pay_date = getRuDate("payDateInput");
        payload.pay_currency = document.getElementById("payCurrencySelect").value;
        payload.pay_amount_currency = document.getElementById("payAmountCurrencyInput").value;
        payload.pay_rate = document.getElementById("payRateInput").value;
        payload.pay_amount_rub = document.getElementById("payRubInput").value;
        payload.comment = document.getElementById("commentInput").value;
      }
      return payload;
    }

    if (formType === "boss_invest_in" || formType === "boss_invest_out") {
      payload.investor = document.getElementById("investorInput").value;
      payload.sum = document.getElementById("sumInput").value;
      payload.op_date = getRuDate("opDateInput");
      payload.comment = document.getElementById("commentInput").value;
      return payload;
    }

    payload.raw = document.getElementById("rawInput")?.value || "";
    return payload;
  }

  // ---------- Init render ----------
  renderForm();
  postRenderEnhancements();
  scheduleRemoteListsLoad();

  // ---------- Submit ----------
  submitBtn.addEventListener("click", () => {
    const tgNow = window.Telegram?.WebApp;
    if (!tgNow) {
      alert("Открой форму через кнопку в Telegram-боте.");
      return;
    }
    const payload = collectFormData();
    try { cacheBossBuyPayload(payload); } catch(e) {}

    const dataStr = JSON.stringify(payload);
    if (dataStr.length > 3800) {
      tgAlert("Слишком много текста для отправки в Telegram. Сократи комментарии/доп.расходы и отправь ещё раз.");
      return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = "Отправка...";

    try {
      tgNow.sendData(dataStr);
      setTimeout(() => { try { tgNow.close(); } catch(e) {} }, 650);
    } catch (e) {
      tgAlert("Не удалось отправить данные. Попробуй ещё раз.");
      submitBtn.disabled = false;
      submitBtn.textContent = "Отправить в бота";
    }
  });
</script>
</body>
</html>
