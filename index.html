<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Автолинк WebApp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    *,*::before,*::after{box-sizing:border-box;}
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: #0f172a;
      color: #e5e7eb;
      min-height: var(--app-height, var(--tg-viewport-height, 100vh));
      padding-bottom: calc(16px + env(safe-area-inset-bottom));
      overscroll-behavior: contain;
    }
    h1 { font-size: 20px; margin: 0 0 4px; text-align: center; }
    .subtitle { font-size: 13px; text-align: center; color: #94a3b8; margin-bottom: 16px; line-height: 1.35; }
    .card {
      background: #111827;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.5);
      max-width: 560px;
      margin: 0 auto;
    }
    .field { margin-bottom: 12px; display: flex; flex-direction: column; gap: 4px; }
    label { font-size: 13px; color: #9ca3af; }
    input, select, textarea {
      border-radius: 10px;
      border: 1px solid #374151;
      padding: 8px 10px;
      font-size: 14px;
      background: #020617;
      color: #e5e7eb;
      outline: none;
    }
    input:focus, select:focus, textarea:focus { border-color: #38bdf8; }
    textarea { min-height: 90px; resize: vertical; }
    .readonly { background: #020617; color: #9ca3af; }
    .hint { font-size: 12px; color: #94a3b8; line-height: 1.35; margin-top: 4px; }
    .pill { display: inline-block; padding: 6px 10px; border-radius: 999px; background: #0b1226; border: 1px solid #334155; color: #cbd5e1; font-size: 12px; }
    .divider { height: 1px; background: #1f2937; margin: 14px 0; }
    .hidden { display:none; }
    .toggle-row{display:flex;align-items:center;gap:10px;font-size:13px;color:#cbd5e1;}
    .toggle-row input{width:18px;height:18px;}
    .toggle-row small{color:#94a3b8;line-height:1.25;}
    button#submitBtn {
      width: 100%;
      border-radius: 999px;
      border: none;
      padding: 10px 14px;
      font-size: 15px;
      font-weight: 600;
      background: linear-gradient(135deg, #38bdf8, #6366f1);
      color: white;
      cursor: pointer;
      margin-top: 12px;
      touch-action: manipulation;
    }
    button#submitBtn:disabled { opacity: .5; cursor: default; }
    .errorbox{
      margin: 12px auto 0;
      max-width: 560px;
      background:#0b1226;
      border:1px solid #ef4444;
      color:#fecaca;
      border-radius: 14px;
      padding: 10px 12px;
      display:none;
      line-height:1.35;
      font-size:13px;
      white-space: pre-line;
    }
    .req{ color:#fca5a5; margin-left:6px; font-weight:600; }
  </style>
</head>

<body>
  <h1>Автолинк</h1>
  <div class="subtitle" id="subtitle"></div>

  <div class="card" id="formCard"></div>
  <button id="submitBtn" disabled>Отправить в бота</button>
  <div class="errorbox" id="errorBox"></div>

<script>
  // ---------- Telegram ----------
  const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
  const urlParams = new URLSearchParams(window.location.search);
  const formType = urlParams.get("type") || "unknown";
  const APP_VERSION = urlParams.get("v") || "8";

  // ✅ iOS detection (для фикса "кнопка не нажимается/подвисает")
  const IS_IOS =
    /iPad|iPhone|iPod/.test(navigator.userAgent) ||
    (navigator.platform === "MacIntel" && navigator.maxTouchPoints > 1);

  // ---------- Service Worker ----------
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js?v=" + encodeURIComponent(APP_VERSION)).catch(() => {});
    });
  }

  try { if (tg) { tg.ready(); tg.expand(); } } catch (e) {}

  if (tg) {
    const setH = () => {
      document.documentElement.style.setProperty('--app-height', (tg.viewportHeight || window.innerHeight) + 'px');
    };
    setH();
    tg.onEvent('viewportChanged', setH);
  }

  function tgAlert(text) {
    try {
      if (tg && typeof tg.showAlert === "function") tg.showAlert(String(text));
      else alert(String(text));
    } catch(e) { alert(String(text)); }
  }

  const subtitleEl = document.getElementById("subtitle");
  const formCard = document.getElementById("formCard");
  const submitBtn = document.getElementById("submitBtn");
  const errorBox = document.getElementById("errorBox");

  function showError(msg){
    if (!msg) { errorBox.style.display="none"; errorBox.textContent=""; return; }
    errorBox.textContent = msg;
    errorBox.style.display="block";
    try { errorBox.scrollIntoView({behavior:"smooth", block:"start"}); } catch(e){}
  }

  // ---------- URL lists ----------
  const categoryFromUrl = urlParams.get("category") || "";
  const brandsParam = urlParams.get("brands") || "";
  const investorsParam = urlParams.get("investors") || "";
  const sourcesParam = urlParams.get("sources") || "";
  const managersParam = urlParams.get("managers") || "";
  const currenciesParam = urlParams.get("currencies") || "";

  const brands = brandsParam ? brandsParam.split("|") : [];
  const investors = investorsParam ? investorsParam.split("|") : [];
  const sources = sourcesParam ? sourcesParam.split("|") : [];
  const managers = managersParam ? managersParam.split("|") : [];
  const currencies = currenciesParam ? currenciesParam.split("|") : [];

  const FORM_TITLES = {
    mgr_stock: "Сток",
    sale_main: "Продажа — основная",
    sale_deposit: "Задаток",
    sale_extra: "Доп. услуги",
    sale_nds_broker: "Продажа — НДС с комиссией брокера",
    sale_nds_no_broker: "Продажа — НДС без комиссии брокера",
    sale_cash: "Продажа — Наличные",
    sale_cash_broker: "Продажа — Наличные с комиссией брокера",
    fin_auto_template: "Расходы на авто РФ",
    fin_company: "Расходы компании (MAIN)",
    fin_company_expense: "Расходы компании (RF)",
    fin_oper: "Оперрасходы",
    boss_buy: "Закупка / Оплата по VIN",
    boss_invest_in: "Инвестиции — ввод",
    boss_invest_out: "Инвестиции — вывод",
  };

  function isSaleMainLike(t) {
    return ["sale_main","sale_nds_broker","sale_nds_no_broker","sale_cash","sale_cash_broker"].includes(String(t||""));
  }

  // ✅ менеджерские формы (оставляем обязательность как было)
  function isManagerForms(t){
    return t === "mgr_stock" || t === "sale_deposit" || t === "sale_extra" || isSaleMainLike(t);
  }

  // ✅ финансист + руководитель (убираем обязательность полностью)
  function isFinanceOrBossForms(t){
    return [
      "fin_auto_template",
      "fin_company",
      "fin_company_expense",
      "fin_oper",
      "boss_buy",
      "boss_invest_in",
      "boss_invest_out"
    ].includes(String(t||""));
  }

  subtitleEl.textContent =
    "Форма: " + (FORM_TITLES[formType] || formType) +
    (categoryFromUrl ? " | Категория: " + categoryFromUrl : "");

  // ---------- helpers ----------
  function todayISO() { return new Date().toISOString().slice(0, 10); }
  function formatDateToRu(value) {
    if (!value) return "";
    const parts = value.split("-");
    if (parts.length === 3) {
      const [y, m, d] = parts;
      return `${d}.${m}.${y}`;
    }
    return value;
  }
  function getRuDate(id) {
    const el = document.getElementById(id);
    if (!el) return "";
    return formatDateToRu(el.value);
  }
  function showEl(el, show) {
    if (!el) return;
    el.classList.toggle("hidden", !show);
  }
  function safeStr(v){ return (v===null||v===undefined) ? "" : String(v); }
  function normalizeVin(v) { return String(v || "").trim().toUpperCase().replace(/\s+/g,""); }
  function uniq(arr){
    const out=[]; const seen=new Set();
    (arr||[]).forEach(x=>{
      const s=String(x||"").trim();
      if(!s) return;
      const k=s.toLowerCase();
      if(seen.has(k)) return;
      seen.add(k); out.push(s);
    });
    return out;
  }
  function mergeUnique(...arrays){ return uniq(arrays.flat()); }
  function normKey(s){ return String(s||"").trim().toLowerCase(); }

  function removeManagersFromSources(srcList, mgrList){
    const mset = new Set((mgrList||[]).map(normKey).filter(Boolean));
    return (srcList||[]).filter(x=>{
      const k = normKey(x);
      if(!k) return false;
      return !mset.has(k);
    });
  }

  // ✅ helper: ISO from "DD.MM.YYYY" or keep ISO
  function toISODateMaybe(value){
    const v = String(value || "").trim();
    if (!v) return "";
    if (/^\d{4}-\d{2}-\d{2}$/.test(v)) return v;
    const m = v.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/);
    if (m) {
      const dd = String(m[1]).padStart(2,"0");
      const mm = String(m[2]).padStart(2,"0");
      const yy = m[3];
      return `${yy}-${mm}-${dd}`;
    }
    return "";
  }

  // ✅ helper: поставить значение в SELECT (если нет опции — добавим)
  function setSelectValueSmart(selectEl, value){
    if (!selectEl) return;
    const v = String(value || "").trim();
    if (!v) { selectEl.value = ""; return; }
    if (selectEl.tagName !== "SELECT") { selectEl.value = v; return; }
    const exists = Array.from(selectEl.options || []).some(o => o.value === v);
    if (!exists) {
      const o = document.createElement("option");
      o.value = v;
      o.textContent = v;
      selectEl.appendChild(o);
    }
    selectEl.value = v;
  }

  // ---------- localStorage ----------
  const LS_KEYS = {
    VINS: "avtolink_vins",
    BRAND_MODELS: "avtolink_brand_models",
    SOURCES: "avtolink_sources",
    MANAGERS: "avtolink_managers",
    EXP_CATS: "avtolink_expense_categories",
    EXP_ARTICLES: "avtolink_expense_articles",
    VIN_SOURCE_MAP: "avtolink_vin_source_map",
    REMOTE_TS: "avtolink_remote_ts_" + APP_VERSION,
    SCHEMA: "avtolink_schema_v1",
  };

  function lsRead(key, fallback){
    try{
      const v = localStorage.getItem(key);
      if (v===null || v===undefined || v==="") return fallback;
      return JSON.parse(v);
    }catch(e){ return fallback; }
  }
  function lsWrite(key, value){
    try{ localStorage.setItem(key, JSON.stringify(value)); }catch(e){}
  }
  function lsReadArr(key){ const a=lsRead(key, []); return Array.isArray(a)?a.filter(Boolean):[]; }
  function lsWriteArr(key, arr, max=2000){ lsWrite(key, (Array.isArray(arr)?arr:[]).filter(Boolean).slice(0,max)); }

  // ✅ Авто-очистка кэша при смене версии
  try {
    const prev = localStorage.getItem(LS_KEYS.SCHEMA);
    if (prev !== String(APP_VERSION)) {
      localStorage.removeItem(LS_KEYS.SOURCES);
      localStorage.removeItem(LS_KEYS.MANAGERS);
      localStorage.removeItem(LS_KEYS.VINS);
      localStorage.removeItem(LS_KEYS.BRAND_MODELS);
      localStorage.removeItem(LS_KEYS.EXP_CATS);
      localStorage.removeItem(LS_KEYS.EXP_ARTICLES);
      localStorage.removeItem(LS_KEYS.VIN_SOURCE_MAP);
      localStorage.setItem(LS_KEYS.SCHEMA, String(APP_VERSION));
    }
  } catch(e){}

  function rememberVin(vin){
    const v = normalizeVin(vin);
    if(!v || v.length < 4) return;
    const cur = lsReadArr(LS_KEYS.VINS);
    const merged = mergeUnique([v], cur);
    lsWriteArr(LS_KEYS.VINS, merged, 4000);
  }

  function vinSourceMapGet(vin){
    const map = lsRead(LS_KEYS.VIN_SOURCE_MAP, {}) || {};
    return map[normalizeVin(vin)] || "";
  }
  function vinSourceMapSet(vin, source){
    const v = normalizeVin(vin);
    const s = String(source||"").trim();
    if(!v || v.length<4 || !s) return;
    const map = lsRead(LS_KEYS.VIN_SOURCE_MAP, {}) || {};
    map[v] = s;
    const keys = Object.keys(map);
    if(keys.length > 4000){
      keys.slice(0, keys.length-3500).forEach(k=>{ delete map[k]; });
    }
    lsWrite(LS_KEYS.VIN_SOURCE_MAP, map);
  }

  // ---------- datalist ----------
  function updateDatalist(dlId, options) {
    const dl = document.getElementById(dlId);
    if (!dl) return;
    dl.innerHTML = "";
    (options || []).slice(0, 800).forEach((opt) => {
      const o = document.createElement("option");
      o.value = opt;
      dl.appendChild(o);
    });
  }

  // ✅ select options updater (для менеджера/источника)
  function updateSelectOptions(selectId, options, placeholder="Выберите...") {
    const el = document.getElementById(selectId);
    if (!el || el.tagName !== "SELECT") return;

    const prev = (el.value || "").trim();
    const pending = (el.dataset.pendingValue || "").trim();

    el.innerHTML = "";

    const ph = document.createElement("option");
    ph.value = "";
    ph.textContent = placeholder;
    ph.disabled = true;
    ph.selected = true;
    el.appendChild(ph);

    const list = uniq(options || []);
    list.forEach(v=>{
      const o = document.createElement("option");
      o.value = v;
      o.textContent = v;
      el.appendChild(o);
    });

    // сначала пробуем восстановить прежнее значение, потом pendingValue
    const trySet = (v) => {
      if (!v) return false;
      const exists = Array.from(el.options).some(o=>o.value === v);
      if (exists) {
        el.value = v;
        ph.selected = false;
        return true;
      }
      return false;
    };

    if (trySet(prev)) { /* ok */ }
    else if (trySet(pending)) { el.dataset.pendingValue = ""; }
    else { el.value = ""; ph.selected = true; }
  }

  function createInput(id, labelText, placeholder = "", value = "", type = "text", readonly = false, required = false) {
    const w = document.createElement("div");
    w.className = "field";
    const l = document.createElement("label");
    l.htmlFor = id;
    l.textContent = labelText;
    if (required) {
      const r = document.createElement("span");
      r.className = "req";
      r.textContent = "*";
      l.appendChild(r);
    }
    const i = document.createElement("input");
    i.id = id;
    i.placeholder = placeholder;
    i.type = type;
    if (value) i.value = value;
    if (readonly) { i.readOnly = true; i.classList.add("readonly"); }
    if (id.toLowerCase().includes("vin")) i.maxLength = 17;
    if (required) i.dataset.required = "1";
    w.appendChild(l);
    w.appendChild(i);
    return w;
  }

  function createTextarea(id, labelText, placeholder = "", readonly = false, required = false) {
    const w = document.createElement("div");
    w.className = "field";
    const l = document.createElement("label");
    l.htmlFor = id;
    l.textContent = labelText;
    if (required) {
      const r = document.createElement("span");
      r.className = "req";
      r.textContent = "*";
      l.appendChild(r);
    }
    const t = document.createElement("textarea");
    t.id = id;
    t.placeholder = placeholder;
    if (readonly) { t.readOnly = true; t.classList.add("readonly"); }
    if (required) t.dataset.required = "1";
    w.appendChild(l);
    w.appendChild(t);
    return w;
  }

  function createSelectKV(id, labelText, options, placeholder = "Выберите...", required = false) {
    const w = document.createElement("div");
    w.className = "field";
    const l = document.createElement("label");
    l.htmlFor = id;
    l.textContent = labelText;
    if (required) {
      const r = document.createElement("span");
      r.className = "req";
      r.textContent = "*";
      l.appendChild(r);
    }
    const s = document.createElement("select");
    s.id = id;

    const ph = document.createElement("option");
    ph.value = "";
    ph.textContent = placeholder;
    ph.disabled = true;
    ph.selected = true;
    s.appendChild(ph);

    options.forEach((opt) => {
      const o = document.createElement("option");
      o.value = opt.value;
      o.textContent = opt.label;
      s.appendChild(o);
    });

    if (required) s.dataset.required = "1";

    w.appendChild(l);
    w.appendChild(s);
    return w;
  }

  function createAutocompleteInput(id, labelText, placeholder = "", options = [], required = false) {
    const w = document.createElement("div");
    w.className = "field";
    const l = document.createElement("label");
    l.htmlFor = id;
    l.textContent = labelText;
    if (required) {
      const r = document.createElement("span");
      r.className = "req";
      r.textContent = "*";
      l.appendChild(r);
    }
    const i = document.createElement("input");
    i.id = id;
    i.placeholder = placeholder;
    const dlId = id + "_list";
    i.setAttribute("list", dlId);
    let dl = document.getElementById(dlId);
    if (!dl) {
      dl = document.createElement("datalist");
      dl.id = dlId;
      document.body.appendChild(dl);
    }
    updateDatalist(dlId, options);
    if (required) i.dataset.required = "1";
    w.appendChild(l);
    w.appendChild(i);
    return w;
  }

  // ✅ NEW: Select from string list (для iPhone: менеджер/источник)
  function createSelectFromList(id, labelText, options = [], placeholder = "Выберите...", required = false) {
    const w = document.createElement("div");
    w.className = "field";

    const l = document.createElement("label");
    l.htmlFor = id;
    l.textContent = labelText;
    if (required) {
      const r = document.createElement("span");
      r.className = "req";
      r.textContent = "*";
      l.appendChild(r);
    }

    const s = document.createElement("select");
    s.id = id;

    const ph = document.createElement("option");
    ph.value = "";
    ph.textContent = placeholder;
    ph.disabled = true;
    ph.selected = true;
    s.appendChild(ph);

    uniq(options || []).forEach(v=>{
      const o = document.createElement("option");
      o.value = v;
      o.textContent = v;
      s.appendChild(o);
    });

    if (required) s.dataset.required = "1";
    w.appendChild(l);
    w.appendChild(s);
    return w;
  }

  // ---------- money formatting ----------
  function digitsOnly(s){ return String(s||"").replace(/[^\d]/g, ""); }
  function formatWithSpaces(numStr){
    const s = digitsOnly(numStr);
    if (!s) return "";
    return s.replace(/\B(?=(\d{3})+(?!\d))/g, " ");
  }

  // ✅ iOS fix: меньше вмешиваемся в ввод (форматируем на blur)
  function setupMoneyInput(id){
    const el = document.getElementById(id);
    if (!el || el.dataset.money === "1") return;
    el.dataset.money = "1";

    const formatNow = () => {
      const raw = el.value;
      el.value = formatWithSpaces(raw);
    };

    if (IS_IOS) {
      el.addEventListener("blur", formatNow);
      return;
    }

    const onInput = () => {
      const start = el.selectionStart || 0;
      const raw = el.value;
      const beforeDigits = digitsOnly(raw.slice(0, start)).length;

      const formatted = formatWithSpaces(raw);
      el.value = formatted;

      let pos = 0;
      let seenDigits = 0;
      while (pos < el.value.length && seenDigits < beforeDigits) {
        if (/\d/.test(el.value[pos])) seenDigits++;
        pos++;
      }
      try { el.setSelectionRange(pos, pos); } catch(e){}
    };

    el.addEventListener("input", onInput);
    el.addEventListener("blur", onInput);
  }

  // ---------- Smart VIN datalist (includes) ----------
  function setupVinAutocompleteSmart(inputId, getAllVinsFn) {
    const input = document.getElementById(inputId);
    if (!input) return;
    if (input.dataset && input.dataset.vinAuto === "1") return;
    input.dataset.vinAuto = "1";

    const listId = inputId + "_list";
    let dl = document.getElementById(listId);
    if (!dl) {
      dl = document.createElement("datalist");
      dl.id = listId;
      document.body.appendChild(dl);
    }
    input.setAttribute("list", listId);

    function fill(filter = "") {
      const raw = String(filter || "").trim();
      if (!raw) return;
      const onlyDigits = /^[0-9]+$/.test(raw);
      if (!onlyDigits && raw.length < 2) return;
      const f = raw.toLowerCase();

      dl.innerHTML = "";
      const source = (typeof getAllVinsFn === "function") ? getAllVinsFn() : [];
      const out = [];

      for (let i = 0; i < source.length; i++) {
        const v = normalizeVin(source[i]);
        if (!v) continue;
        if (v.toLowerCase().includes(f)) out.push(v);
        if (out.length >= 80) break;
      }

      out.forEach(v => {
        const o = document.createElement("option");
        o.value = v;
        dl.appendChild(o);
      });
    }

    input.addEventListener("focus", () => fill(input.value));
    input.addEventListener("input", () => fill(input.value));

    input.addEventListener("change", ()=>rememberVin(input.value));
    input.addEventListener("blur", ()=>rememberVin(input.value));
  }

  // ---------- Apps Script (3 URL) ----------
  const LOOKUP_API_URL_BOSS =
    "https://script.google.com/macros/s/AKfycbzuBwFkGUiXnJcwUeTSt5jP8Y1BdE8PD0MQO_0SH6hr74O2htidfhD3Oop5zZ80G-GlDw/exec";

  const LOOKUP_API_URL_REF =
    "https://script.google.com/macros/s/AKfycbx_JDoOiJ_yTGiTyY16aIkNFSOjNelz40UiUbvVCdWq0wbsBpbTC5_0vZNga_ImSJ54MQ/exec";

  const LOOKUP_API_URL_RF_EXPENSE =
    "https://script.google.com/macros/s/AKfycbz-f23gebbose-v_t2iqFeX-7UeoKg1-JUU1fhPCdk2GqM0Dmk1bIDZJoHUVD_Q7bMHAA/exec";

  const LOOKUP_API_TOKEN = "";

  function getLookupUrl() {
    if (formType === "boss_buy") return LOOKUP_API_URL_BOSS;
    if (formType === "fin_company_expense") return LOOKUP_API_URL_RF_EXPENSE;
    return LOOKUP_API_URL_REF;
  }
  function getLookupUrlByForm(){ return getLookupUrl(); }

  function canUseLookup() {
    const u = getLookupUrl();
    return typeof u === "string" && u.trim().startsWith("https://");
  }

  function jsonpRequest(baseUrl, params, timeoutMs = 8000) {
    return new Promise((resolve, reject) => {
      const cb = "__cb_" + Math.random().toString(36).slice(2);
      const q = new URLSearchParams(params || {});
      q.set("callback", cb);
      if (LOOKUP_API_TOKEN) q.set("token", LOOKUP_API_TOKEN);

      const src = baseUrl + (baseUrl.includes("?") ? "&" : "?") + q.toString();
      const script = document.createElement("script");
      let done = false;

      function cleanup() {
        if (script && script.parentNode) script.parentNode.removeChild(script);
        try { delete window[cb]; } catch (e) { window[cb] = undefined; }
      }

      const timer = setTimeout(() => {
        if (done) return;
        done = true;
        cleanup();
        reject(new Error("Lookup timeout"));
      }, timeoutMs);

      window[cb] = (data) => {
        if (done) return;
        done = true;
        clearTimeout(timer);
        cleanup();
        resolve(data);
      };

      script.onerror = () => {
        if (done) return;
        done = true;
        clearTimeout(timer);
        cleanup();
        reject(new Error("Lookup request failed"));
      };

      script.src = src;
      document.body.appendChild(script);
    });
  }

  // remote cache
  const remoteCache = {
    vins: [],
    brand_models: [],
    sources: [],
    managers: [],
    expense_categories: [],
    expense_articles: [],
    suppliers: [],
    places: [],
  };

  function getAllVins() {
    return mergeUnique(remoteCache.vins, lsReadArr(LS_KEYS.VINS)).map(v => normalizeVin(v));
  }
  function getAllBrandModels() {
    return mergeUnique(brands, remoteCache.brand_models, lsReadArr(LS_KEYS.BRAND_MODELS));
  }
  function getAllManagers() {
    return mergeUnique(managers, remoteCache.managers, lsReadArr(LS_KEYS.MANAGERS));
  }
  function getAllSources() {
    const raw = mergeUnique(sources, remoteCache.sources, lsReadArr(LS_KEYS.SOURCES));
    return removeManagersFromSources(raw, getAllManagers());
  }
  function getAllExpenseCategories() {
    return mergeUnique(remoteCache.expense_categories, lsReadArr(LS_KEYS.EXP_CATS));
  }
  function getAllExpenseArticles() {
    return mergeUnique(remoteCache.expense_articles, lsReadArr(LS_KEYS.EXP_ARTICLES));
  }

  async function remoteListsLoad(force=false) {
    if (!canUseLookup()) return;
    try {
      const res = await jsonpRequest(getLookupUrl(), { action: "lists" }, 8000);
      if (res && res.ok && res.lists) {
        const L = res.lists;

        remoteCache.vins = Array.isArray(L.vins) ? L.vins : remoteCache.vins;
        remoteCache.brand_models = Array.isArray(L.brand_models) ? L.brand_models : remoteCache.brand_models;
        remoteCache.sources = Array.isArray(L.sources) ? L.sources : remoteCache.sources;
        remoteCache.managers = Array.isArray(L.managers) ? L.managers : remoteCache.managers;
        remoteCache.expense_categories = Array.isArray(L.expense_categories) ? L.expense_categories : remoteCache.expense_categories;
        remoteCache.suppliers = Array.isArray(L.suppliers) ? L.suppliers : remoteCache.suppliers;
        remoteCache.places = Array.isArray(L.places) ? L.places : remoteCache.places;

        remoteCache.expense_articles = Array.isArray(L.expense_articles) ? L.expense_articles : remoteCache.expense_articles;

        // ✅ фильтруем источники от менеджеров
        remoteCache.sources = removeManagersFromSources(remoteCache.sources, remoteCache.managers);

        // write LS
        if (remoteCache.vins.length) lsWriteArr(LS_KEYS.VINS, mergeUnique(remoteCache.vins, lsReadArr(LS_KEYS.VINS)), 4000);
        if (remoteCache.brand_models.length) lsWriteArr(LS_KEYS.BRAND_MODELS, mergeUnique(remoteCache.brand_models, lsReadArr(LS_KEYS.BRAND_MODELS)), 3000);
        if (remoteCache.managers.length) lsWriteArr(LS_KEYS.MANAGERS, mergeUnique(remoteCache.managers, lsReadArr(LS_KEYS.MANAGERS)), 2000);

        // ✅ ВАЖНО: чистим localStorage sources от менеджеров (чтобы "грязь" больше не возвращалась)
        const lsSourcesClean = removeManagersFromSources(lsReadArr(LS_KEYS.SOURCES), remoteCache.managers);
        const mergedSourcesClean = mergeUnique(remoteCache.sources, lsSourcesClean);
        if (mergedSourcesClean.length) lsWriteArr(LS_KEYS.SOURCES, mergedSourcesClean, 2000);

        if (remoteCache.expense_categories.length) lsWriteArr(LS_KEYS.EXP_CATS, mergeUnique(remoteCache.expense_categories, lsReadArr(LS_KEYS.EXP_CATS)), 2000);
        if (remoteCache.expense_articles.length) lsWriteArr(LS_KEYS.EXP_ARTICLES, mergeUnique(remoteCache.expense_articles, lsReadArr(LS_KEYS.EXP_ARTICLES)), 2000);

        // refresh datalists/selects if present
        updateDatalist("vinInput_list", getAllVins());
        updateDatalist("brandModelInput_list", getAllBrandModels());

        // ✅ NEW: если менеджер/источник стали SELECT — обновляем их опции
        const mgrEl = document.getElementById("managerInput");
        if (mgrEl && mgrEl.tagName === "SELECT") updateSelectOptions("managerInput", getAllManagers(), "Выберите менеджера");
        else updateDatalist("managerInput_list", getAllManagers());

        const srcEl = document.getElementById("leadSourceInput");
        if (srcEl && srcEl.tagName === "SELECT") updateSelectOptions("leadSourceInput", getAllSources(), "Выберите источник");
        else updateDatalist("leadSourceInput_list", getAllSources());

        updateDatalist("categoryInput_list", getAllExpenseCategories());
        updateDatalist("expenseArticleInput_list", getAllExpenseArticles());

        updateDatalist("supplierInput_list", mergeUnique(remoteCache.suppliers, lsReadArr("boss_buy_suppliers")));
        updateDatalist("placeInput_list", mergeUnique(remoteCache.places, lsReadArr("boss_buy_places")));
      }
    } catch (e) {
      console.warn("remoteListsLoad failed:", e);
    }
  }

  function shouldRefreshRemoteLists() {
    const ts = Number(localStorage.getItem(LS_KEYS.REMOTE_TS) || "0");
    const TTL = 10 * 60 * 1000;
    return (!ts) || ((Date.now() - ts) > TTL);
  }

  function scheduleRemoteListsLoad() {
    if (!canUseLookup()) return;
    const run = async () => {
      await remoteListsLoad(true);
      try { localStorage.setItem(LS_KEYS.REMOTE_TS, String(Date.now())); } catch(e){}
    };
    if (shouldRefreshRemoteLists()) {
      const idle = window.requestIdleCallback || ((fn) => setTimeout(fn, 200));
      idle(run);
    } else {
      if (!lsReadArr(LS_KEYS.VINS).length && !remoteCache.vins.length) run();
    }
  }

  // ---------- lookup by VIN ----------
  async function lookupByVin(vinRaw) {
    if (!canUseLookup()) return null;
    const vin = normalizeVin(vinRaw);
    if (!vin || vin.length < 4) return null;
    try {
      const res = await jsonpRequest(getLookupUrl(), { action: "lookup", vin: vin }, 8000);
      if (res && res.ok && res.found && res.data) return res.data;
    } catch (e) {}
    return null;
  }

  async function sourceByVinServer(vinRaw) {
    const vin = normalizeVin(vinRaw);
    if (!vin || vin.length < 4) return "";
    if (!["sale_main","sale_deposit","sale_extra","sale_nds_broker","sale_nds_no_broker","sale_cash","sale_cash_broker"].includes(formType)) return "";
    try {
      const res = await jsonpRequest(LOOKUP_API_URL_REF, { action: "source_by_vin", vin: vin }, 8000);
      if (res && res.ok && res.found && res.source) return String(res.source).trim();
    } catch (e) {}
    return "";
  }

  // ---------- managers & sources touch flags ----------
  let sourceTouched = false;
  function markTouched(id, setter){
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener("input", () => setter(true));
    el.addEventListener("change", () => setter(true));
  }

  // ---------- Render ----------
  function renderForm() {
    formCard.innerHTML = "";
    submitBtn.disabled = true;
    showError("");

    if (formType === "mgr_stock") {
      formCard.appendChild(createSelectKV("dealTypeInput", "Тип сделки", [
        {value:"Склад", label:"Склад"},
        {value:"Поставка", label:"Поставка"},
      ], "Выберите тип сделки", true));

      // ✅ ИЗМЕНЕНИЕ: менеджер теперь SELECT (раскрывающийся список)
      formCard.appendChild(createSelectFromList("managerInput","Менеджер", getAllManagers(), "Выберите менеджера", true));

      formCard.appendChild(createAutocompleteInput("brandModelInput", "Марка / Модель", "Начните вводить", getAllBrandModels(), true));
      formCard.appendChild(createInput("vinInput", "VIN (можно цифры подряд)", "Например: 1457 или полный VIN", "", "text", false, true));
      formCard.appendChild(createInput("configInput", "Комплектация", "", "", "text", false, true));
      formCard.appendChild(createInput("bodyColorInput", "Цвет кузова", "", "", "text", false, true));
      formCard.appendChild(createInput("salonColorInput", "Цвет салона", "", "", "text", false, true));
      formCard.appendChild(createInput("priceInput", "Цена, ₽", "", "", "text", false, true));
      formCard.appendChild(createInput("stockDateInput", "Дата", "", todayISO(), "date", false, true));

      formCard.appendChild(createSelectKV("payTypeInput", "Тип оплаты", [
        {value:"Нал", label:"Нал"},
        {value:"Безнал", label:"Безнал"},
        {value:"НДС", label:"НДС"},
      ], "Выберите тип оплаты", true));

      formCard.appendChild(createInput("clientInput", "Клиент (Имя + телефон)", "", "", "text", false, true));

      setupVinAutocompleteSmart("vinInput", getAllVins);
      setupMoneyInput("priceInput");

      submitBtn.disabled = false;
      return;
    }

    if (isSaleMainLike(formType)) {
      renderSaleMain();
      return;
    }

    if (formType === "sale_deposit") {
      // ✅ ИЗМЕНЕНИЕ: менеджер теперь SELECT
      formCard.appendChild(createSelectFromList("managerInput","Менеджер", getAllManagers(), "Выберите менеджера", true));

      formCard.appendChild(createInput("saleDateInput", "Дата", "", todayISO(), "date", false, true));
      formCard.appendChild(createAutocompleteInput("brandModelInput", "Марка / Модель", "", getAllBrandModels(), true));
      formCard.appendChild(createInput("vinInput", "VIN (можно цифры подряд)", "Например: 1457 или полный VIN", "", "text", false, true));

      // ✅ ИЗМЕНЕНИЕ: источник теперь SELECT (и при входе будет пустым, как ниже)
      formCard.appendChild(createSelectFromList("leadSourceInput", "Источник", getAllSources(), "Выберите источник", true));

      formCard.appendChild(createInput("depositSumInput", "Сумма задатка", "", "", "text", false, true));
      formCard.appendChild(createInput("receiverInput", "Кому передана сумма", "", "", "text", false, true));
      formCard.appendChild(createInput("priceInput", "Цена продажи", "", "", "text", false, true));
      formCard.appendChild(createInput("buyerInput", "Покупатель (необязательно)", "", "", "text", false, false));

      setupVinAutocompleteSmart("vinInput", getAllVins);
      setupMoneyInput("depositSumInput");
      setupMoneyInput("priceInput");

      sourceTouched = false;
      markTouched("leadSourceInput", v=>sourceTouched=v);

      setupAutoFillFromVin();
      submitBtn.disabled = false;
      return;
    }

    if (formType === "sale_extra") {
      // ✅ ИЗМЕНЕНИЕ: менеджер теперь SELECT
      formCard.appendChild(createSelectFromList("managerInput","Менеджер", getAllManagers(), "Выберите менеджера", true));

      formCard.appendChild(createInput("saleDateInput", "Дата", "", todayISO(), "date", false, true));
      formCard.appendChild(createAutocompleteInput("brandModelInput", "Марка / Модель", "", getAllBrandModels(), true));
      formCard.appendChild(createInput("vinInput", "VIN (можно цифры подряд)", "Например: 1457 или полный VIN", "", "text", false, true));

      // ✅ ИЗМЕНЕНИЕ: источник теперь SELECT
      formCard.appendChild(createSelectFromList("leadSourceInput", "Источник", getAllSources(), "Выберите источник", true));

      formCard.appendChild(createTextarea("extraDescInput", "Доп. услуги (описание) (необязательно)", "", false, false));
      formCard.appendChild(createInput("priceInput", "Цена продажи", "", "", "text", false, true));
      formCard.appendChild(createInput("receiverInput", "Кому передали средства", "", "", "text", false, true));
      formCard.appendChild(createInput("purchaserInput", "Кто выдал средства на закупку", "", "", "text", false, true));
      formCard.appendChild(createInput("buyPriceInput", "Цена покупки", "", "", "text", false, true));
      formCard.appendChild(createInput("profitInput", "Доход", "Авторасчёт (можно изменить)", "", "text", false, true));

      setupVinAutocompleteSmart("vinInput", getAllVins);
      setupMoneyInput("priceInput");
      setupMoneyInput("buyPriceInput");
      setupMoneyInput("profitInput");

      setupAutoProfit();

      sourceTouched = false;
      markTouched("leadSourceInput", v=>sourceTouched=v);

      setupAutoFillFromVin();
      submitBtn.disabled = false;
      return;
    }

    // ✅ Финансист: убираем обязательность полностью (все required = false)
    if (formType === "fin_auto_template") {
      formCard.appendChild(createInput("vinInput", "VIN (можно цифры подряд)", "Например: 1457 или полный VIN", "", "text", false, false));
      formCard.appendChild(createAutocompleteInput("brandModelInput", "Марка / Модель", "", getAllBrandModels(), false));
      formCard.appendChild(createInput("faDateInput", "Дата", "", todayISO(), "date", false, false));
      formCard.appendChild(createInput("evacuatorInput", "Эвакуатор", "", "", "text", false, false));
      formCard.appendChild(createInput("labInput", "Лаборатория", "", "", "text", false, false));
      formCard.appendChild(createInput("utilWriteoffInput", "Списания утильсбора", "", "", "text", false, false));
      formCard.appendChild(createInput("utilInput", "Утильсбор", "", "", "text", false, false));
      formCard.appendChild(createInput("preSaleInput", "Предпродажная подготовка", "", "", "text", false, false));
      formCard.appendChild(createInput("marketingInput", "Маркетинг", "", "", "text", false, false));
      formCard.appendChild(createInput("otherInput", "Прочие расходы", "", "", "text", false, false));
      formCard.appendChild(createTextarea("extraExpensesInput", "Доп. расходы", "Если есть: строками", false, false));
      formCard.appendChild(createTextarea("commentInput", "Комментарий", "", false, false));

      setupVinAutocompleteSmart("vinInput", getAllVins);
      ["evacuatorInput","labInput","utilWriteoffInput","utilInput","preSaleInput","marketingInput","otherInput"].forEach(setupMoneyInput);

      setupAutoFillBrandByVinOnly();
      submitBtn.disabled = false;
      return;
    }

    // ✅ Финансист (RF): обязательность убрана
    if (formType === "fin_company_expense") {
      formCard.appendChild(createInput("opDateInput", "Дата", "", todayISO(), "date", false, false));
      formCard.appendChild(createAutocompleteInput("expenseArticleInput", "Статья", "Начни вводить статью", getAllExpenseArticles(), false));
      formCard.appendChild(createInput("amountInput", "Сумма, ₽", "Например: 1 200 000", "", "text", false, false));
      formCard.appendChild(createTextarea("commentInput", "Комментарий (необязательно)", "", false, false));

      setupMoneyInput("amountInput");
      submitBtn.disabled = false;
      return;
    }

    // ✅ Финансист (MAIN): обязательность убрана
    if (formType === "fin_company") {
      formCard.appendChild(createInput("opDateInput", "Дата", "", todayISO(), "date", false, false));
      formCard.appendChild(createAutocompleteInput("categoryInput", "Статья расхода", "Например: Аренда", getAllExpenseCategories(), false));
      formCard.appendChild(createInput("amountInput", "Сумма, ₽", "", "", "text", false, false));
      formCard.appendChild(createTextarea("commentInput", "Комментарий (необязательно)", "", false, false));

      setupMoneyInput("amountInput");
      submitBtn.disabled = false;
      return;
    }

    if (formType === "boss_buy") {
      renderBossBuy();
      return;
    }

    // ✅ Руководитель: обязательность убрана
    if (formType === "boss_invest_in" || formType === "boss_invest_out") {
      formCard.appendChild(createAutocompleteInput("investorInput", "Инвестор", "", investors, false));
      formCard.appendChild(createInput("sumInput", "Сумма", "", "", "text", false, false));
      formCard.appendChild(createInput("opDateInput", "Дата", "", todayISO(), "date", false, false));
      formCard.appendChild(createTextarea("commentInput", "Комментарий", "", false, false));
      setupMoneyInput("sumInput");
      submitBtn.disabled = false;
      return;
    }

    formCard.appendChild(createTextarea("rawInput", "Данные", "Форма не настроена. Введите данные в свободной форме.", false, true));
    submitBtn.disabled = false;
  }

  // ---------- Sale Main ----------
  function applySalePresetByType(t) {
    const pay = document.getElementById("salePaymentTypeInput");
    const vat = document.getElementById("saleVatInput");
    const comm = document.getElementById("saleCommissionInput");
    if (!pay || !vat || !comm) return;

    const type = String(t || "");
    pay.value = "cash";
    vat.value = "no";
    comm.value = "no";

    if (type === "sale_cash") { pay.value = "cash"; vat.value = "no"; comm.value = "no"; }
    else if (type === "sale_cash_broker") { pay.value = "cash"; vat.value = "no"; comm.value = "yes"; }
    else if (type === "sale_nds_no_broker") { pay.value = "cashless"; vat.value = "yes"; comm.value = "no"; }
    else if (type === "sale_nds_broker") { pay.value = "cashless"; vat.value = "yes"; comm.value = "yes"; }
  }

  function renderSaleMain() {
    formCard.innerHTML = "";

    // ✅ ИЗМЕНЕНИЕ: менеджер теперь SELECT
    formCard.appendChild(createSelectFromList("managerInput","Менеджер", getAllManagers(), "Выберите менеджера", true));

    const payWrap = createSelectKV("salePaymentTypeInput", "Оплата", [
      {value:"cash", label:"Нал"},
      {value:"cashless", label:"Безнал"},
    ], "Выберите оплату", true);

    const vatWrap = createSelectKV("saleVatInput", "НДС", [
      {value:"yes", label:"С НДС"},
      {value:"no", label:"Без НДС"},
    ], "Выберите НДС", true);

    const commWrap = createSelectKV("saleCommissionInput", "Комиссия брокера", [
      {value:"yes", label:"Есть"},
      {value:"no", label:"Нет"},
    ], "Выберите", true);

    formCard.appendChild(payWrap);
    formCard.appendChild(vatWrap);
    formCard.appendChild(commWrap);

    const badge = document.createElement("div");
    badge.style.marginTop = "6px";
    badge.innerHTML = `<span class="pill" id="saleVariantBadge">Вариант: —</span>`;
    formCard.appendChild(badge);

    formCard.appendChild(createInput("saleDateInput", "Дата продажи", "", todayISO(), "date", false, true));
    formCard.appendChild(createAutocompleteInput("brandModelInput", "Марка / Модель", "", getAllBrandModels(), true));
    formCard.appendChild(createInput("vinInput", "VIN (можно цифры подряд)", "Например: 1457 или полный VIN", "", "text", false, true));

    // ✅ ИЗМЕНЕНИЕ: источник теперь SELECT
    formCard.appendChild(createSelectFromList("leadSourceInput", "Источник", getAllSources(), "Выберите источник", true));

    const buyerWrap = createInput("buyerInput", "Покупатель (необязательно)", "", "", "text", false, false);
    const receiverWrap = createInput("receiverInput", "Получатель (необязательно)", "", "", "text", false, false);
    formCard.appendChild(buyerWrap);
    formCard.appendChild(receiverWrap);

    const priceCashWrap = createInput("priceCashInput", "Цена (нал)", "", "", "text", false, true);
    const priceCashNoCommWrap = createInput("priceCashNoCommInput", "Цена без комиссии (нал)", "", "", "text", false, true);

    const priceCashlessWrap = createInput("priceCashlessInput", "Сумма (безнал, без НДС)", "", "", "text", false, true);
    const priceNdsWrap = createInput("priceNdsInput", "Цена с НДС", "", "", "text", false, true);
    const markupNdsWrap = createInput("markupNdsInput", "Наценка НДС (% / руб)", "", "", "text", false, true);

    const priceNoVatCashWrap = createInput("priceNoVatCashInput", "Цена без НДС за наличные", "", "", "text", false, true);

    const contractPriceWrap = createInput("contractPriceInput", "Сумма договора", "", "", "text", false, true);
    const brokerPriceWrap = createInput("brokerPriceInput", "Цена без комиссии брокера", "", "", "text", false, true);
    const brokerExpenseWrap = createInput("brokerExpenseInput", "Комиссия брокера (коммент/сумма)", "", "", "text", false, true);

    formCard.appendChild(priceCashWrap);
    formCard.appendChild(priceCashNoCommWrap);
    formCard.appendChild(priceCashlessWrap);
    formCard.appendChild(priceNdsWrap);
    formCard.appendChild(markupNdsWrap);
    formCard.appendChild(priceNoVatCashWrap);
    formCard.appendChild(contractPriceWrap);
    formCard.appendChild(brokerPriceWrap);
    formCard.appendChild(brokerExpenseWrap);

    ["priceCashInput","priceCashNoCommInput","priceCashlessInput","priceNdsInput","markupNdsInput","priceNoVatCashInput","contractPriceInput","brokerPriceInput"].forEach(setupMoneyInput);

    function updateSaleMainVisibility() {
      const payment = document.getElementById("salePaymentTypeInput").value || "cash";
      const commission = (document.getElementById("saleCommissionInput").value || "no") === "yes";
      const vatYes = (document.getElementById("saleVatInput").value || "no") === "yes";
      const vat = (payment === "cashless") && vatYes;

      const vatSelect = document.getElementById("saleVatInput");
      if (payment !== "cashless") {
        vatSelect.disabled = true;
        vatSelect.value = "no";
      } else {
        vatSelect.disabled = false;
      }

      showEl(receiverWrap, payment === "cash");

      showEl(priceCashWrap, payment === "cash");
      showEl(priceCashNoCommWrap, payment === "cash" && commission);

      showEl(priceCashlessWrap, payment === "cashless" && !vat);
      showEl(priceNdsWrap, payment === "cashless" && vat);
      showEl(markupNdsWrap, payment === "cashless" && vat);

      showEl(priceNoVatCashWrap, payment === "cashless" && vat);

      showEl(contractPriceWrap, payment === "cashless" && commission);
      showEl(brokerPriceWrap, payment === "cashless" && commission);
      showEl(brokerExpenseWrap, payment === "cashless" && commission);

      if (payment === "cash") {
        showEl(priceCashlessWrap, false);
        showEl(priceNdsWrap, false);
        showEl(markupNdsWrap, false);
        showEl(priceNoVatCashWrap, false);
        showEl(contractPriceWrap, false);
        showEl(brokerPriceWrap, false);
        showEl(brokerExpenseWrap, false);
      }

      let variant = "";
      if (payment === "cash" && !commission) variant = "Нал / без брокера";
      if (payment === "cash" && commission) variant = "Нал / с брокером";
      if (payment === "cashless" && vat && !commission) variant = "Безнал / с НДС / без брокера";
      if (payment === "cashless" && vat && commission) variant = "Безнал / с НДС / с брокером";
      if (payment === "cashless" && !vat && !commission) variant = "Безнал / без НДС / без брокера";
      if (payment === "cashless" && !vat && commission) variant = "Безнал / без НДС / с брокером";

      const badgeEl = document.getElementById("saleVariantBadge");
      if (badgeEl) badgeEl.textContent = "Вариант: " + variant;
    }

    applySalePresetByType(formType);
    document.getElementById("salePaymentTypeInput").addEventListener("change", updateSaleMainVisibility);
    document.getElementById("saleVatInput").addEventListener("change", updateSaleMainVisibility);
    document.getElementById("saleCommissionInput").addEventListener("change", updateSaleMainVisibility);
    updateSaleMainVisibility();

    setupVinAutocompleteSmart("vinInput", getAllVins);

    sourceTouched = false;
    markTouched("leadSourceInput", v=>sourceTouched=v);

    setupAutoFillFromVin();
    submitBtn.disabled = false;
  }

  // ---------- Auto fill Brand + Source from VIN ----------
  function setupAutoFillBrandByVinOnly() {
    const vinEl = document.getElementById("vinInput");
    const brandEl = document.getElementById("brandModelInput");
    if (!vinEl || !brandEl) return;

    let brandTouched = false;
    brandEl.addEventListener("input", ()=>{ brandTouched=true; });

    let tmr=null;
    const run = async () => {
      const v = normalizeVin(vinEl.value);
      if (!v || v.length < 4) return;

      if (!brandTouched && !brandEl.value) {
        const data = await lookupByVin(v);
        const bm = data?.brand_model || data?.brandModel || "";
        if (bm) brandEl.value = bm;
      }
    };

    vinEl.addEventListener("input", ()=>{
      if (tmr) clearTimeout(tmr);
      tmr=setTimeout(run, 350);
    });
    vinEl.addEventListener("change", run);
    vinEl.addEventListener("blur", run);
  }

  function setupAutoFillFromVin() {
    const vinEl = document.getElementById("vinInput");
    const brandEl = document.getElementById("brandModelInput");
    const sourceEl = document.getElementById("leadSourceInput");
    if (!vinEl || !brandEl) return;

    let brandTouched = false;
    brandEl.addEventListener("input", ()=>{ brandTouched=true; });

    let tmr=null;
    const run = async () => {
      const v = normalizeVin(vinEl.value);
      if (!v || v.length < 4) return;

      if (!brandTouched && !brandEl.value) {
        const data = await lookupByVin(v);
        const bm = data?.brand_model || data?.brandModel || "";
        if (bm) brandEl.value = bm;
      }

      // ✅ источник подтягиваем ТОЛЬКО если он пустой (чтобы ручной выбор не перетирался)
      if (sourceEl && !sourceEl.value) {
        const local = vinSourceMapGet(v);
        if (local) { setSelectValueSmart(sourceEl, local); return; }

        const srv = await sourceByVinServer(v);
        if (srv) {
          setSelectValueSmart(sourceEl, srv);
          vinSourceMapSet(v, srv);

          // ✅ чтобы строгая проверка "из списка" не ломалась даже если списки ещё не загрузились
          try {
            const cur = lsReadArr(LS_KEYS.SOURCES);
            const merged = mergeUnique([srv], cur);
            lsWriteArr(LS_KEYS.SOURCES, merged, 2000);
          } catch(e){}
        }
      }
    };

    vinEl.addEventListener("input", ()=>{
      if (tmr) clearTimeout(tmr);
      tmr=setTimeout(run, 350);
    });
    vinEl.addEventListener("change", run);
    vinEl.addEventListener("blur", run);
  }

  // ---------- Auto profit (sale_extra) ----------
  function toNum(v){
    const s = String(v||"").replace(/\s/g,"").replace(",",".").replace(/[^\d.\-]/g,"");
    const n = parseFloat(s);
    return Number.isFinite(n) ? n : 0;
  }
  function setupAutoProfit(){
    const priceEl = document.getElementById("priceInput");
    const buyEl = document.getElementById("buyPriceInput");
    const profitEl = document.getElementById("profitInput");
    if (!priceEl || !buyEl || !profitEl) return;

    let manual = false;
    profitEl.addEventListener("input", ()=>{ manual=true; });

    const recalc = () => {
      if (manual) return;
      const p = toNum(priceEl.value);
      const b = toNum(buyEl.value);
      if (!p && !b) return;
      const diff = p - b;
      profitEl.value = formatWithSpaces(String(Math.round(diff)));
    };

    priceEl.addEventListener("input", recalc);
    buyEl.addEventListener("input", recalc);
  }

  // ---------- boss_buy ----------
  function renderBossBuy() {
    formCard.innerHTML = "";

    // ✅ Руководитель: обязательность убрана
    formCard.appendChild(createInput("vinInput", "VIN (можно цифры подряд)", "Например: 1457 или полный VIN", "", "text", false, false));

    const modeWrap = document.createElement("div");
    modeWrap.className = "field";
    const modeLabel = document.createElement("label");
    modeLabel.textContent = "Что делаем?";
    const modeSelect = document.createElement("select");
    modeSelect.id = "modeSelect";
    modeSelect.innerHTML = `
      <option value="purchase">Новая закупка (создать VIN)</option>
      <option value="payment">Добавить оплату к VIN</option>
    `;
    const modeBadge = document.createElement("div");
    modeBadge.style.marginTop = "6px";
    modeBadge.innerHTML = `<span class="pill" id="modeBadge">Режим: —</span>`;
    modeWrap.appendChild(modeLabel);
    modeWrap.appendChild(modeSelect);
    modeWrap.appendChild(modeBadge);
    formCard.appendChild(modeWrap);

    const hint = document.createElement("div");
    hint.className = "hint";
    hint.textContent = "Подсказки VIN работают по вхождению (цифры подряд).";
    formCard.appendChild(hint);

    formCard.appendChild(document.createElement("div")).className = "divider";

    const purchaseBlock = document.createElement("div");
    purchaseBlock.id = "purchaseBlock";
    purchaseBlock.appendChild(createInput("purchaseDateInput", "Дата закупки", "", todayISO(), "date", false, false));
    purchaseBlock.appendChild(createAutocompleteInput("supplierInput", "Поставщик", "", mergeUnique(remoteCache.suppliers, lsReadArr("boss_buy_suppliers")), false));
    purchaseBlock.appendChild(createAutocompleteInput("placeInput", "Место закупки", "", mergeUnique(remoteCache.places, lsReadArr("boss_buy_places")), false));
    purchaseBlock.appendChild(createAutocompleteInput("brandModelInput", "Марка / Модель", "", getAllBrandModels(), false));
    purchaseBlock.appendChild(createInput("complectationInput", "Комплектация", "", "", "text", false, false));

    purchaseBlock.appendChild(
      createSelectKV("currencyInput", "Валюта ($ / ₽ / ¥)", [
        {value:"$", label:"$ (доллар)"},
        {value:"₽", label:"₽ (рубль)"},
        {value:"¥", label:"¥ (юань)"},
      ], "Выберите валюту", false)
    );

    purchaseBlock.appendChild(createInput("amountCurrencyInput", "Сумма, валюта", "", "", "text", false, false));
    purchaseBlock.appendChild(createInput("rateInput", "Курс (на дату первой оплаты)", "", "", "text", false, false));
    purchaseBlock.appendChild(createInput("amountRubInput", "Стоимость авто, ₽ (контроль)", "Авторасчёт", "", "text", true, false));
    purchaseBlock.appendChild(createTextarea("commentInput_p", "Комментарий", "По желанию", false, false));

    const paymentBlock = document.createElement("div");
    paymentBlock.id = "paymentBlock";
    paymentBlock.appendChild(createInput("payDateInput", "Дата оплаты", "", todayISO(), "date", false, false));
    paymentBlock.appendChild(
      createSelectKV("payCurrencySelect", "Валюта оплаты", [
        {value:"₽", label:"₽ (рубль)"},
        {value:"$", label:"$ (доллар)"},
        {value:"¥", label:"¥ (юань)"},
      ], "Выберите валюту", false)
    );
    paymentBlock.appendChild(createInput("payAmountCurrencyInput", "Сумма оплаты (валюта)", "", "", "text", false, false));
    paymentBlock.appendChild(createInput("payRateInput", "Курс на дату оплаты", "", "", "text", false, false));
    paymentBlock.appendChild(createInput("payRubInput", "Сумма оплаты (₽)", "Авторасчёт", "", "text", false, false));
    paymentBlock.appendChild(createTextarea("commentInput", "Комментарий", "По желанию", false, false));

    formCard.appendChild(purchaseBlock);
    formCard.appendChild(paymentBlock);

    function setMode(mode) {
      const badge = document.getElementById("modeBadge");
      const mSel = document.getElementById("modeSelect");
      if (mSel.value !== mode) mSel.value = mode;
      badge.textContent = "Режим: " + (mode === "payment" ? "Оплата" : "Новая закупка");
      showEl(purchaseBlock, mode === "purchase");
      showEl(paymentBlock, mode === "payment");
    }
    setMode("purchase");

    setupVinAutocompleteSmart("vinInput", getAllVins);

    ["amountCurrencyInput","rateInput","payAmountCurrencyInput","payRateInput","payRubInput"].forEach(setupMoneyInput);

    function recalcPurchaseRub() {
      const cur = document.getElementById("currencyInput")?.value || "";
      const a = toNum(document.getElementById("amountCurrencyInput")?.value);
      const r = toNum(document.getElementById("rateInput")?.value);
      const out = document.getElementById("amountRubInput");
      if (!out) return;
      if (!a) { out.value = ""; return; }
      if (cur === "₽") { out.value = formatWithSpaces(String(Math.round(a))); return; }
      if (a && r) out.value = formatWithSpaces(String(Math.round(a * r)));
      else out.value = "";
    }
    ["currencyInput","amountCurrencyInput","rateInput"].forEach(id => {
      const el = document.getElementById(id);
      if (el) { el.addEventListener("input", recalcPurchaseRub); el.addEventListener("change", recalcPurchaseRub); }
    });

    function recalcPayRub(){
      const cur = document.getElementById("payCurrencySelect")?.value || "₽";
      const a = toNum(document.getElementById("payAmountCurrencyInput")?.value);
      const r = toNum(document.getElementById("payRateInput")?.value);
      const out = document.getElementById("payRubInput");
      if (!out) return;
      if (!a) { out.value=""; return; }
      if (cur === "₽") { out.value = formatWithSpaces(String(Math.round(a))); return; }
      if (a && r) out.value = formatWithSpaces(String(Math.round(a * r)));
    }
    ["payCurrencySelect","payAmountCurrencyInput","payRateInput"].forEach(id=>{
      const el = document.getElementById(id);
      if (el) { el.addEventListener("input", recalcPayRub); el.addEventListener("change", recalcPayRub); }
    });

    document.getElementById("modeSelect").addEventListener("change", (e) => setMode(e.target.value));

    // ✅ NEW: автоподтягивание данных из таблицы руководителя по VIN (если есть)
    setupBossBuyAutofillFromVin();

    submitBtn.disabled = false;
  }

  // ✅ NEW: Boss_buy autofill from VIN (подтянуть заполненные поля)
  function setupBossBuyAutofillFromVin() {
    const vinEl = document.getElementById("vinInput");
    if (!vinEl) return;
    if (vinEl.dataset && vinEl.dataset.bossAuto === "1") return;
    vinEl.dataset.bossAuto = "1";

    let tmr=null;

    // ✅ строго устанавливаем значение (перезаписываем/очищаем), чтобы при смене VIN не оставался мусор
    const setValueStrict = (id, value, mode="text") => {
      const el = document.getElementById(id);
      if (!el) return;

      let v = (value === null || value === undefined) ? "" : String(value).trim();

      if (mode === "date") {
        const iso = toISODateMaybe(v);
        el.value = iso || "";
        return;
      }

      if (el.tagName === "SELECT") {
        if (!v) { el.value = ""; return; }
        setSelectValueSmart(el, v);
        return;
      }

      el.value = v;
    };

    const clearAll = () => {
      // закупка
      setValueStrict("purchaseDateInput", todayISO(), "date");
      setValueStrict("supplierInput", "");
      setValueStrict("placeInput", "");
      setValueStrict("brandModelInput", "");
      setValueStrict("complectationInput", "");
      setValueStrict("currencyInput", "");
      setValueStrict("amountCurrencyInput", "");
      setValueStrict("rateInput", "");
      setValueStrict("amountRubInput", "");
      setValueStrict("commentInput_p", "");

      // оплата
      setValueStrict("payDateInput", todayISO(), "date");
      setValueStrict("payCurrencySelect", "");
      setValueStrict("payAmountCurrencyInput", "");
      setValueStrict("payRateInput", "");
      setValueStrict("payRubInput", "");
      setValueStrict("commentInput", "");
    };

    const run = async () => {
      const v = normalizeVin(vinEl.value);
      if (!v || v.length < 4) return;

      const data = await lookupByVin(v); // для boss_buy getLookupUrl() уже BOSS

      // ✅ VIN не найден — чистим всё, даты возвращаем на todayISO()
      if (!data) { clearAll(); return; }

      // ✅ VIN найден — все поля отражают таблицу (если пусто в таблице → пусто в форме)
      setValueStrict("purchaseDateInput", data.purchase_date || data.purchaseDate || data.date || "", "date");
      setValueStrict("supplierInput", data.supplier || data.seller || "");
      setValueStrict("placeInput", data.purchase_place || data.place || data.purchasePlace || "");
      setValueStrict("brandModelInput", data.brand_model || data.brandModel || "");
      setValueStrict("complectationInput", data.complectation || "");

      setValueStrict("currencyInput", data.currency || "");
      setValueStrict("amountCurrencyInput", data.amount_currency || data.amountCurrency || "");
      setValueStrict("rateInput", data.rate_to_rub || data.rate || data.rateToRub || "");

      // поддержим разные названия поля стоимости из сервера
      setValueStrict("amountRubInput",
        data.amount_rub || data.amountRub || data.cost_rub || data.costRub || "",
        "text"
      );

      setValueStrict("payDateInput", data.pay_date || data.payDate || "", "date");
      setValueStrict("payCurrencySelect", data.pay_currency || data.payCurrency || "");
      setValueStrict("payAmountCurrencyInput",
        data.pay_amount_currency || data.payAmountCurrency || data.paid_fx || data.paidFx || "",
        "text"
      );
      setValueStrict("payRateInput", data.pay_rate || data.payRate || "");
      setValueStrict("payRubInput",
        data.pay_amount_rub || data.payAmountRub || data.pay_rub || data.paid_rub || data.paidRub || "",
        "text"
      );

      setValueStrict("commentInput_p", data.comment_purchase || data.comment_p || "");
      setValueStrict("commentInput", data.comment_pay || data.comment || "");
    };

    vinEl.addEventListener("input", ()=>{
      if (tmr) clearTimeout(tmr);
      tmr=setTimeout(run, 380);
    });
    vinEl.addEventListener("change", run);
    vinEl.addEventListener("blur", run);
  }

  // ---------- VALIDATION ----------
  function isFieldHidden(el){
    if (!el) return true;
    const field = el.closest(".field");
    if (!field) return false;
    return field.classList.contains("hidden");
  }

  function labelFor(el){
    if (!el || !el.id) return el?.id || "поле";
    const lab = formCard.querySelector(`label[for="${el.id}"]`);
    if (!lab) return el.id;
    return lab.textContent.replace("*","").trim();
  }

  // ✅ ЖЁСТКО: для менеджерских форм "Менеджер" и "Источник" должны быть строго из списка
  function enforceFromList(fieldId, getListFn, allowEmpty=true){
    const el = document.getElementById(fieldId);
    if (!el) return true;

    const v = String(el.value || "").trim();
    if (!v) return allowEmpty;

    const list = (typeof getListFn === "function") ? getListFn() : (getListFn || []);
    const map = new Map();
    (list || []).forEach(x => {
      const s = String(x||"").trim();
      if (!s) return;
      map.set(s.toLowerCase(), s);
    });

    const key = v.toLowerCase();
    if (map.has(key)) {
      // нормализуем написание
      el.value = map.get(key);
      return true;
    }

    showError(`Выбери значение из списка: ${labelFor(el)}.\n(Нельзя вводить вручную)`);
    return false;
  }

  function validateVisibleRequired(optionalIds = []) {
    const opt = new Set(optionalIds || []);
    const missing = [];

    const controls = formCard.querySelectorAll("input, select, textarea");
    controls.forEach(el=>{
      if (!el.id) return;
      if (opt.has(el.id)) return;

      const requiredFlag = el.dataset.required === "1";
      if (!requiredFlag) return;

      if (isFieldHidden(el)) return;

      const v = (el.value || "").trim();
      if (!v) missing.push(labelFor(el));
    });

    if (missing.length) {
      showError("Заполни обязательные поля:\n• " + missing.join("\n• "));
      return false;
    }
    showError("");
    return true;
  }

  function extraSaleScenarioValidation(){
    if (!isSaleMainLike(formType)) return true;

    const payment = document.getElementById("salePaymentTypeInput")?.value || "";
    const commission = (document.getElementById("saleCommissionInput")?.value || "no") === "yes";
    const vatYes = (document.getElementById("saleVatInput")?.value || "no") === "yes";
    const vat = (payment === "cashless") && vatYes;

    const mustHave = [];
    if (payment === "cash") {
      mustHave.push("priceCashInput");
      if (commission) mustHave.push("priceCashNoCommInput");
    } else if (payment === "cashless") {
      if (vat) {
        mustHave.push("priceNdsInput");
        mustHave.push("markupNdsInput");
        mustHave.push("priceNoVatCashInput");
      } else {
        mustHave.push("priceCashlessInput");
      }
      if (commission) {
        mustHave.push("contractPriceInput");
        mustHave.push("brokerPriceInput");
        mustHave.push("brokerExpenseInput");
      }
    }

    const missing = [];
    mustHave.forEach(id=>{
      const el = document.getElementById(id);
      if (!el) return;
      if (isFieldHidden(el)) return;
      if (!(el.value||"").trim()) missing.push(labelFor(el));
    });

    if (missing.length){
      showError("Заполни обязательные поля по выбранному варианту:\n• " + missing.join("\n• "));
      return false;
    }
    return true;
  }

  function validateBeforeSubmit() {
    // ✅ Финансист/Руководитель — обязательность полностью убрана
    if (isFinanceOrBossForms(formType)) return true;

    // ✅ Менеджер: Менеджер

    // ✅ Менеджерские формы: обычная проверка required + доп.проверка сценария продаж
    if (isManagerForms(formType)) {
      if (!validateVisibleRequired()) return false;
      if (!extraSaleScenarioValidation()) return false;

      // строгая проверка "из списка"
      if (document.getElementById("managerInput")) {
        if (!enforceFromList("managerInput", getAllManagers, false)) return false;
      }
      if (document.getElementById("leadSourceInput")) {
        if (!enforceFromList("leadSourceInput", getAllSources, false)) return false;
      }
      return true;
    }

    // по умолчанию
    return validateVisibleRequired();
  }

  // ---------- payload builder ----------
  function getVal(id){ return String(document.getElementById(id)?.value || "").trim(); }

  function buildSaleVariant() {
    const payment = document.getElementById("salePaymentTypeInput")?.value || "cash";
    const commission = (document.getElementById("saleCommissionInput")?.value || "no") === "yes";
    const vatYes = (document.getElementById("saleVatInput")?.value || "no") === "yes";
    const vat = (payment === "cashless") && vatYes;

    let variant = "";
    if (payment === "cash" && !commission) variant = "Нал / без брокера";
    if (payment === "cash" && commission) variant = "Нал / с брокером";
    if (payment === "cashless" && vat && !commission) variant = "Безнал / с НДС / без брокера";
    if (payment === "cashless" && vat && commission) variant = "Безнал / с НДС / с брокером";
    if (payment === "cashless" && !vat && !commission) variant = "Безнал / без НДС / без брокера";
    if (payment === "cashless" && !vat && commission) variant = "Безнал / без НДС / с брокером";
    return variant;
  }

  function buildPayload() {
    const base = {
      formType: formType,
      category: categoryFromUrl || "",
      appVersion: String(APP_VERSION || ""),
      ts: Date.now(),
    };

    // mgr_stock
    if (formType === "mgr_stock") {
      return {
        ...base,
        dealType: getVal("dealTypeInput"),
        manager: getVal("managerInput"),
        brand_model: getVal("brandModelInput"),
        vin: normalizeVin(getVal("vinInput")),
        complectation: getVal("configInput"),
        body_color: getVal("bodyColorInput"),
        salon_color: getVal("salonColorInput"),
        price: getVal("priceInput"),
        date: getRuDate("stockDateInput"),
        pay_type: getVal("payTypeInput"),
        client: getVal("clientInput"),
      };
    }

    // sale_deposit
    if (formType === "sale_deposit") {
      return {
        ...base,
        manager: getVal("managerInput"),
        sale_date: getRuDate("saleDateInput"),
        brand_model: getVal("brandModelInput"),
        vin: normalizeVin(getVal("vinInput")),
        source: getVal("leadSourceInput"),
        deposit_sum: getVal("depositSumInput"),
        receiver: getVal("receiverInput"),
        price: getVal("priceInput"),
        buyer: getVal("buyerInput"),
      };
    }

    // sale_extra
    if (formType === "sale_extra") {
      return {
        ...base,
        manager: getVal("managerInput"),
        sale_date: getRuDate("saleDateInput"),
        brand_model: getVal("brandModelInput"),
        vin: normalizeVin(getVal("vinInput")),
        source: getVal("leadSourceInput"),
        extra_desc: getVal("extraDescInput"),
        price: getVal("priceInput"),
        receiver: getVal("receiverInput"),
        purchaser: getVal("purchaserInput"),
        buy_price: getVal("buyPriceInput"),
        profit: getVal("profitInput"),
      };
    }

    // sale_main like
    if (isSaleMainLike(formType)) {
      const payment = getVal("salePaymentTypeInput"); // cash/cashless
      const vat = getVal("saleVatInput");             // yes/no
      const commission = getVal("saleCommissionInput"); // yes/no

      return {
        ...base,
        manager: getVal("managerInput"),
        sale_date: getRuDate("saleDateInput"),
        brand_model: getVal("brandModelInput"),
        vin: normalizeVin(getVal("vinInput")),
        source: getVal("leadSourceInput"),
        buyer: getVal("buyerInput"),
        receiver: getVal("receiverInput"),

        payment_type: payment,
        vat: vat,
        broker_commission: commission,
        variant: buildSaleVariant(),

        price_cash: getVal("priceCashInput"),
        price_cash_no_commission: getVal("priceCashNoCommInput"),

        price_cashless: getVal("priceCashlessInput"),
        price_nds: getVal("priceNdsInput"),
        markup_nds: getVal("markupNdsInput"),
        price_no_vat_cash: getVal("priceNoVatCashInput"),

        contract_price: getVal("contractPriceInput"),
        broker_price: getVal("brokerPriceInput"),
        broker_expense: getVal("brokerExpenseInput"),
      };
    }

    // fin_auto_template
    if (formType === "fin_auto_template") {
      return {
        ...base,
        vin: normalizeVin(getVal("vinInput")),
        brand_model: getVal("brandModelInput"),
        date: getRuDate("faDateInput"),
        evacuator: getVal("evacuatorInput"),
        lab: getVal("labInput"),
        util_writeoff: getVal("utilWriteoffInput"),
        util: getVal("utilInput"),
        presale: getVal("preSaleInput"),
        marketing: getVal("marketingInput"),
        other: getVal("otherInput"),
        extra_expenses: getVal("extraExpensesInput"),
        comment: getVal("commentInput"),
      };
    }

    // fin_company_expense
    if (formType === "fin_company_expense") {
      return {
        ...base,
        date: getRuDate("opDateInput"),
        article: getVal("expenseArticleInput"),
        amount: getVal("amountInput"),
        comment: getVal("commentInput"),
      };
    }

    // fin_company
    if (formType === "fin_company") {
      return {
        ...base,
        date: getRuDate("opDateInput"),
        category: getVal("categoryInput"),
        amount: getVal("amountInput"),
        comment: getVal("commentInput"),
      };
    }

    // boss_buy
    if (formType === "boss_buy") {
      const mode = getVal("modeSelect") || "purchase";
      return {
        ...base,
        mode: mode,
        vin: normalizeVin(getVal("vinInput")),

        // purchase block
        purchase_date: getRuDate("purchaseDateInput"),
        supplier: getVal("supplierInput"),
        purchase_place: getVal("placeInput"),
        brand_model: getVal("brandModelInput"),
        complectation: getVal("complectationInput"),
        currency: getVal("currencyInput"),
        amount_currency: getVal("amountCurrencyInput"),
        rate_to_rub: getVal("rateInput"),
        cost_rub: getVal("amountRubInput"),
        comment_purchase: getVal("commentInput_p"),

        // payment block
        pay_date: getRuDate("payDateInput"),
        pay_currency: getVal("payCurrencySelect"),
        paid_fx: getVal("payAmountCurrencyInput"),
        pay_rate: getVal("payRateInput"),
        paid_rub: getVal("payRubInput"),
        comment_pay: getVal("commentInput"),
      };
    }

    // boss_invest_in / boss_invest_out
    if (formType === "boss_invest_in" || formType === "boss_invest_out") {
      return {
        ...base,
        investor: getVal("investorInput"),
        sum: getVal("sumInput"),
        date: getRuDate("opDateInput"),
        comment: getVal("commentInput"),
      };
    }

    // fallback
    return {
      ...base,
      raw: getVal("rawInput"),
    };
  }

  // ---------- submit ----------
  function handleSubmit() {
    showError("");

    if (!validateBeforeSubmit()) return;

    const payload = buildPayload();

    // запоминаем VIN локально
    if (payload && payload.vin) rememberVin(payload.vin);

    // safety: disable to prevent double tap
    submitBtn.disabled = true;

    try {
      if (tg && typeof tg.sendData === "function") {
        tg.sendData(JSON.stringify(payload));
      } else {
        console.log("payload:", payload);
        tgAlert("WebApp открыт вне Telegram. Данные в консоли.");
      }
    } catch (e) {
      console.warn(e);
      showError("Ошибка отправки: " + String(e?.message || e));
      submitBtn.disabled = false;
    }
  }

  // clear error on input
  formCard.addEventListener("input", () => showError(""));
  formCard.addEventListener("change", () => showError(""));

  // submit listeners (iOS fix)
  submitBtn.addEventListener("click", (e) => {
    e.preventDefault();
    handleSubmit();
  });

  if (IS_IOS) {
    submitBtn.addEventListener("touchstart", (e) => {
      e.preventDefault();
      handleSubmit();
    }, { passive: false });
  }

  // ---------- init ----------
  renderForm();
  scheduleRemoteListsLoad();

</script>
</body>
</html>
