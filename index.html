<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Автолинк WebApp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="preconnect" href="https://telegram.org">
  <link rel="preconnect" href="https://script.google.com">
  <link rel="dns-prefetch" href="https://telegram.org">
  <link rel="dns-prefetch" href="https://script.google.com">
<script defer src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: #0f172a;
      color: #e5e7eb;
    }
    h1 {
      font-size: 20px;
      margin: 0 0 4px;
      text-align: center;
    }
    .subtitle {
      font-size: 13px;
      text-align: center;
      color: #94a3b8;
      margin-bottom: 16px;
      line-height: 1.35;
    }
    .card {
      background: #111827;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.5);
      max-width: 560px;
      margin: 0 auto;
    }
    .field {
      margin-bottom: 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    label {
      font-size: 13px;
      color: #9ca3af;
    }
    input, select, textarea {
      border-radius: 10px;
      border: 1px solid #374151;
      padding: 8px 10px;
      font-size: 14px;
      background: #020617;
      color: #e5e7eb;
      outline: none;
    }
    input:focus, select:focus, textarea:focus {
      border-color: #38bdf8;
    }
    textarea {
      min-height: 90px;
      resize: vertical;
    }
    .readonly {
      background: #020617;
      color: #9ca3af;
    }
    .hint {
      font-size: 12px;
      color: #94a3b8;
      line-height: 1.35;
      margin-top: 4px;
    }
    .pill {
      display: inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      background: #0b1226;
      border: 1px solid #334155;
      color: #cbd5e1;
      font-size: 12px;
    }
    .divider {
      height: 1px;
      background: #1f2937;
      margin: 14px 0;
    }
    .hidden { display:none; }

    button#submitBtn {
      width: 100%;
      border-radius: 999px;
      border: none;
      padding: 10px 14px;
      font-size: 15px;
      font-weight: 600;
      background: linear-gradient(135deg, #38bdf8, #6366f1);
      color: white;
      cursor: pointer;
      margin-top: 12px;
    }
    button#submitBtn:disabled {
      opacity: .5;
      cursor: default;
    }

    /* --- MULTI OWNER UI (СТОК) --- */
    .owner-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 6px;
    }
    .owner-row input { flex: 1; }
    .mini-btn {
      border: 1px solid #374151;
      background: #0b1220;
      color: #e5e7eb;
      border-radius: 10px;
      padding: 8px 10px;
      cursor: pointer;
      white-space: nowrap;
    }
    .mini-btn:active { transform: translateY(1px); }
  </style>
</head>
<body>
  <h1>Автолинк</h1>
  <div class="subtitle" id="subtitle"></div>

  <div class="card" id="formCard"></div>
  <button id="submitBtn" disabled>Отправить в бота</button>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    // --- Service Worker cache (ускоряет повторные открытия WebApp) ---
    try {
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("./sw.js?v=2025-12-21-1").catch(()=>{});
      }
    } catch(e) {}

    const formType = urlParams.get("type") || "unknown";

    const categoryFromUrl = urlParams.get("category") || "";
    
    const brandsParam = urlParams.get("brands") || "";
    const investorsParam = urlParams.get("investors") || "";
    const sourcesParam = urlParams.get("sources") || "";
    const vinsParam = urlParams.get("vins") || "";
    const currenciesParam = urlParams.get("currencies") || "";
    const bossVinsParam = urlParams.get("bossvins") || "";

    // Небольшие списки — разбираем сразу
    const brands = brandsParam ? brandsParam.split("|") : [];
    const investors = investorsParam ? investorsParam.split("|") : [];
    const sources = sourcesParam ? sourcesParam.split("|") : [];
    const currencies = currenciesParam ? currenciesParam.split("|") : [];
    const bossVins = bossVinsParam ? bossVinsParam.split("|") : [];

    // VIN-список может быть большим → разбираем ЛЕНИВО, чтобы WebApp открывался быстрее
    const LS_GLOBAL = { VINS: "ref_vins_cache_v1" };
    let vins = [];               // будет заполнен из URL в idle
    let vinsWarmStarted = false; // чтобы не запускать дважды
    let allVinsCache = null;

    function lsReadArr(key) {
      try {
        const raw = localStorage.getItem(key);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      } catch (e) { return []; }
    }
    function lsWriteArr(key, arr, limit = 2000) {
      try {
        const out = (arr || []).slice(0, limit);
        localStorage.setItem(key, JSON.stringify(out));
      } catch (e) {}
    }

    function normalizeVinQuick(v) { return String(v || "").trim().toUpperCase(); }

    function scheduleWarmVinsFromUrl() {
      if (vinsWarmStarted) return;
      if (!vinsParam || vinsParam.length < 4) return;
      vinsWarmStarted = true;

      const run = () => {
        try {
          // split может быть тяжёлым → делаем после первого рендера
          vins = vinsParam.split("|").map(normalizeVinQuick).filter(Boolean);
          // сохраним для следующих открытий (чтобы даже без vinsParam подсказки были)
          const merged = mergeUnique(vins, lsReadArr(LS_GLOBAL.VINS));
          lsWriteArr(LS_GLOBAL.VINS, merged, 2500);
          allVinsCache = null; // invalidate
          // если input VIN уже есть — обновим подсказки
          updateDatalist("vinInput_list", getAllVins());
        } catch (e) {
          console.warn("warm vins failed:", e);
        }
      };

      if ("requestIdleCallback" in window) {
        requestIdleCallback(run, { timeout: 1200 });
      } else {
        setTimeout(run, 200);
      }
    }


    const subtitleEl = document.getElementById("subtitle");
    const formCard = document.getElementById("formCard");
    const submitBtn = document.getElementById("submitBtn");

    const FORM_TITLES = {
      mgr_stock: "Сток",
      sale_nds_broker: "Продажа — НДС с комиссией брокера",
      sale_nds_no_broker: "Продажа — НДС без комиссии брокера",
      sale_cash: "Продажа — Наличные",
      sale_cash_broker: "Продажа — Наличные с комиссией",
      sale_deposit: "Продажа — Задаток",
      sale_extra: "Продажа — Доп. услуги",
      fin_auto_template: "Расходы на авто РФ",
      fin_oper: "Оперрасходы",
      boss_buy: "Закупка / Оплата по VIN",
      boss_invest_in: "Инвестиции — ввод",
      boss_invest_out: "Инвестиции — вывод",
    };

    subtitleEl.textContent =
      "Форма: " + (FORM_TITLES[formType] || formType) +
      (categoryFromUrl ? " | Категория: " + categoryFromUrl : "");

    function todayISO() {
      return new Date().toISOString().slice(0, 10);
    }

    function formatDateToRu(value) {
      if (!value) return "";
      const parts = value.split("-");
      if (parts.length === 3) {
        const [y, m, d] = parts;
        return `${d}.${m}.${y}`;
      }
      return value;
    }


    // ---------- Local cache for dropdowns (VIN / supplier / place / brand_model) ----------
    const LS_KEYS = {
      VINS: "boss_buy_vins",
      SUPPLIERS: "boss_buy_suppliers",
      PLACES: "boss_buy_places",
      BRAND_MODELS: "boss_buy_brand_models",
    };
    // ===================== OPTIONAL REMOTE LOOKUP (Google Apps Script JSONP) =====================
    // Чтобы подтягивать данные по VIN из Google Sheets:
    // 1) Разверни Apps Script Web App (см. Code.gs из моего сообщения)
    // 2) Вставь ссылку вида https://script.google.com/macros/s/XXXX/exec в LOOKUP_API_URL
    // Если LOOKUP_API_URL пустой — всё работает как раньше, просто без автоподтягивания.

   const LOOKUP_API_URL = "https://script.google.com/macros/s/AKfycbyCSjWIYwn58Z2843yPmTZvM8vLtpzdmG_AOCa3VWb2_JnFgCOgc4KklrozyePbiz5G7g/exec";
   const LOOKUP_API_TOKEN = "";


    const remoteCache = { vins: [], suppliers: [], places: [], brand_models: [] };
    let remoteListsLoaded = false;

    function canUseLookup() {
      return typeof LOOKUP_API_URL === "string" && LOOKUP_API_URL.trim().startsWith("https://");
    }

    function updateDatalist(dlId, options) {
      const dl = document.getElementById(dlId);
      if (!dl) return;
      dl.innerHTML = "";
      (options || []).slice(0, 200).forEach((opt) => {
        const o = document.createElement("option");
        o.value = opt;
        dl.appendChild(o);
      });
    }

    function jsonpRequest(baseUrl, params, timeoutMs = 8000) {
      return new Promise((resolve, reject) => {
        const cb = "__cb_" + Math.random().toString(36).slice(2);
        const q = new URLSearchParams(params || {});
        q.set("callback", cb);
        if (LOOKUP_API_TOKEN) q.set("token", LOOKUP_API_TOKEN);

        const src = baseUrl + (baseUrl.includes("?") ? "&" : "?") + q.toString();
        const script = document.createElement("script");
        let done = false;

        function cleanup() {
          if (script && script.parentNode) script.parentNode.removeChild(script);
          try { delete window[cb]; } catch (e) { window[cb] = undefined; }
        }

        const timer = setTimeout(() => {
          if (done) return;
          done = true;
          cleanup();
          reject(new Error("Lookup timeout"));
        }, timeoutMs);

        window[cb] = (data) => {
          if (done) return;
          done = true;
          clearTimeout(timer);
          cleanup();
          resolve(data);
        };

        script.onerror = () => {
          if (done) return;
          done = true;
          clearTimeout(timer);
          cleanup();
          reject(new Error("Lookup request failed"));
        };

        script.src = src;
        document.body.appendChild(script);
      });
    }

    async function remoteListsLoad(force = false) {
      if (!canUseLookup()) return;

      const TS_KEY = "boss_buy_lists_ts";
      const TTL_MS = 12 * 60 * 60 * 1000; // 12 часов

      if (!force) {
        try {
          const ts = parseInt(localStorage.getItem(TS_KEY) || "0", 10);
          if (ts && (Date.now() - ts) < TTL_MS) {
            return; // свежие списки уже закешированы
          }
        } catch (e) {}
      }

      try {
        const res = await jsonpRequest(LOOKUP_API_URL, { action: "lists" });
        if (res && res.ok && res.lists) {
          remoteCache.vins = res.lists.vins || [];
          remoteCache.suppliers = res.lists.suppliers || [];
          remoteCache.places = res.lists.places || [];
          remoteCache.brand_models = res.lists.brand_models || [];
          remoteListsLoaded = true;
          try { allVinsCache = null; } catch(e) {}

          // Сохраним в localStorage, чтобы подсказки работали быстрее
          if (remoteCache.vins.length) lsWrite(LS_KEYS.VINS, mergeUnique(remoteCache.vins, lsRead(LS_KEYS.VINS)), 800);
          if (remoteCache.suppliers.length) lsWrite(LS_KEYS.SUPPLIERS, mergeUnique(remoteCache.suppliers, lsRead(LS_KEYS.SUPPLIERS)), 400);
          if (remoteCache.places.length) lsWrite(LS_KEYS.PLACES, mergeUnique(remoteCache.places, lsRead(LS_KEYS.PLACES)), 400);
          if (remoteCache.brand_models.length) lsWrite(LS_KEYS.BRAND_MODELS, mergeUnique(remoteCache.brand_models, lsRead(LS_KEYS.BRAND_MODELS)), 600);

          try { localStorage.setItem(TS_KEY, String(Date.now())); } catch(e) {}

          // Обновим datalist'ы, если форма уже отрендерилась
          updateDatalist("vinInput_list", getAllVins());
          updateDatalist("supplierInput_list", mergeUnique(remoteCache.suppliers, lsRead(LS_KEYS.SUPPLIERS)));
          updateDatalist("placeInput_list", mergeUnique(remoteCache.places, lsRead(LS_KEYS.PLACES)));
          updateDatalist("brandModelInput_list", mergeUnique(remoteCache.brand_models, lsRead(LS_KEYS.BRAND_MODELS)));
        }
      } catch (e) {
        console.warn("remoteListsLoad failed:", e);
      }
    }


    function normalizeVin(v) {
      return String(v || "").trim().toUpperCase();
    }

    function getVinCandidates() {
      return mergeUnique(remoteCache.vins || [], getAllVins());
    }

    function resolveFullVin(vinRaw) {
      const v = normalizeVin(vinRaw);
      if (!v) return "";
      if (v.length === 17) return v;

      const cand = getVinCandidates();
      if (v.length >= 4 && v.length < 17) {
        const matches = cand.filter(x => normalizeVin(x).endsWith(v));
        if (matches.length === 1) return matches[0];
        return ""; // неоднозначно — пусть выберет из списка
      }
      return v;
    }

    async function lookupByVin(vinRaw) {
      if (!canUseLookup()) return null;
      const fullVin = resolveFullVin(vinRaw);
      if (!fullVin) return null;

      try {
        const res = await jsonpRequest(LOOKUP_API_URL, { action: "lookup", vin: fullVin });
        if (res && res.ok && res.found && res.data) return res.data;
      } catch (e) {
        console.warn("lookupByVin failed:", e);
      }
      return null;
    }

    function setValueIfExists(id, val) {
      const el = document.getElementById(id);
      if (!el) return;
      if (val === null || typeof val === "undefined") return;
      el.value = String(val);
    }

    function prefillBossBuyFields(data) {
      if (!data) return;
      if (data.vin) setValueIfExists("vinInput", data.vin);

      setValueIfExists("purchaseDateInput", data.purchase_date || "");
      setValueIfExists("supplierInput", data.supplier || "");
      setValueIfExists("placeInput", data.purchase_place || "");
      setValueIfExists("brandModelInput", data.brand_model || "");
      setValueIfExists("complectationInput", data.complectation || "");

      if (document.getElementById("currencyInput")) setValueIfExists("currencyInput", data.currency || "");
      setValueIfExists("amountCurrencyInput", data.amount_currency || "");
      setValueIfExists("rateInput", data.rate_to_rub || "");

      // опционально показать рассчитанную стоимость (если есть в таблице)
      if (document.getElementById("amountRubInput")) {
        setValueIfExists("amountRubInput", data.cost_rub || "");
      }
    }

    async function prefillBossBuyByVin(vinRaw) {
      const data = await lookupByVin(vinRaw);
      if (data) prefillBossBuyFields(data);
    }



    function lsRead(key) {
      try {
        const v = localStorage.getItem(key);
        const arr = v ? JSON.parse(v) : [];
        return Array.isArray(arr) ? arr.filter(Boolean) : [];
      } catch (e) { return []; }
    }

    function lsWrite(key, arr, maxLen = 200) {
      try {
        const clean = (Array.isArray(arr) ? arr : []).filter(Boolean).slice(0, maxLen);
        localStorage.setItem(key, JSON.stringify(clean));
      } catch (e) {}
    }

    function lsAdd(key, value, maxLen = 200) {
      const v = String(value || "").trim();
      if (!v) return;
      const arr = lsRead(key);
      const lo = v.toLowerCase();
      const filtered = arr.filter(x => String(x).trim().toLowerCase() !== lo);
      filtered.unshift(v);
      lsWrite(key, filtered, maxLen);
    }

    function mergeUnique(...arrays) {
      const out = [];
      const seen = new Set();
      arrays.flat().forEach((x) => {
        const s = String(x || "").trim();
        if (!s) return;
        const k = s.toLowerCase();
        if (seen.has(k)) return;
        seen.add(k);
        out.push(s);
      });
      return out;
    }

    function getAllVins() {
      // Кэшируем, чтобы не пересобирать массив на каждый keypress
      if (allVinsCache) return allVinsCache;

      const globalCached = lsReadArr(LS_GLOBAL.VINS).map(normalizeVinQuick).filter(Boolean);
      const bossCached = (typeof LS_KEYS !== "undefined") ? (lsRead(LS_KEYS.VINS) || []).map(normalizeVinQuick).filter(Boolean) : [];
      const remoteV = (typeof remoteCache !== "undefined" && remoteCache && remoteCache.vins) ? remoteCache.vins.map(normalizeVinQuick).filter(Boolean) : [];

      // vins (из URL) появится позже — но если уже прогрето, тоже попадёт
      const urlV = (vins || []).map(normalizeVinQuick).filter(Boolean);

      allVinsCache = mergeUnique((bossVins || []).map(normalizeVinQuick), globalCached, bossCached, remoteV, urlV);

      // фоном распарсим большой параметр vins=...
      scheduleWarmVinsFromUrl();
      return allVinsCache;
    }
    function warmLocalDatalists() {
      // мгновенно подставляем подсказки из localStorage (без сети)
      updateDatalist("vinInput_list", getAllVins());
      updateDatalist("supplierInput_list", lsRead(LS_KEYS.SUPPLIERS));
      updateDatalist("placeInput_list", lsRead(LS_KEYS.PLACES));
      updateDatalist("brandModelInput_list", lsRead(LS_KEYS.BRAND_MODELS));
    }



    function cacheBossBuyPayload(payload) {
      if (!payload || payload.formType !== "boss_buy") return;

      const vin = String(payload.vin || "").trim().toUpperCase();
      if (vin) lsAdd(LS_KEYS.VINS, vin);

      if (payload.brand_model) lsAdd(LS_KEYS.BRAND_MODELS, payload.brand_model);
      if (payload.supplier) lsAdd(LS_KEYS.SUPPLIERS, payload.supplier);
      if (payload.purchase_place) lsAdd(LS_KEYS.PLACES, payload.purchase_place);
    }

    function getRuDate(id) {
      const el = document.getElementById(id);
      if (!el) return "";
      return formatDateToRu(el.value);
    }

    function showEl(el, show) {
      if (!el) return;
      el.classList.toggle("hidden", !show);
    }

    function parseNum(v) {
      if (!v) return 0;
      const n = parseFloat(String(v).replace(/\s/g, "").replace(",", "."));
      return isFinite(n) ? n : 0;
    }

    function createInput(id, labelText, placeholder = "", value = "", type = "text", readonly = false) {
      const w = document.createElement("div");
      w.className = "field";
      const l = document.createElement("label");
      l.htmlFor = id;
      l.textContent = labelText;
      const i = document.createElement("input");
      i.id = id;
      i.placeholder = placeholder;
      i.type = type;
      if (value) i.value = value;
      if (readonly) {
        i.readOnly = true;
        i.classList.add("readonly");
      }
      if (id.toLowerCase().includes("vin")) i.maxLength = 17;
      w.appendChild(l);
      w.appendChild(i);
      return w;
    }

    function createTextarea(id, labelText, placeholder = "", readonly = false) {
      const w = document.createElement("div");
      w.className = "field";
      const l = document.createElement("label");
      l.htmlFor = id;
      l.textContent = labelText;
      const t = document.createElement("textarea");
      t.id = id;
      t.placeholder = placeholder;
      if (readonly) {
        t.readOnly = true;
        t.classList.add("readonly");
      }
      w.appendChild(l);
      w.appendChild(t);
      return w;
    }

    function createSelectSimple(id, labelText, options, placeholder = "Выберите...") {
      const w = document.createElement("div");
      w.className = "field";
      const l = document.createElement("label");
      l.htmlFor = id;
      l.textContent = labelText;
      const s = document.createElement("select");
      s.id = id;

      const ph = document.createElement("option");
      ph.value = "";
      ph.textContent = placeholder;
      ph.disabled = true;
      ph.selected = true;
      s.appendChild(ph);

      options.forEach((opt) => {
        const o = document.createElement("option");
        o.value = opt;
        o.textContent = opt;
        s.appendChild(o);
      });

      w.appendChild(l);
      w.appendChild(s);
      return w;
    }

    function createSelectKV(id, labelText, options, placeholder = "Выберите...") {
      // options: [{value, label}]
      const w = document.createElement("div");
      w.className = "field";
      const l = document.createElement("label");
      l.htmlFor = id;
      l.textContent = labelText;
      const s = document.createElement("select");
      s.id = id;

      const ph = document.createElement("option");
      ph.value = "";
      ph.textContent = placeholder;
      ph.disabled = true;
      ph.selected = true;
      s.appendChild(ph);

      options.forEach((opt) => {
        const o = document.createElement("option");
        o.value = opt.value;
        o.textContent = opt.label;
        s.appendChild(o);
      });

      w.appendChild(l);
      w.appendChild(s);
      return w;
    }

    function createAutocompleteInput(id, labelText, placeholder = "", options = []) {
      const w = document.createElement("div");
      w.className = "field";
      const l = document.createElement("label");
      l.htmlFor = id;
      l.textContent = labelText;
      const i = document.createElement("input");
      i.id = id;
      i.placeholder = placeholder;

      if (options && options.length) {
        const dlId = id + "_list";
        i.setAttribute("list", dlId);
        let dl = document.getElementById(dlId);
        if (!dl) {
          dl = document.createElement("datalist");
          dl.id = dlId;
          document.body.appendChild(dl);
        }
        dl.innerHTML = "";
        options.slice(0, 300).forEach((opt) => {
          const o = document.createElement("option");
          o.value = opt;
          dl.appendChild(o);
        });
      }

      w.appendChild(l);
      w.appendChild(i);
      return w;
    }

    // ---------- VIN autocomplete (smart: last 4 + contains) ----------
    function setupVinAutocompleteSmart(inputId, allVins) {
      const input = document.getElementById(inputId);
      if (!input) return;

      // не навешиваем обработчики повторно
      if (input.dataset && input.dataset.vinAuto === "1") return;
      if (input.dataset) input.dataset.vinAuto = "1";

      const listId = inputId + "_list";
      let datalist = document.getElementById(listId);
      if (!datalist) {
        datalist = document.createElement("datalist");
        datalist.id = listId;
        document.body.appendChild(datalist);
      }
      input.setAttribute("list", listId);

      function normalize(x) { return String(x || "").trim().toUpperCase(); }

      function getSource() {
        try {
          const src = (typeof allVins === "function") ? allVins() : allVins;
          return Array.isArray(src) ? src : [];
        } catch (e) {
          return Array.isArray(allVins) ? allVins : [];
        }
      }

      function fill(filter) {
        const source = getSource();
        const f = String(filter || "").trim().toLowerCase();

        datalist.innerHTML = "";

        // чтобы форма открывалась быстрее — не набиваем 100+ опций сразу
        if (!f || f.length < 2) return;

        const out = [];
        for (let i = 0; i < source.length; i++) {
          const v = normalize(source[i]);
          if (!v) continue;
          const lo = v.toLowerCase();
          if (lo.includes(f) || lo.endsWith(f)) out.push(v);
          if (out.length >= 80) break;
        }

        out.forEach(v => {
          const o = document.createElement("option");
          o.value = v;
          datalist.appendChild(o);
        });
      }

      // ленивое наполнение
      input.addEventListener("focus", () => fill(input.value));
      input.addEventListener("input", () => fill(input.value));
    }



    // ---------- MULTI OWNER (Сток) ----------
    function createMultiOwnerInput(options = []) {
      const wrapper = document.createElement("div");
      wrapper.className = "field";

      const label = document.createElement("label");
      label.textContent = "Собственники (можно несколько)";
      wrapper.appendChild(label);

      const hint = document.createElement("div");
      hint.className = "hint";
      hint.textContent = "Каждый собственник — отдельной строкой. В таблицу уйдёт в одну ячейку «в столбик».";
      wrapper.appendChild(hint);

      const container = document.createElement("div");
      container.id = "ownersContainer";
      wrapper.appendChild(container);

      const datalistId = "owners_list";
      let datalist = document.getElementById(datalistId);
      if (!datalist) {
        datalist = document.createElement("datalist");
        datalist.id = datalistId;
        document.body.appendChild(datalist);
      }
      datalist.innerHTML = "";
      options.forEach((opt) => {
        const o = document.createElement("option");
        o.value = opt;
        datalist.appendChild(o);
      });

      function addOwnerRow(value = "") {
        const row = document.createElement("div");
        row.className = "owner-row";

        const input = document.createElement("input");
        input.placeholder = "Начните вводить собственника";
        input.classList.add("owner-item");
        input.setAttribute("list", datalistId);
        if (value) input.value = value;

        const del = document.createElement("button");
        del.type = "button";
        del.className = "mini-btn";
        del.textContent = "✖";
        del.title = "Удалить";
        del.addEventListener("click", () => {
          row.remove();
          const still = container.querySelectorAll(".owner-item");
          if (!still.length) addOwnerRow("");
        });

        row.appendChild(input);
        row.appendChild(del);
        container.appendChild(row);
      }

      addOwnerRow("");

      const addBtn = document.createElement("button");
      addBtn.type = "button";
      addBtn.className = "mini-btn";
      addBtn.textContent = "➕ Добавить собственника";
      addBtn.style.marginTop = "8px";
      addBtn.addEventListener("click", () => addOwnerRow(""));
      wrapper.appendChild(addBtn);

      return wrapper;
    }

    function collectOwners() {
      const items = Array.from(document.querySelectorAll(".owner-item"))
        .map(el => (el.value || "").trim())
        .filter(Boolean);
      return [...new Set(items)];
    }

    // ===================== RENDER FORMS =====================

    function renderBossBuy() {
      formCard.innerHTML = "";

      const allVinOptions = getAllVins();

      formCard.appendChild(createInput(
        "vinInput",
        "VIN (можно последние 4 символа)",
        "Последние 4 или полный VIN"
      ));

      // MODE
      const modeWrap = document.createElement("div");
      modeWrap.className = "field";
      const modeLabel = document.createElement("label");
      modeLabel.textContent = "Что делаем?";
      const modeSelect = document.createElement("select");
      modeSelect.id = "modeSelect";
      modeSelect.innerHTML = `
        <option value="purchase">Новая закупка (создать VIN)</option>
        <option value="payment">Добавить оплату к VIN</option>
      `;
      const modeBadge = document.createElement("div");
      modeBadge.style.marginTop = "6px";
      modeBadge.innerHTML = `<span class="pill" id="modeBadge">Режим: —</span>`;
      modeWrap.appendChild(modeLabel);
      modeWrap.appendChild(modeSelect);
      modeWrap.appendChild(modeBadge);
      formCard.appendChild(modeWrap);

      const hint = document.createElement("div");
      hint.className = "hint";
      hint.textContent = "Если VIN уже есть в таблице руководителя («Закупка»), форма сама переключится в «Оплата».";
      formCard.appendChild(hint);

      const divider = document.createElement("div");
      divider.className = "divider";
      formCard.appendChild(divider);

      // PURCHASE BLOCK
      const purchaseBlock = document.createElement("div");
      purchaseBlock.id = "purchaseBlock";

      purchaseBlock.appendChild(createInput("purchaseDateInput", "Дата закупки", "", todayISO(), "date"));
      purchaseBlock.appendChild(createAutocompleteInput("supplierInput", "Поставщик", "Например, дилер/компания", lsRead(LS_KEYS.SUPPLIERS)));
      purchaseBlock.appendChild(createAutocompleteInput("placeInput", "Место закупки", "Например, Япония / РФ / Китай", lsRead(LS_KEYS.PLACES)));
      purchaseBlock.appendChild(createAutocompleteInput("brandModelInput", "Марка / Модель", "Например, BMW X5", mergeUnique(brands, lsRead(LS_KEYS.BRAND_MODELS))));
      purchaseBlock.appendChild(createInput("complectationInput", "Комплектация", "Например, M Sport"));

      purchaseBlock.appendChild(
        createSelectKV("currencyInput", "Валюта ($ / ₽ / ¥)", [
          {value:"$", label:"$ (доллар)"},
          {value:"₽", label:"₽ (рубль)"},
          {value:"¥", label:"¥ (юань)"},
        ], "Выберите валюту")
      );

      purchaseBlock.appendChild(createInput("amountCurrencyInput", "Сумма, валюта", "Например, 100000"));
      purchaseBlock.appendChild(createInput("rateInput", "Курс (на дату первой оплаты)", "Например, 80"));
      purchaseBlock.appendChild(createInput("amountRubInput", "Стоимость авто, ₽ (для контроля)", "Авторасчёт", "", "text", true));

      // optional payment on purchase
      purchaseBlock.appendChild(createSelectKV("payNowSelect", "Добавить оплату сейчас?", [
        {value:"no", label:"Нет"},
        {value:"yes", label:"Да"},
      ], "Выберите..."));

      const purchasePayBlock = document.createElement("div");
      purchasePayBlock.id = "purchasePayBlock";
      purchasePayBlock.className = "hidden";

      purchasePayBlock.appendChild(createInput("payDateInput_p", "Дата оплаты", "", todayISO(), "date"));
      purchasePayBlock.appendChild(
        createSelectKV("payCurrencySelect_p", "Валюта оплаты", [
          {value:"₽", label:"₽ (рубль)"},
          {value:"$", label:"$ (доллар)"},
          {value:"¥", label:"¥ (юань)"},
        ], "Выберите валюту")
      );

      const payAmountWrapP = createInput("payAmountCurrencyInput_p", "Сумма оплаты (валюта)", "Например, 20000");
      const payRateWrapP = createInput("payRateInput_p", "Курс на дату оплаты", "Например, 82");
      const payRubWrapP = createInput("payRubInput_p", "Сумма оплаты (₽)", "Авторасчёт", "", "text", false);

      purchasePayBlock.appendChild(payAmountWrapP);
      purchasePayBlock.appendChild(payRateWrapP);
      purchasePayBlock.appendChild(payRubWrapP);

      purchaseBlock.appendChild(purchasePayBlock);
      purchaseBlock.appendChild(createTextarea("commentInput_p", "Комментарий", "По желанию"));

      // PAYMENT BLOCK
      const paymentBlock = document.createElement("div");
      paymentBlock.id = "paymentBlock";

      paymentBlock.appendChild(createInput("payDateInput", "Дата оплаты", "", todayISO(), "date"));
      paymentBlock.appendChild(
        createSelectKV("payCurrencySelect", "Валюта оплаты", [
          {value:"₽", label:"₽ (рубль)"},
          {value:"$", label:"$ (доллар)"},
          {value:"¥", label:"¥ (юань)"},
        ], "Выберите валюту")
      );

      const fxWrap = document.createElement("div");
      fxWrap.id = "fxWrap";
      fxWrap.appendChild(createInput("payAmountCurrencyInput", "Сумма оплаты (валюта)", "Например, 20000"));
      fxWrap.appendChild(createInput("payRateInput", "Курс на дату оплаты", "Например, 82"));
      fxWrap.appendChild(createInput("payRubInput", "Сумма оплаты (₽)", "Авторасчёт", "", "text", false));

      const rubWrap = document.createElement("div");
      rubWrap.id = "rubWrap";
      rubWrap.appendChild(createInput("payRubOnlyInput", "Сумма оплаты (₽)", "Например, 500000"));

      paymentBlock.appendChild(fxWrap);
      paymentBlock.appendChild(rubWrap);
      paymentBlock.appendChild(createTextarea("commentInput", "Комментарий", "По желанию"));

      formCard.appendChild(purchaseBlock);
      formCard.appendChild(paymentBlock);

      // wiring
      setupVinAutocompleteSmart("vinInput", getAllVins);

      function setMode(mode) {
        const badge = document.getElementById("modeBadge");
        const mSel = document.getElementById("modeSelect");
        if (mSel.value !== mode) mSel.value = mode;
        badge.textContent = "Режим: " + (mode === "payment" ? "Оплата" : "Новая закупка");
        showEl(purchaseBlock, mode === "purchase");
        showEl(paymentBlock, mode === "payment");
      }

      function autoDetectModeByVin(vinRaw) {
        const vin = (vinRaw || "").trim().toUpperCase();
        if (!vin) return;

        const bossUpper = bossVins.map(v => (v || "").toUpperCase());

        if (vin.length === 17 && bossUpper.includes(vin)) {
          setMode("payment");
          return;
        }

        if (vin.length >= 4 && vin.length < 17 && bossVins.length) {
          const matches = bossVins.filter(v => (v || "").toUpperCase().endsWith(vin));
          if (matches.length === 1) {
            document.getElementById("vinInput").value = matches[0];
            setMode("payment");
            return;
          }
          if (matches.length > 1) {
            setMode("payment");
            return;
          }
        }

        setMode("purchase");
      }

      function recalcPurchaseRub() {
        const cur = document.getElementById("currencyInput")?.value || "";
        const a = parseNum(document.getElementById("amountCurrencyInput")?.value);
        const r = parseNum(document.getElementById("rateInput")?.value);
        const out = document.getElementById("amountRubInput");
        if (!out) return;

        if (!a) { out.value = ""; return; }
        if (cur === "₽") {
          out.value = Math.round(a).toString();
          return;
        }
        if (a && r) out.value = Math.round(a * r).toString();
        else out.value = "";
      }

      function recalcPaymentRub(amountId, rateId, rubId, currencySelId) {
        const cur = document.getElementById(currencySelId)?.value || "";
        const a = parseNum(document.getElementById(amountId)?.value);
        const r = parseNum(document.getElementById(rateId)?.value);
        const out = document.getElementById(rubId);
        if (!out) return;
        if (cur && cur !== "₽") {
          if (a && r) out.value = Math.round(a * r).toString();
          else out.value = "";
        }
      }

      function togglePaymentFields(curSelId, fxWrapEl, rubWrapEl) {
        const cur = document.getElementById(curSelId)?.value || "";
        if (cur === "₽") {
          showEl(fxWrapEl, false);
          showEl(rubWrapEl, true);
        } else {
          showEl(fxWrapEl, true);
          showEl(rubWrapEl, false);
        }
      }

      // init
      setMode("purchase");
      document.getElementById("modeBadge").textContent = "Режим: Новая закупка";

      // VIN: если VIN уже есть в таблице — подтянем данные в поля (для удобства)
      let vinPrefillTimer = null;
      const vinEl = document.getElementById("vinInput");
      vinEl.addEventListener("input", (e) => {
        if (vinPrefillTimer) clearTimeout(vinPrefillTimer);
        vinPrefillTimer = setTimeout(() => prefillBossBuyByVin(e.target.value), 450);
      });
      vinEl.addEventListener("change", (e) => prefillBossBuyByVin(e.target.value));
      vinEl.addEventListener("blur", (e) => prefillBossBuyByVin(e.target.value));
      document.getElementById("modeSelect").addEventListener("change", (e) => setMode(e.target.value));

      ["currencyInput","amountCurrencyInput","rateInput"].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.addEventListener("input", recalcPurchaseRub);
          el.addEventListener("change", recalcPurchaseRub);
        }
      });

      document.getElementById("payNowSelect").addEventListener("change", (e) => {
        showEl(purchasePayBlock, e.target.value === "yes");
      });

      // purchase pay currency toggle (hide amount/rate when ₽)
      document.getElementById("payCurrencySelect_p").addEventListener("change", () => {
        const cur = document.getElementById("payCurrencySelect_p").value;
        // wrappers: input is inside .field; we stored them
        showEl(payAmountWrapP, cur !== "₽");
        showEl(payRateWrapP, cur !== "₽");
      });

      ["payAmountCurrencyInput_p","payRateInput_p"].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener("input", () => recalcPaymentRub("payAmountCurrencyInput_p","payRateInput_p","payRubInput_p","payCurrencySelect_p"));
      });

      // payment block currency toggle
      togglePaymentFields("payCurrencySelect", fxWrap, rubWrap);
      document.getElementById("payCurrencySelect").addEventListener("change", () => togglePaymentFields("payCurrencySelect", fxWrap, rubWrap));

      ["payAmountCurrencyInput","payRateInput"].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener("input", () => recalcPaymentRub("payAmountCurrencyInput","payRateInput","payRubInput","payCurrencySelect"));
      });

      recalcPurchaseRub();
      submitBtn.disabled = false;
    }

    function renderForm() {
      formCard.innerHTML = "";

      if (formType === "mgr_stock") {
        formCard.appendChild(createSelectKV("dealTypeInput", "Тип сделки", [
          {value:"Склад", label:"Склад"},
          {value:"Поставка", label:"Поставка"},
        ], "Выберите тип сделки"));

        formCard.appendChild(createMultiOwnerInput(investors));

        formCard.appendChild(createAutocompleteInput("brandModelInput", "Марка / Модель", "Начните вводить марку или модель", brands));
        formCard.appendChild(createInput("vinInput", "VIN (можно последние 4 символа)", "Последние 4 или полный VIN"));
        formCard.appendChild(createInput("configInput", "Комплектация", "Например, Comfort"));
        formCard.appendChild(createInput("bodyColorInput", "Цвет кузова", "Черный"));
        formCard.appendChild(createInput("salonColorInput", "Цвет салона", "Черный"));
        formCard.appendChild(createInput("priceInput", "Цена, ₽", "1500000"));
        formCard.appendChild(createInput("stockDateInput", "Дата", "", todayISO(), "date"));
        formCard.appendChild(createSelectKV("payTypeInput", "Тип оплаты", [
          {value:"Нал", label:"Нал"},
          {value:"Безнал", label:"Безнал"},
          {value:"НДС", label:"НДС"},
        ], "Выберите тип оплаты"));
        formCard.appendChild(createInput("clientInput", "Клиент (Имя + телефон)", "Иван Иванов, +7..."));

        setupVinAutocompleteSmart("vinInput", getAllVins());
        submitBtn.disabled = false;
        return;
      }

      // ✅ Продажи: собственник НЕ добавляем (как вы просили)
      if (formType === "sale_nds_broker") {
        formCard.appendChild(createInput("managerInput", "Менеджер", "Имя менеджера"));
        formCard.appendChild(createInput("saleDateInput", "Дата продажи", "", todayISO(), "date"));
        formCard.appendChild(createAutocompleteInput("brandModelInput", "Марка / Модель", "", brands));
        formCard.appendChild(createInput("vinInput", "VIN (можно последние 4 символа)", "Последние 4 или полный VIN"));
        formCard.appendChild(createAutocompleteInput("leadSourceInput", "Источник", "Например, Авито", sources));
        formCard.appendChild(createInput("priceNdsInput", "Цена с НДС", ""));
        formCard.appendChild(createInput("markupNdsInput", "Наценка НДС (% / руб)", ""));
        formCard.appendChild(createInput("contractPriceInput", "Цена в договоре (с учётом комиссии брокера)", ""));
        formCard.appendChild(createInput("brokerPriceInput", "Цена без комиссии брокера", ""));
        formCard.appendChild(createInput("brokerExpenseInput", "Расход брокера (машина + НДС, кому, сумма)", ""));
        formCard.appendChild(createInput("buyerInput", "Покупатель", ""));
        setupVinAutocompleteSmart("vinInput", getAllVins());
        submitBtn.disabled = false;
        return;
      }

      if (formType === "sale_nds_no_broker") {
        formCard.appendChild(createInput("managerInput", "Менеджер", ""));
        formCard.appendChild(createInput("saleDateInput", "Дата продажи", "", todayISO(), "date"));
        formCard.appendChild(createAutocompleteInput("brandModelInput", "Марка / Модель", "", brands));
        formCard.appendChild(createInput("vinInput", "VIN (можно последние 4 символа)", "Последние 4 или полный VIN"));
        formCard.appendChild(createAutocompleteInput("leadSourceInput", "Источник", "Например, Авито", sources));
        formCard.appendChild(createInput("priceNdsInput", "Цена с НДС", ""));
        formCard.appendChild(createInput("priceCashInput", "Цена за наличные", ""));
        formCard.appendChild(createInput("markupNdsInput", "Наценка НДС (% / руб)", ""));
        formCard.appendChild(createInput("buyerInput", "Покупатель", ""));
        setupVinAutocompleteSmart("vinInput", getAllVins());
        submitBtn.disabled = false;
        return;
      }

      if (formType === "sale_cash") {
        formCard.appendChild(createInput("managerInput", "Менеджер", ""));
        formCard.appendChild(createInput("saleDateInput", "Дата продажи", "", todayISO(), "date"));
        formCard.appendChild(createAutocompleteInput("brandModelInput", "Марка / Модель", "", brands));
        formCard.appendChild(createInput("vinInput", "VIN (можно последние 4 символа)", "Последние 4 или полный VIN"));
        formCard.appendChild(createAutocompleteInput("leadSourceInput", "Источник", "Например, Авито", sources));
        formCard.appendChild(createInput("priceInput", "Цена продажи", ""));
        formCard.appendChild(createInput("receiverInput", "Кому передали средства", ""));
        formCard.appendChild(createInput("buyerInput", "Покупатель", ""));
        setupVinAutocompleteSmart("vinInput", getAllVins());
        submitBtn.disabled = false;
        return;
      }

      if (formType === "sale_cash_broker") {
        formCard.appendChild(createInput("managerInput", "Менеджер", ""));
        formCard.appendChild(createInput("saleDateInput", "Дата продажи", "", todayISO(), "date"));
        formCard.appendChild(createAutocompleteInput("brandModelInput", "Марка / Модель", "", brands));
        formCard.appendChild(createInput("vinInput", "VIN (можно последние 4 символа)", "Последние 4 или полный VIN"));
        formCard.appendChild(createAutocompleteInput("leadSourceInput", "Источник", "Например, Авито", sources));
        formCard.appendChild(createInput("priceInput", "Цена продажи", ""));
        formCard.appendChild(createInput("priceNoCommInput", "Цена без комиссии", ""));
        formCard.appendChild(createInput("managerFeeInput", "Комиссия менеджера", ""));
        formCard.appendChild(createInput("receiverInput", "Кому передали средства", ""));
        formCard.appendChild(createInput("buyerInput", "Покупатель", ""));
        setupVinAutocompleteSmart("vinInput", getAllVins());
        submitBtn.disabled = false;
        return;
      }

      if (formType === "sale_deposit") {
        formCard.appendChild(createInput("managerInput", "Менеджер", ""));
        formCard.appendChild(createInput("saleDateInput", "Дата", "", todayISO(), "date"));
        formCard.appendChild(createAutocompleteInput("brandModelInput", "Марка / Модель", "", brands));
        formCard.appendChild(createInput("vinInput", "VIN (можно последние 4 символа)", "Последние 4 или полный VIN"));
        formCard.appendChild(createAutocompleteInput("leadSourceInput", "Источник", "Например, Авито", sources));
        formCard.appendChild(createInput("depositSumInput", "Сумма задатка", ""));
        formCard.appendChild(createInput("receiverInput", "Кому передана сумма", ""));
        formCard.appendChild(createInput("priceInput", "Цена продажи", ""));
        formCard.appendChild(createInput("buyerInput", "Покупатель", ""));
        setupVinAutocompleteSmart("vinInput", getAllVins());
        submitBtn.disabled = false;
        return;
      }

      if (formType === "sale_extra") {
        formCard.appendChild(createInput("managerInput", "Менеджер", ""));
        formCard.appendChild(createInput("saleDateInput", "Дата", "", todayISO(), "date"));
        formCard.appendChild(createAutocompleteInput("brandModelInput", "Марка / Модель", "", brands));
        formCard.appendChild(createInput("vinInput", "VIN (можно последние 4 символа)", "Последние 4 или полный VIN"));
        formCard.appendChild(createAutocompleteInput("leadSourceInput", "Источник", "Например, Авито", sources));
        formCard.appendChild(createTextarea("extraDescInput", "Доп. услуги (описание)", ""));
        formCard.appendChild(createInput("priceInput", "Цена продажи", ""));
        formCard.appendChild(createInput("receiverInput", "Кому передали средства", ""));
        formCard.appendChild(createInput("purchaserInput", "Кто выдал средства на закупку", ""));
        formCard.appendChild(createInput("buyPriceInput", "Цена покупки", ""));
        formCard.appendChild(createInput("profitInput", "Доход", ""));
        setupVinAutocompleteSmart("vinInput", getAllVins());
        submitBtn.disabled = false;
        return;
      }

      if (formType === "fin_auto_template") {
        formCard.appendChild(createInput("vinInput", "VIN (можно последние 4 символа)", "Последние 4 или полный VIN"));
        formCard.appendChild(createAutocompleteInput("brandModelInput", "Марка / Модель", "", brands));
        formCard.appendChild(createInput("faDateInput", "Дата", "", todayISO(), "date"));
        formCard.appendChild(createInput("evacuatorInput", "Эвакуатор", ""));
        formCard.appendChild(createInput("labInput", "Лаборатория", ""));
        formCard.appendChild(createInput("utilWriteoffInput", "Списания утильсбора", ""));
        formCard.appendChild(createInput("utilInput", "Утильсбор", ""));
        formCard.appendChild(createInput("preSaleInput", "Предпродажная подготовка", ""));
        formCard.appendChild(createInput("marketingInput", "Маркетинг", ""));
        formCard.appendChild(createInput("otherInput", "Прочие расходы", ""));
        formCard.appendChild(createTextarea("extraExpensesInput", "Доп. расходы", "Если есть: строками (например: Шиномонтаж: 3000)"));
        formCard.appendChild(createTextarea("commentInput", "Комментарий", ""));
        setupVinAutocompleteSmart("vinInput", getAllVins());
        submitBtn.disabled = false;
        return;
      }

      if (formType === "fin_oper") {
        formCard.appendChild(createInput("categoryInput", "Категория", "", categoryFromUrl || "", "text", true));
        formCard.appendChild(createInput("opDateInput", "Дата", "", todayISO(), "date"));
        formCard.appendChild(createInput("amountInput", "Сумма, ₽", ""));
        formCard.appendChild(createTextarea("commentInput", "Комментарий", ""));
        submitBtn.disabled = false;
        return;
      }

      if (formType === "boss_buy") {
        renderBossBuy();
        return;
      }

      if (formType === "boss_invest_in" || formType === "boss_invest_out") {
        formCard.appendChild(createAutocompleteInput("investorInput", "Инвестор", "Начните вводить инвестора", investors));
        formCard.appendChild(createInput("sumInput", "Сумма", ""));
        formCard.appendChild(createInput("opDateInput", "Дата", "", todayISO(), "date"));
        formCard.appendChild(createTextarea("commentInput", "Комментарий", ""));
        submitBtn.disabled = false;
        return;
      }

      formCard.appendChild(createTextarea("rawInput", "Данные", "Форма не настроена. Введите данные в свободной форме."));
      submitBtn.disabled = false;
    }

    renderForm();

    // Подсказки из localStorage (чтобы открывалось быстрее)
    warmLocalDatalists();

    // Фоном распарсим vins=... из URL (если он большой)
    scheduleWarmVinsFromUrl();

    // Подсказки VIN во всех формах (работают из localStorage/lookup)
    setupVinAutocompleteSmart("vinInput", getAllVins);

    // Подгрузим списки/автоподтягивание по VIN (ТОЛЬКО для закупки руководителя) в фоне
    if (formType === "boss_buy") {
      if (window.requestIdleCallback) {
        requestIdleCallback(() => remoteListsLoad(false), { timeout: 2000 });
      } else {
        setTimeout(() => remoteListsLoad(false), 200);
      }
    }

// ===================== COLLECT DATA =====================

    function collectFormData() {
      const payload = { formType };

      if (formType === "mgr_stock") {
        payload.deal_type = document.getElementById("dealTypeInput").value;

        const ownersArr = collectOwners();
        payload.owners = ownersArr;
        payload.owner = ownersArr.join("\n");

        payload.brand_model = document.getElementById("brandModelInput").value;
        payload.vin = document.getElementById("vinInput").value;
        payload.complectation = document.getElementById("configInput").value;
        payload.body_color = document.getElementById("bodyColorInput").value;
        payload.salon_color = document.getElementById("salonColorInput").value;
        payload.price = document.getElementById("priceInput").value;
        payload.stock_date = getRuDate("stockDateInput");
        payload.payment_type = document.getElementById("payTypeInput").value;
        payload.client = document.getElementById("clientInput").value;
        return payload;
      }

      if (formType === "sale_nds_broker") {
        payload.manager = document.getElementById("managerInput").value;
        payload.sale_date = getRuDate("saleDateInput");
        payload.brand_model = document.getElementById("brandModelInput").value;
        payload.vin = document.getElementById("vinInput").value;
        payload.source = document.getElementById("leadSourceInput").value;
        payload.price_nds = document.getElementById("priceNdsInput").value;
        payload.markup_nds = document.getElementById("markupNdsInput").value;
        payload.contract_price = document.getElementById("contractPriceInput").value;
        payload.broker_price = document.getElementById("brokerPriceInput").value;
        payload.broker_expense = document.getElementById("brokerExpenseInput").value;
        payload.buyer = document.getElementById("buyerInput").value;
        return payload;
      }

      if (formType === "sale_nds_no_broker") {
        payload.manager = document.getElementById("managerInput").value;
        payload.sale_date = getRuDate("saleDateInput");
        payload.brand_model = document.getElementById("brandModelInput").value;
        payload.vin = document.getElementById("vinInput").value;
        payload.source = document.getElementById("leadSourceInput").value;
        payload.price_nds = document.getElementById("priceNdsInput").value;
        payload.price_cash = document.getElementById("priceCashInput").value;
        payload.markup_nds = document.getElementById("markupNdsInput").value;
        payload.buyer = document.getElementById("buyerInput").value;
        return payload;
      }

      if (formType === "sale_cash") {
        payload.manager = document.getElementById("managerInput").value;
        payload.sale_date = getRuDate("saleDateInput");
        payload.brand_model = document.getElementById("brandModelInput").value;
        payload.vin = document.getElementById("vinInput").value;
        payload.source = document.getElementById("leadSourceInput").value;
        payload.price = document.getElementById("priceInput").value;
        payload.receiver = document.getElementById("receiverInput").value;
        payload.buyer = document.getElementById("buyerInput").value;
        return payload;
      }

      if (formType === "sale_cash_broker") {
        payload.manager = document.getElementById("managerInput").value;
        payload.sale_date = getRuDate("saleDateInput");
        payload.brand_model = document.getElementById("brandModelInput").value;
        payload.vin = document.getElementById("vinInput").value;
        payload.source = document.getElementById("leadSourceInput").value;
        payload.price = document.getElementById("priceInput").value;
        payload.price_no_commission = document.getElementById("priceNoCommInput").value;
        payload.manager_fee = document.getElementById("managerFeeInput").value;
        payload.receiver = document.getElementById("receiverInput").value;
        payload.buyer = document.getElementById("buyerInput").value;
        return payload;
      }

      if (formType === "sale_deposit") {
        payload.manager = document.getElementById("managerInput").value;
        payload.sale_date = getRuDate("saleDateInput");
        payload.brand_model = document.getElementById("brandModelInput").value;
        payload.vin = document.getElementById("vinInput").value;
        payload.source = document.getElementById("leadSourceInput").value;
        payload.deposit_sum = document.getElementById("depositSumInput").value;
        payload.receiver = document.getElementById("receiverInput").value;
        payload.price = document.getElementById("priceInput").value;
        payload.buyer = document.getElementById("buyerInput").value;
        return payload;
      }

      if (formType === "sale_extra") {
        payload.manager = document.getElementById("managerInput").value;
        payload.sale_date = getRuDate("saleDateInput");
        payload.brand_model = document.getElementById("brandModelInput").value;
        payload.vin = document.getElementById("vinInput").value;
        payload.source = document.getElementById("leadSourceInput").value;
        payload.extra_desc = document.getElementById("extraDescInput").value;
        payload.price = document.getElementById("priceInput").value;
        payload.receiver = document.getElementById("receiverInput").value;
        payload.purchaser = document.getElementById("purchaserInput").value;
        payload.buy_price = document.getElementById("buyPriceInput").value;
        payload.profit = document.getElementById("profitInput").value;
        return payload;
      }

      if (formType === "fin_auto_template") {
        payload.vin = document.getElementById("vinInput").value;
        payload.brand_model = document.getElementById("brandModelInput").value;
        payload.op_date = getRuDate("faDateInput");
        payload.evacuator = document.getElementById("evacuatorInput").value;
        payload.lab = document.getElementById("labInput").value;
        payload.util_writeoff = document.getElementById("utilWriteoffInput").value;
        payload.util = document.getElementById("utilInput").value;
        payload.pre_sale = document.getElementById("preSaleInput").value;
        payload.marketing = document.getElementById("marketingInput").value;
        payload.other = document.getElementById("otherInput").value;
        payload.extra_expenses = document.getElementById("extraExpensesInput").value;
        payload.comment = document.getElementById("commentInput").value;
        return payload;
      }

      if (formType === "fin_oper") {
        payload.category = document.getElementById("categoryInput").value;
        payload.op_date = getRuDate("opDateInput");
        payload.amount = document.getElementById("amountInput").value;
        payload.comment = document.getElementById("commentInput").value;
        return payload;
      }

      if (formType === "boss_buy") {
        const mode = document.getElementById("modeSelect").value;
        payload.mode = mode;
        payload.vin = document.getElementById("vinInput").value.trim().toUpperCase();

        if (mode === "purchase") {
          payload.purchase_date = getRuDate("purchaseDateInput");
          payload.supplier = document.getElementById("supplierInput").value;
          payload.purchase_place = document.getElementById("placeInput").value;
          payload.brand_model = document.getElementById("brandModelInput").value;
          payload.complectation = document.getElementById("complectationInput").value;
          payload.currency = document.getElementById("currencyInput").value;
          payload.amount_currency = document.getElementById("amountCurrencyInput").value;
          payload.rate_to_rub = document.getElementById("rateInput").value;
          payload.amount_rub = document.getElementById("amountRubInput").value;
          payload.comment = document.getElementById("commentInput_p").value;

          const payNow = document.getElementById("payNowSelect").value === "yes";
          if (payNow) {
            payload.pay_date = getRuDate("payDateInput_p");
            payload.pay_currency = document.getElementById("payCurrencySelect_p").value;
            if (payload.pay_currency === "₽") {
              payload.pay_amount_currency = "";
              payload.pay_rate = "";
              payload.pay_amount_rub = document.getElementById("payRubInput_p").value;
            } else {
              payload.pay_amount_currency = document.getElementById("payAmountCurrencyInput_p").value;
              payload.pay_rate = document.getElementById("payRateInput_p").value;
              payload.pay_amount_rub = document.getElementById("payRubInput_p").value;
            }
          }
        } else {
          payload.pay_date = getRuDate("payDateInput");
          payload.pay_currency = document.getElementById("payCurrencySelect").value;
          if (payload.pay_currency === "₽") {
            payload.pay_amount_currency = "";
            payload.pay_rate = "";
            payload.pay_amount_rub = document.getElementById("payRubOnlyInput").value;
          } else {
            payload.pay_amount_currency = document.getElementById("payAmountCurrencyInput").value;
            payload.pay_rate = document.getElementById("payRateInput").value;
            payload.pay_amount_rub = document.getElementById("payRubInput").value;
          }
          payload.comment = document.getElementById("commentInput").value;
        }

        return payload;
      }

      if (formType === "boss_invest_in" || formType === "boss_invest_out") {
        payload.investor = document.getElementById("investorInput").value;
        payload.sum = document.getElementById("sumInput").value;
        payload.op_date = getRuDate("opDateInput");
        payload.comment = document.getElementById("commentInput").value;
        return payload;
      }

      payload.raw = document.getElementById("rawInput").value;
      return payload;
    }

    // ===================== TELEGRAM INTEGRATION =====================

    submitBtn.addEventListener("click", () => {
      const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
      if (!tg) {
        alert("Открой форму через кнопку в Telegram-боте.");
        return;
      }

      try { tg.ready(); } catch(e) {}

      const payload = collectFormData();

      try { cacheBossBuyPayload(payload); } catch(e) {}

      submitBtn.disabled = true;
      submitBtn.textContent = "Отправка...";

      try {
        tg.sendData(JSON.stringify(payload));
        setTimeout(() => { try { tg.close(); } catch(e) {} }, 400);
      } catch (e) {
        alert("Не удалось отправить данные. Попробуй ещё раз.");
        submitBtn.disabled = false;
        submitBtn.textContent = "Отправить в бота";
      }
    });
  </script>
</body>
</html>


