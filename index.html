<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ê–≤—Ç–æ–ª–∏–Ω–∫ WebApp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    *,*::before,*::after{box-sizing:border-box;}
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: #0f172a;
      color: #e5e7eb;
      min-height: var(--app-height, var(--tg-viewport-height, 100vh));
      padding-bottom: calc(16px + env(safe-area-inset-bottom));
      overscroll-behavior: contain;
    }
    h1 { font-size: 20px; margin: 0 0 4px; text-align: center; }
    .subtitle { font-size: 13px; text-align: center; color: #94a3b8; margin-bottom: 16px; line-height: 1.35; }
    .card {
      background: #111827;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.5);
      max-width: 560px;
      margin: 0 auto;
    }
    .field { margin-bottom: 12px; display: flex; flex-direction: column; gap: 4px; }
    label { font-size: 13px; color: #9ca3af; }
    input, select, textarea {
      border-radius: 10px;
      border: 1px solid #374151;
      padding: 8px 10px;
      font-size: 14px;
      background: #020617;
      color: #e5e7eb;
      outline: none;
    }
    input:focus, select:focus, textarea:focus { border-color: #38bdf8; }
    textarea { min-height: 90px; resize: vertical; }
    .readonly { background: #020617; color: #9ca3af; }
    .hint { font-size: 12px; color: #94a3b8; line-height: 1.35; margin-top: 4px; }
    .pill { display: inline-block; padding: 6px 10px; border-radius: 999px; background: #0b1226; border: 1px solid #334155; color: #cbd5e1; font-size: 12px; }
    .divider { height: 1px; background: #1f2937; margin: 14px 0; }
    .hidden { display:none; }
    .toggle-row{display:flex;align-items:center;gap:10px;font-size:13px;color:#cbd5e1;}
    .toggle-row input{width:18px;height:18px;}
    .toggle-row small{color:#94a3b8;line-height:1.25;}
    button#submitBtn {
      width: 100%;
      border-radius: 999px;
      border: none;
      padding: 10px 14px;
      font-size: 15px;
      font-weight: 600;
      background: linear-gradient(135deg, #38bdf8, #6366f1);
      color: white;
      cursor: pointer;
      margin-top: 12px;
      touch-action: manipulation;
    }
    button#submitBtn:disabled { opacity: .5; cursor: default; }
    .errorbox{
      margin: 12px auto 0;
      max-width: 560px;
      background:#0b1226;
      border:1px solid #ef4444;
      color:#fecaca;
      border-radius: 14px;
      padding: 10px 12px;
      display:none;
      line-height:1.35;
      font-size:13px;
      white-space: pre-line;
    }
    .req{ color:#fca5a5; margin-left:6px; font-weight:600; }

    /* ‚úÖ NEW (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ñ–æ—Ä–º—ã —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–¥–∞—Ç–∫–∞) */
    .btnRow{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px; }
    .actionBtn{
      flex: 1 1 160px;
      border-radius: 14px;
      border: 1px solid #334155;
      padding: 10px 12px;
      background: #0b1226;
      color: #e5e7eb;
      font-weight: 700;
      cursor: pointer;
      touch-action: manipulation;
    }
    .actionBtn:disabled{ opacity:.55; cursor: default; }
    .actionBtnPrimary{
      background: linear-gradient(135deg, #38bdf8, #6366f1);
      border: none;
      color: #fff;
    }
  </style>
</head>

<body>
  <h1>–ê–≤—Ç–æ–ª–∏–Ω–∫</h1>
  <div class="subtitle" id="subtitle"></div>

  <div class="card" id="formCard"></div>
  <button id="submitBtn" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –±–æ—Ç–∞</button>
  <div class="errorbox" id="errorBox"></div>

<script>
  // ---------- Telegram ----------
  const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
  const urlParams = new URLSearchParams(window.location.search);
  const formType = urlParams.get("type") || "unknown";
  const APP_VERSION = urlParams.get("v") || "9";

  // ‚úÖ iOS detection (–¥–ª—è —Ñ–∏–∫—Å–∞ "–∫–Ω–æ–ø–∫–∞ –Ω–µ –Ω–∞–∂–∏–º–∞–µ—Ç—Å—è/–ø–æ–¥–≤–∏—Å–∞–µ—Ç")
  const IS_IOS =
    /iPad|iPhone|iPod/.test(navigator.userAgent) ||
    (navigator.platform === "MacIntel" && navigator.maxTouchPoints > 1);

  // ---------- Service Worker ----------
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js?v=" + encodeURIComponent(APP_VERSION)).catch(() => {});
    });
  }

  try { if (tg) { tg.ready(); tg.expand(); } } catch (e) {}

  if (tg) {
    const setH = () => {
      document.documentElement.style.setProperty('--app-height', (tg.viewportHeight || window.innerHeight) + 'px');
    };
    setH();
    tg.onEvent('viewportChanged', setH);
  }

  function tgAlert(text) {
    try {
      if (tg && typeof tg.showAlert === "function") tg.showAlert(String(text));
      else alert(String(text));
    } catch(e) { alert(String(text)); }
  }

  const subtitleEl = document.getElementById("subtitle");
  const formCard = document.getElementById("formCard");
  const submitBtn = document.getElementById("submitBtn");
  const errorBox = document.getElementById("errorBox");

  function showError(msg){
    if (!msg) { errorBox.style.display="none"; errorBox.textContent=""; return; }
    errorBox.textContent = msg;
    errorBox.style.display="block";
    try { errorBox.scrollIntoView({behavior:"smooth", block:"start"}); } catch(e){}
  }

  // ---------- URL lists ----------
  const categoryFromUrl = urlParams.get("category") || "";
  const brandsParam = urlParams.get("brands") || "";
  const investorsParam = urlParams.get("investors") || "";
  const sourcesParam = urlParams.get("sources") || "";
  const managersParam = urlParams.get("managers") || "";
  const currenciesParam = urlParams.get("currencies") || "";

  const brands = brandsParam ? brandsParam.split("|") : [];
  const investors = investorsParam ? investorsParam.split("|") : [];
  const sources = sourcesParam ? sourcesParam.split("|") : [];
  const managers = managersParam ? managersParam.split("|") : [];
  const currencies = currenciesParam ? currenciesParam.split("|") : [];

  const FORM_TITLES = {
    mgr_stock: "–°—Ç–æ–∫",
    sale_main: "–ü—Ä–æ–¥–∞–∂–∞ ‚Äî –æ—Å–Ω–æ–≤–Ω–∞—è",
    sale_deposit: "–ó–∞–¥–∞—Ç–æ–∫",
    sale_extra: "–î–æ–ø. —É—Å–ª—É–≥–∏",
    sale_nds_broker: "–ü—Ä–æ–¥–∞–∂–∞ ‚Äî –ù–î–° —Å –∫–æ–º–∏—Å—Å–∏–µ–π –±—Ä–æ–∫–µ—Ä–∞",
    sale_nds_no_broker: "–ü—Ä–æ–¥–∞–∂–∞ ‚Äî –ù–î–° –±–µ–∑ –∫–æ–º–∏—Å—Å–∏–∏ –±—Ä–æ–∫–µ—Ä–∞",
    sale_cash: "–ü—Ä–æ–¥–∞–∂–∞ ‚Äî –ù–∞–ª–∏—á–Ω—ã–µ",
    sale_cash_broker: "–ü—Ä–æ–¥–∞–∂–∞ ‚Äî –ù–∞–ª–∏—á–Ω—ã–µ —Å –∫–æ–º–∏—Å—Å–∏–µ–π –±—Ä–æ–∫–µ—Ä–∞",
    fin_auto_template: "–†–∞—Å—Ö–æ–¥—ã –Ω–∞ –∞–≤—Ç–æ –†–§",
    fin_company: "–†–∞—Å—Ö–æ–¥—ã –∫–æ–º–ø–∞–Ω–∏–∏ (MAIN)",
    fin_company_expense: "–†–∞—Å—Ö–æ–¥—ã –∫–æ–º–ø–∞–Ω–∏–∏ (RF)",
    fin_oper: "–û–ø–µ—Ä—Ä–∞—Å—Ö–æ–¥—ã",
    boss_buy: "–ó–∞–∫—É–ø–∫–∞ / –û–ø–ª–∞—Ç–∞ –ø–æ VIN",
    boss_invest_in: "–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ ‚Äî –≤–≤–æ–¥",
    boss_invest_out: "–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ ‚Äî –≤—ã–≤–æ–¥",

    /* ‚úÖ NEW */
    deposit_status: "–°—Ç–∞—Ç—É—Å –∑–∞–¥–∞—Ç–∫–∞",
  };

  function isSaleMainLike(t) {
    return ["sale_main","sale_nds_broker","sale_nds_no_broker","sale_cash","sale_cash_broker"].includes(String(t||""));
  }

  // ‚úÖ –º–µ–Ω–µ–¥–∂–µ—Ä—Å–∫–∏–µ —Ñ–æ—Ä–º—ã (–æ—Å—Ç–∞–≤–ª—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫–∞–∫ –±—ã–ª–æ)
  function isManagerForms(t){
    return t === "mgr_stock" || t === "sale_deposit" || t === "sale_extra" || isSaleMainLike(t);
  }

  // ‚úÖ —Ñ–∏–Ω–∞–Ω—Å–∏—Å—Ç + —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å (—É–±–∏—Ä–∞–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é)
  function isFinanceOrBossForms(t){
    return [
      "fin_auto_template",
      "fin_company",
      "fin_company_expense",
      "fin_oper",
      "boss_buy",
      "boss_invest_in",
      "boss_invest_out"
    ].includes(String(t||""));
  }

  subtitleEl.textContent =
    "–§–æ—Ä–º–∞: " + (FORM_TITLES[formType] || formType) +
    (categoryFromUrl ? " | –ö–∞—Ç–µ–≥–æ—Ä–∏—è: " + categoryFromUrl : "");

  // ---------- helpers ----------
  function todayISO() { return new Date().toISOString().slice(0, 10); }
  function formatDateToRu(value) {
    if (!value) return "";
    const parts = value.split("-");
    if (parts.length === 3) {
      const [y, m, d] = parts;
      return `${d}.${m}.${y}`;
    }
    return value;
  }
  function getRuDate(id) {
    const el = document.getElementById(id);
    if (!el) return "";
    return formatDateToRu(el.value);
  }
  function showEl(el, show) {
    if (!el) return;
    el.classList.toggle("hidden", !show);
  }
  function safeStr(v){ return (v===null||v===undefined) ? "" : String(v); }
  function normalizeVin(v) { return String(v || "").trim().toUpperCase().replace(/\s+/g,""); }
  function uniq(arr){
    const out=[]; const seen=new Set();
    (arr||[]).forEach(x=>{
      const s=String(x||"").trim();
      if(!s) return;
      const k=s.toLowerCase();
      if(seen.has(k)) return;
      seen.add(k); out.push(s);
    });
    return out;
  }
  function mergeUnique(...arrays){ return uniq(arrays.flat()); }
  function normKey(s){ return String(s||"").trim().toLowerCase(); }

  function removeManagersFromSources(srcList, mgrList){
    const mset = new Set((mgrList||[]).map(normKey).filter(Boolean));
    return (srcList||[]).filter(x=>{
      const k = normKey(x);
      if(!k) return false;
      return !mset.has(k);
    });
  }

  // ‚úÖ helper: ISO from "DD.MM.YYYY" or keep ISO
  function toISODateMaybe(value){
    const v = String(value || "").trim();
    if (!v) return "";
    if (/^\d{4}-\d{2}-\d{2}$/.test(v)) return v;
    const m = v.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/);
    if (m) {
      const dd = String(m[1]).padStart(2,"0");
      const mm = String(m[2]).padStart(2,"0");
      const yy = m[3];
      return `${yy}-${mm}-${dd}`;
    }
    return "";
  }

  // ‚úÖ helper: –ø–æ—Å—Ç–∞–≤–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –≤ SELECT (–µ—Å–ª–∏ –Ω–µ—Ç –æ–ø—Ü–∏–∏ ‚Äî –¥–æ–±–∞–≤–∏–º)
  function setSelectValueSmart(selectEl, value){
    if (!selectEl) return;
    const v = String(value || "").trim();
    if (!v) { selectEl.value = ""; return; }
    if (selectEl.tagName !== "SELECT") { selectEl.value = v; return; }
    const exists = Array.from(selectEl.options || []).some(o => o.value === v);
    if (!exists) {
      const o = document.createElement("option");
      o.value = v;
      o.textContent = v;
      selectEl.appendChild(o);
    }
    selectEl.value = v;
  }

  // ---------- localStorage ----------
  const LS_KEYS = {
    VINS: "avtolink_vins",
    BRAND_MODELS: "avtolink_brand_models",
    SOURCES: "avtolink_sources",
    MANAGERS: "avtolink_managers",
    EXP_CATS: "avtolink_expense_categories",
    EXP_ARTICLES: "avtolink_expense_articles",
    VIN_SOURCE_MAP: "avtolink_vin_source_map",
    REMOTE_TS: "avtolink_remote_ts_" + APP_VERSION,
    SCHEMA: "avtolink_schema_v1",
  };

  function lsRead(key, fallback){
    try{
      const v = localStorage.getItem(key);
      if (v===null || v===undefined || v==="") return fallback;
      return JSON.parse(v);
    }catch(e){ return fallback; }
  }
  function lsWrite(key, value){
    try{ localStorage.setItem(key, JSON.stringify(value)); }catch(e){}
  }
  function lsReadArr(key){ const a=lsRead(key, []); return Array.isArray(a)?a.filter(Boolean):[]; }
  function lsWriteArr(key, arr, max=2000){ lsWrite(key, (Array.isArray(arr)?arr:[]).filter(Boolean).slice(0,max)); }

  // ‚úÖ –ê–≤—Ç–æ-–æ—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ –≤–µ—Ä—Å–∏–∏
  try {
    const prev = localStorage.getItem(LS_KEYS.SCHEMA);
    if (prev !== String(APP_VERSION)) {
      localStorage.removeItem(LS_KEYS.SOURCES);
      localStorage.removeItem(LS_KEYS.MANAGERS);
      localStorage.removeItem(LS_KEYS.VINS);
      localStorage.removeItem(LS_KEYS.BRAND_MODELS);
      localStorage.removeItem(LS_KEYS.EXP_CATS);
      localStorage.removeItem(LS_KEYS.EXP_ARTICLES);
      localStorage.removeItem(LS_KEYS.VIN_SOURCE_MAP);
      localStorage.setItem(LS_KEYS.SCHEMA, String(APP_VERSION));
    }
  } catch(e){}

  function rememberVin(vin){
    const v = normalizeVin(vin);
    if(!v || v.length < 4) return;
    const cur = lsReadArr(LS_KEYS.VINS);
    const merged = mergeUnique([v], cur);
    lsWriteArr(LS_KEYS.VINS, merged, 4000);
  }

  function vinSourceMapGet(vin){
    const map = lsRead(LS_KEYS.VIN_SOURCE_MAP, {}) || {};
    return map[normalizeVin(vin)] || "";
  }
  function vinSourceMapSet(vin, source){
    const v = normalizeVin(vin);
    const s = String(source||"").trim();
    if(!v || v.length<4 || !s) return;
    const map = lsRead(LS_KEYS.VIN_SOURCE_MAP, {}) || {};
    map[v] = s;
    const keys = Object.keys(map);
    if(keys.length > 4000){
      keys.slice(0, keys.length-3500).forEach(k=>{ delete map[k]; });
    }
    lsWrite(LS_KEYS.VIN_SOURCE_MAP, map);
  }

  // ---------- datalist ----------
  function updateDatalist(dlId, options) {
    const dl = document.getElementById(dlId);
    if (!dl) return;
    dl.innerHTML = "";
    (options || []).slice(0, 800).forEach((opt) => {
      const o = document.createElement("option");
      o.value = opt;
      dl.appendChild(o);
    });
  }

  // ‚úÖ select options updater (–¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞/–∏—Å—Ç–æ—á–Ω–∏–∫–∞)
  function updateSelectOptions(selectId, options, placeholder="–í—ã–±–µ—Ä–∏—Ç–µ...") {
    const el = document.getElementById(selectId);
    if (!el || el.tagName !== "SELECT") return;

    const prev = (el.value || "").trim();
    const pending = (el.dataset.pendingValue || "").trim();

    el.innerHTML = "";

    const ph = document.createElement("option");
    ph.value = "";
    ph.textContent = placeholder;
    ph.disabled = true;
    ph.selected = true;
    el.appendChild(ph);

    const list = uniq(options || []);
    list.forEach(v=>{
      const o = document.createElement("option");
      o.value = v;
      o.textContent = v;
      el.appendChild(o);
    });

    const trySet = (v) => {
      if (!v) return false;
      const exists = Array.from(el.options).some(o=>o.value === v);
      if (exists) {
        el.value = v;
        ph.selected = false;
        return true;
      }
      return false;
    };

    if (trySet(prev)) { /* ok */ }
    else if (trySet(pending)) { el.dataset.pendingValue = ""; }
    else { el.value = ""; ph.selected = true; }
  }

  function createInput(id, labelText, placeholder = "", value = "", type = "text", readonly = false, required = false) {
    const w = document.createElement("div");
    w.className = "field";
    const l = document.createElement("label");
    l.htmlFor = id;
    l.textContent = labelText;
    if (required) {
      const r = document.createElement("span");
      r.className = "req";
      r.textContent = "*";
      l.appendChild(r);
    }
    const i = document.createElement("input");
    i.id = id;
    i.placeholder = placeholder;
    i.type = type;
    if (value) i.value = value;
    if (readonly) { i.readOnly = true; i.classList.add("readonly"); }
    if (id.toLowerCase().includes("vin")) i.maxLength = 17;
    if (required) i.dataset.required = "1";
    w.appendChild(l);
    w.appendChild(i);
    return w;
  }

  function createTextarea(id, labelText, placeholder = "", readonly = false, required = false) {
    const w = document.createElement("div");
    w.className = "field";
    const l = document.createElement("label");
    l.htmlFor = id;
    l.textContent = labelText;
    if (required) {
      const r = document.createElement("span");
      r.className = "req";
      r.textContent = "*";
      l.appendChild(r);
    }
    const t = document.createElement("textarea");
    t.id = id;
    t.placeholder = placeholder;
    if (readonly) { t.readOnly = true; t.classList.add("readonly"); }
    if (required) t.dataset.required = "1";
    w.appendChild(l);
    w.appendChild(t);
    return w;
  }

  function createSelectKV(id, labelText, options, placeholder = "–í—ã–±–µ—Ä–∏—Ç–µ...", required = false) {
    const w = document.createElement("div");
    w.className = "field";
    const l = document.createElement("label");
    l.htmlFor = id;
    l.textContent = labelText;
    if (required) {
      const r = document.createElement("span");
      r.className = "req";
      r.textContent = "*";
      l.appendChild(r);
    }
    const s = document.createElement("select");
    s.id = id;

    const ph = document.createElement("option");
    ph.value = "";
    ph.textContent = placeholder;
    ph.disabled = true;
    ph.selected = true;
    s.appendChild(ph);

    options.forEach((opt) => {
      const o = document.createElement("option");
      o.value = opt.value;
      o.textContent = opt.label;
      s.appendChild(o);
    });

    if (required) s.dataset.required = "1";

    w.appendChild(l);
    w.appendChild(s);
    return w;
  }

  function createAutocompleteInput(id, labelText, placeholder = "", options = [], required = false) {
    const w = document.createElement("div");
    w.className = "field";
    const l = document.createElement("label");
    l.htmlFor = id;
    l.textContent = labelText;
    if (required) {
      const r = document.createElement("span");
      r.className = "req";
      r.textContent = "*";
      l.appendChild(r);
    }
    const i = document.createElement("input");
    i.id = id;
    i.placeholder = placeholder;
    const dlId = id + "_list";
    i.setAttribute("list", dlId);
    let dl = document.getElementById(dlId);
    if (!dl) {
      dl = document.createElement("datalist");
      dl.id = dlId;
      document.body.appendChild(dl);
    }
    updateDatalist(dlId, options);
    if (required) i.dataset.required = "1";
    w.appendChild(l);
    w.appendChild(i);
    return w;
  }

  // ‚úÖ NEW: Select from string list (–¥–ª—è iPhone: –º–µ–Ω–µ–¥–∂–µ—Ä/–∏—Å—Ç–æ—á–Ω–∏–∫)
  function createSelectFromList(id, labelText, options = [], placeholder = "–í—ã–±–µ—Ä–∏—Ç–µ...", required = false) {
    const w = document.createElement("div");
    w.className = "field";

    const l = document.createElement("label");
    l.htmlFor = id;
    l.textContent = labelText;
    if (required) {
      const r = document.createElement("span");
      r.className = "req";
      r.textContent = "*";
      l.appendChild(r);
    }

    const s = document.createElement("select");
    s.id = id;

    const ph = document.createElement("option");
    ph.value = "";
    ph.textContent = placeholder;
    ph.disabled = true;
    ph.selected = true;
    s.appendChild(ph);

    uniq(options || []).forEach(v=>{
      const o = document.createElement("option");
      o.value = v;
      o.textContent = v;
      s.appendChild(o);
    });

    if (required) s.dataset.required = "1";
    w.appendChild(l);
    w.appendChild(s);
    return w;
  }

  // ---------- money formatting ----------
  function digitsOnly(s){ return String(s||"").replace(/[^\d]/g, ""); }
  function formatWithSpaces(numStr){
    const s = digitsOnly(numStr);
    if (!s) return "";
    return s.replace(/\B(?=(\d{3})+(?!\d))/g, " ");
  }

  // ‚úÖ iOS fix: –º–µ–Ω—å—à–µ –≤–º–µ—à–∏–≤–∞–µ–º—Å—è –≤ –≤–≤–æ–¥ (—Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –Ω–∞ blur)
  function setupMoneyInput(id){
    const el = document.getElementById(id);
    if (!el || el.dataset.money === "1") return;
    el.dataset.money = "1";

    const formatNow = () => {
      const raw = el.value;
      el.value = formatWithSpaces(raw);
    };

    if (IS_IOS) {
      el.addEventListener("blur", formatNow);
      return;
    }

    const onInput = () => {
      const start = el.selectionStart || 0;
      const raw = el.value;
      const beforeDigits = digitsOnly(raw.slice(0, start)).length;

      const formatted = formatWithSpaces(raw);
      el.value = formatted;

      let pos = 0;
      let seenDigits = 0;
      while (pos < el.value.length && seenDigits < beforeDigits) {
        if (/\d/.test(el.value[pos])) seenDigits++;
        pos++;
      }
      try { el.setSelectionRange(pos, pos); } catch(e){}
    };

    el.addEventListener("input", onInput);
    el.addEventListener("blur", onInput);
  }

  // ---------- Smart VIN datalist (includes) ----------
  function setupVinAutocompleteSmart(inputId, getAllVinsFn) {
    const input = document.getElementById(inputId);
    if (!input) return;
    if (input.dataset && input.dataset.vinAuto === "1") return;
    input.dataset.vinAuto = "1";

    const listId = inputId + "_list";
    let dl = document.getElementById(listId);
    if (!dl) {
      dl = document.createElement("datalist");
      dl.id = listId;
      document.body.appendChild(dl);
    }
    input.setAttribute("list", listId);

    function fill(filter = "") {
      const raw = String(filter || "").trim();
      if (!raw) return;
      const onlyDigits = /^[0-9]+$/.test(raw);
      if (!onlyDigits && raw.length < 2) return;
      const f = raw.toLowerCase();

      dl.innerHTML = "";
      const source = (typeof getAllVinsFn === "function") ? getAllVinsFn() : [];
      const out = [];

      for (let i = 0; i < source.length; i++) {
        const v = normalizeVin(source[i]);
        if (!v) continue;
        if (v.toLowerCase().includes(f)) out.push(v);
        if (out.length >= 80) break;
      }

      out.forEach(v => {
        const o = document.createElement("option");
        o.value = v;
        dl.appendChild(o);
      });
    }

    input.addEventListener("focus", () => fill(input.value));
    input.addEventListener("input", () => fill(input.value));

    input.addEventListener("change", ()=>rememberVin(input.value));
    input.addEventListener("blur", ()=>rememberVin(input.value));
  }

  // ---------- Apps Script (3 URL) ----------
  const LOOKUP_API_URL_BOSS =
    "https://script.google.com/macros/s/AKfycbzuBwFkGUiXnJcwUeTSt5jP8Y1BdE8PD0MQO_0SH6hr74O2htidfhD3Oop5zZ80G-GlDw/exec";

  const LOOKUP_API_URL_REF =
    "https://script.google.com/macros/s/AKfycbx_JDoOiJ_yTGiTyY16aIkNFSOjNelz40UiUbvVCdWq0wbsBpbTC5_0vZNga_ImSJ54MQ/exec";

  const LOOKUP_API_URL_RF_EXPENSE =
    "https://script.google.com/macros/s/AKfycbz-f23gebbose-v_t2iqFeX-7UeoKg1-JUU1fhPCdk2GqM0Dmk1bIDZJoHUVD_Q7bMHAA/exec";

  const LOOKUP_API_TOKEN = "";

  function getLookupUrl() {
    if (formType === "boss_buy") return LOOKUP_API_URL_BOSS;
    if (formType === "fin_company_expense") return LOOKUP_API_URL_RF_EXPENSE;
    return LOOKUP_API_URL_REF;
  }
  function getLookupUrlByForm(){ return getLookupUrl(); }

  function canUseLookup() {
    const u = getLookupUrl();
    return typeof u === "string" && u.trim().startsWith("https://");
  }

  function jsonpRequest(baseUrl, params, timeoutMs = 8000) {
    return new Promise((resolve, reject) => {
      const cb = "__cb_" + Math.random().toString(36).slice(2);
      const q = new URLSearchParams(params || {});
      q.set("callback", cb);
      if (LOOKUP_API_TOKEN) q.set("token", LOOKUP_API_TOKEN);

      const src = baseUrl + (baseUrl.includes("?") ? "&" : "?") + q.toString();
      const script = document.createElement("script");
      let done = false;

      function cleanup() {
        if (script && script.parentNode) script.parentNode.removeChild(script);
        try { delete window[cb]; } catch (e) { window[cb] = undefined; }
      }

      const timer = setTimeout(() => {
        if (done) return;
        done = true;
        cleanup();
        reject(new Error("Lookup timeout"));
      }, timeoutMs);

      window[cb] = (data) => {
        if (done) return;
        done = true;
        clearTimeout(timer);
        cleanup();
        resolve(data);
      };

      script.onerror = () => {
        if (done) return;
        done = true;
        clearTimeout(timer);
        cleanup();
        reject(new Error("Lookup request failed"));
      };

      script.src = src;
      document.body.appendChild(script);
    });
  }

  // remote cache
  const remoteCache = {
    vins: [],
    brand_models: [],
    sources: [],
    managers: [],
    expense_categories: [],
    expense_articles: [],
    suppliers: [],
    places: [],
  };

  function getAllVins() {
    return mergeUnique(remoteCache.vins, lsReadArr(LS_KEYS.VINS)).map(v => normalizeVin(v));
  }
  function getAllBrandModels() {
    return mergeUnique(brands, remoteCache.brand_models, lsReadArr(LS_KEYS.BRAND_MODELS));
  }
  function getAllManagers() {
    return mergeUnique(managers, remoteCache.managers, lsReadArr(LS_KEYS.MANAGERS));
  }
  function getAllSources() {
    const raw = mergeUnique(sources, remoteCache.sources, lsReadArr(LS_KEYS.SOURCES));
    return removeManagersFromSources(raw, getAllManagers());
  }
  function getAllExpenseCategories() {
    return mergeUnique(remoteCache.expense_categories, lsReadArr(LS_KEYS.EXP_CATS));
  }
  function getAllExpenseArticles() {
    return mergeUnique(remoteCache.expense_articles, lsReadArr(LS_KEYS.EXP_ARTICLES));
  }

  async function remoteListsLoad(force=false) {
    if (!canUseLookup()) return;
    try {
      const res = await jsonpRequest(getLookupUrl(), { action: "lists" }, 8000);
      if (res && res.ok && res.lists) {
        const L = res.lists;

        remoteCache.vins = Array.isArray(L.vins) ? L.vins : remoteCache.vins;
        remoteCache.brand_models = Array.isArray(L.brand_models) ? L.brand_models : remoteCache.brand_models;
        remoteCache.sources = Array.isArray(L.sources) ? L.sources : remoteCache.sources;
        remoteCache.managers = Array.isArray(L.managers) ? L.managers : remoteCache.managers;
        remoteCache.expense_categories = Array.isArray(L.expense_categories) ? L.expense_categories : remoteCache.expense_categories;
        remoteCache.suppliers = Array.isArray(L.suppliers) ? L.suppliers : remoteCache.suppliers;
        remoteCache.places = Array.isArray(L.places) ? L.places : remoteCache.places;

        remoteCache.expense_articles = Array.isArray(L.expense_articles) ? L.expense_articles : remoteCache.expense_articles;

        // ‚úÖ —Ñ–∏–ª—å—Ç—Ä—É–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –æ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
        remoteCache.sources = removeManagersFromSources(remoteCache.sources, remoteCache.managers);

        // write LS
        if (remoteCache.vins.length) lsWriteArr(LS_KEYS.VINS, mergeUnique(remoteCache.vins, lsReadArr(LS_KEYS.VINS)), 4000);
        if (remoteCache.brand_models.length) lsWriteArr(LS_KEYS.BRAND_MODELS, mergeUnique(remoteCache.brand_models, lsReadArr(LS_KEYS.BRAND_MODELS)), 3000);
        if (remoteCache.managers.length) lsWriteArr(LS_KEYS.MANAGERS, mergeUnique(remoteCache.managers, lsReadArr(LS_KEYS.MANAGERS)), 2000);

        // ‚úÖ –í–ê–ñ–ù–û: —á–∏—Å—Ç–∏–º localStorage sources –æ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ (—á—Ç–æ–±—ã "–≥—Ä—è–∑—å" –±–æ–ª—å—à–µ –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–ª–∞—Å—å)
        const lsSourcesClean = removeManagersFromSources(lsReadArr(LS_KEYS.SOURCES), remoteCache.managers);
        const mergedSourcesClean = mergeUnique(remoteCache.sources, lsSourcesClean);
        if (mergedSourcesClean.length) lsWriteArr(LS_KEYS.SOURCES, mergedSourcesClean, 2000);

        if (remoteCache.expense_categories.length) lsWriteArr(LS_KEYS.EXP_CATS, mergeUnique(remoteCache.expense_categories, lsReadArr(LS_KEYS.EXP_CATS)), 2000);
        if (remoteCache.expense_articles.length) lsWriteArr(LS_KEYS.EXP_ARTICLES, mergeUnique(remoteCache.expense_articles, lsReadArr(LS_KEYS.EXP_ARTICLES)), 2000);

        // refresh datalists/selects if present
        updateDatalist("vinInput_list", getAllVins());
        updateDatalist("brandModelInput_list", getAllBrandModels());

        const mgrEl = document.getElementById("managerInput");
        if (mgrEl && mgrEl.tagName === "SELECT") updateSelectOptions("managerInput", getAllManagers(), "–í—ã–±–µ—Ä–∏—Ç–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞");
        else updateDatalist("managerInput_list", getAllManagers());

        const srcEl = document.getElementById("leadSourceInput");
        if (srcEl && srcEl.tagName === "SELECT") updateSelectOptions("leadSourceInput", getAllSources(), "–í—ã–±–µ—Ä–∏—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫");
        else updateDatalist("leadSourceInput_list", getAllSources());

        updateDatalist("categoryInput_list", getAllExpenseCategories());
        updateDatalist("expenseArticleInput_list", getAllExpenseArticles());

        updateDatalist("supplierInput_list", mergeUnique(remoteCache.suppliers, lsReadArr("boss_buy_suppliers")));
        updateDatalist("placeInput_list", mergeUnique(remoteCache.places, lsReadArr("boss_buy_places")));
      }
    } catch (e) {
      console.warn("remoteListsLoad failed:", e);
    }
  }

  function shouldRefreshRemoteLists() {
    const ts = Number(localStorage.getItem(LS_KEYS.REMOTE_TS) || "0");
    const TTL = 10 * 60 * 1000;
    return (!ts) || ((Date.now() - ts) > TTL);
  }

  function scheduleRemoteListsLoad() {
    if (!canUseLookup()) return;
    const run = async () => {
      await remoteListsLoad(true);
      try { localStorage.setItem(LS_KEYS.REMOTE_TS, String(Date.now())); } catch(e){}
    };
    if (shouldRefreshRemoteLists()) {
      const idle = window.requestIdleCallback || ((fn) => setTimeout(fn, 200));
      idle(run);
    } else {
      if (!lsReadArr(LS_KEYS.VINS).length && !remoteCache.vins.length) run();
    }
  }

  // ---------- lookup by VIN ----------
  async function lookupByVin(vinRaw) {
    if (!canUseLookup()) return null;
    const vin = normalizeVin(vinRaw);
    if (!vin || vin.length < 4) return null;
    try {
      const res = await jsonpRequest(getLookupUrl(), { action: "lookup", vin: vin }, 8000);
      if (res && res.ok && res.found && res.data) return res.data;
    } catch (e) {}
    return null;
  }

  async function sourceByVinServer(vinRaw) {
    const vin = normalizeVin(vinRaw);
    if (!vin || vin.length < 4) return "";
    if (!["sale_main","sale_deposit","sale_extra","sale_nds_broker","sale_nds_no_broker","sale_cash","sale_cash_broker"].includes(formType)) return "";
    try {
      const res = await jsonpRequest(LOOKUP_API_URL_REF, { action: "source_by_vin", vin: vin }, 8000);
      if (res && res.ok && res.found && res.source) return String(res.source).trim();
    } catch (e) {}
    return "";
  }

  // ---------- managers & sources touch flags ----------
  let sourceTouched = false;
  function markTouched(id, setter){
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener("input", () => setter(true));
    el.addEventListener("change", () => setter(true));
  }

  // ---------- Render ----------
  function renderForm() {
    formCard.innerHTML = "";
    submitBtn.disabled = true;
    submitBtn.style.display = "block";
    submitBtn.textContent = "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –±–æ—Ç–∞";
    showError("");

    /* ‚úÖ NEW */
    if (formType === "deposit_status") {
      renderDepositStatusForm();
      return;
    }

    if (formType === "mgr_stock") {
      formCard.appendChild(createSelectKV("dealTypeInput", "–¢–∏–ø —Å–¥–µ–ª–∫–∏", [
        {value:"–°–∫–ª–∞–¥", label:"–°–∫–ª–∞–¥"},
        {value:"–ü–æ—Å—Ç–∞–≤–∫–∞", label:"–ü–æ—Å—Ç–∞–≤–∫–∞"},
      ], "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Å–¥–µ–ª–∫–∏", true));

      formCard.appendChild(createSelectFromList("managerInput","–ú–µ–Ω–µ–¥–∂–µ—Ä", getAllManagers(), "–í—ã–±–µ—Ä–∏—Ç–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞", true));

      formCard.appendChild(createAutocompleteInput("brandModelInput", "–ú–∞—Ä–∫–∞ / –ú–æ–¥–µ–ª—å", "–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å", getAllBrandModels(), true));
      formCard.appendChild(createInput("vinInput", "VIN (–º–æ–∂–Ω–æ —Ü–∏—Ñ—Ä—ã –ø–æ–¥—Ä—è–¥)", "–ù–∞–ø—Ä–∏–º–µ—Ä: 1457 –∏–ª–∏ –ø–æ–ª–Ω—ã–π VIN", "", "text", false, true));
      formCard.appendChild(createInput("configInput", "–ö–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è", "", "", "text", false, true));
      formCard.appendChild(createInput("bodyColorInput", "–¶–≤–µ—Ç –∫—É–∑–æ–≤–∞", "", "", "text", false, true));
      formCard.appendChild(createInput("salonColorInput", "–¶–≤–µ—Ç —Å–∞–ª–æ–Ω–∞", "", "", "text", false, true));
      formCard.appendChild(createInput("priceInput", "–¶–µ–Ω–∞, ‚ÇΩ", "", "", "text", false, true));
      formCard.appendChild(createInput("stockDateInput", "–î–∞—Ç–∞", "", todayISO(), "date", false, true));

      formCard.appendChild(createSelectKV("payTypeInput", "–¢–∏–ø –æ–ø–ª–∞—Ç—ã", [
        {value:"–ù–∞–ª", label:"–ù–∞–ª"},
        {value:"–ë–µ–∑–Ω–∞–ª", label:"–ë–µ–∑–Ω–∞–ª"},
        {value:"–ù–î–°", label:"–ù–î–°"},
      ], "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ–ø–ª–∞—Ç—ã", true));

      formCard.appendChild(createInput("clientInput", "–ö–ª–∏–µ–Ω—Ç (–ò–º—è + —Ç–µ–ª–µ—Ñ–æ–Ω)", "", "", "text", false, true));

      setupVinAutocompleteSmart("vinInput", getAllVins);
      setupMoneyInput("priceInput");

      submitBtn.disabled = false;
      return;
    }

    if (isSaleMainLike(formType)) {
      renderSaleMain();
      return;
    }

    if (formType === "sale_deposit") {
      formCard.appendChild(createSelectFromList("managerInput","–ú–µ–Ω–µ–¥–∂–µ—Ä", getAllManagers(), "–í—ã–±–µ—Ä–∏—Ç–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞", true));

      formCard.appendChild(createInput("saleDateInput", "–î–∞—Ç–∞", "", todayISO(), "date", false, true));
      formCard.appendChild(createAutocompleteInput("brandModelInput", "–ú–∞—Ä–∫–∞ / –ú–æ–¥–µ–ª—å", "", getAllBrandModels(), true));
      formCard.appendChild(createInput("vinInput", "VIN (–º–æ–∂–Ω–æ —Ü–∏—Ñ—Ä—ã –ø–æ–¥—Ä—è–¥)", "–ù–∞–ø—Ä–∏–º–µ—Ä: 1457 –∏–ª–∏ –ø–æ–ª–Ω—ã–π VIN", "", "text", false, true));

      formCard.appendChild(createSelectFromList("leadSourceInput", "–ò—Å—Ç–æ—á–Ω–∏–∫", getAllSources(), "–í—ã–±–µ—Ä–∏—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫", true));

      formCard.appendChild(createInput("depositSumInput", "–°—É–º–º–∞ –∑–∞–¥–∞—Ç–∫–∞", "", "", "text", false, true));
      formCard.appendChild(createInput("receiverInput", "–ö–æ–º—É –ø–µ—Ä–µ–¥–∞–Ω–∞ —Å—É–º–º–∞", "", "", "text", false, true));
      formCard.appendChild(createInput("priceInput", "–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏", "", "", "text", false, true));
      formCard.appendChild(createInput("buyerInput", "–ü–æ–∫—É–ø–∞—Ç–µ–ª—å (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)", "", "", "text", false, false));

      setupVinAutocompleteSmart("vinInput", getAllVins);
      setupMoneyInput("depositSumInput");
      setupMoneyInput("priceInput");

      sourceTouched = false;
      markTouched("leadSourceInput", v=>sourceTouched=v);

      setupAutoFillFromVin();
      submitBtn.disabled = false;
      return;
    }

    if (formType === "sale_extra") {
      formCard.appendChild(createInput("saleDateInput", "–î–∞—Ç–∞", "", todayISO(), "date", false, true));
      formCard.appendChild(createAutocompleteInput("brandModelInput", "–ú–∞—Ä–∫–∞ / –ú–æ–¥–µ–ª—å", "", getAllBrandModels(), true));
      formCard.appendChild(createInput("vinInput", "VIN (–º–æ–∂–Ω–æ —Ü–∏—Ñ—Ä—ã –ø–æ–¥—Ä—è–¥)", "–ù–∞–ø—Ä–∏–º–µ—Ä: 1457 –∏–ª–∏ –ø–æ–ª–Ω—ã–π VIN", "", "text", false, true));

      formCard.appendChild(createTextarea("extraDescInput", "–î–æ–ø. —É—Å–ª—É–≥–∏ (–æ–ø–∏—Å–∞–Ω–∏–µ) (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)", "", false, false));
      formCard.appendChild(createInput("priceInput", "–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏", "", "", "text", false, true));
      formCard.appendChild(createInput("receiverInput", "–ö–æ–º—É –ø–µ—Ä–µ–¥–∞–ª–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞", "", "", "text", false, true));
      formCard.appendChild(createInput("purchaserInput", "–ö—Ç–æ –≤—ã–¥–∞–ª —Å—Ä–µ–¥—Å—Ç–≤–∞ –Ω–∞ –∑–∞–∫—É–ø–∫—É", "", "", "text", false, true));
      formCard.appendChild(createInput("buyPriceInput", "–¶–µ–Ω–∞ –ø–æ–∫—É–ø–∫–∏", "", "", "text", false, true));
      formCard.appendChild(createInput("profitInput", "–î–æ—Ö–æ–¥", "–ê–≤—Ç–æ—Ä–∞—Å—á—ë—Ç (–º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å)", "", "text", false, true));

      setupVinAutocompleteSmart("vinInput", getAllVins);
      setupMoneyInput("priceInput");
      setupMoneyInput("buyPriceInput");
      setupMoneyInput("profitInput");

      setupAutoProfit();

      sourceTouched = false;
      markTouched("leadSourceInput", v=>sourceTouched=v);

      setupAutoFillFromVin();
      submitBtn.disabled = false;
      return;
    }

    if (formType === "fin_auto_template") {
      formCard.appendChild(createInput("vinInput", "VIN (–º–æ–∂–Ω–æ —Ü–∏—Ñ—Ä—ã –ø–æ–¥—Ä—è–¥)", "–ù–∞–ø—Ä–∏–º–µ—Ä: 1457 –∏–ª–∏ –ø–æ–ª–Ω—ã–π VIN", "", "text", false, false));
      formCard.appendChild(createAutocompleteInput("brandModelInput", "–ú–∞—Ä–∫–∞ / –ú–æ–¥–µ–ª—å", "", getAllBrandModels(), false));
      formCard.appendChild(createInput("faDateInput", "–î–∞—Ç–∞", "", todayISO(), "date", false, false));
      formCard.appendChild(createInput("evacuatorInput", "–≠–≤–∞–∫—É–∞—Ç–æ—Ä", "", "", "text", false, false));
      formCard.appendChild(createInput("labInput", "–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è", "", "", "text", false, false));
      formCard.appendChild(createInput("utilWriteoffInput", "–°–ø–∏—Å–∞–Ω–∏—è —É—Ç–∏–ª—å—Å–±–æ—Ä–∞", "", "", "text", false, false));
      formCard.appendChild(createInput("utilInput", "–£—Ç–∏–ª—å—Å–±–æ—Ä", "", "", "text", false, false));
      formCard.appendChild(createInput("preSaleInput", "–ü—Ä–µ–¥–ø—Ä–æ–¥–∞–∂–Ω–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞", "", "", "text", false, false));
      formCard.appendChild(createInput("marketingInput", "–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥", "", "", "text", false, false));
      formCard.appendChild(createInput("otherInput", "–ü—Ä–æ—á–∏–µ —Ä–∞—Å—Ö–æ–¥—ã", "", "", "text", false, false));
      formCard.appendChild(createTextarea("extraExpensesInput", "–î–æ–ø. —Ä–∞—Å—Ö–æ–¥—ã", "–ï—Å–ª–∏ –µ—Å—Ç—å: —Å—Ç—Ä–æ–∫–∞–º–∏", false, false));
      formCard.appendChild(createTextarea("commentInput", "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π", "", false, false));

      setupVinAutocompleteSmart("vinInput", getAllVins);
      ["evacuatorInput","labInput","utilWriteoffInput","utilInput","preSaleInput","marketingInput","otherInput"].forEach(setupMoneyInput);

      setupAutoFillBrandByVinOnly();
      submitBtn.disabled = false;
      return;
    }

    if (formType === "fin_company_expense") {
      formCard.appendChild(createInput("opDateInput", "–î–∞—Ç–∞", "", todayISO(), "date", false, false));
      formCard.appendChild(createAutocompleteInput("expenseArticleInput", "–°—Ç–∞—Ç—å—è", "–ù–∞—á–Ω–∏ –≤–≤–æ–¥–∏—Ç—å —Å—Ç–∞—Ç—å—é", getAllExpenseArticles(), false));
      formCard.appendChild(createInput("amountInput", "–°—É–º–º–∞, ‚ÇΩ", "–ù–∞–ø—Ä–∏–º–µ—Ä: 1 200 000", "", "text", false, false));
      formCard.appendChild(createTextarea("commentInput", "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)", "", false, false));

      setupMoneyInput("amountInput");
      submitBtn.disabled = false;
      return;
    }

    if (formType === "fin_company") {
      formCard.appendChild(createInput("opDateInput", "–î–∞—Ç–∞", "", todayISO(), "date", false, false));
      formCard.appendChild(createAutocompleteInput("categoryInput", "–°—Ç–∞—Ç—å—è —Ä–∞—Å—Ö–æ–¥–∞", "–ù–∞–ø—Ä–∏–º–µ—Ä: –ê—Ä–µ–Ω–¥–∞", getAllExpenseCategories(), false));
      formCard.appendChild(createInput("amountInput", "–°—É–º–º–∞, ‚ÇΩ", "", "", "text", false, false));
      formCard.appendChild(createTextarea("commentInput", "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)", "", false, false));

      setupMoneyInput("amountInput");
      submitBtn.disabled = false;
      return;
    }

    if (formType === "boss_buy") {
      renderBossBuy();
      return;
    }

    if (formType === "boss_invest_in" || formType === "boss_invest_out") {
      formCard.appendChild(createAutocompleteInput("investorInput", "–ò–Ω–≤–µ—Å—Ç–æ—Ä", "", investors, false));
      formCard.appendChild(createInput("sumInput", "–°—É–º–º–∞", "", "", "text", false, false));
      formCard.appendChild(createInput("opDateInput", "–î–∞—Ç–∞", "", todayISO(), "date", false, false));
      formCard.appendChild(createTextarea("commentInput", "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π", "", false, false));
      setupMoneyInput("sumInput");
      submitBtn.disabled = false;
      return;
    }

    formCard.appendChild(createTextarea("rawInput", "–î–∞–Ω–Ω—ã–µ", "–§–æ—Ä–º–∞ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞. –í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤ —Å–≤–æ–±–æ–¥–Ω–æ–π —Ñ–æ—Ä–º–µ.", false, true));
    submitBtn.disabled = false;
  }

  // ‚úÖ NEW: —Ñ–æ—Ä–º–∞ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–¥–∞—Ç–∫–∞ (WebApp –Ω–∞–ø—Ä—è–º—É—é –ø–∏—à–µ—Ç –≤ —Ç–∞–±–ª–∏—Ü—É —á–µ—Ä–µ–∑ Apps Script)
  function renderDepositStatusForm(){
    formCard.innerHTML = "";
    submitBtn.disabled = true;
    submitBtn.style.display = "none"; // —Ç—É—Ç –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –±–æ—Ç–∞
    showError("");

    formCard.appendChild(createInput("depVinInput", "VIN (–≤–≤–µ–¥–∏—Ç–µ 4+ —Å–∏–º–≤–æ–ª–∞)", "–ù–∞–ø—Ä–∏–º–µ—Ä: 1457 –∏–ª–∏ VIN", "", "text", false, true));

    const hint = document.createElement("div");
    hint.className = "hint";
    hint.textContent = "–ü–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç VIN-—ã, –∫–æ—Ç–æ—Ä—ã–µ –µ—Å—Ç—å –≤ –ª–∏—Å—Ç–µ ¬´–ó–∞–¥–∞—Ç–æ–∫¬ª –∏ –µ—â—ë –Ω–µ –∑–∞–∫—Ä—ã—Ç—ã.";
    formCard.appendChild(hint);

    // select —Å—Ç—Ä–æ–∫ –∑–∞–¥–∞—Ç–∫–∞
    const w = document.createElement("div");
    w.className = "field";
    const l = document.createElement("label");
    l.htmlFor = "depRowSelect";
    l.textContent = "–ù–∞–π–¥–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—Ç–∫–∏";
    const s = document.createElement("select");
    s.id = "depRowSelect";
    s.disabled = true;

    const ph = document.createElement("option");
    ph.value = "";
    ph.textContent = "–°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏ VIN";
    ph.disabled = true;
    ph.selected = true;
    s.appendChild(ph);

    w.appendChild(l);
    w.appendChild(s);
    formCard.appendChild(w);

    const info = document.createElement("div");
    info.className = "hint";
    info.id = "depInfo";
    info.textContent = "";
    formCard.appendChild(info);

    // –∫–Ω–æ–ø–∫–∏ —Å—Ç–∞—Ç—É—Å–∞
    const btnRow = document.createElement("div");
    btnRow.className = "btnRow";

    const statuses = [
      { txt: "‚úÖ –ó–∞—á—Ç—ë–Ω", val: "–ó–∞—á—Ç—ë–Ω" },
      { txt: "‚Ü©Ô∏è –í–æ–∑–≤—Ä–∞—Ç", val: "–í–æ–∑–≤—Ä–∞—Ç" },
      { txt: "üî• –°–≥–æ—Ä–µ–ª", val: "–°–≥–æ—Ä–µ–ª" },
    ];

    const btns = [];
    statuses.forEach(st=>{
      const b = document.createElement("button");
      b.type = "button";
      b.className = "actionBtn actionBtnPrimary";
      b.textContent = st.txt;
      b.disabled = true;
      b.addEventListener("click", ()=>applyDepositStatus(st.val));
      btnRow.appendChild(b);
      btns.push(b);
    });

    formCard.appendChild(btnRow);

    // datalist –¥–ª—è VIN
    const vinEl = document.getElementById("depVinInput");
    const dlId = "depVinInput_list";
    vinEl.setAttribute("list", dlId);
    let dl = document.getElementById(dlId);
    if (!dl) {
      dl = document.createElement("datalist");
      dl.id = dlId;
      document.body.appendChild(dl);
    }

    let tmr = null;

    async function suggestVins(){
      const q = String(vinEl.value||"").trim();
      if (!q || q.length < 2) { updateDatalist(dlId, []); return; }
      try{
        const res = await jsonpRequest(getLookupUrl(), { action:"deposit_suggest", q:q, limit:"80" }, 8000);
        if (res && res.ok && Array.isArray(res.vins)) {
          updateDatalist(dlId, res.vins.map(v=>normalizeVin(v)));
        }
      }catch(e){}
    }

    async function loadRows(){
      showError("");
      info.textContent = "";
      s.innerHTML = "";
      const ph2 = document.createElement("option");
      ph2.value = "";
      ph2.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞...";
      ph2.disabled = true;
      ph2.selected = true;
      s.appendChild(ph2);
      s.disabled = true;
      btns.forEach(b=>b.disabled=true);

      const v = normalizeVin(vinEl.value);
      if (!v || v.length < 4) {
        s.innerHTML = "";
        const ph3 = document.createElement("option");
        ph3.value = "";
        ph3.textContent = "–í–≤–µ–¥–∏ VIN (4+ —Å–∏–º–≤–æ–ª–∞)";
        ph3.disabled = true;
        ph3.selected = true;
        s.appendChild(ph3);
        s.disabled = true;
        return;
      }

      try{
        const res = await jsonpRequest(getLookupUrl(), { action:"deposit_rows", vin:v, limit:"25" }, 8000);
        if (!res || !res.ok || !res.found || !Array.isArray(res.rows) || !res.rows.length) {
          s.innerHTML = "";
          const ph4 = document.createElement("option");
          ph4.value = "";
          ph4.textContent = "–ê–∫—Ç–∏–≤–Ω—ã–π –∑–∞–¥–∞—Ç–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω";
          ph4.disabled = true;
          ph4.selected = true;
          s.appendChild(ph4);
          s.disabled = true;
          showError("–ê–∫—Ç–∏–≤–Ω—ã–π (–Ω–µ –∑–∞–∫—Ä—ã—Ç—ã–π) –∑–∞–¥–∞—Ç–æ–∫ –ø–æ —ç—Ç–æ–º—É VIN –Ω–µ –Ω–∞–π–¥–µ–Ω.");
          return;
        }

        s.innerHTML = "";
        const ph5 = document.createElement("option");
        ph5.value = "";
        ph5.textContent = "–í—ã–±–µ—Ä–∏ —Å—Ç—Ä–æ–∫—É";
        ph5.disabled = true;
        ph5.selected = true;
        s.appendChild(ph5);

        res.rows.forEach(r=>{
          const buyer = (r.buyer||"–±–µ–∑ –∏–º–µ–Ω–∏").toString().trim();
          const dt = (r.sale_date||"").toString().trim();
          const sm = (r.deposit_sum||"").toString().trim();
          const rowNum = r.row;
          const opt = document.createElement("option");
          opt.value = String(rowNum);
          opt.textContent = `${buyer} | ${dt} | ${sm} | #${rowNum}`.slice(0, 120);
          opt.dataset.buyer = buyer;
          opt.dataset.dt = dt;
          opt.dataset.sm = sm;
          opt.dataset.status = (r.status||"").toString();
          s.appendChild(opt);
        });

        s.disabled = false;
        // –∞–≤—Ç–æ –≤—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–æ–∫—É
        if (s.options.length > 1) {
          s.selectedIndex = 1;
          updateInfo();
          btns.forEach(b=>b.disabled=false);
        }
      }catch(e){
        s.innerHTML = "";
        const ph6 = document.createElement("option");
        ph6.value = "";
        ph6.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏";
        ph6.disabled = true;
        ph6.selected = true;
        s.appendChild(ph6);
        s.disabled = true;
        showError("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–¥–∞—Ç–∫–∏. –ü—Ä–æ–≤–µ—Ä—å Apps Script deploy.");
      }
    }

    function updateInfo(){
      const opt = s.options[s.selectedIndex];
      if (!opt || !opt.value) { info.textContent=""; return; }
      const buyer = opt.dataset.buyer || "";
      const dt = opt.dataset.dt || "";
      const sm = opt.dataset.sm || "";
      const st = opt.dataset.status || "";
      info.textContent =
        `–ü–æ–∫—É–ø–∞—Ç–µ–ª—å: ${buyer}\n–î–∞—Ç–∞: ${dt}\n–°—É–º–º–∞: ${sm}` + (st ? `\n–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å: ${st}` : "");
    }

    async function applyDepositStatus(status){
      showError("");
      const row = Number(s.value || "0");
      if (!row) {
        showError("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ –Ω—É–∂–Ω—É—é —Å—Ç—Ä–æ–∫—É –∑–∞–¥–∞—Ç–∫–∞.");
        return;
      }

      btns.forEach(b=>b.disabled=true);

      try{
        const res = await jsonpRequest(getLookupUrl(), { action:"deposit_set_status", row:String(row), status:String(status) }, 8000);
        if (res && res.ok) {
          tgAlert(`‚úÖ –°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª—ë–Ω: ${status}\n–°—Ç—Ä–æ–∫–∞: ${row}`);
          // –æ–±–Ω–æ–≤–∏–º —Å–ø–∏—Å–æ–∫
          await loadRows();
          return;
        }
        showError("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å. –ü—Ä–æ–≤–µ—Ä—å –ø—Ä–∞–≤–∞/–∑–∞–≥–æ–ª–æ–≤–∫–∏ —Å—Ç–æ–ª–±—Ü–æ–≤ ¬´–°—Ç–∞—Ç—É—Å/–ó–∞–∫—Ä—ã—Ç¬ª.");
      }catch(e){
        showError("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞. –ü—Ä–æ–≤–µ—Ä—å Apps Script deploy –∏ –¥–æ—Å—Ç—É–ø.");
      } finally {
        if (!s.disabled && s.value) btns.forEach(b=>b.disabled=false);
      }
    }

    // —Å–æ–±—ã—Ç–∏—è
    vinEl.addEventListener("input", ()=>{
      if (tmr) clearTimeout(tmr);
      tmr = setTimeout(async ()=>{
        await suggestVins();
        // –Ω–µ –≥—Ä—É–∑–∏–º rows –Ω–∞ –∫–∞–∂–¥—É—é –±—É–∫–≤—É, —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ 4+ —Å–∏–º–≤–æ–ª–∞
        if (normalizeVin(vinEl.value).length >= 4) await loadRows();
      }, 250);
    });
    vinEl.addEventListener("change", loadRows);
    vinEl.addEventListener("blur", ()=>{ if (normalizeVin(vinEl.value).length >= 4) loadRows(); });

    s.addEventListener("change", ()=>{
      updateInfo();
      btns.forEach(b=>b.disabled = !s.value);
    });
  }

  // ---------- Sale Main ----------
  function applySalePresetByType(t) {
    const pay = document.getElementById("salePaymentTypeInput");
    const vat = document.getElementById("saleVatInput");
    const comm = document.getElementById("saleCommissionInput");
    if (!pay || !vat || !comm) return;

    const type = String(t || "");
    pay.value = "cash";
    vat.value = "no";
    comm.value = "no";

    if (type === "sale_cash") { pay.value = "cash"; vat.value = "no"; comm.value = "no"; }
    else if (type === "sale_cash_broker") { pay.value = "cash"; vat.value = "no"; comm.value = "yes"; }
    else if (type === "sale_nds_no_broker") { pay.value = "cashless"; vat.value = "yes"; comm.value = "no"; }
    else if (type === "sale_nds_broker") { pay.value = "cashless"; vat.value = "yes"; comm.value = "yes"; }
  }

  function renderSaleMain() {
    formCard.innerHTML = "";

    formCard.appendChild(createSelectFromList("managerInput","–ú–µ–Ω–µ–¥–∂–µ—Ä", getAllManagers(), "–í—ã–±–µ—Ä–∏—Ç–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞", true));

    const payWrap = createSelectKV("salePaymentTypeInput", "–û–ø–ª–∞—Ç–∞", [
      {value:"cash", label:"–ù–∞–ª"},
      {value:"cashless", label:"–ë–µ–∑–Ω–∞–ª"},
    ], "–í—ã–±–µ—Ä–∏—Ç–µ –æ–ø–ª–∞—Ç—É", true);

    const vatWrap = createSelectKV("saleVatInput", "–ù–î–°", [
      {value:"yes", label:"–° –ù–î–°"},
      {value:"no", label:"–ë–µ–∑ –ù–î–°"},
    ], "–í—ã–±–µ—Ä–∏—Ç–µ –ù–î–°", true);

    const commWrap = createSelectKV("saleCommissionInput", "–ö–æ–º–∏—Å—Å–∏—è –±—Ä–æ–∫–µ—Ä–∞", [
      {value:"yes", label:"–ï—Å—Ç—å"},
      {value:"no", label:"–ù–µ—Ç"},
    ], "–í—ã–±–µ—Ä–∏—Ç–µ", true);

    formCard.appendChild(payWrap);
    formCard.appendChild(vatWrap);
    formCard.appendChild(commWrap);

    const badge = document.createElement("div");
    badge.style.marginTop = "6px";
    badge.innerHTML = `<span class="pill" id="saleVariantBadge">–í–∞—Ä–∏–∞–Ω—Ç: ‚Äî</span>`;
    formCard.appendChild(badge);

    formCard.appendChild(createInput("saleDateInput", "–î–∞—Ç–∞ –ø—Ä–æ–¥–∞–∂–∏", "", todayISO(), "date", false, true));
    formCard.appendChild(createAutocompleteInput("brandModelInput", "–ú–∞—Ä–∫–∞ / –ú–æ–¥–µ–ª—å", "", getAllBrandModels(), true));
    formCard.appendChild(createInput("vinInput", "VIN (–º–æ–∂–Ω–æ —Ü–∏—Ñ—Ä—ã –ø–æ–¥—Ä—è–¥)", "–ù–∞–ø—Ä–∏–º–µ—Ä: 1457 –∏–ª–∏ –ø–æ–ª–Ω—ã–π VIN", "", "text", false, true));

    formCard.appendChild(createSelectFromList("leadSourceInput", "–ò—Å—Ç–æ—á–Ω–∏–∫", getAllSources(), "–í—ã–±–µ—Ä–∏—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫", true));

    const buyerWrap = createInput("buyerInput", "–ü–æ–∫—É–ø–∞—Ç–µ–ª—å (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)", "", "", "text", false, false);
    const receiverWrap = createInput("receiverInput", "–ü–æ–ª—É—á–∞—Ç–µ–ª—å (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)", "", "", "text", false, false);
    formCard.appendChild(buyerWrap);
    formCard.appendChild(receiverWrap);

    const priceCashWrap = createInput("priceCashInput", "–¶–µ–Ω–∞ (–Ω–∞–ª)", "", "", "text", false, true);
    const priceCashNoCommWrap = createInput("priceCashNoCommInput", "–¶–µ–Ω–∞ –±–µ–∑ –∫–æ–º–∏—Å—Å–∏–∏ (–Ω–∞–ª)", "", "", "text", false, true);

    const priceCashlessWrap = createInput("priceCashlessInput", "–°—É–º–º–∞ (–±–µ–∑–Ω–∞–ª, –±–µ–∑ –ù–î–°)", "", "", "text", false, true);
    const priceNdsWrap = createInput("priceNdsInput", "–¶–µ–Ω–∞ —Å –ù–î–°", "", "", "text", false, true);
    const markupNdsWrap = createInput("markupNdsInput", "–ù–∞—Ü–µ–Ω–∫–∞ –ù–î–° (% / —Ä—É–±)", "", "", "text", false, true);

    const priceNoVatCashWrap = createInput("priceNoVatCashInput", "–¶–µ–Ω–∞ –±–µ–∑ –ù–î–° –∑–∞ –Ω–∞–ª–∏—á–Ω—ã–µ", "", "", "text", false, true);

    const contractPriceWrap = createInput("contractPriceInput", "–°—É–º–º–∞ –¥–æ–≥–æ–≤–æ—Ä–∞", "", "", "text", false, true);
    const brokerPriceWrap = createInput("brokerPriceInput", "–¶–µ–Ω–∞ –±–µ–∑ –∫–æ–º–∏—Å—Å–∏–∏ –±—Ä–æ–∫–µ—Ä–∞", "", "", "text", false, true);
    const brokerExpenseWrap = createInput("brokerExpenseInput", "–ö–æ–º–∏—Å—Å–∏—è –±—Ä–æ–∫–µ—Ä–∞ (–∫–æ–º–º–µ–Ω—Ç/—Å—É–º–º–∞)", "", "", "text", false, true);

    formCard.appendChild(priceCashWrap);
    formCard.appendChild(priceCashNoCommWrap);
    formCard.appendChild(priceCashlessWrap);
    formCard.appendChild(priceNdsWrap);
    formCard.appendChild(markupNdsWrap);
    formCard.appendChild(priceNoVatCashWrap);
    formCard.appendChild(contractPriceWrap);
    formCard.appendChild(brokerPriceWrap);
    formCard.appendChild(brokerExpenseWrap);

    ["priceCashInput","priceCashNoCommInput","priceCashlessInput","priceNdsInput","markupNdsInput","priceNoVatCashInput","contractPriceInput","brokerPriceInput"].forEach(setupMoneyInput);

    function updateSaleMainVisibility() {
      const payment = document.getElementById("salePaymentTypeInput").value || "cash";
      const commission = (document.getElementById("saleCommissionInput").value || "no") === "yes";
      const vatYes = (document.getElementById("saleVatInput").value || "no") === "yes";
      const vat = (payment === "cashless") && vatYes;

      const vatSelect = document.getElementById("saleVatInput");
      if (payment !== "cashless") {
        vatSelect.disabled = true;
        vatSelect.value = "no";
      } else {
        vatSelect.disabled = false;
      }

      showEl(receiverWrap, payment === "cash");

      showEl(priceCashWrap, payment === "cash");
      showEl(priceCashNoCommWrap, payment === "cash" && commission);

      showEl(priceCashlessWrap, payment === "cashless" && !vat);
      showEl(priceNdsWrap, payment === "cashless" && vat);
      showEl(markupNdsWrap, payment === "cashless" && vat);

      showEl(priceNoVatCashWrap, payment === "cashless" && vat);

      showEl(contractPriceWrap, payment === "cashless" && commission);
      showEl(brokerPriceWrap, payment === "cashless" && commission);
      showEl(brokerExpenseWrap, payment === "cashless" && commission);

      if (payment === "cash") {
        showEl(priceCashlessWrap, false);
        showEl(priceNdsWrap, false);
        showEl(markupNdsWrap, false);
        showEl(priceNoVatCashWrap, false);
        showEl(contractPriceWrap, false);
        showEl(brokerPriceWrap, false);
        showEl(brokerExpenseWrap, false);
      }

      let variant = "";
      if (payment === "cash" && !commission) variant = "–ù–∞–ª / –±–µ–∑ –±—Ä–æ–∫–µ—Ä–∞";
      if (payment === "cash" && commission) variant = "–ù–∞–ª / —Å –±—Ä–æ–∫–µ—Ä–æ–º";
      if (payment === "cashless" && vat && !commission) variant = "–ë–µ–∑–Ω–∞–ª / —Å –ù–î–° / –±–µ–∑ –±—Ä–æ–∫–µ—Ä–∞";
      if (payment === "cashless" && vat && commission) variant = "–ë–µ–∑–Ω–∞–ª / —Å –ù–î–° / —Å –±—Ä–æ–∫–µ—Ä–æ–º";
      if (payment === "cashless" && !vat && !commission) variant = "–ë–µ–∑–Ω–∞–ª / –±–µ–∑ –ù–î–° / –±–µ–∑ –±—Ä–æ–∫–µ—Ä–∞";
      if (payment === "cashless" && !vat && commission) variant = "–ë–µ–∑–Ω–∞–ª / –±–µ–∑ –ù–î–° / —Å –±—Ä–æ–∫–µ—Ä–æ–º";

      const badgeEl = document.getElementById("saleVariantBadge");
      if (badgeEl) badgeEl.textContent = "–í–∞—Ä–∏–∞–Ω—Ç: " + variant;
    }

    applySalePresetByType(formType);
    document.getElementById("salePaymentTypeInput").addEventListener("change", updateSaleMainVisibility);
    document.getElementById("saleVatInput").addEventListener("change", updateSaleMainVisibility);
    document.getElementById("saleCommissionInput").addEventListener("change", updateSaleMainVisibility);
    updateSaleMainVisibility();

    setupVinAutocompleteSmart("vinInput", getAllVins);

    sourceTouched = false;
    markTouched("leadSourceInput", v=>sourceTouched=v);

    setupAutoFillFromVin();
    submitBtn.disabled = false;
  }

  // ---------- Auto fill Brand + Source from VIN ----------
  function setupAutoFillBrandByVinOnly() {
    const vinEl = document.getElementById("vinInput");
    const brandEl = document.getElementById("brandModelInput");
    if (!vinEl || !brandEl) return;

    let brandTouched = false;
    brandEl.addEventListener("input", ()=>{ brandTouched=true; });

    let tmr=null;
    const run = async () => {
      const v = normalizeVin(vinEl.value);
      if (!v || v.length < 4) return;

      if (!brandTouched && !brandEl.value) {
        const data = await lookupByVin(v);
        const bm = data?.brand_model || data?.brandModel || "";
        if (bm) brandEl.value = bm;
      }
    };

    vinEl.addEventListener("input", ()=>{
      if (tmr) clearTimeout(tmr);
      tmr=setTimeout(run, 350);
    });
    vinEl.addEventListener("change", run);
    vinEl.addEventListener("blur", run);
  }

  function setupAutoFillFromVin() {
    const vinEl = document.getElementById("vinInput");
    const brandEl = document.getElementById("brandModelInput");
    const sourceEl = document.getElementById("leadSourceInput");
    if (!vinEl || !brandEl) return;

    let brandTouched = false;
    brandEl.addEventListener("input", ()=>{ brandTouched=true; });

    let tmr=null;
    const run = async () => {
      const v = normalizeVin(vinEl.value);
      if (!v || v.length < 4) return;

      if (!brandTouched && !brandEl.value) {
        const data = await lookupByVin(v);
        const bm = data?.brand_model || data?.brandModel || "";
        if (bm) brandEl.value = bm;
      }

      if (sourceEl && !sourceEl.value) {
        const local = vinSourceMapGet(v);
        if (local) { setSelectValueSmart(sourceEl, local); return; }

        const srv = await sourceByVinServer(v);
        if (srv) {
          setSelectValueSmart(sourceEl, srv);
          vinSourceMapSet(v, srv);

          try {
            const cur = lsReadArr(LS_KEYS.SOURCES);
            const merged = mergeUnique([srv], cur);
            lsWriteArr(LS_KEYS.SOURCES, merged, 2000);
          } catch(e){}
        }
      }
    };

    vinEl.addEventListener("input", ()=>{
      if (tmr) clearTimeout(tmr);
      tmr=setTimeout(run, 350);
    });
    vinEl.addEventListener("change", run);
    vinEl.addEventListener("blur", run);
  }

  // ---------- Auto profit (sale_extra) ----------
  function toNum(v){
    const s = String(v||"").replace(/\s/g,"").replace(",",".").replace(/[^\d.\-]/g,"");
    const n = parseFloat(s);
    return Number.isFinite(n) ? n : 0;
  }
  function setupAutoProfit(){
    const priceEl = document.getElementById("priceInput");
    const buyEl = document.getElementById("buyPriceInput");
    const profitEl = document.getElementById("profitInput");
    if (!priceEl || !buyEl || !profitEl) return;

    let manual = false;
    profitEl.addEventListener("input", ()=>{ manual=true; });

    const recalc = () => {
      if (manual) return;
      const p = toNum(priceEl.value);
      const b = toNum(buyEl.value);
      if (!p && !b) return;
      const diff = p - b;
      profitEl.value = formatWithSpaces(String(Math.round(diff)));
    };

    priceEl.addEventListener("input", recalc);
    buyEl.addEventListener("input", recalc);
  }

  // ---------- boss_buy ----------
  function renderBossBuy() {
    formCard.innerHTML = "";

    formCard.appendChild(createInput("vinInput", "VIN (–º–æ–∂–Ω–æ —Ü–∏—Ñ—Ä—ã –ø–æ–¥—Ä—è–¥)", "–ù–∞–ø—Ä–∏–º–µ—Ä: 1457 –∏–ª–∏ –ø–æ–ª–Ω—ã–π VIN", "", "text", false, false));

    const modeWrap = document.createElement("div");
    modeWrap.className = "field";
    const modeLabel = document.createElement("label");
    modeLabel.textContent = "–ß—Ç–æ –¥–µ–ª–∞–µ–º?";
    const modeSelect = document.createElement("select");
    modeSelect.id = "modeSelect";
    modeSelect.innerHTML = `
      <option value="purchase">–ù–æ–≤–∞—è –∑–∞–∫—É–ø–∫–∞ (—Å–æ–∑–¥–∞—Ç—å VIN)</option>
      <option value="payment">–î–æ–±–∞–≤–∏—Ç—å –æ–ø–ª–∞—Ç—É –∫ VIN</option>
    `;
    const modeBadge = document.createElement("div");
    modeBadge.style.marginTop = "6px";
    modeBadge.innerHTML = `<span class="pill" id="modeBadge">–†–µ–∂–∏–º: ‚Äî</span>`;
    modeWrap.appendChild(modeLabel);
    modeWrap.appendChild(modeSelect);
    modeWrap.appendChild(modeBadge);
    formCard.appendChild(modeWrap);

    const hint = document.createElement("div");
    hint.className = "hint";
    hint.textContent = "–ü–æ–¥—Å–∫–∞–∑–∫–∏ VIN —Ä–∞–±–æ—Ç–∞—é—Ç –ø–æ –≤—Ö–æ–∂–¥–µ–Ω–∏—é (—Ü–∏—Ñ—Ä—ã –ø–æ–¥—Ä—è–¥).";
    formCard.appendChild(hint);

    formCard.appendChild(document.createElement("div")).className = "divider";

    const purchaseBlock = document.createElement("div");
    purchaseBlock.id = "purchaseBlock";
    purchaseBlock.appendChild(createInput("purchaseDateInput", "–î–∞—Ç–∞ –∑–∞–∫—É–ø–∫–∏", "", todayISO(), "date", false, false));
    purchaseBlock.appendChild(createAutocompleteInput("supplierInput", "–ü–æ—Å—Ç–∞–≤—â–∏–∫", "", mergeUnique(remoteCache.suppliers, lsReadArr("boss_buy_suppliers")), false));
    purchaseBlock.appendChild(createAutocompleteInput("placeInput", "–ú–µ—Å—Ç–æ –∑–∞–∫—É–ø–∫–∏", "", mergeUnique(remoteCache.places, lsReadArr("boss_buy_places")), false));
    purchaseBlock.appendChild(createAutocompleteInput("brandModelInput", "–ú–∞—Ä–∫–∞ / –ú–æ–¥–µ–ª—å", "", getAllBrandModels(), false));
    purchaseBlock.appendChild(createInput("complectationInput", "–ö–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è", "", "", "text", false, false));

    purchaseBlock.appendChild(
      createSelectKV("currencyInput", "–í–∞–ª—é—Ç–∞ ($ / ‚ÇΩ / ¬•)", [
        {value:"$", label:"$ (–¥–æ–ª–ª–∞—Ä)"},
        {value:"‚ÇΩ", label:"‚ÇΩ (—Ä—É–±–ª—å)"},
        {value:"¬•", label:"¬• (—é–∞–Ω—å)"},
      ], "–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞–ª—é—Ç—É", false)
    );

    purchaseBlock.appendChild(createInput("amountCurrencyInput", "–°—É–º–º–∞, –≤–∞–ª—é—Ç–∞", "", "", "text", false, false));
    purchaseBlock.appendChild(createInput("rateInput", "–ö—É—Ä—Å (–Ω–∞ –¥–∞—Ç—É –ø–µ—Ä–≤–æ–π –æ–ø–ª–∞—Ç—ã)", "", "", "text", false, false));
    purchaseBlock.appendChild(createInput("amountRubInput", "–°—Ç–æ–∏–º–æ—Å—Ç—å –∞–≤—Ç–æ, ‚ÇΩ (–∫–æ–Ω—Ç—Ä–æ–ª—å)", "–ê–≤—Ç–æ—Ä–∞—Å—á—ë—Ç", "", "text", true, false));
    purchaseBlock.appendChild(createTextarea("commentInput_p", "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π", "–ü–æ –∂–µ–ª–∞–Ω–∏—é", false, false));

    const paymentBlock = document.createElement("div");
    paymentBlock.id = "paymentBlock";
    paymentBlock.appendChild(createInput("payDateInput", "–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã", "", todayISO(), "date", false, false));
    paymentBlock.appendChild(
      createSelectKV("payCurrencySelect", "–í–∞–ª—é—Ç–∞ –æ–ø–ª–∞—Ç—ã", [
        {value:"‚ÇΩ", label:"‚ÇΩ (—Ä—É–±–ª—å)"},
        {value:"$", label:"$ (–¥–æ–ª–ª–∞—Ä)"},
        {value:"¬•", label:"¬• (—é–∞–Ω—å)"},
      ], "–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞–ª—é—Ç—É", false)
    );
    paymentBlock.appendChild(createInput("payAmountCurrencyInput", "–°—É–º–º–∞ –æ–ø–ª–∞—Ç—ã (–≤–∞–ª—é—Ç–∞)", "", "", "text", false, false));
    paymentBlock.appendChild(createInput("payRateInput", "–ö—É—Ä—Å –Ω–∞ –¥–∞—Ç—É –æ–ø–ª–∞—Ç—ã", "", "", "text", false, false));
    paymentBlock.appendChild(createInput("payRubInput", "–°—É–º–º–∞ –æ–ø–ª–∞—Ç—ã (‚ÇΩ)", "–ê–≤—Ç–æ—Ä–∞—Å—á—ë—Ç", "", "text", false, false));
    paymentBlock.appendChild(createTextarea("commentInput", "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π", "–ü–æ –∂–µ–ª–∞–Ω–∏—é", false, false));

    formCard.appendChild(purchaseBlock);
    formCard.appendChild(paymentBlock);

    function setMode(mode) {
      const badge = document.getElementById("modeBadge");
      const mSel = document.getElementById("modeSelect");
      if (mSel.value !== mode) mSel.value = mode;
      badge.textContent = "–†–µ–∂–∏–º: " + (mode === "payment" ? "–û–ø–ª–∞—Ç–∞" : "–ù–æ–≤–∞—è –∑–∞–∫—É–ø–∫–∞");
      showEl(purchaseBlock, mode === "purchase");
      showEl(paymentBlock, mode === "payment");
    }
    setMode("purchase");

    setupVinAutocompleteSmart("vinInput", getAllVins);

    ["amountCurrencyInput","rateInput","payAmountCurrencyInput","payRateInput","payRubInput"].forEach(setupMoneyInput);

    function recalcPurchaseRub() {
      const cur = document.getElementById("currencyInput")?.value || "";
      const a = toNum(document.getElementById("amountCurrencyInput")?.value);
      const r = toNum(document.getElementById("rateInput")?.value);
      const out = document.getElementById("amountRubInput");
      if (!out) return;
      if (!a) { out.value = ""; return; }
      if (cur === "‚ÇΩ") { out.value = formatWithSpaces(String(Math.round(a))); return; }
      if (a && r) out.value = formatWithSpaces(String(Math.round(a * r)));
      else out.value = "";
    }
    ["currencyInput","amountCurrencyInput","rateInput"].forEach(id => {
      const el = document.getElementById(id);
      if (el) { el.addEventListener("input", recalcPurchaseRub); el.addEventListener("change", recalcPurchaseRub); }
    });

    function recalcPayRub(){
      const cur = document.getElementById("payCurrencySelect")?.value || "‚ÇΩ";
      const a = toNum(document.getElementById("payAmountCurrencyInput")?.value);
      const r = toNum(document.getElementById("payRateInput")?.value);
      const out = document.getElementById("payRubInput");
      if (!out) return;
      if (!a) { out.value=""; return; }
      if (cur === "‚ÇΩ") { out.value = formatWithSpaces(String(Math.round(a))); return; }
      if (a && r) out.value = formatWithSpaces(String(Math.round(a * r)));
    }
    ["payCurrencySelect","payAmountCurrencyInput","payRateInput"].forEach(id=>{
      const el = document.getElementById(id);
      if (el) { el.addEventListener("input", recalcPayRub); el.addEventListener("change", recalcPayRub); }
    });

    document.getElementById("modeSelect").addEventListener("change", (e) => setMode(e.target.value));

    setupBossBuyAutofillFromVin();

    submitBtn.disabled = false;
  }

  function setupBossBuyAutofillFromVin() {
    const vinEl = document.getElementById("vinInput");
    if (!vinEl) return;
    if (vinEl.dataset && vinEl.dataset.bossAuto === "1") return;
    vinEl.dataset.bossAuto = "1";

    let tmr=null;

    const setIfEmpty = (id, value, mode="text") => {
      const el = document.getElementById(id);
      if (!el) return;
      if ((el.value || "").trim()) return;
      const v = String(value || "").trim();
      if (!v) return;
      if (mode === "date") {
        const iso = toISODateMaybe(v);
        if (iso) el.value = iso;
        return;
      }
      if (el.tagName === "SELECT") {
        setSelectValueSmart(el, v);
      } else {
        el.value = v;
      }
    };

    const run = async () => {
      const v = normalizeVin(vinEl.value);
      if (!v || v.length < 4) return;

      const data = await lookupByVin(v);
      if (!data) return;

      setIfEmpty("purchaseDateInput", data.purchase_date || data.purchaseDate || data.date || "", "date");
      setIfEmpty("supplierInput", data.supplier || data.seller || "");
      setIfEmpty("placeInput", data.purchase_place || data.place || data.purchasePlace || "");
      setIfEmpty("brandModelInput", data.brand_model || data.brandModel || "");
      setIfEmpty("complectationInput", data.complectation || "");

      setIfEmpty("currencyInput", data.currency || "");
      setIfEmpty("amountCurrencyInput", data.amount_currency || data.amountCurrency || "");
      setIfEmpty("rateInput", data.rate_to_rub || data.rate || data.rateToRub || "");
      setIfEmpty("amountRubInput", data.amount_rub || data.amountRub || "");

      setIfEmpty("payDateInput", data.pay_date || data.payDate || "", "date");
      setIfEmpty("payCurrencySelect", data.pay_currency || data.payCurrency || "");
      setIfEmpty("payAmountCurrencyInput", data.pay_amount_currency || data.payAmountCurrency || "");
      setIfEmpty("payRateInput", data.pay_rate || data.payRate || "");
      setIfEmpty("payRubInput", data.pay_amount_rub || data.payAmountRub || data.pay_rub || "");

      setIfEmpty("commentInput_p", data.comment_purchase || data.comment_p || "");
      setIfEmpty("commentInput", data.comment_pay || data.comment || "");
    };

    vinEl.addEventListener("input", ()=>{
      if (tmr) clearTimeout(tmr);
      tmr=setTimeout(run, 380);
    });
    vinEl.addEventListener("change", run);
    vinEl.addEventListener("blur", run);
  }

  // ---------- VALIDATION ----------
  function isFieldHidden(el){
    if (!el) return true;
    const field = el.closest(".field");
    if (!field) return false;
    return field.classList.contains("hidden");
  }

  function labelFor(el){
    if (!el || !el.id) return el?.id || "–ø–æ–ª–µ";
    const lab = formCard.querySelector(`label[for="${el.id}"]`);
    if (!lab) return el.id;
    return lab.textContent.replace("*","").trim();
  }

  function enforceFromList(fieldId, getListFn, allowEmpty=true){
    const el = document.getElementById(fieldId);
    if (!el) return true;

    const v = String(el.value || "").trim();
    if (!v) return allowEmpty;

    const list = (typeof getListFn === "function") ? getListFn() : (getListFn || []);
    const map = new Map();
    (list || []).forEach(x => {
      const s = String(x||"").trim();
      if (!s) return;
      map.set(s.toLowerCase(), s);
    });

    const key = v.toLowerCase();
    if (map.has(key)) {
      el.value = map.get(key);
      return true;
    }

    showError(`–í—ã–±–µ—Ä–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ —Å–ø–∏—Å–∫–∞: ${labelFor(el)}.\n(–ù–µ–ª—å–∑—è –≤–≤–æ–¥–∏—Ç—å –≤—Ä—É—á–Ω—É—é)`);
    return false;
  }

  function validateVisibleRequired(optionalIds = []) {
    const opt = new Set(optionalIds || []);
    const missing = [];

    const controls = formCard.querySelectorAll("input, select, textarea");
    controls.forEach(el=>{
      if (!el.id) return;
      if (opt.has(el.id)) return;

      const requiredFlag = el.dataset.required === "1";
      if (!requiredFlag) return;

      if (isFieldHidden(el)) return;

      const v = (el.value || "").trim();
      if (!v) missing.push(labelFor(el));
    });

    if (missing.length) {
      showError("–ó–∞–ø–æ–ª–Ω–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è:\n‚Ä¢ " + missing.join("\n‚Ä¢ "));
      return false;
    }
    showError("");
    return true;
  }

  function extraSaleScenarioValidation(){
    if (!isSaleMainLike(formType)) return true;

    const payment = document.getElementById("salePaymentTypeInput")?.value || "";
    const commission = (document.getElementById("saleCommissionInput")?.value || "no") === "yes";
    const vatYes = (document.getElementById("saleVatInput")?.value || "no") === "yes";
    const vat = (payment === "cashless") && vatYes;

    const mustHave = [];
    if (payment === "cash") {
      mustHave.push("priceCashInput");
      if (commission) mustHave.push("priceCashNoCommInput");
    } else if (payment === "cashless") {
      if (vat) {
        mustHave.push("priceNdsInput");
        mustHave.push("markupNdsInput");
        mustHave.push("priceNoVatCashInput");
      } else {
        mustHave.push("priceCashlessInput");
      }
      if (commission) {
        mustHave.push("contractPriceInput");
        mustHave.push("brokerPriceInput");
        mustHave.push("brokerExpenseInput");
      }
    }

    const missing = [];
    mustHave.forEach(id=>{
      const el = document.getElementById(id);
      if (!el) return;
      if (isFieldHidden(el)) return;
      if (!(el.value||"").trim()) missing.push(labelFor(el));
    });

    if (missing.length){
      showError("–ó–∞–ø–æ–ª–Ω–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –≤–∞—Ä–∏–∞–Ω—Ç—É:\n‚Ä¢ " + missing.join("\n‚Ä¢ "));
      return false;
    }
    return true;
  }

  function validateBeforeSubmit() {
    if (isFinanceOrBossForms(formType)) return true;

    if (isManagerForms(formType)) {
      if (!enforceFromList("managerInput", getAllManagers, true)) return false;
      if (document.getElementById("leadSourceInput")) {
        if (!enforceFromList("leadSourceInput", getAllSources, true)) return false;
      }
    }

    if (formType === "sale_main" || isSaleMainLike(formType)) {
      const ok1 = validateVisibleRequired(["buyerInput","receiverInput"]);
      if (!ok1) return false;
      return extraSaleScenarioValidation();
    }
    if (formType === "sale_deposit") return validateVisibleRequired(["buyerInput"]);
    if (formType === "sale_extra") return validateVisibleRequired(["extraDescInput"]);
    return validateVisibleRequired([]);
  }

  // ---------- Collect data ----------
  function collectSaleMain() {
    const payload = { formType };

    payload.manager = document.getElementById("managerInput")?.value || "";
    payload.sale_date = getRuDate("saleDateInput");
    payload.brand_model = document.getElementById("brandModelInput")?.value || "";
    payload.vin = document.getElementById("vinInput")?.value || "";
    payload.source = document.getElementById("leadSourceInput")?.value || "";
    payload.buyer = document.getElementById("buyerInput")?.value || "";
    payload.receiver = document.getElementById("receiverInput")?.value || "";

    const badgeEl = document.getElementById("saleVariantBadge");
    payload.variant = badgeEl ? String(badgeEl.textContent || "").replace("–í–∞—Ä–∏–∞–Ω—Ç:", "").trim() : "";

    const payment = document.getElementById("salePaymentTypeInput")?.value || "cash";
    const vatYes = (document.getElementById("saleVatInput")?.value || "no") === "yes";
    const commission = (document.getElementById("saleCommissionInput")?.value || "no") === "yes";
    const vat = (payment === "cashless") && vatYes;

    let price = "";
    if (payment === "cash") {
      price = document.getElementById("priceCashInput")?.value || "";
    } else {
      price = vat ? (document.getElementById("priceNdsInput")?.value || "") : (document.getElementById("priceCashlessInput")?.value || "");
    }
    payload.price = price;

    payload.price_no_commission = (payment === "cash" && commission) ? (document.getElementById("priceCashNoCommInput")?.value || "") : "";
    payload.contract_price = (payment === "cashless" && commission) ? (document.getElementById("contractPriceInput")?.value || "") : "";
    payload.broker_price = (payment === "cashless" && commission) ? (document.getElementById("brokerPriceInput")?.value || "") : "";
    payload.broker_expense = (payment === "cashless" && commission) ? (document.getElementById("brokerExpenseInput")?.value || "") : "";
    payload.markup_nds = (payment === "cashless" && vat) ? (document.getElementById("markupNdsInput")?.value || "") : "";

    payload.price_no_vat_cash = (payment === "cashless" && vat) ? (document.getElementById("priceNoVatCashInput")?.value || "") : "";

    payload.price_cash = (payment === "cash") ? price : "";
    payload.price_cashless = (payment === "cashless" && !vat) ? price : "";
    payload.price_nds = (payment === "cashless" && vat) ? price : "";

    payload.manager_fee = "";

    return payload;
  }

  function collectFormData() {
    const payload = { formType };

    if (formType === "mgr_stock") {
      payload.deal_type = document.getElementById("dealTypeInput")?.value || "";
      payload.manager = document.getElementById("managerInput")?.value || "";
      payload.brand_model = document.getElementById("brandModelInput")?.value || "";
      payload.vin = document.getElementById("vinInput")?.value || "";
      payload.complectation = document.getElementById("configInput")?.value || "";
      payload.body_color = document.getElementById("bodyColorInput")?.value || "";
      payload.salon_color = document.getElementById("salonColorInput")?.value || "";
      payload.price = document.getElementById("priceInput")?.value || "";
      payload.stock_date = getRuDate("stockDateInput");
      payload.payment_type = document.getElementById("payTypeInput")?.value || "";
      payload.client = document.getElementById("clientInput")?.value || "";
      return payload;
    }

    if (formType === "fin_company_expense") {
      payload.op_date = getRuDate("opDateInput");
      payload.expense_article = document.getElementById("expenseArticleInput")?.value || "";
      payload.amount = document.getElementById("amountInput")?.value || "";
      payload.comment = document.getElementById("commentInput")?.value || "";
      return payload;
    }

    if (isSaleMainLike(formType)) return collectSaleMain();

    if (formType === "sale_deposit") {
      payload.manager = document.getElementById("managerInput")?.value || "";
      payload.sale_date = getRuDate("saleDateInput");
      payload.brand_model = document.getElementById("brandModelInput")?.value || "";
      payload.vin = document.getElementById("vinInput")?.value || "";
      payload.source = document.getElementById("leadSourceInput")?.value || "";
      payload.deposit_sum = document.getElementById("depositSumInput")?.value || "";
      payload.receiver = document.getElementById("receiverInput")?.value || "";
      payload.price = document.getElementById("priceInput")?.value || "";
      payload.buyer = document.getElementById("buyerInput")?.value || "";
      return payload;
    }

    if (formType === "sale_extra") {
      payload.manager = document.getElementById("managerInput")?.value || "";
      payload.sale_date = getRuDate("saleDateInput");
      payload.brand_model = document.getElementById("brandModelInput")?.value || "";
      payload.vin = document.getElementById("vinInput")?.value || "";
      payload.extra_desc = document.getElementById("extraDescInput")?.value || "";
      payload.price = document.getElementById("priceInput")?.value || "";
      payload.receiver = document.getElementById("receiverInput")?.value || "";
      payload.purchaser = document.getElementById("purchaserInput")?.value || "";
      payload.buy_price = document.getElementById("buyPriceInput")?.value || "";
      payload.profit = document.getElementById("profitInput")?.value || "";
      return payload;
    }

    if (formType === "fin_auto_template") {
      payload.vin = document.getElementById("vinInput")?.value || "";
      payload.brand_model = document.getElementById("brandModelInput")?.value || "";
      payload.op_date = getRuDate("faDateInput");
      payload.evacuator = document.getElementById("evacuatorInput")?.value || "";
      payload.lab = document.getElementById("labInput")?.value || "";
      payload.util_writeoff = document.getElementById("utilWriteoffInput")?.value || "";
      payload.util = document.getElementById("utilInput")?.value || "";
      payload.pre_sale = document.getElementById("preSaleInput")?.value || "";
      payload.marketing = document.getElementById("marketingInput")?.value || "";
      payload.other = document.getElementById("otherInput")?.value || "";
      payload.extra_expenses = document.getElementById("extraExpensesInput")?.value || "";
      payload.comment = document.getElementById("commentInput")?.value || "";
      return payload;
    }

    if (formType === "fin_company") {
      payload.op_date = getRuDate("opDateInput");
      payload.category = document.getElementById("categoryInput")?.value || "";
      payload.amount = document.getElementById("amountInput")?.value || "";
      payload.comment = document.getElementById("commentInput")?.value || "";
      return payload;
    }

    if (formType === "boss_buy") {
      const mode = document.getElementById("modeSelect")?.value || "purchase";
      payload.mode = mode;
      payload.vin = normalizeVin(document.getElementById("vinInput")?.value || "");

      if (mode === "purchase") {
        payload.purchase_date = getRuDate("purchaseDateInput");
        payload.supplier = document.getElementById("supplierInput")?.value || "";
        payload.purchase_place = document.getElementById("placeInput")?.value || "";
        payload.brand_model = document.getElementById("brandModelInput")?.value || "";
        payload.complectation = document.getElementById("complectationInput")?.value || "";
        payload.currency = document.getElementById("currencyInput")?.value || "";
        payload.amount_currency = document.getElementById("amountCurrencyInput")?.value || "";
        payload.rate_to_rub = document.getElementById("rateInput")?.value || "";
        payload.amount_rub = document.getElementById("amountRubInput")?.value || "";
        payload.comment = document.getElementById("commentInput_p")?.value || "";
      } else {
        payload.pay_date = getRuDate("payDateInput");
        payload.pay_currency = document.getElementById("payCurrencySelect")?.value || "";
        payload.pay_amount_currency = document.getElementById("payAmountCurrencyInput")?.value || "";
        payload.pay_rate = document.getElementById("payRateInput")?.value || "";
        payload.pay_amount_rub = document.getElementById("payRubInput")?.value || "";
        payload.comment = document.getElementById("commentInput")?.value || "";
      }
      return payload;
    }

    if (formType === "boss_invest_in" || formType === "boss_invest_out") {
      payload.investor = document.getElementById("investorInput")?.value || "";
      payload.sum = document.getElementById("sumInput")?.value || "";
      payload.op_date = getRuDate("opDateInput");
      payload.comment = document.getElementById("commentInput")?.value || "";
      return payload;
    }

    payload.raw = document.getElementById("rawInput")?.value || "";
    return payload;
  }

  // ---------- remember manager/source/category ----------
  function tgUserFullName() {
    try {
      const u = window.Telegram?.WebApp?.initDataUnsafe?.user;
      if (!u) return "";
      return [u.first_name, u.last_name].filter(Boolean).join(" ").trim() || (u.username ? "@" + u.username : "");
    } catch (e) { return ""; }
  }

  function rememberField(id, lsKey, fallback = "") {
    const el = document.getElementById(id);
    if (!el) return;
    try {
      const saved = localStorage.getItem(lsKey);

      const trySetSelect = (val) => {
        const v = String(val || "").trim();
        if (!v) return false;
        if (el.tagName !== "SELECT") return false;
        const exists = Array.from(el.options || []).some(o => o.value === v);
        if (exists) { el.value = v; return true; }
        el.dataset.pendingValue = v;
        return false;
      };

      if (!el.value && saved) {
        if (el.tagName === "SELECT") { trySetSelect(saved); }
        else el.value = saved;
      }
      if (!el.value && fallback) {
        if (el.tagName === "SELECT") { trySetSelect(fallback); }
        else el.value = fallback;
      }
    } catch (e) {}
    el.addEventListener("input", () => {
      try { localStorage.setItem(lsKey, el.value || ""); } catch (e) {}
    });
    el.addEventListener("change", () => {
      try { localStorage.setItem(lsKey, el.value || ""); } catch (e) {}
    });
  }

  // ---------- Init ----------
  renderForm();

  rememberField("managerInput", "avtolink_last_manager", tgUserFullName());
  rememberField("leadSourceInput", "avtolink_last_source", "");
  try {
    const src = document.getElementById("leadSourceInput");
    if (src) src.value = "";
  } catch(e){}

  rememberField("categoryInput", "avtolink_last_exp_cat", "");
  rememberField("expenseArticleInput", "avtolink_last_exp_article", "");

  scheduleRemoteListsLoad();

  // ‚úÖ iPhone fix: touchend –¥—É–±–ª–∏—Ä—É–µ—Ç click (–∫–æ–≥–¥–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –æ—Ç–∫—Ä—ã—Ç–∞)
  let _touchLock = false;
  submitBtn.addEventListener("touchend", (e) => {
    if (_touchLock) return;
    _touchLock = true;
    e.preventDefault();
    submitBtn.click();
    setTimeout(() => { _touchLock = false; }, 400);
  }, { passive: false });

  // ---------- Submit ----------
  submitBtn.addEventListener("click", async () => {
    try { document.activeElement?.blur?.(); } catch(e) {}

    showError("");
    if (!validateBeforeSubmit()) return;

    const tgNow = window.Telegram?.WebApp;
    if (!tgNow) {
      alert("–û—Ç–∫—Ä–æ–π —Ñ–æ—Ä–º—É —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –≤ Telegram-–±–æ—Ç–µ.");
      return;
    }

    const payload = collectFormData();

    try { if (payload && payload.vin) rememberVin(payload.vin); } catch(e){}
    try { if (payload && payload.vin && payload.source) vinSourceMapSet(payload.vin, payload.source); } catch(e){}

    const dataStr = JSON.stringify(payload);
    if (dataStr.length > 3800) {
      tgAlert("–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è Telegram. –°–æ–∫—Ä–∞—Ç–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ –æ—Ç–ø—Ä–∞–≤—å –µ—â—ë —Ä–∞–∑.");
      return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = "–û—Ç–ø—Ä–∞–≤–∫–∞...";

    try {
      tgNow.sendData(dataStr);
      setTimeout(() => { try { tgNow.close(); } catch(e) {} }, 650);
    } catch (e) {
      tgAlert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.");
      submitBtn.disabled = false;
      submitBtn.textContent = "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –±–æ—Ç–∞";
    }
  });
</script>
</body>
</html>
