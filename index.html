<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Автолинк WebApp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    *,*::before,*::after{box-sizing:border-box;}
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      margin:0;
      padding:16px;
      background:#0f172a;
      color:#e5e7eb;
      min-height:var(--app-height,var(--tg-viewport-height,100vh));
      padding-bottom:calc(16px + env(safe-area-inset-bottom));
      overscroll-behavior:contain;
    }
    h1{font-size:20px;margin:0 0 4px;text-align:center;}
    .subtitle{font-size:13px;text-align:center;color:#94a3b8;margin-bottom:16px;line-height:1.35;}
    .card{
      background:#111827;
      border-radius:16px;
      padding:16px;
      box-shadow:0 10px 25px rgba(0,0,0,0.5);
      max-width:560px;
      margin:0 auto;
    }
    .field{margin-bottom:12px;display:flex;flex-direction:column;gap:4px;}
    label{font-size:13px;color:#9ca3af;}
    input,select,textarea{
      border-radius:10px;
      border:1px solid #374151;
      padding:8px 10px;
      font-size:14px;
      background:#020617;
      color:#e5e7eb;
      outline:none;
    }
    input:focus,select:focus,textarea:focus{border-color:#38bdf8;}
    textarea{min-height:90px;resize:vertical;}
    .readonly{background:#020617;color:#9ca3af;}
    .hint{font-size:12px;color:#94a3b8;line-height:1.35;margin-top:4px;}
    .pill{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      background:#0b1226;
      border:1px solid #334155;
      color:#cbd5e1;
      font-size:12px;
    }
    .divider{height:1px;background:#1f2937;margin:14px 0;}
    .hidden{display:none;}
    .toggle-row{display:flex;align-items:flex-start;gap:10px;font-size:13px;color:#cbd5e1;}
    .toggle-row input{width:18px;height:18px;margin-top:2px;}
    .toggle-row small{color:#94a3b8;line-height:1.25;display:block;margin-top:2px;}
    button#submitBtn{
      width:100%;
      border-radius:999px;
      border:none;
      padding:10px 14px;
      font-size:15px;
      font-weight:600;
      background:linear-gradient(135deg,#38bdf8,#6366f1);
      color:white;
      cursor:pointer;
      margin-top:12px;
    }
    button#submitBtn:disabled{opacity:.5;cursor:default;}
    .mini-btn{
      border:1px solid #374151;
      background:#0b1220;
      color:#e5e7eb;
      border-radius:10px;
      padding:8px 10px;
      cursor:pointer;
      white-space:nowrap;
    }
    .mini-btn:active{transform:translateY(1px);}
  </style>
</head>

<body>
  <h1>Автолинк</h1>
  <div class="subtitle" id="subtitle"></div>

  <div class="card" id="formCard"></div>
  <button id="submitBtn" disabled>Отправить в бота</button>

<script>
/* ===========================
   Telegram + Version + SW
=========================== */
const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
const urlParams = new URLSearchParams(window.location.search);
const formType = urlParams.get("type") || "unknown";

// Версию берём из ?v= (её добавляет Python build_webapp_url). Это важно для обновления SW/кэша.
const APP_VERSION = urlParams.get("v") || "5";

// SW
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./sw.js?v=" + encodeURIComponent(APP_VERSION)).catch(() => {});
  });
}

try {
  if (tg) { tg.ready(); tg.expand(); }
} catch(e){}

if (tg) {
  const setH = () => {
    document.documentElement.style.setProperty("--app-height", (tg.viewportHeight || window.innerHeight) + "px");
  };
  setH();
  tg.onEvent("viewportChanged", setH);
}

function tgAlert(text){
  try{
    if(tg && typeof tg.showAlert==="function") tg.showAlert(String(text));
    else alert(String(text));
  }catch(e){ alert(String(text)); }
}

window.addEventListener("error", (e) => {
  console.warn("JS error:", e?.message || e);
});

/* ===========================
   Apps Script URL (Variant A)
   - boss_buy -> старый URL закупок
   - все остальные -> новый URL справочника (СПРАВОЧНИКИ A↔C)
=========================== */
const LOOKUP_API_URL_BOSS = "https://script.google.com/macros/s/AKfycbzuBwFkGUiXnJcwUeTSt5jP8Y1BdE8PD0MQO_0SH6hr74O2htidfhD3Oop5zZ80G-GlDw/exec";
const LOOKUP_API_URL_REF  = "https://script.google.com/macros/s/AKfycbx_JDoOiJ_yTGiTyY16aIkNFSOjNelz40UiUbvVCdWq0wbsBpbTC5_0vZNga_ImSJ54MQ/exec";

// если надо — можно защитить токеном на стороне Apps Script
const LOOKUP_API_TOKEN = "";

function getLookupUrl() {
  return (formType === "boss_buy") ? LOOKUP_API_URL_BOSS : LOOKUP_API_URL_REF;
}
function canUseLookup() {
  const u = getLookupUrl();
  return (typeof u === "string" && u.trim().startsWith("https://"));
}

/* ===========================
   URL lists (если бот когда-то прокидывает)
=========================== */
const categoryFromUrl = urlParams.get("category") || "";
const brandsParam     = urlParams.get("brands") || "";
const investorsParam  = urlParams.get("investors") || "";
const sourcesParam    = urlParams.get("sources") || "";
const vinsParam       = urlParams.get("vins") || "";
const currenciesParam = urlParams.get("currencies") || "";
const bossVinsParam   = urlParams.get("bossvins") || "";

let brands     = brandsParam ? brandsParam.split("|") : [];
let investors  = investorsParam ? investorsParam.split("|") : [];
let sources    = sourcesParam ? sourcesParam.split("|") : [];
let vins       = vinsParam ? vinsParam.split("|") : [];
let currencies = currenciesParam ? currenciesParam.split("|") : [];
let bossVins   = bossVinsParam ? bossVinsParam.split("|") : [];

/* ===========================
   UI refs
=========================== */
const subtitleEl = document.getElementById("subtitle");
const formCard   = document.getElementById("formCard");
const submitBtn  = document.getElementById("submitBtn");

/* ===========================
   Titles
=========================== */
const FORM_TITLES = {
  mgr_stock: "Сток",
  sale_main: "Продажа — основная",
  sale_deposit: "Задаток",
  sale_extra: "Доп. услуги",
  sale_nds_broker: "Продажа — НДС с брокером",
  sale_nds_no_broker: "Продажа — НДС без брокера",
  sale_cash: "Продажа — Нал",
  sale_cash_broker: "Продажа — Нал (устар.)",
  fin_auto_template: "Расходы на авто РФ",
  fin_oper: "Оперрасходы",
  boss_buy: "Закупка / Оплата по VIN",
  boss_invest_in: "Инвестиции — ввод",
  boss_invest_out: "Инвестиции — вывод",
};

function isSaleMainLike(t){
  return ["sale_main","sale_nds_broker","sale_nds_no_broker","sale_cash","sale_cash_broker"].includes(String(t||""));
}

subtitleEl.textContent =
  "Форма: " + (FORM_TITLES[formType] || formType) +
  (categoryFromUrl ? " | Категория: " + categoryFromUrl : "");

/* ===========================
   Helpers
=========================== */
function todayISO(){ return new Date().toISOString().slice(0,10); }
function formatDateToRu(value){
  if(!value) return "";
  const parts = String(value).split("-");
  if(parts.length === 3){
    const [y,m,d] = parts;
    return `${d}.${m}.${y}`;
  }
  return value;
}
function getRuDate(id){
  const el = document.getElementById(id);
  if(!el) return "";
  return formatDateToRu(el.value);
}
function showEl(el, show){
  if(!el) return;
  el.classList.toggle("hidden", !show);
}
function parseNum(v){
  if(v===null || v===undefined) return 0;
  const s = String(v).replace(/\s/g,"").replace(",",".").replace(/[^\d.\-]/g,"");
  const n = parseFloat(s);
  return Number.isFinite(n) ? n : 0;
}
function normalizeVin(v){ return String(v||"").trim().toUpperCase(); }

function mergeUnique(...arrays){
  const out = [];
  const seen = new Set();
  arrays.flat().forEach(x=>{
    const s = String(x||"").trim();
    if(!s) return;
    const k = s.toLowerCase();
    if(seen.has(k)) return;
    seen.add(k);
    out.push(s);
  });
  return out;
}
function updateDatalist(dlId, options){
  const dl = document.getElementById(dlId);
  if(!dl) return;
  dl.innerHTML = "";
  (options||[]).slice(0,500).forEach(opt=>{
    const o = document.createElement("option");
    o.value = opt;
    dl.appendChild(o);
  });
}

/* ===========================
   localStorage helpers (boss_buy)
=========================== */
const LS_KEYS = {
  VINS: "boss_buy_vins",
  SUPPLIERS: "boss_buy_suppliers",
  PLACES: "boss_buy_places",
  BRAND_MODELS: "boss_buy_brand_models",
};
function lsRead(key){
  try{
    const v = localStorage.getItem(key);
    const arr = v ? JSON.parse(v) : [];
    return Array.isArray(arr) ? arr.filter(Boolean) : [];
  }catch(e){ return []; }
}
function lsWrite(key, arr, maxLen=200){
  try{
    const clean = (Array.isArray(arr)?arr:[]).filter(Boolean).slice(0,maxLen);
    localStorage.setItem(key, JSON.stringify(clean));
  }catch(e){}
}
function lsAdd(key, value, maxLen=200){
  const v = String(value||"").trim();
  if(!v) return;
  const arr = lsRead(key);
  const lo = v.toLowerCase();
  const filtered = arr.filter(x => String(x||"").trim().toLowerCase() !== lo);
  filtered.unshift(v);
  lsWrite(key, filtered, maxLen);
}

/* ===========================
   JSONP (Apps Script)
=========================== */
function jsonpRequest(baseUrl, params, timeoutMs=8000){
  return new Promise((resolve,reject)=>{
    const cb = "__cb_" + Math.random().toString(36).slice(2);
    const q = new URLSearchParams(params || {});
    q.set("callback", cb);
    if(LOOKUP_API_TOKEN) q.set("token", LOOKUP_API_TOKEN);

    const src = baseUrl + (baseUrl.includes("?") ? "&" : "?") + q.toString();
    const script = document.createElement("script");
    let done = false;

    function cleanup(){
      if(script && script.parentNode) script.parentNode.removeChild(script);
      try { delete window[cb]; } catch(e){ window[cb] = undefined; }
    }

    const timer = setTimeout(()=>{
      if(done) return;
      done = true;
      cleanup();
      reject(new Error("Lookup timeout"));
    }, timeoutMs);

    window[cb] = (data)=>{
      if(done) return;
      done = true;
      clearTimeout(timer);
      cleanup();
      resolve(data);
    };

    script.onerror = ()=>{
      if(done) return;
      done = true;
      clearTimeout(timer);
      cleanup();
      reject(new Error("Lookup request failed"));
    };

    script.src = src;
    document.body.appendChild(script);
  });
}

/* ===========================
   Remote lists cache
   ВАЖНО: TTL отдельно для boss/ref, чтобы не было ситуации:
   "заходил в boss_buy → TTL ещё жив → открыл продажи → списки не подтянулись"
=========================== */
const remoteCache = {
  vins: [],
  suppliers: [],
  places: [],
  brand_models: [],
  sources: [],
};

const REMOTE_LISTS_TS_KEY = "avtolink_remote_lists_ts_" + ((formType === "boss_buy") ? "boss" : "ref");
const REMOTE_LISTS_TTL_MS = 12 * 60 * 60 * 1000; // 12 часов

function lsReadNum(key, fallback=0){
  const v = localStorage.getItem(key);
  const n = parseInt(String(v||""), 10);
  return Number.isFinite(n) ? n : fallback;
}
function lsWriteNum(key,val){
  try{ localStorage.setItem(key, String(val)); }catch(e){}
}
function shouldRefreshRemoteLists(){
  const ts = lsReadNum(REMOTE_LISTS_TS_KEY, 0);
  return (!ts) || ((Date.now() - ts) > REMOTE_LISTS_TTL_MS);
}

async function remoteListsLoad(){
  if(!canUseLookup()) return;
  const base = getLookupUrl();
  const res = await jsonpRequest(base, { action: "lists" }, 8000);

  if(res && res.ok && res.lists){
    remoteCache.vins        = res.lists.vins || [];
    remoteCache.suppliers   = res.lists.suppliers || [];
    remoteCache.places      = res.lists.places || [];
    remoteCache.brand_models= res.lists.brand_models || [];
    remoteCache.sources     = res.lists.sources || [];

    // подмешаем в локальные подсказки, если прилетело
    if(remoteCache.brand_models.length) brands = mergeUnique(brands, remoteCache.brand_models);
    if(remoteCache.sources.length) sources = mergeUnique(sources, remoteCache.sources);

    // для boss_buy — сохраняем локально, как и было
    if(formType === "boss_buy"){
      if(remoteCache.vins.length) lsWrite(LS_KEYS.VINS, mergeUnique(remoteCache.vins, lsRead(LS_KEYS.VINS)), 800);
      if(remoteCache.suppliers.length) lsWrite(LS_KEYS.SUPPLIERS, mergeUnique(remoteCache.suppliers, lsRead(LS_KEYS.SUPPLIERS)), 400);
      if(remoteCache.places.length) lsWrite(LS_KEYS.PLACES, mergeUnique(remoteCache.places, lsRead(LS_KEYS.PLACES)), 400);
      if(remoteCache.brand_models.length) lsWrite(LS_KEYS.BRAND_MODELS, mergeUnique(remoteCache.brand_models, lsRead(LS_KEYS.BRAND_MODELS)), 600);
    }
  }
}

function scheduleRemoteListsLoad(){
  if(!canUseLookup()) return;
  if(!shouldRefreshRemoteLists()) return;

  const runner = async ()=>{
    try{
      await remoteListsLoad();
      lsWriteNum(REMOTE_LISTS_TS_KEY, Date.now());
      // если элементы уже на странице — обновим подсказки
      updateDatalist("brandModelInput_list", brands);
      updateDatalist("leadSourceInput_list", sources);

      // VIN list (если есть инпут)
      const vinIn = document.getElementById("vinInput");
      if(vinIn){
        const all = getAllVins();
        updateDatalist("vinInput_list", all);
      }
    }catch(e){
      console.warn("remoteListsLoad failed:", e);
    }
  };

  const idle = window.requestIdleCallback || ((fn)=>setTimeout(fn,250));
  idle(runner);
}

/* ===========================
   VIN helpers + suffix candidates + lookup
=========================== */
const ENABLE_SUFFIX_LOOKUP = true; // включаем для всех форм (не только boss_buy)
const _suffixMemo = new Map();

function getAllVins(){
  // boss vins/старые vins из url + remote + localStorage
  const localBoss = (formType === "boss_buy") ? lsRead(LS_KEYS.VINS) : [];
  return mergeUnique(bossVins || [], vins || [], remoteCache.vins || [], localBoss)
    .map(v => normalizeVin(v))
    .filter(Boolean);
}

async function requestSuffixCandidates(suffixRaw){
  if(!canUseLookup() || !ENABLE_SUFFIX_LOOKUP) return [];
  const suffix = normalizeVin(suffixRaw);
  if(suffix.length < 4) return [];

  const now = Date.now();
  const cached = _suffixMemo.get(suffix);
  if(cached && (now - cached.ts) < 5*60*1000) return cached.vins || [];

  const res = await jsonpRequest(getLookupUrl(), { action:"suffix", suffix, limit:80 }, 8000);
  const vins2 = (res && res.ok && Array.isArray(res.vins)) ? res.vins : [];
  _suffixMemo.set(suffix, { ts: now, vins: vins2 });
  return vins2;
}

function resolveFullVin(vinRaw){
  const v = normalizeVin(vinRaw);
  if(!v) return "";
  if(v.length === 17) return v;

  const cand = getAllVins();

  // если ввели последние 4..16
  if(v.length >= 4 && v.length < 17){
    const matches = cand.filter(x => normalizeVin(x).endsWith(v));
    if(matches.length === 1) return matches[0];
    return ""; // неоднозначно
  }
  return v;
}

async function lookupByVin(vinRaw){
  if(!canUseLookup()) return null;
  const fullVin = resolveFullVin(vinRaw);
  if(!fullVin) return null;

  try{
    const res = await jsonpRequest(getLookupUrl(), { action:"lookup", vin: fullVin }, 8000);
    if(res && res.ok && res.found && res.data) return res.data;
  }catch(e){}
  return null;
}

function setValueIfExists(id, val){
  const el = document.getElementById(id);
  if(!el) return;
  if(val === null || typeof val === "undefined") return;
  el.value = String(val);
}

/* ===========================
   UI builders
=========================== */
function createInput(id, labelText, placeholder="", value="", type="text", readonly=false){
  const w = document.createElement("div");
  w.className = "field";
  const l = document.createElement("label");
  l.htmlFor = id;
  l.textContent = labelText;

  const i = document.createElement("input");
  i.id = id;
  i.placeholder = placeholder;
  i.type = type;
  if(value) i.value = value;
  if(readonly){
    i.readOnly = true;
    i.classList.add("readonly");
  }
  if(id.toLowerCase().includes("vin")) i.maxLength = 17;

  w.appendChild(l);
  w.appendChild(i);
  return w;
}

function createTextarea(id, labelText, placeholder="", readonly=false){
  const w = document.createElement("div");
  w.className = "field";
  const l = document.createElement("label");
  l.htmlFor = id;
  l.textContent = labelText;

  const t = document.createElement("textarea");
  t.id = id;
  t.placeholder = placeholder;
  if(readonly){
    t.readOnly = true;
    t.classList.add("readonly");
  }

  w.appendChild(l);
  w.appendChild(t);
  return w;
}

function createSelectKV(id, labelText, options, placeholder="Выберите..."){
  const w = document.createElement("div");
  w.className = "field";
  const l = document.createElement("label");
  l.htmlFor = id;
  l.textContent = labelText;

  const s = document.createElement("select");
  s.id = id;

  const ph = document.createElement("option");
  ph.value = "";
  ph.textContent = placeholder;
  ph.disabled = true;
  ph.selected = true;
  s.appendChild(ph);

  options.forEach(opt=>{
    const o = document.createElement("option");
    o.value = opt.value;
    o.textContent = opt.label;
    s.appendChild(o);
  });

  w.appendChild(l);
  w.appendChild(s);
  return w;
}

function createAutocompleteInput(id, labelText, placeholder="", options=[]){
  const w = document.createElement("div");
  w.className = "field";
  const l = document.createElement("label");
  l.htmlFor = id;
  l.textContent = labelText;

  const i = document.createElement("input");
  i.id = id;
  i.placeholder = placeholder;

  const dlId = id + "_list";
  i.setAttribute("list", dlId);

  let dl = document.getElementById(dlId);
  if(!dl){
    dl = document.createElement("datalist");
    dl.id = dlId;
    document.body.appendChild(dl);
  }
  updateDatalist(dlId, options);

  w.appendChild(l);
  w.appendChild(i);
  return w;
}

/* VIN smart autocomplete */
function setupVinAutocompleteSmart(inputId, allVinsSource){
  const input = document.getElementById(inputId);
  if(!input) return;
  if(input.dataset && input.dataset.vinAuto === "1") return;
  input.dataset.vinAuto = "1";

  const listId = inputId + "_list";
  let dl = document.getElementById(listId);
  if(!dl){
    dl = document.createElement("datalist");
    dl.id = listId;
    document.body.appendChild(dl);
  }
  input.setAttribute("list", listId);

  function getSource(){
    try{
      const src = (typeof allVinsSource === "function") ? allVinsSource() : allVinsSource;
      return Array.isArray(src) ? src : [];
    }catch(e){ return []; }
  }

  function fillLocal(filter){
    const f = String(filter||"").trim().toLowerCase();
    if(!f || f.length < 2) return false;

    dl.innerHTML = "";
    const source = getSource();
    const out = [];

    for(let i=0;i<source.length;i++){
      const v = normalizeVin(source[i]);
      if(!v) continue;
      const lo = v.toLowerCase();
      if(lo.includes(f) || lo.endsWith(f)) out.push(v);
      if(out.length >= 80) break;
    }

    if(out.length){
      out.forEach(v=>{
        const o = document.createElement("option");
        o.value = v;
        dl.appendChild(o);
      });
      return true;
    }
    return false;
  }

  async function fillSmart(){
    const f = String(input.value||"").trim();
    if(!f) return;

    // 1) локально
    const ok = fillLocal(f);
    if(ok) return;

    // 2) если 4+ — тянем suffix
    const ff = normalizeVin(f);
    if(ENABLE_SUFFIX_LOOKUP && canUseLookup() && ff.length >= 4){
      try{
        const candidates = await requestSuffixCandidates(ff);
        if(!candidates || !candidates.length) return;

        dl.innerHTML = "";
        candidates.slice(0,80).forEach(v=>{
          const o = document.createElement("option");
          o.value = normalizeVin(v);
          dl.appendChild(o);
        });

        // если ровно 1 — можно сразу подставить полный VIN
        if(candidates.length === 1){
          input.value = normalizeVin(candidates[0]);
          // и сразу можно попытаться подтянуть марку/модель
          setTimeout(()=>{ tryAutoFillBrandByVin(); }, 0);
        }
      }catch(e){}
    }
  }

  input.addEventListener("focus", fillSmart);
  input.addEventListener("input", fillSmart);
}

/* ===========================
   Boss buy prefill (оставляем как было)
=========================== */
function prefillBossBuyFields(data){
  if(!data) return;
  if(data.vin) setValueIfExists("vinInput", data.vin);
  setValueIfExists("purchaseDateInput", data.purchase_date || "");
  setValueIfExists("supplierInput", data.supplier || "");
  setValueIfExists("placeInput", data.purchase_place || "");
  setValueIfExists("brandModelInput", data.brand_model || "");
  setValueIfExists("complectationInput", data.complectation || "");
  if(document.getElementById("currencyInput")) setValueIfExists("currencyInput", data.currency || "");
  setValueIfExists("amountCurrencyInput", data.amount_currency || "");
  setValueIfExists("rateInput", data.rate_to_rub || "");
  if(document.getElementById("amountRubInput")) setValueIfExists("amountRubInput", data.cost_rub || data.amount_rub || "");
}

async function prefillBossBuyByVin(vinRaw){
  const vin = normalizeVin(vinRaw);
  if(!vin) return;

  const data = await lookupByVin(vin);
  if(data){
    prefillBossBuyFields(data);
    return;
  }

  if(ENABLE_SUFFIX_LOOKUP && canUseLookup() && vin.length >= 4 && vin.length < 17){
    try{
      const candidates = await requestSuffixCandidates(vin);
      if(candidates && candidates.length){
        updateDatalist("vinInput_list", mergeUnique(candidates, getAllVins()));
        if(candidates.length === 1){
          const fullVin = normalizeVin(candidates[0]);
          setValueIfExists("vinInput", fullVin);
          const d2 = await lookupByVin(fullVin);
          if(d2) prefillBossBuyFields(d2);
        }
      }
    }catch(e){}
  }
}

/* ===========================
   Auto fill Brand/Model by VIN (для всех форм)
   - вводишь VIN (в т.ч. последние 4)
   - если можно однозначно → подставляем Марка/Модель
=========================== */
let _autoVinTimer = null;

async function tryAutoFillBrandByVin(){
  const vinEl = document.getElementById("vinInput");
  const brandEl = document.getElementById("brandModelInput");
  if(!vinEl || !brandEl) return;

  // если пользователь уже руками ввёл марку/модель — не перетираем
  if(brandEl.dataset.manual === "1" && brandEl.value) return;
  if(!canUseLookup()) return;

  const v = String(vinEl.value||"").trim();
  if(!v || v.length < 4) return;

  const data = await lookupByVin(v);
  const bm = data?.brand_model || data?.brandModel || "";
  if(bm){
    brandEl.value = bm;
    brandEl.dataset.manual = "0";
  }
}

/* ===========================
   Render forms
=========================== */
function renderBossBuy(){
  formCard.innerHTML = "";
  formCard.appendChild(createInput("vinInput", "VIN (можно последние 4 символа)", "Последние 4 или полный VIN"));

  const modeWrap = document.createElement("div");
  modeWrap.className = "field";
  const modeLabel = document.createElement("label");
  modeLabel.textContent = "Что делаем?";

  const modeSelect = document.createElement("select");
  modeSelect.id = "modeSelect";
  modeSelect.innerHTML = `
    <option value="purchase">Новая закупка (создать VIN)</option>
    <option value="payment">Добавить оплату к VIN</option>
  `;

  const modeBadge = document.createElement("div");
  modeBadge.style.marginTop = "6px";
  modeBadge.innerHTML = `<span class="pill" id="modeBadge">Режим: —</span>`;

  modeWrap.appendChild(modeLabel);
  modeWrap.appendChild(modeSelect);
  modeWrap.appendChild(modeBadge);
  formCard.appendChild(modeWrap);

  const hint = document.createElement("div");
  hint.className = "hint";
  hint.textContent = "Если VIN уже есть в таблице руководителя, форма сама подтянет данные (если доступно).";
  formCard.appendChild(hint);

  formCard.appendChild(Object.assign(document.createElement("div"), { className:"divider" }));

  const purchaseBlock = document.createElement("div");
  purchaseBlock.id = "purchaseBlock";
  purchaseBlock.appendChild(createInput("purchaseDateInput", "Дата закупки", "", todayISO(), "date"));
  purchaseBlock.appendChild(createAutocompleteInput("supplierInput", "Поставщик", "Например, дилер/компания", lsRead(LS_KEYS.SUPPLIERS)));
  purchaseBlock.appendChild(createAutocompleteInput("placeInput", "Место закупки", "Например, Япония / РФ / Китай", lsRead(LS_KEYS.PLACES)));
  purchaseBlock.appendChild(createAutocompleteInput("brandModelInput", "Марка / Модель", "Например, BMW X5", mergeUnique(brands, lsRead(LS_KEYS.BRAND_MODELS))));
  purchaseBlock.appendChild(createInput("complectationInput", "Комплектация", "Например, M Sport"));
  purchaseBlock.appendChild(
    createSelectKV("currencyInput", "Валюта ($ / ₽ / ¥)",
      [{value:"$",label:"$ (доллар)"},{value:"₽",label:"₽ (рубль)"},{value:"¥",label:"¥ (юань)"}],
      "Выберите валюту"
    )
  );
  purchaseBlock.appendChild(createInput("amountCurrencyInput", "Сумма, валюта", "Например, 100000"));
  purchaseBlock.appendChild(createInput("rateInput", "Курс (на дату первой оплаты)", "Например, 80"));
  purchaseBlock.appendChild(createInput("amountRubInput", "Стоимость авто, ₽ (для контроля)", "Авторасчёт", "", "text", true));

  purchaseBlock.appendChild(createTextarea("commentInput_p", "Комментарий", "По желанию"));

  const paymentBlock = document.createElement("div");
  paymentBlock.id = "paymentBlock";
  paymentBlock.appendChild(createInput("payDateInput", "Дата оплаты", "", todayISO(), "date"));
  paymentBlock.appendChild(
    createSelectKV("payCurrencySelect", "Валюта оплаты",
      [{value:"₽",label:"₽ (рубль)"},{value:"$",label:"$ (доллар)"},{value:"¥",label:"¥ (юань)"}],
      "Выберите валюту"
    )
  );

  const fxWrap = document.createElement("div");
  fxWrap.id = "fxWrap";
  fxWrap.appendChild(createInput("payAmountCurrencyInput", "Сумма оплаты (валюта)", "Например, 20000"));
  fxWrap.appendChild(createInput("payRateInput", "Курс на дату оплаты", "Например, 82"));
  fxWrap.appendChild(createInput("payRubInput", "Сумма оплаты (₽)", "Авторасчёт", "", "text", false));

  const rubWrap = document.createElement("div");
  rubWrap.id = "rubWrap";
  rubWrap.appendChild(createInput("payRubOnlyInput", "Сумма оплаты (₽)", "Например, 500000"));

  paymentBlock.appendChild(fxWrap);
  paymentBlock.appendChild(rubWrap);
  paymentBlock.appendChild(createTextarea("commentInput", "Комментарий", "По желанию"));

  formCard.appendChild(purchaseBlock);
  formCard.appendChild(paymentBlock);

  setupVinAutocompleteSmart("vinInput", getAllVins);

  function setMode(mode){
    const badge = document.getElementById("modeBadge");
    const mSel = document.getElementById("modeSelect");
    if(mSel.value !== mode) mSel.value = mode;
    badge.textContent = "Режим: " + (mode === "payment" ? "Оплата" : "Новая закупка");
    showEl(purchaseBlock, mode === "purchase");
    showEl(paymentBlock, mode === "payment");
  }

  function recalcPurchaseRub(){
    const cur = document.getElementById("currencyInput")?.value || "";
    const a = parseNum(document.getElementById("amountCurrencyInput")?.value);
    const r = parseNum(document.getElementById("rateInput")?.value);
    const out = document.getElementById("amountRubInput");
    if(!out) return;

    if(!a){ out.value=""; return; }
    if(cur === "₽"){ out.value = String(Math.round(a)); return; }
    if(a && r) out.value = String(Math.round(a*r));
    else out.value = "";
  }

  function recalcPaymentRub(){
    const cur = document.getElementById("payCurrencySelect")?.value || "";
    const a = parseNum(document.getElementById("payAmountCurrencyInput")?.value);
    const r = parseNum(document.getElementById("payRateInput")?.value);
    const out = document.getElementById("payRubInput");
    if(!out) return;

    if(cur && cur !== "₽"){
      if(a && r) out.value = String(Math.round(a*r));
      else out.value = "";
    }
  }

  function togglePaymentFields(){
    const cur = document.getElementById("payCurrencySelect")?.value || "";
    if(cur === "₽"){
      showEl(fxWrap, false);
      showEl(rubWrap, true);
    }else{
      showEl(fxWrap, true);
      showEl(rubWrap, false);
    }
  }

  // init
  setMode("purchase");
  togglePaymentFields();
  recalcPurchaseRub();

  document.getElementById("modeSelect").addEventListener("change", (e)=>setMode(e.target.value));

  ["currencyInput","amountCurrencyInput","rateInput"].forEach(id=>{
    const el = document.getElementById(id);
    if(el){
      el.addEventListener("input", recalcPurchaseRub);
      el.addEventListener("change", recalcPurchaseRub);
    }
  });

  document.getElementById("payCurrencySelect").addEventListener("change", togglePaymentFields);
  ["payAmountCurrencyInput","payRateInput"].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.addEventListener("input", recalcPaymentRub);
  });

  // VIN prefill
  let vinPrefillTimer = null;
  const vinEl = document.getElementById("vinInput");
  vinEl.addEventListener("input", (e)=>{
    if(vinPrefillTimer) clearTimeout(vinPrefillTimer);
    vinPrefillTimer = setTimeout(()=>prefillBossBuyByVin(e.target.value), 450);
  });
  vinEl.addEventListener("change", (e)=>prefillBossBuyByVin(e.target.value));
  vinEl.addEventListener("blur",  (e)=>prefillBossBuyByVin(e.target.value));

  submitBtn.disabled = false;
}

/* ===========================
   SALE MAIN (обновлено):
   - УБРАНА "Комиссия менеджера"
   - Комиссия (теперь это только брокер) доступна только в безнал
=========================== */
function applySalePresetByType(t){
  const pay = document.getElementById("salePaymentTypeInput");
  const vat = document.getElementById("saleVatInput");
  const broker = document.getElementById("saleBrokerInput");
  if(!pay || !vat || !broker) return;

  const type = String(t||"");
  // defaults
  pay.value = "cashless";
  vat.value = "no";
  broker.value = "no";

  if(type === "sale_cash" || type === "sale_cash_broker"){
    pay.value = "cash";
    vat.value = "no";
    broker.value = "no";
  }else if(type === "sale_nds_no_broker"){
    pay.value = "cashless";
    vat.value = "yes";
    broker.value = "no";
  }else if(type === "sale_nds_broker"){
    pay.value = "cashless";
    vat.value = "yes";
    broker.value = "yes";
  }
}

function renderSaleMain(){
  formCard.innerHTML = "";

  const payWrap = createSelectKV("salePaymentTypeInput", "Оплата",
    [{value:"cash",label:"Нал"},{value:"cashless",label:"Безнал"}],
    "Выберите оплату"
  );

  const vatWrap = createSelectKV("saleVatInput", "НДС",
    [{value:"yes",label:"С НДС"},{value:"no",label:"Без НДС"}],
    "Выберите НДС"
  );

  const brokerWrap = createSelectKV("saleBrokerInput", "Брокер (комиссия)",
    [{value:"yes",label:"Есть"},{value:"no",label:"Нет"}],
    "Выберите"
  );

  formCard.appendChild(payWrap);
  formCard.appendChild(vatWrap);
  formCard.appendChild(brokerWrap);

  const badge = document.createElement("div");
  badge.style.marginTop = "6px";
  badge.innerHTML = `<span class="pill" id="saleVariantBadge">Вариант: —</span>`;
  formCard.appendChild(badge);

  formCard.appendChild(createInput("managerInput", "Менеджер", "Имя менеджера"));
  formCard.appendChild(createInput("saleDateInput", "Дата продажи", "", todayISO(), "date"));
  formCard.appendChild(createAutocompleteInput("brandModelInput", "Марка / Модель", "", brands));
  formCard.appendChild(createInput("vinInput", "VIN (можно последние 4 символа)", "Последние 4 или полный VIN"));
  formCard.appendChild(createAutocompleteInput("leadSourceInput", "Источник", "Например, Авито", sources));

  const buyerWrap = createInput("buyerInput", "Покупатель", "");
  const receiverWrap = createInput("receiverInput", "Получатель", "");
  formCard.appendChild(buyerWrap);
  formCard.appendChild(receiverWrap);

  const priceCashWrap = createInput("priceCashInput", "Цена (нал)", "");
  const priceCashlessWrap = createInput("priceCashlessInput", "Сумма (безнал, без НДС)", "");
  const priceNdsWrap = createInput("priceNdsInput", "Цена с НДС", "");
  const markupNdsWrap = createInput("markupNdsInput", "Наценка НДС (% / руб)", "");
  const contractPriceWrap = createInput("contractPriceInput", "Сумма договора", "");
  const brokerPriceWrap = createInput("brokerPriceInput", "Цена без комиссии брокера", "");
  const brokerExpenseWrap = createInput("brokerExpenseInput", "Расход брокера (кому/сумма/комментарий)", "");

  formCard.appendChild(priceCashWrap);
  formCard.appendChild(priceCashlessWrap);
  formCard.appendChild(priceNdsWrap);
  formCard.appendChild(markupNdsWrap);
  formCard.appendChild(contractPriceWrap);
  formCard.appendChild(brokerPriceWrap);
  formCard.appendChild(brokerExpenseWrap);

  function updateSaleMainVisibility(){
    const payment = document.getElementById("salePaymentTypeInput").value || "cashless";
    const brokerYes = (document.getElementById("saleBrokerInput").value || "no") === "yes";
    const vatYes = (document.getElementById("saleVatInput").value || "no") === "yes";

    // НДС доступен только в безнал
    const vatSelect = document.getElementById("saleVatInput");
    if(payment !== "cashless"){
      vatSelect.disabled = true;
      vatSelect.value = "no";
    }else{
      vatSelect.disabled = false;
    }

    // Брокер доступен только в безнал (т.к. менеджерскую комиссию мы убрали)
    const brokerSelect = document.getElementById("saleBrokerInput");
    if(payment !== "cashless"){
      brokerSelect.disabled = true;
      brokerSelect.value = "no";
    }else{
      brokerSelect.disabled = false;
    }

    const vat = (payment === "cashless") && vatYes;

    // receiver нужен только для нал
    showEl(receiverWrap, payment === "cash");

    // цены
    showEl(priceCashWrap, payment === "cash");
    showEl(priceCashlessWrap, payment === "cashless" && !vat);
    showEl(priceNdsWrap, payment === "cashless" && vat);
    showEl(markupNdsWrap, payment === "cashless" && vat);

    // брокерские поля только если безнал + брокер
    showEl(contractPriceWrap, payment === "cashless" && brokerYes);
    showEl(brokerPriceWrap, payment === "cashless" && brokerYes);
    showEl(brokerExpenseWrap, payment === "cashless" && brokerYes);

    // вариант
    let variant = "";
    if(payment === "cash") variant = "Нал";
    if(payment === "cashless" && vat && !brokerYes) variant = "Безнал / с НДС / без брокера";
    if(payment === "cashless" && vat && brokerYes) variant = "Безнал / с НДС / с брокером";
    if(payment === "cashless" && !vat && !brokerYes) variant = "Безнал / без НДС / без брокера";
    if(payment === "cashless" && !vat && brokerYes) variant = "Безнал / без НДС / с брокером";

    const badgeEl = document.getElementById("saleVariantBadge");
    if(badgeEl) badgeEl.textContent = "Вариант: " + variant;
  }

  applySalePresetByType(formType);

  document.getElementById("salePaymentTypeInput").addEventListener("change", updateSaleMainVisibility);
  document.getElementById("saleVatInput").addEventListener("change", updateSaleMainVisibility);
  document.getElementById("saleBrokerInput").addEventListener("change", updateSaleMainVisibility);

  updateSaleMainVisibility();

  setupVinAutocompleteSmart("vinInput", getAllVins);

  submitBtn.disabled = false;
}

/* ===========================
   Render all forms
=========================== */
function renderForm(){
  formCard.innerHTML = "";
  submitBtn.disabled = true;

  if(formType === "mgr_stock"){
    formCard.appendChild(createSelectKV("dealTypeInput","Тип сделки",
      [{value:"Склад",label:"Склад"},{value:"Поставка",label:"Поставка"}],
      "Выберите тип сделки"
    ));
    formCard.appendChild(createAutocompleteInput("brandModelInput","Марка / Модель","Начните вводить марку или модель", brands));
    formCard.appendChild(createInput("vinInput","VIN (можно последние 4 символа)","Последние 4 или полный VIN"));
    formCard.appendChild(createInput("configInput","Комплектация","Например, Comfort"));
    formCard.appendChild(createInput("bodyColorInput","Цвет кузова","Черный"));
    formCard.appendChild(createInput("salonColorInput","Цвет салона","Черный"));
    formCard.appendChild(createInput("priceInput","Цена, ₽","1500000"));
    formCard.appendChild(createInput("stockDateInput","Дата","", todayISO(), "date"));
    formCard.appendChild(createSelectKV("payTypeInput","Тип оплаты",
      [{value:"Нал",label:"Нал"},{value:"Безнал",label:"Безнал"},{value:"НДС",label:"НДС"}],
      "Выберите тип оплаты"
    ));
    formCard.appendChild(createInput("clientInput","Клиент (Имя + телефон)","Иван Иванов, +7..."));
    setupVinAutocompleteSmart("vinInput", getAllVins);
    submitBtn.disabled = false;
    return;
  }

  if(isSaleMainLike(formType)){
    renderSaleMain();
    return;
  }

  if(formType === "sale_deposit"){
    formCard.appendChild(createInput("managerInput","Менеджер",""));
    formCard.appendChild(createInput("saleDateInput","Дата","", todayISO(),"date"));
    formCard.appendChild(createAutocompleteInput("brandModelInput","Марка / Модель","", brands));
    formCard.appendChild(createInput("vinInput","VIN (можно последние 4 символа)","Последние 4 или полный VIN"));
    formCard.appendChild(createAutocompleteInput("leadSourceInput","Источник","Например, Авито", sources));
    formCard.appendChild(createInput("depositSumInput","Сумма задатка",""));
    formCard.appendChild(createInput("receiverInput","Кому передана сумма",""));
    formCard.appendChild(createInput("priceInput","Цена продажи",""));
    formCard.appendChild(createInput("buyerInput","Покупатель",""));
    setupVinAutocompleteSmart("vinInput", getAllVins);
    submitBtn.disabled = false;
    return;
  }

  if(formType === "sale_extra"){
    formCard.appendChild(createInput("managerInput","Менеджер",""));
    formCard.appendChild(createInput("saleDateInput","Дата","", todayISO(),"date"));
    formCard.appendChild(createAutocompleteInput("brandModelInput","Марка / Модель","", brands));
    formCard.appendChild(createInput("vinInput","VIN (можно последние 4 символа)","Последние 4 или полный VIN"));
    formCard.appendChild(createAutocompleteInput("leadSourceInput","Источник","Например, Авито", sources));
    formCard.appendChild(createTextarea("extraDescInput","Доп. услуги (описание)",""));
    formCard.appendChild(createInput("priceInput","Цена продажи",""));
    formCard.appendChild(createInput("receiverInput","Кому передали средства",""));
    formCard.appendChild(createInput("purchaserInput","Кто выдал средства на закупку",""));
    formCard.appendChild(createInput("buyPriceInput","Цена покупки",""));
    formCard.appendChild(createInput("profitInput","Доход",""));
    setupVinAutocompleteSmart("vinInput", getAllVins);
    submitBtn.disabled = false;
    return;
  }

  if(formType === "fin_auto_template"){
    formCard.appendChild(createInput("vinInput","VIN (можно последние 4 символа)","Последние 4 или полный VIN"));
    formCard.appendChild(createAutocompleteInput("brandModelInput","Марка / Модель","", brands));
    formCard.appendChild(createInput("faDateInput","Дата","", todayISO(),"date"));
    formCard.appendChild(createInput("evacuatorInput","Эвакуатор",""));
    formCard.appendChild(createInput("labInput","Лаборатория",""));
    formCard.appendChild(createInput("utilWriteoffInput","Списания утильсбора",""));
    formCard.appendChild(createInput("utilInput","Утильсбор",""));
    formCard.appendChild(createInput("preSaleInput","Предпродажная подготовка",""));
    formCard.appendChild(createInput("marketingInput","Маркетинг",""));
    formCard.appendChild(createInput("otherInput","Прочие расходы",""));
    formCard.appendChild(createTextarea("extraExpensesInput","Доп. расходы","Если есть: строками (например: Шиномонтаж: 3000)"));
    formCard.appendChild(createTextarea("commentInput","Комментарий",""));
    setupVinAutocompleteSmart("vinInput", getAllVins);
    submitBtn.disabled = false;
    return;
  }

  if(formType === "fin_oper"){
    formCard.appendChild(createInput("categoryInput","Категория","", categoryFromUrl || "", "text", true));
    formCard.appendChild(createInput("opDateInput","Дата","", todayISO(),"date"));
    formCard.appendChild(createInput("amountInput","Сумма, ₽",""));
    formCard.appendChild(createTextarea("commentInput","Комментарий",""));
    submitBtn.disabled = false;
    return;
  }

  if(formType === "boss_buy"){
    renderBossBuy();
    return;
  }

  if(formType === "boss_invest_in" || formType === "boss_invest_out"){
    formCard.appendChild(createAutocompleteInput("investorInput","Инвестор","Начните вводить инвестора", investors));
    formCard.appendChild(createInput("sumInput","Сумма",""));
    formCard.appendChild(createInput("opDateInput","Дата","", todayISO(),"date"));
    formCard.appendChild(createTextarea("commentInput","Комментарий",""));
    submitBtn.disabled = false;
    return;
  }

  formCard.appendChild(createTextarea("rawInput","Данные","Форма не настроена. Введите данные в свободной форме."));
  submitBtn.disabled = false;
}

/* ===========================
   UX Enhancements + remember fields
=========================== */
function tgUserFullName(){
  try{
    const u = window.Telegram?.WebApp?.initDataUnsafe?.user;
    if(!u) return "";
    return [u.first_name, u.last_name].filter(Boolean).join(" ").trim() || (u.username ? "@"+u.username : "");
  }catch(e){ return ""; }
}

function rememberField(id, lsKey, fallback=""){
  const el = document.getElementById(id);
  if(!el) return;
  try{
    const saved = localStorage.getItem(lsKey);
    if(!el.value && saved) el.value = saved;
    if(!el.value && fallback) el.value = fallback;
  }catch(e){}
  el.addEventListener("input", ()=>{
    try{ localStorage.setItem(lsKey, el.value || ""); }catch(e){}
  });
}

function insertToggleAfterInput(inputId, toggleId, labelText, hintText, checkedByDefault=true){
  const input = document.getElementById(inputId);
  if(!input) return null;
  if(document.getElementById(toggleId)) return document.getElementById(toggleId);

  const field = input.closest(".field") || input.parentElement;
  if(!field || !field.parentElement) return null;

  const row = document.createElement("div");
  row.className = "field";
  row.innerHTML = `
    <div class="toggle-row">
      <input type="checkbox" id="${toggleId}" ${checkedByDefault ? "checked" : ""}/>
      <div>
        <div>${labelText}</div>
        ${hintText ? `<small>${hintText}</small>` : ""}
      </div>
    </div>
  `;
  field.parentElement.insertBefore(row, field.nextSibling);
  return document.getElementById(toggleId);
}

function postRenderEnhancements(){
  rememberField("managerInput", "avtolink_last_manager", tgUserFullName());
  rememberField("leadSourceInput", "avtolink_last_source", "");
  rememberField("receiverInput", "avtolink_last_receiver", "");
  rememberField("purchaserInput", "avtolink_last_purchaser", "");

  // марка/модель manual flag
  const brandEl = document.getElementById("brandModelInput");
  if(brandEl){
    brandEl.addEventListener("input", ()=>{ brandEl.dataset.manual = "1"; });
  }

  // Автоподстановка Марка/Модель по VIN (включено по умолчанию)
  const vinEl = document.getElementById("vinInput");
  if(vinEl && brandEl){
    const t = insertToggleAfterInput(
      "vinInput",
      "autoVinFillToggle",
      "Автоподстановка «Марка / Модель» по VIN",
      "Можно ввести последние 4 символа VIN: покажем варианты и попробуем подтянуть марку/модель.",
      true
    );

    vinEl.addEventListener("input", ()=>{
      if(_autoVinTimer) clearTimeout(_autoVinTimer);
      _autoVinTimer = setTimeout(async ()=>{
        if(!t || !t.checked) return;
        await tryAutoFillBrandByVin();
      }, 350);
    });
    vinEl.addEventListener("change", async ()=>{
      if(!t || !t.checked) return;
      await tryAutoFillBrandByVin();
    });
    vinEl.addEventListener("blur", async ()=>{
      if(!t || !t.checked) return;
      await tryAutoFillBrandByVin();
    });
  }

  // boss_buy: VIN prefill
  if(formType === "boss_buy"){
    const v = document.getElementById("vinInput");
    if(v){
      v.addEventListener("change", ()=>prefillBossBuyByVin(v.value));
      v.addEventListener("blur",   ()=>prefillBossBuyByVin(v.value));
    }
  }

  // авторасчёт дохода (sale_extra)
  const priceEl = document.getElementById("priceInput");
  const buyEl   = document.getElementById("buyPriceInput");
  const profitEl= document.getElementById("profitInput");
  if(priceEl && buyEl && profitEl){
    const t = insertToggleAfterInput(
      "profitInput",
      "autoProfitToggle",
      "Авторасчёт дохода",
      "Доход = Цена продажи − Цена покупки (можно поправить вручную).",
      true
    );

    const recalc = ()=>{
      if(!t || !t.checked) return;
      if(profitEl.dataset.manual === "1") return;
      const p = parseNum(priceEl.value);
      const b = parseNum(buyEl.value);
      if(!p && !b) return;
      const diff = p - b;
      if(!profitEl.value || profitEl.dataset.auto === "1"){
        profitEl.value = String(Math.round(diff));
        profitEl.dataset.auto = "1";
      }
    };

    profitEl.addEventListener("input", ()=>{ profitEl.dataset.manual = "1"; });
    priceEl.addEventListener("input", recalc);
    buyEl.addEventListener("input", recalc);
    recalc();
  }
}

/* ===========================
   Collect data
=========================== */
function cacheBossBuyPayload(payload){
  if(!payload || payload.formType !== "boss_buy") return;
  const vin = String(payload.vin||"").trim().toUpperCase();
  if(vin) lsAdd(LS_KEYS.VINS, vin);
  if(payload.brand_model) lsAdd(LS_KEYS.BRAND_MODELS, payload.brand_model);
  if(payload.supplier) lsAdd(LS_KEYS.SUPPLIERS, payload.supplier);
  if(payload.purchase_place) lsAdd(LS_KEYS.PLACES, payload.purchase_place);
}

function collectSaleMain(){
  const payload = { formType };

  payload.manager   = document.getElementById("managerInput")?.value || "";
  payload.sale_date = getRuDate("saleDateInput");
  payload.brand_model = document.getElementById("brandModelInput")?.value || "";
  payload.vin       = document.getElementById("vinInput")?.value || "";
  payload.source    = document.getElementById("leadSourceInput")?.value || "";
  payload.buyer     = document.getElementById("buyerInput")?.value || "";
  payload.receiver  = document.getElementById("receiverInput")?.value || "";

  const badgeEl = document.getElementById("saleVariantBadge");
  payload.variant = badgeEl ? String(badgeEl.textContent||"").replace("Вариант:","").trim() : "";

  const payment = document.getElementById("salePaymentTypeInput")?.value || "cashless";
  const vatYes  = (document.getElementById("saleVatInput")?.value || "no") === "yes";
  const brokerYes = (document.getElementById("saleBrokerInput")?.value || "no") === "yes";
  const vat = (payment === "cashless") && vatYes;

  // ЕДИНАЯ цена в payload.price
  let price = "";
  if(payment === "cash"){
    price = document.getElementById("priceCashInput")?.value || "";
  }else{
    price = vat ? (document.getElementById("priceNdsInput")?.value || "")
                : (document.getElementById("priceCashlessInput")?.value || "");
  }
  payload.price = price;

  // Broker fields (only cashless + broker)
  payload.contract_price = (payment === "cashless" && brokerYes) ? (document.getElementById("contractPriceInput")?.value || "") : "";
  payload.broker_price   = (payment === "cashless" && brokerYes) ? (document.getElementById("brokerPriceInput")?.value || "") : "";
  payload.broker_expense = (payment === "cashless" && brokerYes) ? (document.getElementById("brokerExpenseInput")?.value || "") : "";
  payload.markup_nds     = (payment === "cashless" && vat) ? (document.getElementById("markupNdsInput")?.value || "") : "";

  // совместимость со старым пайтоном (если где-то ещё ожидается)
  payload.price_cash     = (payment === "cash") ? price : "";
  payload.price_cashless = (payment === "cashless" && !vat) ? price : "";
  payload.price_nds      = (payment === "cashless" && vat) ? price : "";

  // менеджерскую комиссию УБРАЛИ полностью
  // payload.manager_fee = ... (нет)

  return payload;
}

function collectFormData(){
  const payload = { formType };

  if(formType === "mgr_stock"){
    payload.deal_type = document.getElementById("dealTypeInput").value;
    payload.brand_model = document.getElementById("brandModelInput").value;
    payload.vin = document.getElementById("vinInput").value;
    payload.complectation = document.getElementById("configInput").value;
    payload.body_color = document.getElementById("bodyColorInput").value;
    payload.salon_color = document.getElementById("salonColorInput").value;
    payload.price = document.getElementById("priceInput").value;
    payload.stock_date = getRuDate("stockDateInput");
    payload.payment_type = document.getElementById("payTypeInput").value;
    payload.client = document.getElementById("clientInput").value;
    return payload;
  }

  if(isSaleMainLike(formType)){
    return collectSaleMain();
  }

  if(formType === "sale_deposit"){
    payload.manager = document.getElementById("managerInput").value;
    payload.sale_date = getRuDate("saleDateInput");
    payload.brand_model = document.getElementById("brandModelInput").value;
    payload.vin = document.getElementById("vinInput").value;
    payload.source = document.getElementById("leadSourceInput").value;
    payload.deposit_sum = document.getElementById("depositSumInput").value;
    payload.receiver = document.getElementById("receiverInput").value;
    payload.price = document.getElementById("priceInput").value;
    payload.buyer = document.getElementById("buyerInput").value;
    return payload;
  }

  if(formType === "sale_extra"){
    payload.manager = document.getElementById("managerInput").value;
    payload.sale_date = getRuDate("saleDateInput");
    payload.brand_model = document.getElementById("brandModelInput").value;
    payload.vin = document.getElementById("vinInput").value;
    payload.source = document.getElementById("leadSourceInput").value;
    payload.extra_desc = document.getElementById("extraDescInput").value;
    payload.price = document.getElementById("priceInput").value;
    payload.receiver = document.getElementById("receiverInput").value;
    payload.purchaser = document.getElementById("purchaserInput").value;
    payload.buy_price = document.getElementById("buyPriceInput").value;
    payload.profit = document.getElementById("profitInput").value;
    return payload;
  }

  if(formType === "fin_auto_template"){
    payload.vin = document.getElementById("vinInput").value;
    payload.brand_model = document.getElementById("brandModelInput").value;
    payload.op_date = getRuDate("faDateInput");
    payload.evacuator = document.getElementById("evacuatorInput").value;
    payload.lab = document.getElementById("labInput").value;
    payload.util_writeoff = document.getElementById("utilWriteoffInput").value;
    payload.util = document.getElementById("utilInput").value;
    payload.pre_sale = document.getElementById("preSaleInput").value;
    payload.marketing = document.getElementById("marketingInput").value;
    payload.other = document.getElementById("otherInput").value;
    payload.extra_expenses = document.getElementById("extraExpensesInput").value;
    payload.comment = document.getElementById("commentInput").value;
    return payload;
  }

  if(formType === "fin_oper"){
    payload.category = document.getElementById("categoryInput").value;
    payload.op_date = getRuDate("opDateInput");
    payload.amount = document.getElementById("amountInput").value;
    payload.comment = document.getElementById("commentInput").value;
    return payload;
  }

  if(formType === "boss_buy"){
    const mode = document.getElementById("modeSelect").value;
    payload.mode = mode;
    payload.vin = document.getElementById("vinInput").value.trim().toUpperCase();

    if(mode === "purchase"){
      payload.purchase_date = getRuDate("purchaseDateInput");
      payload.supplier = document.getElementById("supplierInput").value;
      payload.purchase_place = document.getElementById("placeInput").value;
      payload.brand_model = document.getElementById("brandModelInput").value;
      payload.complectation = document.getElementById("complectationInput").value;
      payload.currency = document.getElementById("currencyInput").value;
      payload.amount_currency = document.getElementById("amountCurrencyInput").value;
      payload.rate_to_rub = document.getElementById("rateInput").value;
      payload.amount_rub = document.getElementById("amountRubInput").value;
      payload.comment = document.getElementById("commentInput_p").value;
    }else{
      payload.pay_date = getRuDate("payDateInput");
      payload.pay_currency = document.getElementById("payCurrencySelect").value;

      if(payload.pay_currency === "₽"){
        payload.pay_amount_currency = "";
        payload.pay_rate = "";
        payload.pay_amount_rub = document.getElementById("payRubOnlyInput").value;
      }else{
        payload.pay_amount_currency = document.getElementById("payAmountCurrencyInput").value;
        payload.pay_rate = document.getElementById("payRateInput").value;
        payload.pay_amount_rub = document.getElementById("payRubInput").value;
      }
      payload.comment = document.getElementById("commentInput").value;
    }
    return payload;
  }

  if(formType === "boss_invest_in" || formType === "boss_invest_out"){
    payload.investor = document.getElementById("investorInput").value;
    payload.sum = document.getElementById("sumInput").value;
    payload.op_date = getRuDate("opDateInput");
    payload.comment = document.getElementById("commentInput").value;
    return payload;
  }

  payload.raw = document.getElementById("rawInput")?.value || "";
  return payload;
}

/* ===========================
   Init
=========================== */
renderForm();
postRenderEnhancements();
scheduleRemoteListsLoad();

/* ===========================
   Submit
=========================== */
submitBtn.addEventListener("click", ()=>{
  const tg2 = window.Telegram?.WebApp;
  if(!tg2){
    alert("Открой форму через кнопку в Telegram-боте.");
    return;
  }

  const payload = collectFormData();

  try{ cacheBossBuyPayload(payload); }catch(e){}

  const dataStr = JSON.stringify(payload);

  // Лимит Telegram WebAppData небольшой
  if(dataStr.length > 3800){
    tgAlert("Слишком много текста для отправки в Telegram. Сократи комментарии/доп.расходы и отправь ещё раз.");
    return;
  }

  submitBtn.disabled = true;
  submitBtn.textContent = "Отправка...";

  try{
    tg2.sendData(dataStr);
    setTimeout(()=>{ try{ tg2.close(); }catch(e){} }, 650);
  }catch(e){
    tgAlert("Не удалось отправить данные. Попробуй ещё раз.");
    submitBtn.disabled = false;
    submitBtn.textContent = "Отправить в бота";
  }
});
</script>

</body>
</html>
