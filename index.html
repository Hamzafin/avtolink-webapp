<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Автолинк WebApp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script defer src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    *,*::before,*::after{box-sizing:border-box;}

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: #0f172a;
      color: #e5e7eb;
      min-height: var(--app-height, var(--tg-viewport-height, 100vh));
      padding-bottom: calc(16px + env(safe-area-inset-bottom));
      overscroll-behavior: contain;
    }
    h1 {
      font-size: 20px;
      margin: 0 0 4px;
      text-align: center;
    }
    .subtitle {
      font-size: 13px;
      text-align: center;
      color: #94a3b8;
      margin-bottom: 16px;
      line-height: 1.35;
    }
    .card {
      background: #111827;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.5);
      max-width: 560px;
      margin: 0 auto;
    }
    .field {
      margin-bottom: 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    label {
      font-size: 13px;
      color: #9ca3af;
    }
    input, select, textarea {
      border-radius: 10px;
      border: 1px solid #374151;
      padding: 8px 10px;
      font-size: 14px;
      background: #020617;
      color: #e5e7eb;
      outline: none;
    }
    input:focus, select:focus, textarea:focus {
      border-color: #38bdf8;
    }
    textarea {
      min-height: 90px;
      resize: vertical;
    }
    .readonly {
      background: #020617;
      color: #9ca3af;
    }
    .hint {
      font-size: 12px;
      color: #94a3b8;
      line-height: 1.35;
      margin-top: 4px;
    }
    .pill {
      display: inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      background: #0b1226;
      border: 1px solid #334155;
      color: #cbd5e1;
      font-size: 12px;
    }
    .divider {
      height: 1px;
      background: #1f2937;
      margin: 14px 0;
    }
    .hidden { display:none; }

    .toggle-row{display:flex;align-items:center;gap:10px;font-size:13px;color:#cbd5e1;}
    .toggle-row input{width:18px;height:18px;}
    .toggle-row small{color:#94a3b8;line-height:1.25;}


    button#submitBtn {
      width: 100%;
      border-radius: 999px;
      border: none;
      padding: 10px 14px;
      font-size: 15px;
      font-weight: 600;
      background: linear-gradient(135deg, #38bdf8, #6366f1);
      color: white;
      cursor: pointer;
      margin-top: 12px;
    }
    button#submitBtn:disabled {
      opacity: .5;
      cursor: default;
    }

    /* --- MULTI OWNER UI (СТОК) --- */
    .owner-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 6px;
    }
    .owner-row input { flex: 1; }
    .mini-btn {
      border: 1px solid #374151;
      background: #0b1220;
      color: #e5e7eb;
      border-radius: 10px;
      padding: 8px 10px;
      cursor: pointer;
      white-space: nowrap;
    }
    .mini-btn:active { transform: translateY(1px); }
  </style>
</head>
<body>
  <h1>Автолинк</h1>
  <div class="subtitle" id="subtitle"></div>

  <div class="card" id="formCard"></div>
  <button id="submitBtn" disabled>Отправить в бота</button>

  <script>

    const APP_VERSION = "4";

    // ===================== SERVICE WORKER (GitHub Pages cache) =====================
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./sw.js?v=" + APP_VERSION).catch(() => {});
      });
    }

    // ===================== TELEGRAM INIT (faster open / full height) =====================
    const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
    try { if (tg) { tg.ready(); tg.expand(); } } catch (e) {}
    // Telegram sets CSS vars --tg-viewport-height/--tg-viewport-stable-height
    if (tg) {
      const setH = () => {
        document.documentElement.style.setProperty('--app-height', (tg.viewportHeight || window.innerHeight) + 'px');
      };
      setH();
      tg.onEvent('viewportChanged', setH);
    }

    const urlParams = new URLSearchParams(window.location.search);
    const formType = urlParams.get("type") || "unknown";

    const ENABLE_SUFFIX_LOOKUP = (formType === "boss_buy");

    const categoryFromUrl = urlParams.get("category") || "";
    const brandsParam = urlParams.get("brands") || "";
    const investorsParam = urlParams.get("investors") || "";
    const sourcesParam = urlParams.get("sources") || "";
    const vinsParam = urlParams.get("vins") || "";
    const currenciesParam = urlParams.get("currencies") || "";
    const bossVinsParam = urlParams.get("bossvins") || "";

    const brands = brandsParam ? brandsParam.split("|") : [];
    const investors = investorsParam ? investorsParam.split("|") : [];
    const sources = sourcesParam ? sourcesParam.split("|") : [];
    const vins = vinsParam ? vinsParam.split("|") : [];
    const currencies = currenciesParam ? currenciesParam.split("|") : [];
    const bossVins = bossVinsParam ? bossVinsParam.split("|") : [];

    const subtitleEl = document.getElementById("subtitle");
    const formCard = document.getElementById("formCard");
    const submitBtn = document.getElementById("submitBtn");

    const FORM_TITLES = {
      mgr_stock: "Сток",
      sale_main: "Продажа — основная",
      sale_deposit: "Задаток",
      sale_extra: "Доп. услуги",
      sale_nds_broker: "Продажа — НДС с комиссией брокера",
      sale_nds_no_broker: "Продажа — НДС без комиссии брокера",
      sale_cash: "Продажа — Наличные",
      sale_cash_broker: "Продажа — Наличные с комиссией",
      fin_auto_template: "Расходы на авто РФ",
      fin_oper: "Оперрасходы",
      boss_buy: "Закупка / Оплата по VIN",
      boss_invest_in: "Инвестиции — ввод",
      boss_invest_out: "Инвестиции — вывод",
    };

    subtitleEl.textContent =
      "Форма: " + (FORM_TITLES[formType] || formType) +
      (categoryFromUrl ? " | Категория: " + categoryFromUrl : "");

    function todayISO() {
      return new Date().toISOString().slice(0, 10);
    }

    function formatDateToRu(value) {
      if (!value) return "";
      const parts = value.split("-");
      if (parts.length === 3) {
        const [y, m, d] = parts;
        return `${d}.${m}.${y}`;
      }
      return value;
    }


    // ---------- Local cache for dropdowns (VIN / supplier / place / brand_model) ----------
    const LS_KEYS = {
      VINS: "boss_buy_vins",
      SUPPLIERS: "boss_buy_suppliers",
      PLACES: "boss_buy_places",
      BRAND_MODELS: "boss_buy_brand_models",
    };
    // ===================== OPTIONAL REMOTE LOOKUP (Google Apps Script JSONP) =====================
    // Чтобы подтягивать данные по VIN из Google Sheets:
    // 1) Разверни Apps Script Web App (см. Code.gs из моего сообщения)
    // 2) Вставь ссылку вида https://script.google.com/macros/s/XXXX/exec в LOOKUP_API_URL
    // Если LOOKUP_API_URL пустой — всё работает как раньше, просто без автоподтягивания.

    const LOOKUP_API_URL = "https://script.google.com/macros/s/AKfycbzuBwFkGUiXnJcwUeTSt5jP8Y1BdE8PD0MQO_0SH6hr74O2htidfhD3Oop5zZ80G-GlDw/exec";   // <-- вставь сюда URL /exec
    const LOOKUP_API_TOKEN = ""; // <-- опционально (должен совпадать с TOKEN в Apps Script)

    const remoteCache = { vins: [], suppliers: [], places: [], brand_models: [] };
    let remoteListsLoaded = false;

    function canUseLookup() {
      return typeof LOOKUP_API_URL === "string" && LOOKUP_API_URL.trim().startsWith("https://");
    }

    function updateDatalist(dlId, options) {
      const dl = document.getElementById(dlId);
      if (!dl) return;
      dl.innerHTML = "";
      (options || []).slice(0, 500).forEach((opt) => {
        const o = document.createElement("option");
        o.value = opt;
        dl.appendChild(o);
      });
    }

    function jsonpRequest(baseUrl, params, timeoutMs = 8000) {
      return new Promise((resolve, reject) => {
        const cb = "__cb_" + Math.random().toString(36).slice(2);
        const q = new URLSearchParams(params || {});
        q.set("callback", cb);
        if (LOOKUP_API_TOKEN) q.set("token", LOOKUP_API_TOKEN);

        const src = baseUrl + (baseUrl.includes("?") ? "&" : "?") + q.toString();
        const script = document.createElement("script");
        let done = false;

        function cleanup() {
          if (script && script.parentNode) script.parentNode.removeChild(script);
          try { delete window[cb]; } catch (e) { window[cb] = undefined; }
        }

        const timer = setTimeout(() => {
          if (done) return;
          done = true;
          cleanup();
          reject(new Error("Lookup timeout"));
        }, timeoutMs);

        window[cb] = (data) => {
          if (done) return;
          done = true;
          clearTimeout(timer);
          cleanup();
          resolve(data);
        };

        script.onerror = () => {
          if (done) return;
          done = true;
          clearTimeout(timer);
          cleanup();
          reject(new Error("Lookup request failed"));
        };

        script.src = src;
        document.body.appendChild(script);
      });
    }


    // ---- Remote VIN suffix search (последние 4+ символа VIN) ----
    // Нужен Apps Script action=suffix&suffix=XXXX (возвращает {ok:true, vins:[...]})
    const _suffixMemo = new Map(); // suffix -> {ts:number, vins:string[]}
    let _suffixSeq = 0;

    async function requestSuffixCandidates(suffixRaw) {
      if (!canUseLookup() || !ENABLE_SUFFIX_LOOKUP) return [];
      const suffix = String(suffixRaw || "").trim().toUpperCase();
      if (suffix.length < 4) return [];

      const now = Date.now();
      const cached = _suffixMemo.get(suffix);
      if (cached && (now - cached.ts) < 5 * 60 * 1000) return cached.vins || [];

      const res = await jsonpRequest(LOOKUP_API_URL, { action: "suffix", suffix: suffix, limit: 80 }, 8000);
      const vins = (res && res.ok && Array.isArray(res.vins)) ? res.vins : [];
      _suffixMemo.set(suffix, { ts: now, vins });
      return vins;
    }
    async function remoteListsLoad() {
      if (!canUseLookup()) return;
      try {
        const res = await jsonpRequest(LOOKUP_API_URL, { action: "lists" });
        if (res && res.ok && res.lists) {
          remoteCache.vins = res.lists.vins || [];
          remoteCache.suppliers = res.lists.suppliers || [];
          remoteCache.places = res.lists.places || [];
          remoteCache.brand_models = res.lists.brand_models || [];
          remoteListsLoaded = true;

          // Сохраним в localStorage, чтобы подсказки работали быстрее
          if (remoteCache.vins.length) lsWrite(LS_KEYS.VINS, mergeUnique(remoteCache.vins, lsRead(LS_KEYS.VINS)), 800);
          if (remoteCache.suppliers.length) lsWrite(LS_KEYS.SUPPLIERS, mergeUnique(remoteCache.suppliers, lsRead(LS_KEYS.SUPPLIERS)), 400);
          if (remoteCache.places.length) lsWrite(LS_KEYS.PLACES, mergeUnique(remoteCache.places, lsRead(LS_KEYS.PLACES)), 400);
          if (remoteCache.brand_models.length) lsWrite(LS_KEYS.BRAND_MODELS, mergeUnique(remoteCache.brand_models, lsRead(LS_KEYS.BRAND_MODELS)), 600);

          // Обновим datalist'ы, если форма уже отрендерилась
          // VIN подсказки не набиваем при старте (ускорение открытия). Заполняются при фокусе/вводе.
          updateDatalist("supplierInput_list", mergeUnique(remoteCache.suppliers, lsRead(LS_KEYS.SUPPLIERS)));
          updateDatalist("placeInput_list", mergeUnique(remoteCache.places, lsRead(LS_KEYS.PLACES)));
          updateDatalist("brandModelInput_list", mergeUnique(remoteCache.brand_models, lsRead(LS_KEYS.BRAND_MODELS)));
        }

    // ===================== FAST LISTS (localStorage first, refresh in background) =====================
    const LITE = (urlParams.get("lite") === "1");
    const REMOTE_LISTS_TS_KEY = "avtolink_remote_lists_ts";
    const REMOTE_LISTS_TTL_MS = 12 * 60 * 60 * 1000; // 12 часов

    function lsReadNum(key, fallback = 0) {
      const v = localStorage.getItem(key);
      const n = parseInt(String(v || ""), 10);
      return Number.isFinite(n) ? n : fallback;
    }
    function lsWriteNum(key, val) {
      try { localStorage.setItem(key, String(val)); } catch (e) {}
    }

    function hydrateRemoteListsFromLS() {
      try {
        // моментально поднимаем из localStorage, чтобы форма открывалась быстрее
        const vinsLS = lsRead(LS_KEYS.VINS, []);
        const suppliersLS = lsRead(LS_KEYS.SUPPLIERS, []);
        const placesLS = lsRead(LS_KEYS.PLACES, []);
        const brandsLS = lsRead(LS_KEYS.BRANDS, []);

        if (Array.isArray(vinsLS) && vinsLS.length) remoteCache.vins = mergeUnique(remoteCache.vins, vinsLS);
        if (Array.isArray(suppliersLS) && suppliersLS.length) remoteCache.suppliers = mergeUnique(remoteCache.suppliers, suppliersLS);
        if (Array.isArray(placesLS) && placesLS.length) remoteCache.places = mergeUnique(remoteCache.places, placesLS);
        if (Array.isArray(brandsLS) && brandsLS.length) remoteCache.brand_models = mergeUnique(remoteCache.brand_models, brandsLS);

        // обновляем datalist'ы (VIN — только по мере ввода, чтобы не грузить DOM)
        updateDatalist("supplierInput", remoteCache.suppliers);
        updateDatalist("purchasePlaceInput", remoteCache.places);
        updateDatalist("brandModelInput", remoteCache.brand_models);

        remoteListsLoaded = remoteListsLoaded || remoteCache.brand_models.length > 0 || remoteCache.vins.length > 0;
      } catch (e) {}
    }

    function shouldRefreshRemoteLists() {
      const ts = lsReadNum(REMOTE_LISTS_TS_KEY, 0);
      return (!ts) || ((Date.now() - ts) > REMOTE_LISTS_TTL_MS);
    }

    function scheduleRemoteListsLoad() {
      if (!canUseLookup()) return;
      // сначала — мгновенно из localStorage
      hydrateRemoteListsFromLS();

      // если свежие — не дёргаем сеть каждый раз
      if (!shouldRefreshRemoteLists()) return;

      const runner = async () => {
        try {
          await remoteListsLoad();
          lsWriteNum(REMOTE_LISTS_TS_KEY, Date.now());
        } catch (e) {}
      };

      const idle = window.requestIdleCallback || ((fn) => setTimeout(fn, LITE ? 700 : 80));
      idle(runner);
    }
      } catch (e) {
        console.warn("remoteListsLoad failed:", e);
      }
    }

    function normalizeVin(v) {
      return String(v || "").trim().toUpperCase();
    }

    function getVinCandidates() {
      return mergeUnique(remoteCache.vins || [], getAllVins());
    }

    function resolveFullVin(vinRaw) {
      const v = normalizeVin(vinRaw);
      if (!v) return "";
      if (v.length === 17) return v;

      const cand = getVinCandidates();
      if (v.length >= 4 && v.length < 17) {
        const matches = cand.filter(x => normalizeVin(x).endsWith(v));
        if (matches.length === 1) return matches[0];
        return ""; // неоднозначно — пусть выберет из списка
      }
      return v;
    }

    async function lookupByVin(vinRaw) {
      if (!canUseLookup()) return null;
      const fullVin = resolveFullVin(vinRaw);
      if (!fullVin) return null;

      try {
        const res = await jsonpRequest(LOOKUP_API_URL, { action: "lookup", vin: fullVin });
        if (res && res.ok && res.found && res.data) return res.data;
      } catch (e) {
        console.warn("lookupByVin failed:", e);
      }
      return null;
    }

    function setValueIfExists(id, val) {
      const el = document.getElementById(id);
      if (!el) return;
      if (val === null || typeof val === "undefined") return;
      el.value = String(val);
    }

    function prefillBossBuyFields(data) {
      if (!data) return;
      if (data.vin) setValueIfExists("vinInput", data.vin);

      setValueIfExists("purchaseDateInput", data.purchase_date || "");
      setValueIfExists("supplierInput", data.supplier || "");
      setValueIfExists("placeInput", data.purchase_place || "");
      setValueIfExists("brandModelInput", data.brand_model || "");
      setValueIfExists("complectationInput", data.complectation || "");

      if (document.getElementById("currencyInput")) setValueIfExists("currencyInput", data.currency || "");
      setValueIfExists("amountCurrencyInput", data.amount_currency || "");
      setValueIfExists("rateInput", data.rate_to_rub || "");

      // опционально показать рассчитанную стоимость (если есть в таблице)
      if (document.getElementById("amountRubInput")) {
        setValueIfExists("amountRubInput", data.cost_rub || "");
      }
    }

    async function prefillBossBuyByVin(vinRaw) {
      const vin = normalizeVin(vinRaw);
      if (!vin) return;

      // 1) обычный lookup (полный VIN или однозначно найденный по последним 4 в локальных списках)
      const data = await lookupByVin(vin);
      if (data) {
        prefillBossBuyFields(data);
        return;
      }

      // 2) если введены последние 4+ символа, но локально VIN не смогли однозначно восстановить —
      // спросим Apps Script кандидатов по суффиксу и обновим список подсказок
      if (ENABLE_SUFFIX_LOOKUP && canUseLookup() && vin.length >= 4 && vin.length < 17) {
        try {
          const candidates = await requestSuffixCandidates(vin);
          if (candidates && candidates.length) {
            updateDatalist("vinInput_list", mergeUnique(candidates, getAllVins()));

            // если кандидатов ровно 1 — подставим полный VIN и подтянем данные
            if (candidates.length === 1) {
              const fullVin = String(candidates[0] || "").trim().toUpperCase();
              setValueIfExists("vinInput", fullVin);
              const d2 = await lookupByVin(fullVin);
              if (d2) prefillBossBuyFields(d2);
            }
          }
        } catch (e) {
          console.warn("suffix prefill failed:", e);
        }
      }
    }



    function lsRead(key) {
      try {
        const v = localStorage.getItem(key);
        const arr = v ? JSON.parse(v) : [];
        return Array.isArray(arr) ? arr.filter(Boolean) : [];
      } catch (e) { return []; }
    }

    function lsWrite(key, arr, maxLen = 200) {
      try {
        const clean = (Array.isArray(arr) ? arr : []).filter(Boolean).slice(0, maxLen);
        localStorage.setItem(key, JSON.stringify(clean));
      } catch (e) {}
    }

    function lsAdd(key, value, maxLen = 200) {
      const v = String(value || "").trim();
      if (!v) return;
      const arr = lsRead(key);
      const lo = v.toLowerCase();
      const filtered = arr.filter(x => String(x).trim().toLowerCase() !== lo);
      filtered.unshift(v);
      lsWrite(key, filtered, maxLen);
    }

    function mergeUnique(...arrays) {
      const out = [];
      const seen = new Set();
      arrays.flat().forEach((x) => {
        const s = String(x || "").trim();
        if (!s) return;
        const k = s.toLowerCase();
        if (seen.has(k)) return;
        seen.add(k);
        out.push(s);
      });
      return out;
    }

    function getAllVins() {
      return mergeUnique(bossVins || [], vins || [], (remoteCache.vins || []), lsRead(LS_KEYS.VINS)).map(v => String(v).trim().toUpperCase());
    }

    function cacheBossBuyPayload(payload) {
      if (!payload || payload.formType !== "boss_buy") return;

      const vin = String(payload.vin || "").trim().toUpperCase();
      if (vin) lsAdd(LS_KEYS.VINS, vin);

      if (payload.brand_model) lsAdd(LS_KEYS.BRAND_MODELS, payload.brand_model);
      if (payload.supplier) lsAdd(LS_KEYS.SUPPLIERS, payload.supplier);
      if (payload.purchase_place) lsAdd(LS_KEYS.PLACES, payload.purchase_place);
    }

    function getRuDate(id) {
      const el = document.getElementById(id);
      if (!el) return "";
      return formatDateToRu(el.value);
    }

    function showEl(el, show) {
      if (!el) return;
      el.classList.toggle("hidden", !show);
    }

    function parseNum(v) {
      if (!v) return 0;
      const n = parseFloat(String(v).replace(/\s/g, "").replace(",", "."));
      return isFinite(n) ? n : 0;
    }

    function createInput(id, labelText, placeholder = "", value = "", type = "text", readonly = false) {
      const w = document.createElement("div");
      w.className = "field";
      const l = document.createElement("label");
      l.htmlFor = id;
      l.textContent = labelText;
      const i = document.createElement("input");
      i.id = id;
      i.placeholder = placeholder;
      i.type = type;
      if (value) i.value = value;
      if (readonly) {
        i.readOnly = true;
        i.classList.add("readonly");
      }
      if (id.toLowerCase().includes("vin")) i.maxLength = 17;
      w.appendChild(l);
      w.appendChild(i);
      return w;
    }

    function createTextarea(id, labelText, placeholder = "", readonly = false) {
      const w = document.createElement("div");
      w.className = "field";
      const l = document.createElement("label");
      l.htmlFor = id;
      l.textContent = labelText;
      const t = document.createElement("textarea");
      t.id = id;
      t.placeholder = placeholder;
      if (readonly) {
        t.readOnly = true;
        t.classList.add("readonly");
      }
      w.appendChild(l);
      w.appendChild(t);
      return w;
    }

    function createSelectSimple(id, labelText, options, placeholder = "Выберите...") {
      const w = document.createElement("div");
      w.className = "field";
      const l = document.createElement("label");
      l.htmlFor = id;
      l.textContent = labelText;
      const s = document.createElement("select");
      s.id = id;

      const ph = document.createElement("option");
      ph.value = "";
      ph.textContent = placeholder;
      ph.disabled = true;
      ph.selected = true;
      s.appendChild(ph);

      options.forEach((opt) => {
        const o = document.createElement("option");
        o.value = opt;
        o.textContent = opt;
        s.appendChild(o);
      });

      w.appendChild(l);
      w.appendChild(s);
      return w;
    }

    function createSelectKV(id, labelText, options, placeholder = "Выберите...") {
      // options: [{value, label}]
      const w = document.createElement("div");
      w.className = "field";
      const l = document.createElement("label");
      l.htmlFor = id;
      l.textContent = labelText;
      const s = document.createElement("select");
      s.id = id;

      const ph = document.createElement("option");
      ph.value = "";
      ph.textContent = placeholder;
      ph.disabled = true;
      ph.selected = true;
      s.appendChild(ph);

      options.forEach((opt) => {
        const o = document.createElement("option");
        o.value = opt.value;
        o.textContent = opt.label;
        s.appendChild(o);
      });

      w.appendChild(l);
      w.appendChild(s);
      return w;
    }

    function createAutocompleteInput(id, labelText, placeholder = "", options = []) {
      const w = document.createElement("div");
      w.className = "field";
      const l = document.createElement("label");
      l.htmlFor = id;
      l.textContent = labelText;
      const i = document.createElement("input");
      i.id = id;
      i.placeholder = placeholder;

      if (options && options.length) {
        const dlId = id + "_list";
        i.setAttribute("list", dlId);
        let dl = document.getElementById(dlId);
        if (!dl) {
          dl = document.createElement("datalist");
          dl.id = dlId;
          document.body.appendChild(dl);
        }
        dl.innerHTML = "";
        options.slice(0, 500).forEach((opt) => {
          const o = document.createElement("option");
          o.value = opt;
          dl.appendChild(o);
        });
      }

      w.appendChild(l);
      w.appendChild(i);
      return w;
    }

    // ---------- VIN autocomplete (smart: last 4 + contains) ----------
    function setupVinAutocompleteSmart(inputId, allVinsSource) {
      const input = document.getElementById(inputId);
      if (!input) return;

      // не навешиваем обработчики повторно
      if (input.dataset && input.dataset.vinAuto === "1") return;
      if (input.dataset) input.dataset.vinAuto = "1";

      const listId = inputId + "_list";
      let dl = document.getElementById(listId);
      if (!dl) {
        dl = document.createElement("datalist");
        dl.id = listId;
        document.body.appendChild(dl);
      }
      input.setAttribute("list", listId);

      let reqSeq = 0;

      function normalize(x) { return String(x || "").trim().toUpperCase(); }

      function getSource() {
        try {
          const src = (typeof allVinsSource === "function") ? allVinsSource() : allVinsSource;
          return Array.isArray(src) ? src : [];
        } catch (e) {
          return Array.isArray(allVinsSource) ? allVinsSource : [];
        }
      }

      function fill(filter = "") {
        const f = String(filter || "").trim().toLowerCase();

        // не нагружаем при открытии формы
        if (!f || f.length < 2) return;

        dl.innerHTML = "";

        const source = getSource();
        const out = [];
        for (let i = 0; i < source.length; i++) {
          const v = normalize(source[i]);
          if (!v) continue;
          const lo = v.toLowerCase();
          if (lo.includes(f) || lo.endsWith(f)) out.push(v);
          if (out.length >= 80) break;
        }

        // если есть локальные — показываем их
        if (out.length) {
          out.forEach(v => {
            const o = document.createElement("option");
            o.value = v;
            dl.appendChild(o);
          });
          return;
        }

        // если локально ничего не нашли, а введено 4+ символа — спросим Apps Script (только для boss_buy)
        if (ENABLE_SUFFIX_LOOKUP && canUseLookup() && f.length >= 4) {
          const mySeq = ++reqSeq;
          requestSuffixCandidates(filter)
            .then((cands) => {
              if (mySeq !== reqSeq) return;
              const candidates = Array.isArray(cands) ? cands : [];
              if (!candidates.length) return;

              dl.innerHTML = "";
              candidates.slice(0, 80).forEach(v => {
                const o = document.createElement("option");
                o.value = normalize(v);
                dl.appendChild(o);
              });

              // если нашли ровно 1 VIN — автоподставим и подтянем поля (boss_buy)
              if (candidates.length === 1 && inputId === "vinInput") {
                input.value = normalize(candidates[0]);
                setTimeout(() => { try { prefillBossBuyByVin(input.value); } catch(e) {} }, 0);
              }
            })
            .catch(() => {});
        }
      }

      input.addEventListener("focus", () => fill(input.value));
      input.addEventListener("input", () => fill(input.value));
    }

    // ---------- MULTI OWNER (Сток) ----------
    function createMultiOwnerInput(options = []) {
      const wrapper = document.createElement("div");
      wrapper.className = "field";

      const label = document.createElement("label");
      label.textContent = "Собственники (можно несколько)";
      wrapper.appendChild(label);

      const hint = document.createElement("div");
      hint.className = "hint";
      hint.textContent = "Каждый собственник — отдельной строкой. В таблицу уйдёт в одну ячейку «в столбик».";
      wrapper.appendChild(hint);

      const container = document.createElement("div");
      container.id = "ownersContainer";
      wrapper.appendChild(container);

      const datalistId = "owners_list";
      let datalist = document.getElementById(datalistId);
      if (!datalist) {
        datalist = document.createElement("datalist");
        datalist.id = datalistId;
        document.body.appendChild(datalist);
      }
      datalist.innerHTML = "";
      options.forEach((opt) => {
        const o = document.createElement("option");
        o.value = opt;
        datalist.appendChild(o);
      });

      function addOwnerRow(value = "") {
        const row = document.createElement("div");
        row.className = "owner-row";

        const input = document.createElement("input");
        input.placeholder = "Начните вводить собственника";
        input.classList.add("owner-item");
        input.setAttribute("list", datalistId);
        if (value) input.value = value;

        const del = document.createElement("button");
        del.type = "button";
        del.className = "mini-btn";
        del.textContent = "✖";
        del.title = "Удалить";
        del.addEventListener("click", () => {
          row.remove();
          const still = container.querySelectorAll(".owner-item");
          if (!still.length) addOwnerRow("");
        });

        row.appendChild(input);
        row.appendChild(del);
        container.appendChild(row);
      }

      addOwnerRow("");

      const addBtn = document.createElement("button");
      addBtn.type = "button";
      addBtn.className = "mini-btn";
      addBtn.textContent = "➕ Добавить собственника";
      addBtn.style.marginTop = "8px";
      addBtn.addEventListener("click", () => addOwnerRow(""));
      wrapper.appendChild(addBtn);

      return wrapper;
    }

    function collectOwners() {
      const items = Array.from(document.querySelectorAll(".owner-item"))
        .map(el => (el.value || "").trim())
        .filter(Boolean);
      return [...new Set(items)];
    }

    // ===================== RENDER FORMS =====================

    function renderBossBuy() {
      formCard.innerHTML = "";

      formCard.appendChild(createInput(
        "vinInput",
        "VIN (можно последние 4 символа)",
        "Последние 4 или полный VIN"
      ));

      // MODE
      const modeWrap = document.createElement("div");
      modeWrap.className = "field";
      const modeLabel = document.createElement("label");
      modeLabel.textContent = "Что делаем?";
      const modeSelect = document.createElement("select");
      modeSelect.id = "modeSelect";
      modeSelect.innerHTML = `
        <option value="purchase">Новая закупка (создать VIN)</option>
        <option value="payment">Добавить оплату к VIN</option>
      `;
      const modeBadge = document.createElement("div");
      modeBadge.style.marginTop = "6px";
      modeBadge.innerHTML = `<span class="pill" id="modeBadge">Режим: —</span>`;
      modeWrap.appendChild(modeLabel);
      modeWrap.appendChild(modeSelect);
      modeWrap.appendChild(modeBadge);
      formCard.appendChild(modeWrap);

      const hint = document.createElement("div");
      hint.className = "hint";
      hint.textContent = "Если VIN уже есть в таблице руководителя («Закупка»), форма сама переключится в «Оплата».";
      formCard.appendChild(hint);

      const divider = document.createElement("div");
      divider.className = "divider";
      formCard.appendChild(divider);

      // PURCHASE BLOCK
      const purchaseBlock = document.createElement("div");
      purchaseBlock.id = "purchaseBlock";

      purchaseBlock.appendChild(createInput("purchaseDateInput", "Дата закупки", "", todayISO(), "date"));
      purchaseBlock.appendChild(createAutocompleteInput("supplierInput", "Поставщик", "Например, дилер/компания", lsRead(LS_KEYS.SUPPLIERS)));
      purchaseBlock.appendChild(createAutocompleteInput("placeInput", "Место закупки", "Например, Япония / РФ / Китай", lsRead(LS_KEYS.PLACES)));
      purchaseBlock.appendChild(createAutocompleteInput("brandModelInput", "Марка / Модель", "Например, BMW X5", mergeUnique(brands, lsRead(LS_KEYS.BRAND_MODELS))));
      purchaseBlock.appendChild(createInput("complectationInput", "Комплектация", "Например, M Sport"));

      purchaseBlock.appendChild(
        createSelectKV("currencyInput", "Валюта ($ / ₽ / ¥)", [
          {value:"$", label:"$ (доллар)"},
          {value:"₽", label:"₽ (рубль)"},
          {value:"¥", label:"¥ (юань)"},
        ], "Выберите валюту")
      );

      purchaseBlock.appendChild(createInput("amountCurrencyInput", "Сумма, валюта", "Например, 100000"));
      purchaseBlock.appendChild(createInput("rateInput", "Курс (на дату первой оплаты)", "Например, 80"));
      purchaseBlock.appendChild(createInput("amountRubInput", "Стоимость авто, ₽ (для контроля)", "Авторасчёт", "", "text", true));

      // optional payment on purchase
      purchaseBlock.appendChild(createSelectKV("payNowSelect", "Добавить оплату сейчас?", [
        {value:"no", label:"Нет"},
        {value:"yes", label:"Да"},
      ], "Выберите..."));

      const purchasePayBlock = document.createElement("div");
      purchasePayBlock.id = "purchasePayBlock";
      purchasePayBlock.className = "hidden";

      purchasePayBlock.appendChild(createInput("payDateInput_p", "Дата оплаты", "", todayISO(), "date"));
      purchasePayBlock.appendChild(
        createSelectKV("payCurrencySelect_p", "Валюта оплаты", [
          {value:"₽", label:"₽ (рубль)"},
          {value:"$", label:"$ (доллар)"},
          {value:"¥", label:"¥ (юань)"},
        ], "Выберите валюту")
      );

      const payAmountWrapP = createInput("payAmountCurrencyInput_p", "Сумма оплаты (валюта)", "Например, 20000");
      const payRateWrapP = createInput("payRateInput_p", "Курс на дату оплаты", "Например, 82");
      const payRubWrapP = createInput("payRubInput_p", "Сумма оплаты (₽)", "Авторасчёт", "", "text", false);

      purchasePayBlock.appendChild(payAmountWrapP);
      purchasePayBlock.appendChild(payRateWrapP);
      purchasePayBlock.appendChild(payRubWrapP);

      purchaseBlock.appendChild(purchasePayBlock);
      purchaseBlock.appendChild(createTextarea("commentInput_p", "Комментарий", "По желанию"));

      // PAYMENT BLOCK
      const paymentBlock = document.createElement("div");
      paymentBlock.id = "paymentBlock";

      paymentBlock.appendChild(createInput("payDateInput", "Дата оплаты", "", todayISO(), "date"));
      paymentBlock.appendChild(
        createSelectKV("payCurrencySelect", "Валюта оплаты", [
          {value:"₽", label:"₽ (рубль)"},
          {value:"$", label:"$ (доллар)"},
          {value:"¥", label:"¥ (юань)"},
        ], "Выберите валюту")
      );

      const fxWrap = document.createElement("div");
      fxWrap.id = "fxWrap";
      fxWrap.appendChild(createInput("payAmountCurrencyInput", "Сумма оплаты (валюта)", "Например, 20000"));
      fxWrap.appendChild(createInput("payRateInput", "Курс на дату оплаты", "Например, 82"));
      fxWrap.appendChild(createInput("payRubInput", "Сумма оплаты (₽)", "Авторасчёт", "", "text", false));

      const rubWrap = document.createElement("div");
      rubWrap.id = "rubWrap";
      rubWrap.appendChild(createInput("payRubOnlyInput", "Сумма оплаты (₽)", "Например, 500000"));

      paymentBlock.appendChild(fxWrap);
      paymentBlock.appendChild(rubWrap);
      paymentBlock.appendChild(createTextarea("commentInput", "Комментарий", "По желанию"));

      formCard.appendChild(purchaseBlock);
      formCard.appendChild(paymentBlock);

      // wiring
      setupVinAutocompleteSmart("vinInput", getAllVins);

      function setMode(mode) {
        const badge = document.getElementById("modeBadge");
        const mSel = document.getElementById("modeSelect");
        if (mSel.value !== mode) mSel.value = mode;
        badge.textContent = "Режим: " + (mode === "payment" ? "Оплата" : "Новая закупка");
        showEl(purchaseBlock, mode === "purchase");
        showEl(paymentBlock, mode === "payment");
      }

      function autoDetectModeByVin(vinRaw) {
        const vin = (vinRaw || "").trim().toUpperCase();
        if (!vin) return;

        const bossUpper = bossVins.map(v => (v || "").toUpperCase());

        if (vin.length === 17 && bossUpper.includes(vin)) {
          setMode("payment");
          return;
        }

        if (vin.length >= 4 && vin.length < 17 && bossVins.length) {
          const matches = bossVins.filter(v => (v || "").toUpperCase().endsWith(vin));
          if (matches.length === 1) {
            document.getElementById("vinInput").value = matches[0];
            setMode("payment");
            return;
          }
          if (matches.length > 1) {
            setMode("payment");
            return;
          }
        }

        setMode("purchase");
      }

      function recalcPurchaseRub() {
        const cur = document.getElementById("currencyInput")?.value || "";
        const a = parseNum(document.getElementById("amountCurrencyInput")?.value);
        const r = parseNum(document.getElementById("rateInput")?.value);
        const out = document.getElementById("amountRubInput");
        if (!out) return;

        if (!a) { out.value = ""; return; }
        if (cur === "₽") {
          out.value = Math.round(a).toString();
          return;
        }
        if (a && r) out.value = Math.round(a * r).toString();
        else out.value = "";
      }

      function recalcPaymentRub(amountId, rateId, rubId, currencySelId) {
        const cur = document.getElementById(currencySelId)?.value || "";
        const a = parseNum(document.getElementById(amountId)?.value);
        const r = parseNum(document.getElementById(rateId)?.value);
        const out = document.getElementById(rubId);
        if (!out) return;
        if (cur && cur !== "₽") {
          if (a && r) out.value = Math.round(a * r).toString();
          else out.value = "";
        }
      }

      function togglePaymentFields(curSelId, fxWrapEl, rubWrapEl) {
        const cur = document.getElementById(curSelId)?.value || "";
        if (cur === "₽") {
          showEl(fxWrapEl, false);
          showEl(rubWrapEl, true);
        } else {
          showEl(fxWrapEl, true);
          showEl(rubWrapEl, false);
        }
      }

      // init
      setMode("purchase");
      document.getElementById("modeBadge").textContent = "Режим: Новая закупка";

      // VIN: если VIN уже есть в таблице — подтянем данные в поля (для удобства)
      let vinPrefillTimer = null;
      const vinEl = document.getElementById("vinInput");
      vinEl.addEventListener("input", (e) => {
        if (vinPrefillTimer) clearTimeout(vinPrefillTimer);
        vinPrefillTimer = setTimeout(() => prefillBossBuyByVin(e.target.value), 450);
      });
      vinEl.addEventListener("change", (e) => prefillBossBuyByVin(e.target.value));
      vinEl.addEventListener("blur", (e) => prefillBossBuyByVin(e.target.value));
      document.getElementById("modeSelect").addEventListener("change", (e) => setMode(e.target.value));

      ["currencyInput","amountCurrencyInput","rateInput"].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.addEventListener("input", recalcPurchaseRub);
          el.addEventListener("change", recalcPurchaseRub);
        }
      });

      document.getElementById("payNowSelect").addEventListener("change", (e) => {
        showEl(purchasePayBlock, e.target.value === "yes");
      });

      // purchase pay currency toggle (hide amount/rate when ₽)
      document.getElementById("payCurrencySelect_p").addEventListener("change", () => {
        const cur = document.getElementById("payCurrencySelect_p").value;
        // wrappers: input is inside .field; we stored them
        showEl(payAmountWrapP, cur !== "₽");
        showEl(payRateWrapP, cur !== "₽");
      });

      ["payAmountCurrencyInput_p","payRateInput_p"].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener("input", () => recalcPaymentRub("payAmountCurrencyInput_p","payRateInput_p","payRubInput_p","payCurrencySelect_p"));
      });

      // payment block currency toggle
      togglePaymentFields("payCurrencySelect", fxWrap, rubWrap);
      document.getElementById("payCurrencySelect").addEventListener("change", () => togglePaymentFields("payCurrencySelect", fxWrap, rubWrap));

      ["payAmountCurrencyInput","payRateInput"].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener("input", () => recalcPaymentRub("payAmountCurrencyInput","payRateInput","payRubInput","payCurrencySelect"));
      });

      recalcPurchaseRub();
      submitBtn.disabled = false;
    }

    
    function renderSaleMain() {
      formCard.innerHTML = "";

      // --- переключатели ---
      const payWrap = createSelectKV("salePaymentTypeInput", "Оплата", [
        {value:"cash", label:"Нал"},
        {value:"cashless", label:"Безнал"},
      ], "Выберите оплату");
      const vatWrap = createSelectKV("saleVatInput", "НДС", [
        {value:"yes", label:"С НДС"},
        {value:"no", label:"Без НДС"},
      ], "Выберите НДС");
      const commWrap = createSelectKV("saleCommissionInput", "Комиссия", [
        {value:"yes", label:"Есть"},
        {value:"no", label:"Нет"},
      ], "Выберите");

      payWrap.id = "salePayWrap";
      vatWrap.id = "saleVatWrap";
      commWrap.id = "saleCommWrap";

      formCard.appendChild(payWrap);
      formCard.appendChild(vatWrap);
      formCard.appendChild(commWrap);

      const badge = document.createElement("div");
      badge.style.marginTop = "6px";
      badge.innerHTML = `<span class="pill" id="saleVariantBadge">Вариант: —</span>`;
      formCard.appendChild(badge);

      // --- общие поля ---
      formCard.appendChild(createInput("managerInput", "Менеджер", "Имя менеджера"));
      formCard.appendChild(createInput("saleDateInput", "Дата продажи", "", todayISO(), "date"));
      formCard.appendChild(createAutocompleteInput("brandModelInput", "Марка / Модель", "", brands));
      formCard.appendChild(createInput("vinInput", "VIN (можно последние 4 символа)", "Последние 4 или полный VIN"));
      formCard.appendChild(createAutocompleteInput("leadSourceInput", "Источник", "Например, Авито", sources));

      const buyerWrap = createInput("buyerInput", "Покупатель", "");
      const receiverWrap = createInput("receiverInput", "Получатель", "");

      formCard.appendChild(buyerWrap);
      formCard.appendChild(receiverWrap);

      // --- суммы/поля (показываются по выбору) ---
      const priceCashWrap = createInput("priceCashInput", "Цена (нал)", "");
      const priceCashNoCommWrap = createInput("priceCashNoCommInput", "Цена без комиссии (нал)", "");
      const managerFeeWrap = createInput("managerFeeInput", "Комиссия менеджера", "");

      const priceCashlessWrap = createInput("priceCashlessInput", "Сумма (безнал, без НДС)", "");
      const priceNdsWrap = createInput("priceNdsInput", "Цена с НДС", "");
      const markupNdsWrap = createInput("markupNdsInput", "Наценка НДС (% / руб)", "");

      const contractPriceWrap = createInput("contractPriceInput", "Сумма договора", "");
      const brokerPriceWrap = createInput("brokerPriceInput", "Цена без комиссии брокера", "");
      const brokerExpenseWrap = createInput("brokerExpenseInput", "Расход брокера (кому/сумма/комментарий)", "");

      formCard.appendChild(priceCashWrap);
      formCard.appendChild(priceCashNoCommWrap);
      formCard.appendChild(managerFeeWrap);

      formCard.appendChild(priceCashlessWrap);
      formCard.appendChild(priceNdsWrap);
      formCard.appendChild(markupNdsWrap);

      formCard.appendChild(contractPriceWrap);
      formCard.appendChild(brokerPriceWrap);
      formCard.appendChild(brokerExpenseWrap);

      function updateSaleMainVisibility() {
        const payment = document.getElementById("salePaymentTypeInput").value || "cash";
        const commission = (document.getElementById("saleCommissionInput").value || "no") === "yes";
        const vatYes = (document.getElementById("saleVatInput").value || "no") === "yes";
        const vat = (payment === "cashless") && vatYes;

        // НДС доступен только при безнале
        const vatSelect = document.getElementById("saleVatInput");
        if (payment !== "cashless") {
          vatSelect.disabled = true;
          vatSelect.value = "no";
        } else {
          vatSelect.disabled = false;
        }

        // Покупатель всегда, получатель только при нале
        showEl(receiverWrap, payment === "cash");

        // Нал
        showEl(priceCashWrap, payment === "cash");
        showEl(priceCashNoCommWrap, payment === "cash" && commission);
        showEl(managerFeeWrap, payment === "cash" && commission);

        // Безнал
        showEl(priceCashlessWrap, payment === "cashless" && !vat);
        showEl(priceNdsWrap, payment === "cashless" && vat);
        showEl(markupNdsWrap, payment === "cashless" && vat);

        // Комиссия/брокер (для безнала)
        showEl(contractPriceWrap, payment === "cashless" && commission);
        showEl(brokerPriceWrap, payment === "cashless" && commission);
        showEl(brokerExpenseWrap, payment === "cashless" && commission);

        // Скрыть лишнее при нале
        if (payment === "cash") {
          showEl(priceCashlessWrap, false);
          showEl(priceNdsWrap, false);
          showEl(markupNdsWrap, false);
          showEl(contractPriceWrap, false);
          showEl(brokerPriceWrap, false);
          showEl(brokerExpenseWrap, false);
        }

        // Бейдж варианта
        let variant = "";
        if (payment === "cash" && !commission) variant = "Нал / без комиссии";
        if (payment === "cash" && commission) variant = "Нал / с комиссией";
        if (payment === "cashless" && vat && !commission) variant = "Безнал / с НДС / без брокера";
        if (payment === "cashless" && vat && commission) variant = "Безнал / с НДС / с брокером";
        if (payment === "cashless" && !vat && !commission) variant = "Безнал / без НДС / без брокера";
        if (payment === "cashless" && !vat && commission) variant = "Безнал / без НДС / с брокером";

        const badgeEl = document.getElementById("saleVariantBadge");
        if (badgeEl) badgeEl.textContent = "Вариант: " + variant;
      }

      // дефолты
      document.getElementById("salePaymentTypeInput").value = "cash";
      document.getElementById("saleVatInput").value = "no";
      document.getElementById("saleCommissionInput").value = "no";

      document.getElementById("salePaymentTypeInput").addEventListener("change", updateSaleMainVisibility);
      document.getElementById("saleVatInput").addEventListener("change", updateSaleMainVisibility);
      document.getElementById("saleCommissionInput").addEventListener("change", updateSaleMainVisibility);

      updateSaleMainVisibility();
      setupVinAutocompleteSmart("vinInput", getAllVins);

      submitBtn.disabled = false;
    }

function renderForm() {
      formCard.innerHTML = "";

      if (formType === "mgr_stock") {
        formCard.appendChild(createSelectKV("dealTypeInput", "Тип сделки", [
          {value:"Склад", label:"Склад"},
          {value:"Поставка", label:"Поставка"},
        ], "Выберите тип сделки"));
formCard.appendChild(createAutocompleteInput("brandModelInput", "Марка / Модель", "Начните вводить марку или модель", brands));
        formCard.appendChild(createInput("vinInput", "VIN (можно последние 4 символа)", "Последние 4 или полный VIN"));
        formCard.appendChild(createInput("configInput", "Комплектация", "Например, Comfort"));
        formCard.appendChild(createInput("bodyColorInput", "Цвет кузова", "Черный"));
        formCard.appendChild(createInput("salonColorInput", "Цвет салона", "Черный"));
        formCard.appendChild(createInput("priceInput", "Цена, ₽", "1500000"));
        formCard.appendChild(createInput("stockDateInput", "Дата", "", todayISO(), "date"));
        formCard.appendChild(createSelectKV("payTypeInput", "Тип оплаты", [
          {value:"Нал", label:"Нал"},
          {value:"Безнал", label:"Безнал"},
          {value:"НДС", label:"НДС"},
        ], "Выберите тип оплаты"));
        formCard.appendChild(createInput("clientInput", "Клиент (Имя + телефон)", "Иван Иванов, +7..."));

        setupVinAutocompleteSmart("vinInput", getAllVins);
        submitBtn.disabled = false;
        return;
      }

            if (formType === "sale_main") {
        renderSaleMain();
        return;
      }

// ✅ Продажи: собственник НЕ добавляем (как вы просили)
      
      
      if (formType === "sale_main") {
        payload.manager = document.getElementById("managerInput")?.value || "";
        payload.sale_date = getRuDate("saleDateInput");
        payload.brand_model = document.getElementById("brandModelInput")?.value || "";
        payload.vin = document.getElementById("vinInput")?.value || "";
        payload.source = document.getElementById("leadSourceInput")?.value || "";
        payload.buyer = document.getElementById("buyerInput")?.value || "";
        payload.receiver = document.getElementById("receiverInput")?.value || "";

        // ✅ ТОЛЬКО один служебный ответ: вариант продажи (без "да/нет" в payload)
        const badgeEl = document.getElementById("saleVariantBadge");
        payload.variant = badgeEl ? String(badgeEl.textContent || "").replace("Вариант:", "").trim() : "";

        // суммы (то, что реально относится к выбранному варианту)
        payload.price_cash = document.getElementById("priceCashInput")?.value || "";
        payload.price_no_commission = document.getElementById("priceCashNoCommInput")?.value || "";
        payload.manager_fee = document.getElementById("managerFeeInput")?.value || "";

        payload.price_cashless = document.getElementById("priceCashlessInput")?.value || "";
        payload.price_nds = document.getElementById("priceNdsInput")?.value || "";
        payload.markup_nds = document.getElementById("markupNdsInput")?.value || "";

        payload.contract_price = document.getElementById("contractPriceInput")?.value || "";
        payload.broker_price = document.getElementById("brokerPriceInput")?.value || "";
        payload.broker_expense = document.getElementById("brokerExpenseInput")?.value || "";

        return payload;
      }

if (formType === "sale_nds_broker") {
        formCard.appendChild(createInput("managerInput", "Менеджер", "Имя менеджера"));
        formCard.appendChild(createInput("saleDateInput", "Дата продажи", "", todayISO(), "date"));
        formCard.appendChild(createAutocompleteInput("brandModelInput", "Марка / Модель", "", brands));
        formCard.appendChild(createInput("vinInput", "VIN (можно последние 4 символа)", "Последние 4 или полный VIN"));
        formCard.appendChild(createAutocompleteInput("leadSourceInput", "Источник", "Например, Авито", sources));
        formCard.appendChild(createInput("priceNdsInput", "Цена с НДС", ""));
        formCard.appendChild(createInput("markupNdsInput", "Наценка НДС (% / руб)", ""));
        formCard.appendChild(createInput("contractPriceInput", "Цена в договоре (с учётом комиссии брокера)", ""));
        formCard.appendChild(createInput("brokerPriceInput", "Цена без комиссии брокера", ""));
        formCard.appendChild(createInput("brokerExpenseInput", "Расход брокера (машина + НДС, кому, сумма)", ""));
        formCard.appendChild(createInput("buyerInput", "Покупатель", ""));
        setupVinAutocompleteSmart("vinInput", getAllVins);
        submitBtn.disabled = false;
        return;
      }

      if (formType === "sale_nds_no_broker") {
        formCard.appendChild(createInput("managerInput", "Менеджер", ""));
        formCard.appendChild(createInput("saleDateInput", "Дата продажи", "", todayISO(), "date"));
        formCard.appendChild(createAutocompleteInput("brandModelInput", "Марка / Модель", "", brands));
        formCard.appendChild(createInput("vinInput", "VIN (можно последние 4 символа)", "Последние 4 или полный VIN"));
        formCard.appendChild(createAutocompleteInput("leadSourceInput", "Источник", "Например, Авито", sources));
        formCard.appendChild(createInput("priceNdsInput", "Цена с НДС", ""));
        formCard.appendChild(createInput("priceCashInput", "Цена за наличные", ""));
        formCard.appendChild(createInput("markupNdsInput", "Наценка НДС (% / руб)", ""));
        formCard.appendChild(createInput("buyerInput", "Покупатель", ""));
        setupVinAutocompleteSmart("vinInput", getAllVins);
        submitBtn.disabled = false;
        return;
      }

      if (formType === "sale_cash") {
        formCard.appendChild(createInput("managerInput", "Менеджер", ""));
        formCard.appendChild(createInput("saleDateInput", "Дата продажи", "", todayISO(), "date"));
        formCard.appendChild(createAutocompleteInput("brandModelInput", "Марка / Модель", "", brands));
        formCard.appendChild(createInput("vinInput", "VIN (можно последние 4 символа)", "Последние 4 или полный VIN"));
        formCard.appendChild(createAutocompleteInput("leadSourceInput", "Источник", "Например, Авито", sources));
        formCard.appendChild(createInput("priceInput", "Цена продажи", ""));
        formCard.appendChild(createInput("receiverInput", "Кому передали средства", ""));
        formCard.appendChild(createInput("buyerInput", "Покупатель", ""));
        setupVinAutocompleteSmart("vinInput", getAllVins);
        submitBtn.disabled = false;
        return;
      }

      if (formType === "sale_cash_broker") {
        formCard.appendChild(createInput("managerInput", "Менеджер", ""));
        formCard.appendChild(createInput("saleDateInput", "Дата продажи", "", todayISO(), "date"));
        formCard.appendChild(createAutocompleteInput("brandModelInput", "Марка / Модель", "", brands));
        formCard.appendChild(createInput("vinInput", "VIN (можно последние 4 символа)", "Последние 4 или полный VIN"));
        formCard.appendChild(createAutocompleteInput("leadSourceInput", "Источник", "Например, Авито", sources));
        formCard.appendChild(createInput("priceInput", "Цена продажи", ""));
        formCard.appendChild(createInput("priceNoCommInput", "Цена без комиссии", ""));
        formCard.appendChild(createInput("managerFeeInput", "Комиссия менеджера", ""));
        formCard.appendChild(createInput("receiverInput", "Кому передали средства", ""));
        formCard.appendChild(createInput("buyerInput", "Покупатель", ""));
        setupVinAutocompleteSmart("vinInput", getAllVins);
        submitBtn.disabled = false;
        return;
      }

      if (formType === "sale_deposit") {
        formCard.appendChild(createInput("managerInput", "Менеджер", ""));
        formCard.appendChild(createInput("saleDateInput", "Дата", "", todayISO(), "date"));
        formCard.appendChild(createAutocompleteInput("brandModelInput", "Марка / Модель", "", brands));
        formCard.appendChild(createInput("vinInput", "VIN (можно последние 4 символа)", "Последние 4 или полный VIN"));
        formCard.appendChild(createAutocompleteInput("leadSourceInput", "Источник", "Например, Авито", sources));
        formCard.appendChild(createInput("depositSumInput", "Сумма задатка", ""));
        formCard.appendChild(createInput("receiverInput", "Кому передана сумма", ""));
        formCard.appendChild(createInput("priceInput", "Цена продажи", ""));
        formCard.appendChild(createInput("buyerInput", "Покупатель", ""));
        setupVinAutocompleteSmart("vinInput", getAllVins);
        submitBtn.disabled = false;
        return;
      }

      if (formType === "sale_extra") {
        formCard.appendChild(createInput("managerInput", "Менеджер", ""));
        formCard.appendChild(createInput("saleDateInput", "Дата", "", todayISO(), "date"));
        formCard.appendChild(createAutocompleteInput("brandModelInput", "Марка / Модель", "", brands));
        formCard.appendChild(createInput("vinInput", "VIN (можно последние 4 символа)", "Последние 4 или полный VIN"));
        formCard.appendChild(createAutocompleteInput("leadSourceInput", "Источник", "Например, Авито", sources));
        formCard.appendChild(createTextarea("extraDescInput", "Доп. услуги (описание)", ""));
        formCard.appendChild(createInput("priceInput", "Цена продажи", ""));
        formCard.appendChild(createInput("receiverInput", "Кому передали средства", ""));
        formCard.appendChild(createInput("purchaserInput", "Кто выдал средства на закупку", ""));
        formCard.appendChild(createInput("buyPriceInput", "Цена покупки", ""));
        formCard.appendChild(createInput("profitInput", "Доход", ""));
        setupVinAutocompleteSmart("vinInput", getAllVins);
        submitBtn.disabled = false;
        return;
      }

      if (formType === "fin_auto_template") {
        formCard.appendChild(createInput("vinInput", "VIN (можно последние 4 символа)", "Последние 4 или полный VIN"));
        formCard.appendChild(createAutocompleteInput("brandModelInput", "Марка / Модель", "", brands));
        formCard.appendChild(createInput("faDateInput", "Дата", "", todayISO(), "date"));
        formCard.appendChild(createInput("evacuatorInput", "Эвакуатор", ""));
        formCard.appendChild(createInput("labInput", "Лаборатория", ""));
        formCard.appendChild(createInput("utilWriteoffInput", "Списания утильсбора", ""));
        formCard.appendChild(createInput("utilInput", "Утильсбор", ""));
        formCard.appendChild(createInput("preSaleInput", "Предпродажная подготовка", ""));
        formCard.appendChild(createInput("marketingInput", "Маркетинг", ""));
        formCard.appendChild(createInput("otherInput", "Прочие расходы", ""));
        formCard.appendChild(createTextarea("extraExpensesInput", "Доп. расходы", "Если есть: строками (например: Шиномонтаж: 3000)"));
        formCard.appendChild(createTextarea("commentInput", "Комментарий", ""));
        setupVinAutocompleteSmart("vinInput", getAllVins);
        submitBtn.disabled = false;
        return;
      }

      if (formType === "fin_oper") {
        formCard.appendChild(createInput("categoryInput", "Категория", "", categoryFromUrl || "", "text", true));
        formCard.appendChild(createInput("opDateInput", "Дата", "", todayISO(), "date"));
        formCard.appendChild(createInput("amountInput", "Сумма, ₽", ""));
        formCard.appendChild(createTextarea("commentInput", "Комментарий", ""));
        submitBtn.disabled = false;
        return;
      }

      if (formType === "boss_buy") {
        renderBossBuy();
        return;
      }

      if (formType === "boss_invest_in" || formType === "boss_invest_out") {
        formCard.appendChild(createAutocompleteInput("investorInput", "Инвестор", "Начните вводить инвестора", investors));
        formCard.appendChild(createInput("sumInput", "Сумма", ""));
        formCard.appendChild(createInput("opDateInput", "Дата", "", todayISO(), "date"));
        formCard.appendChild(createTextarea("commentInput", "Комментарий", ""));
        submitBtn.disabled = false;
        return;
      }

      formCard.appendChild(createTextarea("rawInput", "Данные", "Форма не настроена. Введите данные в свободной форме."));
      submitBtn.disabled = false;
    }


    // ===================== UX AUTO (быстрее ввод + можно править вручную) =====================
    function jsParseNum(v) {
      if (v === null || v === undefined) return 0;
      const s = String(v).replace(/\s/g, "").replace(",", ".").replace(/[^\d.\-]/g, "");
      const n = parseFloat(s);
      return Number.isFinite(n) ? n : 0;
    }

    function tgUserFullName() {
      try {
        const u = window.Telegram?.WebApp?.initDataUnsafe?.user;
        if (!u) return "";
        return [u.first_name, u.last_name].filter(Boolean).join(" ").trim() || (u.username ? "@" + u.username : "");
      } catch (e) { return ""; }
    }

    function rememberField(id, lsKey, fallback = "") {
      const el = document.getElementById(id);
      if (!el) return;
      try {
        const saved = localStorage.getItem(lsKey);
        if (!el.value && saved) el.value = saved;
        if (!el.value && fallback) el.value = fallback;
      } catch (e) {}
      el.addEventListener("input", () => {
        try { localStorage.setItem(lsKey, el.value || ""); } catch (e) {}
      });
    }

    function insertToggleAfterInput(inputId, toggleId, labelText, hintText, checkedByDefault = true) {
      const input = document.getElementById(inputId);
      if (!input) return null;
      if (document.getElementById(toggleId)) return document.getElementById(toggleId);
      const field = input.closest(".field") || input.parentElement;
      if (!field || !field.parentElement) return null;

      const row = document.createElement("div");
      row.className = "field";
      row.innerHTML = `
        <div class="toggle-row">
          <input type="checkbox" id="${toggleId}" ${checkedByDefault ? "checked" : ""}/>
          <div>
            <div>${labelText}</div>
            ${hintText ? `<small>${hintText}</small>` : ``}
          </div>
        </div>
      `;
      field.parentElement.insertBefore(row, field.nextSibling);
      return document.getElementById(toggleId);
    }

    function postRenderEnhancements() {
      // менеджер: автоподставляем из Telegram + запоминаем (можно переписать)
      rememberField("managerInput", "avtolink_last_manager", tgUserFullName());

      // источник/получатель/плательщик — запоминаем для ускорения
      rememberField("leadSourceInput", "avtolink_last_source", "");
      rememberField("receiverInput", "avtolink_last_receiver", "");
      rememberField("purchaserInput", "avtolink_last_purchaser", "");

      // --- Автоподстановка Марка/Модель по VIN (если есть LOOKUP_API_URL) ---
      const vinEl = document.getElementById("vinInput");
      const brandEl = document.getElementById("brandModelInput");
      if (vinEl && brandEl) {
        const t = insertToggleAfterInput("vinInput", "autoVinFillToggle",
          "Автоподстановка «Марка / Модель» по VIN",
          "Если выключить — вводите вручную. Если включить — попробуем подтянуть по VIN."
        , true);

        let manualBrand = false;
        brandEl.addEventListener("input", () => { manualBrand = true; });

        let timer = null;
        const run = async () => {
          if (!t || !t.checked) return;
          if (!canUseLookup()) return;
          const v = String(vinEl.value || "").trim();
          if (!v || v.length < 4) return;

          // если пользователь уже руками ввёл марку/модель — не перезатираем
          if (manualBrand && brandEl.value) return;

          try {
            const data = await lookupByVin(v);
            const bm = data?.brand_model || data?.brandModel || "";
            if (bm) {
              brandEl.value = bm;
              manualBrand = false;
            }
          } catch (e) {}
        };

        const schedule = () => {
          if (timer) clearTimeout(timer);
          timer = setTimeout(run, 350);
        };

        vinEl.addEventListener("blur", schedule);
        vinEl.addEventListener("change", schedule);
      }

      // --- Авторасчёт дохода (Доп. услуги): Доход = Цена продажи - Цена покупки ---
      const priceEl = document.getElementById("priceInput");
      const buyEl = document.getElementById("buyPriceInput");
      const profitEl = document.getElementById("profitInput");
      if (priceEl && buyEl && profitEl) {
        const t = insertToggleAfterInput("profitInput", "autoProfitToggle",
          "Авторасчёт дохода",
          "Доход = Цена продажи − Цена покупки (можно поправить вручную).",
          true
        );

        const recalc = () => {
          if (!t || !t.checked) return;
          if (profitEl.dataset.manual === "1") return;
          const p = jsParseNum(priceEl.value);
          const b = jsParseNum(buyEl.value);
          if (!p && !b) return;
          const diff = p - b;
          if (!profitEl.value || profitEl.dataset.auto === "1") {
            profitEl.value = String(Math.round(diff));
            profitEl.dataset.auto = "1";
          }
        };

        profitEl.addEventListener("input", () => { profitEl.dataset.manual = "1"; });
        priceEl.addEventListener("input", recalc);
        buyEl.addEventListener("input", recalc);
        recalc();
      }

      // --- Авторасчёт комиссии менеджера (Основная продажа, нал с комиссией) ---
      const cashEl = document.getElementById("priceCashInput");
      const noCommEl = document.getElementById("priceCashNoCommInput");
      const feeEl = document.getElementById("managerFeeInput");
      if (cashEl && noCommEl && feeEl) {
        const t = insertToggleAfterInput("managerFeeInput", "autoFeeToggle",
          "Авторасчёт комиссии менеджера",
          "Комиссия = Цена (нал) − Цена без комиссии (можно переписать).",
          true
        );

        const recalc = () => {
          if (!t || !t.checked) return;
          if (feeEl.dataset.manual === "1") return;
          const a = jsParseNum(cashEl.value);
          const b = jsParseNum(noCommEl.value);
          if (!a || !b) return;
          const diff = a - b;
          if (!feeEl.value || feeEl.dataset.auto === "1") {
            feeEl.value = String(Math.round(diff));
            feeEl.dataset.auto = "1";
          }
        };

        feeEl.addEventListener("input", () => { feeEl.dataset.manual = "1"; });
        cashEl.addEventListener("input", recalc);
        noCommEl.addEventListener("input", recalc);
      }
    }

    renderForm();

    // Улучшения: автоподстановка/запоминание значений и фоновая подгрузка списков
    postRenderEnhancements();
    scheduleRemoteListsLoad();

    // ===================== COLLECT DATA =====================

    function collectFormData() {
      const payload = { formType };

      if (formType === "mgr_stock") {
        payload.deal_type = document.getElementById("dealTypeInput").value;

        payload.brand_model = document.getElementById("brandModelInput").value;
        payload.vin = document.getElementById("vinInput").value;
        payload.complectation = document.getElementById("configInput").value;
        payload.body_color = document.getElementById("bodyColorInput").value;
        payload.salon_color = document.getElementById("salonColorInput").value;
        payload.price = document.getElementById("priceInput").value;
        payload.stock_date = getRuDate("stockDateInput");
        payload.payment_type = document.getElementById("payTypeInput").value;
        payload.client = document.getElementById("clientInput").value;
        return payload;
      }

      if (formType === "sale_nds_broker") {
        payload.manager = document.getElementById("managerInput").value;
        payload.sale_date = getRuDate("saleDateInput");
        payload.brand_model = document.getElementById("brandModelInput").value;
        payload.vin = document.getElementById("vinInput").value;
        payload.source = document.getElementById("leadSourceInput").value;
        payload.price_nds = document.getElementById("priceNdsInput").value;
        payload.markup_nds = document.getElementById("markupNdsInput").value;
        payload.contract_price = document.getElementById("contractPriceInput").value;
        payload.broker_price = document.getElementById("brokerPriceInput").value;
        payload.broker_expense = document.getElementById("brokerExpenseInput").value;
        payload.buyer = document.getElementById("buyerInput").value;
        return payload;
      }

      if (formType === "sale_nds_no_broker") {
        payload.manager = document.getElementById("managerInput").value;
        payload.sale_date = getRuDate("saleDateInput");
        payload.brand_model = document.getElementById("brandModelInput").value;
        payload.vin = document.getElementById("vinInput").value;
        payload.source = document.getElementById("leadSourceInput").value;
        payload.price_nds = document.getElementById("priceNdsInput").value;
        payload.price_cash = document.getElementById("priceCashInput").value;
        payload.markup_nds = document.getElementById("markupNdsInput").value;
        payload.buyer = document.getElementById("buyerInput").value;
        return payload;
      }

      if (formType === "sale_cash") {
        payload.manager = document.getElementById("managerInput").value;
        payload.sale_date = getRuDate("saleDateInput");
        payload.brand_model = document.getElementById("brandModelInput").value;
        payload.vin = document.getElementById("vinInput").value;
        payload.source = document.getElementById("leadSourceInput").value;
        payload.price = document.getElementById("priceInput").value;
        payload.receiver = document.getElementById("receiverInput").value;
        payload.buyer = document.getElementById("buyerInput").value;
        return payload;
      }

      if (formType === "sale_cash_broker") {
        payload.manager = document.getElementById("managerInput").value;
        payload.sale_date = getRuDate("saleDateInput");
        payload.brand_model = document.getElementById("brandModelInput").value;
        payload.vin = document.getElementById("vinInput").value;
        payload.source = document.getElementById("leadSourceInput").value;
        payload.price = document.getElementById("priceInput").value;
        payload.price_no_commission = document.getElementById("priceNoCommInput").value;
        payload.manager_fee = document.getElementById("managerFeeInput").value;
        payload.receiver = document.getElementById("receiverInput").value;
        payload.buyer = document.getElementById("buyerInput").value;
        return payload;
      }

      if (formType === "sale_deposit") {
        payload.manager = document.getElementById("managerInput").value;
        payload.sale_date = getRuDate("saleDateInput");
        payload.brand_model = document.getElementById("brandModelInput").value;
        payload.vin = document.getElementById("vinInput").value;
        payload.source = document.getElementById("leadSourceInput").value;
        payload.deposit_sum = document.getElementById("depositSumInput").value;
        payload.receiver = document.getElementById("receiverInput").value;
        payload.price = document.getElementById("priceInput").value;
        payload.buyer = document.getElementById("buyerInput").value;
        return payload;
      }

      if (formType === "sale_extra") {
        payload.manager = document.getElementById("managerInput").value;
        payload.sale_date = getRuDate("saleDateInput");
        payload.brand_model = document.getElementById("brandModelInput").value;
        payload.vin = document.getElementById("vinInput").value;
        payload.source = document.getElementById("leadSourceInput").value;
        payload.extra_desc = document.getElementById("extraDescInput").value;
        payload.price = document.getElementById("priceInput").value;
        payload.receiver = document.getElementById("receiverInput").value;
        payload.purchaser = document.getElementById("purchaserInput").value;
        payload.buy_price = document.getElementById("buyPriceInput").value;
        payload.profit = document.getElementById("profitInput").value;
        return payload;
      }

      if (formType === "fin_auto_template") {
        payload.vin = document.getElementById("vinInput").value;
        payload.brand_model = document.getElementById("brandModelInput").value;
        payload.op_date = getRuDate("faDateInput");
        payload.evacuator = document.getElementById("evacuatorInput").value;
        payload.lab = document.getElementById("labInput").value;
        payload.util_writeoff = document.getElementById("utilWriteoffInput").value;
        payload.util = document.getElementById("utilInput").value;
        payload.pre_sale = document.getElementById("preSaleInput").value;
        payload.marketing = document.getElementById("marketingInput").value;
        payload.other = document.getElementById("otherInput").value;
        payload.extra_expenses = document.getElementById("extraExpensesInput").value;
        payload.comment = document.getElementById("commentInput").value;
        return payload;
      }

      if (formType === "fin_oper") {
        payload.category = document.getElementById("categoryInput").value;
        payload.op_date = getRuDate("opDateInput");
        payload.amount = document.getElementById("amountInput").value;
        payload.comment = document.getElementById("commentInput").value;
        return payload;
      }

      if (formType === "boss_buy") {
        const mode = document.getElementById("modeSelect").value;
        payload.mode = mode;
        payload.vin = document.getElementById("vinInput").value.trim().toUpperCase();

        if (mode === "purchase") {
          payload.purchase_date = getRuDate("purchaseDateInput");
          payload.supplier = document.getElementById("supplierInput").value;
          payload.purchase_place = document.getElementById("placeInput").value;
          payload.brand_model = document.getElementById("brandModelInput").value;
          payload.complectation = document.getElementById("complectationInput").value;
          payload.currency = document.getElementById("currencyInput").value;
          payload.amount_currency = document.getElementById("amountCurrencyInput").value;
          payload.rate_to_rub = document.getElementById("rateInput").value;
          payload.amount_rub = document.getElementById("amountRubInput").value;
          payload.comment = document.getElementById("commentInput_p").value;

          const payNow = document.getElementById("payNowSelect").value === "yes";
          if (payNow) {
            payload.pay_date = getRuDate("payDateInput_p");
            payload.pay_currency = document.getElementById("payCurrencySelect_p").value;
            if (payload.pay_currency === "₽") {
              payload.pay_amount_currency = "";
              payload.pay_rate = "";
              payload.pay_amount_rub = document.getElementById("payRubInput_p").value;
            } else {
              payload.pay_amount_currency = document.getElementById("payAmountCurrencyInput_p").value;
              payload.pay_rate = document.getElementById("payRateInput_p").value;
              payload.pay_amount_rub = document.getElementById("payRubInput_p").value;
            }
          }
        } else {
          payload.pay_date = getRuDate("payDateInput");
          payload.pay_currency = document.getElementById("payCurrencySelect").value;
          if (payload.pay_currency === "₽") {
            payload.pay_amount_currency = "";
            payload.pay_rate = "";
            payload.pay_amount_rub = document.getElementById("payRubOnlyInput").value;
          } else {
            payload.pay_amount_currency = document.getElementById("payAmountCurrencyInput").value;
            payload.pay_rate = document.getElementById("payRateInput").value;
            payload.pay_amount_rub = document.getElementById("payRubInput").value;
          }
          payload.comment = document.getElementById("commentInput").value;
        }

        return payload;
      }

      if (formType === "boss_invest_in" || formType === "boss_invest_out") {
        payload.investor = document.getElementById("investorInput").value;
        payload.sum = document.getElementById("sumInput").value;
        payload.op_date = getRuDate("opDateInput");
        payload.comment = document.getElementById("commentInput").value;
        return payload;
      }

      payload.raw = document.getElementById("rawInput").value;
      return payload;
    }

    // ===================== TELEGRAM INTEGRATION =====================

    submitBtn.addEventListener("click", () => {
      const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
      if (!tg) {
        alert("Открой форму через кнопку в Telegram-боте.");
        return;
      }

      try { tg.ready(); } catch(e) {}

      const payload = collectFormData();

      try { cacheBossBuyPayload(payload); } catch(e) {}

      submitBtn.disabled = true;
      submitBtn.textContent = "Отправка...";

      try {
        tg.sendData(JSON.stringify(payload));
        setTimeout(() => { try { tg.close(); } catch(e) {} }, 400);
      } catch (e) {
        alert("Не удалось отправить данные. Попробуй ещё раз.");
        submitBtn.disabled = false;
        submitBtn.textContent = "Отправить в бота";
      }
    });
  </script>
</body>
</html>

